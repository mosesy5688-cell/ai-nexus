# V4.1 Unified Workflow Configuration
# Single Cron, Multiple Tasks: Ingest + FNI + Monitoring

name = "ai-nexus-unified-workflow"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# Cron Trigger: Every 5 minutes
[triggers]
crons = ["*/5 * * * *"]

# Workflow Definition
[[workflows]]
name = "unified-workflow"
binding = "UNIFIED_WORKFLOW"
class_name = "UnifiedWorkflow"

# D1 Database Binding
[[d1_databases]]
binding = "DB"
database_name = "ai-nexus-db"
database_id = "adac7bc9-46a9-40b4-b609-28479221a17d"

# R2 Bucket Binding
[[r2_buckets]]
binding = "R2_ASSETS"
bucket_name = "ai-nexus-assets"

# KV Namespace Binding (Art 2.3 Kill-Switch)
[[kv_namespaces]]
binding = "KV"
id = "24a9a70c8676477c98bf4a02f3b75b05"

# Queue Binding (Producer - Hydration)
[[queues.producers]]
queue = "ai-nexus-hydration-queue"
binding = "HYDRATION_QUEUE"

# Queue Binding (Consumer - Hydration)
[[queues.consumers]]
queue = "ai-nexus-hydration-queue"
max_batch_size = 100
max_batch_timeout = 5

# V7.1: Ingestion Queue (Producer)
[[queues.producers]]
queue = "ai-nexus-ingestion-queue"
binding = "INGESTION_QUEUE"

# V7.1: Ingestion Queue (Consumer)
[[queues.consumers]]
queue = "ai-nexus-ingestion-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "ai-nexus-dlq"

# Observability: Enable Workers Logs for debugging
[observability]
enabled = true

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true


# API Cache proxy
[[routes]]
pattern = "free2aitools.com/api/cache/*"
zone_name = "free2aitools.com"

# Sitemap route (served by Worker via R2)
[[routes]]
pattern = "free2aitools.com/sitemaps/*"
zone_name = "free2aitools.com"
