name: L3 Guardian - Weekly Maintenance

# V3.1 Constitution: Loop 3 - Guardian
# Frequency: Weekly (Sunday)
# Purpose: Dead Link Detection, D1 Backup, R2 Orphan Cleanup
# NOTE: Rankings & Tags are in L1 Harvester for data freshness

on:
  schedule:
    - cron: '0 3 * * 0'  # Every Sunday at 03:00 UTC
  workflow_dispatch:

# V5.2.1 Constitution Art 3.2: Execution Safety
concurrency:
  group: l3-guardian-${{ github.ref }}
  cancel-in-progress: true

jobs:
  maintenance:
    name: System Maintenance
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # === TASK 1: D1 DATABASE BACKUP ===
      - name: Backup D1 Database
        id: backup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ’¾ L3 Guardian: Starting D1 backup..."
          mkdir -p backups
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          EXPORT_FILE="backups/ai-nexus-db-$TIMESTAMP.sql"
          
          set +e
          wrangler d1 export ai-nexus-db --remote --output="$EXPORT_FILE" 2>&1
          EXPORT_EXIT_CODE=$?
          set -e
          
          if [ $EXPORT_EXIT_CODE -eq 0 ] && [ -f "$EXPORT_FILE" ]; then
            FILE_SIZE=$(stat -c%s "$EXPORT_FILE" 2>/dev/null || stat -f%z "$EXPORT_FILE")
            echo "âœ… Backup successful: $EXPORT_FILE ($FILE_SIZE bytes)"
            echo "EXPORT_FILE=$EXPORT_FILE" >> $GITHUB_OUTPUT
            echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_OUTPUT
            
            # Upload to R2 for redundancy
            npx wrangler r2 object put "ai-nexus-assets/backups/d1-$TIMESTAMP.sql" --file="$EXPORT_FILE" || true
          else
            echo "âš ï¸ D1 backup failed (D1 Time Travel is still available)"
          fi
        continue-on-error: true

      # === TASK 2: DEAD LINK DETECTION ===
      - name: Check Dead Links
        id: deadlinks
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”— L3 Guardian: Checking for dead links..."
          if [ -f scripts/check-links.js ]; then
            node scripts/check-links.js 2>&1 | tee link-check.log
            echo "âœ… Dead link check completed"
          else
            echo "âš ï¸ Dead link checker not found, skipping"
          fi
        continue-on-error: true

      # === TASK 3: R2 ORPHAN CLEANUP ===
      - name: Cleanup R2 Orphans
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ§¹ L3 Guardian: Cleaning orphan R2 files..."
          # TODO: Implement R2 orphan detection
          # Compare R2 file list with D1 cover_image_url / body_content_url
          # Delete files not referenced in D1
          echo "â„¹ï¸ R2 cleanup: Placeholder for future implementation"
        continue-on-error: true

      # === TASK 4: DATABASE HEALTH CHECK ===
      - name: Database Health Check
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ¥ L3 Guardian: Database health check..."
          npx wrangler d1 execute ai-nexus-db --remote --command "SELECT COUNT(*) as total_models FROM models" --json | tee db-health.json
          echo "âœ… Database health check completed"
        continue-on-error: true

      - name: Upload maintenance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: l3-guardian-logs
          path: |
            backups/
            link-check.log
            db-health.json
            data/link_check_report.json
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ L3 Guardian Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| D1 Backup | ${{ steps.backup.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dead Links | ${{ steps.deadlinks.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| R2 Cleanup | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.backup.outputs.EXPORT_FILE }}" ]; then
            echo "**Backup File**: ${{ steps.backup.outputs.EXPORT_FILE }}" >> $GITHUB_STEP_SUMMARY
            echo "**Backup Size**: ${{ steps.backup.outputs.FILE_SIZE }} bytes" >> $GITHUB_STEP_SUMMARY
          fi
