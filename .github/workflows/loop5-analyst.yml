name: L5 Analyst - Unified Computation Pipeline

# V6.2 Constitution: L5 = All Computation Tasks
# L1 = Collection (Harvester) | L5 = Computation (Analyst)
#
# Schedule: Daily at 06:00 UTC
# Timeline: L1(03:00) â†’ L8(05:00) â†’ L5(06:00)
# L1 has 2 hours for multi-source harvesting
# L8 has 1 hour for data processing
#
# Tasks:
#   1. Metrics Snapshot (FNI Velocity history)
#   2. FNI Velocity Calculation
#   3. Sitemap Generation
#   4. History Cleanup

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC (after L1+L8)
  workflow_dispatch:     # Manual trigger for testing

concurrency:
  group: l5-analyst
  cancel-in-progress: true

jobs:
  compute:
    name: L5 Unified Computation
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ============================================================
      # SETUP
      # ============================================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Note: pip cache disabled - no requirements.txt in workflow context

      - name: Install Dependencies
        run: |
          npm install -g wrangler
          pip install boto3

      # ============================================================
      # TASK 1: SNAPSHOT CURRENT METRICS (V14.2: D1 BANNED)
      # ============================================================
      - name: Execute Daily Snapshot
        run: |
          echo "ðŸ“¸ [Task 1/5] Creating daily metrics snapshot..."
          echo "âš ï¸ V14.2: D1 database banned - snapshot skipped"
          echo "â„¹ï¸ Metrics are now tracked in R2 entities.json with L5 Heavy Compute"
          echo "âœ… Task 1 skipped (V14.2 compliance)"

      # ============================================================
      # TASK 2: CALCULATE FNI VELOCITY (V14.2: D1 BANNED)
      # ============================================================
      - name: Calculate FNI Velocity
        run: |
          echo "ðŸ“ˆ [Task 2/5] Calculating FNI Velocity..."
          echo "âš ï¸ V14.2: D1 database banned - velocity calculation skipped"
          echo "â„¹ï¸ FNI velocity is now computed in L5 Heavy Compute (fni-compute.js)"
          echo "âœ… Task 2 skipped (V14.2 compliance)"

      # ============================================================
      # TASK 3: VERIFY SNAPSHOT (V14.2: D1 BANNED)
      # ============================================================
      - name: Verify Snapshot
        run: |
          echo "ðŸ” [Task 3/5] Verifying snapshot..."
          echo "âš ï¸ V14.2: D1 database banned - verification skipped"
          echo "â„¹ï¸ Data verification now done via R2 file checks in L5 Heavy Compute"
          echo "âœ… Task 3 skipped (V14.2 compliance)"
      # ============================================================
      # TASK 4: GENERATE SITEMAPS (V6.2 - Merged from l5-sitemap.yml)
      # R2_ENDPOINT constructed from CLOUDFLARE_ACCOUNT_ID if not set
      # ============================================================
      - name: Generate Sitemaps
        continue-on-error: true  # Non-critical - don't fail entire workflow
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ENDPOINT: ${{ vars.R2_ENDPOINT || format('https://{0}.r2.cloudflarestorage.com', secrets.CLOUDFLARE_ACCOUNT_ID) }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ vars.R2_BUCKET || 'ai-nexus-assets' }}
        run: |
          echo "ðŸ—ºï¸ [Task 4/5] Generating sitemaps..."
          echo "R2 Endpoint: ${R2_ENDPOINT:0:30}..."
          python scripts/sidecar/l5_sitemap_gen.py
          echo "âœ… Sitemap generation completed"

      - name: Verify Sitemap Index
        continue-on-error: true  # Non-critical
        env:
          R2_ENDPOINT: ${{ vars.R2_ENDPOINT || format('https://{0}.r2.cloudflarestorage.com', secrets.CLOUDFLARE_ACCOUNT_ID) }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ vars.R2_BUCKET || 'ai-nexus-assets' }}
        run: |
          python -c "
          import boto3
          import os
          from botocore.config import Config
          
          client = boto3.client(
              's3',
              endpoint_url=os.environ['R2_ENDPOINT'],
              aws_access_key_id=os.environ['R2_ACCESS_KEY_ID'],
              aws_secret_access_key=os.environ['R2_SECRET_ACCESS_KEY'],
              config=Config(signature_version='s3v4'),
          )
          
          response = client.head_object(
              Bucket=os.environ['R2_BUCKET'],
              Key='sitemaps/sitemap-index.xml'
          )
          print(f'âœ… sitemap-index.xml exists ({response[\"ContentLength\"]} bytes)')
          "

      # ============================================================
      # TASK 5: CLEANUP OLD HISTORY (Keep 90 days)
      # ============================================================
      - name: Cleanup Old History
        run: |
          echo "ðŸ§¹ [Task 5/5] Cleaning up old history (>90 days)..."
          echo "âš ï¸ V14.2: D1 database banned - using R2 file retention"
          echo "â„¹ï¸ R2 has automatic 90-day retention via lifecycle rules"
          echo "âœ… Cleanup completed (no D1 access per Constitution)"

      # ============================================================
      # SUMMARY
      # ============================================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ“Š L5 Analyst - Unified Computation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d %H:%M UTC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Metrics Snapshot | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | FNI Velocity | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Snapshot Verify | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Sitemap Generation | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | History Cleanup | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** L1=Harvest | L5=Compute" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Next run: Tomorrow at 04:00 UTC (after L1 Harvester)*" >> $GITHUB_STEP_SUMMARY
