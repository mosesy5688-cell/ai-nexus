# Factory 3.5/4 - Knowledge Linker V14.5.2
# SPEC: SPEC-KNOWLEDGE-V14.5.2
#
# Computes knowledge graph relations:
# - Explicit links: Every run (~2min)
# - ALT links: Every run (~10min)
# - Knowledge links: Every run (~1min)
#
# Cost: < $1/month

name: Factory 3.5/4 - Knowledge Linker

on:
  workflow_run:
    workflows: ["Factory 3/4 - Aggregate"]
    types:
      - completed

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      run_alt:
        description: 'Run ALT computation (normally weekly)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

env:
  NODE_OPTIONS: '--max-old-space-size=6144'

jobs:
  # Job 1: Explicit Links (runs every time)
  explicit-links:
    name: Explicit Relations
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline

      # V14.5.2: Debug - Show which run ID we're looking for
      - name: Debug Cache Key
        run: |
          echo "Workflow trigger: ${{ github.event_name }}"
          echo "Looking for cache key: entity-data-${{ github.event.workflow_run.id || 'MANUAL' }}"
        
      - name: Restore entity data from cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: entity-data-${{ github.event.workflow_run.id }}
          restore-keys: |
            entity-data-
          # Don't fail - we'll check manually
          
      - name: Check entity data exists
        run: |
          if [ ! -f "./output/entities.json" ]; then
            echo "âŒ ERROR: entities.json not found!"
            echo "Cache may not have been saved by Factory Aggregate."
            echo "For manual trigger, run Factory Harvest -> Process -> Aggregate first."
            exit 1
          fi
          echo "âœ… entities.json found ($(wc -c < ./output/entities.json) bytes)"
            
      - name: Generate explicit relations
        run: |
          echo "ðŸ“Š Generating explicit relations..."
          node scripts/factory/lib/relations-generator.js
          
      - name: Upload relations artifact
        uses: actions/upload-artifact@v4
        with:
          name: explicit-relations
          path: output/cache/relations/explicit.json
          retention-days: 1

  # Job 2: ALT Links (runs every time)
  alt-links:
    name: ALT Relations
    runs-on: ubuntu-latest
    needs: explicit-links
    # V15: Run every Factory cycle (not just weekly)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Restore entity data
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: entity-data-${{ github.event.workflow_run.id }}
          restore-keys: |
            entity-data-
            
      - name: Compute ALT relations
        run: |
          echo "ðŸ”— Computing alternative relations..."
          node scripts/factory/lib/alt-linker.js output/entities.json output
          
      - name: Upload ALT relations
        uses: actions/upload-artifact@v4
        with:
          name: alt-relations
          path: output/cache/relations/alt-by-category/
          retention-days: 1

  # Job 3: Knowledge Links (runs weekly on Monday)
  knowledge-links:
    name: Knowledge Links
    runs-on: ubuntu-latest
    needs: explicit-links
    # V15: Run every Factory cycle (not just weekly)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Restore entity data
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: entity-data-${{ github.event.workflow_run.id }}
          restore-keys: |
            entity-data-
            
      - name: Compute knowledge links
        run: |
          echo "ðŸ“š Computing knowledge links..."
          node scripts/factory/lib/knowledge-linker.js output/entities.json output
          
      - name: Upload knowledge links
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-links
          path: output/cache/relations/knowledge-links.json
          retention-days: 1

  # V16.2 Job 4: Knowledge Data Generation
  knowledge-data:
    name: Knowledge Data
    runs-on: ubuntu-latest
    needs: knowledge-links
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Restore entity data
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: entity-data-${{ github.event.workflow_run.id }}
          restore-keys: |
            entity-data-
            
      - name: Download knowledge links
        uses: actions/download-artifact@v4
        with:
          name: knowledge-links
          path: output/cache/relations/
          
      - name: Generate knowledge data
        run: node scripts/factory/lib/knowledge-data-generator.js ./output
        
      - name: Upload knowledge data
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          retention-days: 1

  # V16.2 Job 5: Mesh Graph Generation (V14.5.3: Skipped to save compute)
  # mesh-graph:
  #   name: Mesh Graph
  #   ... (disabled)

  # V16.2 Job 6: RSS Feeds
  rss-feeds:
    name: RSS Feeds
    runs-on: ubuntu-latest
    needs: [knowledge-data]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Restore entity data
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: entity-data-${{ github.event.workflow_run.id }}
          restore-keys: |
            entity-data-
            
      - name: Download knowledge data
        uses: actions/download-artifact@v4
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          
      - name: Generate RSS feeds
        run: node scripts/factory/lib/rss-generator.js ./output
        
      - name: Upload RSS feeds
        uses: actions/upload-artifact@v4
        with:
          name: rss-feeds
          path: output/rss/
          retention-days: 1

  # Job 7: Merge and Upload to R2 (V16.2 Enhanced)
  upload-relations:
    name: Upload to R2
    runs-on: ubuntu-latest
    needs: [explicit-links, alt-links, knowledge-links, knowledge-data, rss-feeds]
    if: always() && needs.explicit-links.result == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
          
      - name: Download explicit relations
        uses: actions/download-artifact@v4
        with:
          name: explicit-relations
          path: output/cache/relations/
          
      - name: Download ALT relations (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: alt-relations
          path: output/cache/relations/alt-by-category/
          
      - name: Download knowledge links (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: knowledge-links
          path: output/cache/relations/
          
      - name: Download knowledge data (V16.2)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          
      - name: Download mesh graph (V16.2)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: mesh-graph
          path: output/cache/mesh/
          
      - name: Download RSS feeds (V16.2)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: rss-feeds
          path: output/rss/
          
      - name: Upload to R2 (SPEC V16.2)
        env:
          R2_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          echo "â˜ï¸ Uploading to R2..."
          node scripts/factory/r2-upload-s3.js --prefix cache/relations/
          node scripts/factory/r2-upload-s3.js --prefix cache/knowledge/
          node scripts/factory/r2-upload-s3.js --prefix cache/mesh/
          node scripts/factory/r2-upload-s3.js --prefix rss/
          
      - name: Summary
        run: |
          echo "## ðŸ”— Knowledge Mesh V16.2 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| explicit.json | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| knowledge-links.json | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| cache/knowledge/ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| cache/mesh/graph.json | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| rss/*.xml | âœ… |" >> $GITHUB_STEP_SUMMARY
