# Factory 3.5/4 - Knowledge Linker V14.5.2
# SPEC: SPEC-KNOWLEDGE-V14.5.2
#
# Computes knowledge graph relations:
# - Explicit links: Every run (~2min)
# - ALT links: Every run (~10min)
# - Knowledge links: Every run (~1min)
#
# Cost: < $1/month

name: Factory 3.5/4 - Knowledge Linker

on:
  workflow_run:
    workflows: ["Factory 3/4 - Aggregate"]
    types:
      - completed

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      run_alt:
        description: 'Run ALT computation (normally weekly)'
        required: false
        default: 'false'
        type: boolean
      run_id:
        description: 'Aggregate workflow run ID to download artifacts from'
        required: false
        type: string

permissions:
  contents: read

env:
  NODE_OPTIONS: '--max-old-space-size=6144'

jobs:
  check-upstream:
    name: Check Upstream
    runs-on: ubuntu-latest
    outputs:
      run-id: ${{ steps.get-id.outputs.id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Verify Upstream Conclusion
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' }}
        run: |
          echo "‚ùå ERROR: Upstream workflow '${{ github.event.workflow_run.name }}' failed with conclusion '${{ github.event.workflow_run.conclusion }}'."
          echo "Aborting Factory 3.5/4 to prevent data corruption."
          exit 1
      - name: Get ID
        id: get-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Start with the Aggregate Run ID (Triggering event or manual input)
          AGGREGATE_RUN_ID=${{ inputs.run_id || github.event.workflow_run.id }}
          
          # 2. If missing, find the latest successful Aggregate run on MAIN
          if [ -z "$AGGREGATE_RUN_ID" ] || [ "$AGGREGATE_RUN_ID" == "null" ]; then
            echo "üîç Manual dispatch: Finding latest successful Aggregate run on main branch..."
            AGGREGATE_RUN_ID=$(gh run list --workflow factory-aggregate.yml --branch main --status success --limit 1 --json databaseId --jq '.[0].databaseId' | tr -d '[:space:]')
          fi
          
          echo "id=$AGGREGATE_RUN_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Resolved Aggregate ID (Main): $AGGREGATE_RUN_ID"
  explicit-links:
    name: Explicit Relations
    runs-on: ubuntu-latest
    needs: check-upstream
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline

      # V4.1: Debug - Show which cache key we're looking for
      - name: Debug Cache Key
        run: |
          echo "Workflow trigger: ${{ github.event_name }}"
          echo "Looking for cache key: cycle-${{ needs.check-upstream.outputs.run-id }}-output"
        
      # V4.1: Restore from Cache (Not Artifact)
      - name: Restore Entity Data from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.run-id }}-output
          restore-keys: |
            cycle-
          
      - name: Check entity data exists
        run: |
          if [ ! -f "./output/entities.json" ]; then
            echo "‚ùå ERROR: entities.json not found!"
            ls -la output/ || echo "output/ directory not found"
            exit 1
          fi
          echo "‚úÖ entities.json found ($(wc -c < ./output/entities.json) bytes)"
            
      - name: Generate explicit relations
        run: |
          echo "üìä Generating explicit relations..."
          node scripts/factory/lib/relations-generator.js
          
      - name: Upload relations artifact
        uses: actions/upload-artifact@v4
        with:
          name: explicit-relations
          path: output/cache/relations/explicit.json
          retention-days: 1

  # Job 2: ALT Links (runs every time)
  alt-links:
    name: ALT Relations
    runs-on: ubuntu-latest
    needs: [explicit-links, check-upstream]
    # V15: Run every Factory cycle (not just weekly)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      # V4.1: Restore from Cache (Not Artifact)
      - name: Restore Entity Data from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.run-id }}-output
          restore-keys: |
            cycle-
            
      - name: Compute ALT relations
        run: |
          echo "üîó Computing alternative relations..."
          node scripts/factory/lib/alt-linker.js output/entities.json output
          
      - name: Upload ALT relations
        uses: actions/upload-artifact@v4
        with:
          name: alt-relations
          path: output/cache/relations/alt-by-category/
          retention-days: 1

  # Job 3: Knowledge Links (runs weekly on Monday)
  knowledge-links:
    name: Knowledge Links
    runs-on: ubuntu-latest
    needs: [explicit-links, check-upstream]
    # V15: Run every Factory cycle (not just weekly)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      # V4.1: Restore from Cache (Not Artifact)
      - name: Restore Entity Data from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.run-id }}-output
          restore-keys: |
            cycle-
            
      - name: Compute knowledge links
        run: |
          echo "üìö Computing knowledge links..."
          node scripts/factory/lib/knowledge-linker.js output/entities.json output
          
      - name: Upload knowledge links
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-links
          path: output/cache/relations/knowledge-links.json
          retention-days: 1

  # V16.2 Job 4: Knowledge Data Generation
  knowledge-data:
    name: Knowledge Data
    runs-on: ubuntu-latest
    needs: [knowledge-links, check-upstream]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      # V17.0: Download to output/ to match expected path
      - name: Restore entity data from Artifact (V17.0)
        uses: actions/download-artifact@v4
        with:
          name: core-registry-v2
          path: output/
          run-id: ${{ needs.check-upstream.outputs.run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
            
      - name: Download knowledge links
        uses: actions/download-artifact@v4
        with:
          name: knowledge-links
          path: output/cache/relations/
          
      - name: Generate knowledge data
        run: node scripts/factory/lib/knowledge-data-generator.js ./output
        
      - name: Upload knowledge data
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          retention-days: 1

  # V16.2 Job 5: Mesh Graph Generation
  mesh-graph:
    name: Mesh Graph
    runs-on: ubuntu-latest
    needs: [explicit-links, alt-links, knowledge-links, check-upstream]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      # V17.0: Download to output/ to match expected path
      - name: Restore entity data from Artifact (V17.0)
        uses: actions/download-artifact@v4
        with:
          name: core-registry-v2
          path: output/
          run-id: ${{ needs.check-upstream.outputs.run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
            
      - name: Download explicit relations
        uses: actions/download-artifact@v4
        with:
          name: explicit-relations
          path: output/cache/relations/
          
      - name: Download knowledge links
        uses: actions/download-artifact@v4
        with:
          name: knowledge-links
          path: output/cache/relations/
            
      - name: Generate mesh graph
        run: node scripts/factory/lib/mesh-graph-generator.js ./output
        
      - name: Upload mesh graph
        uses: actions/upload-artifact@v4
        with:
          name: mesh-graph
          path: output/cache/mesh/
          retention-days: 1

  # V16.2 Job 6: RSS Feeds
  rss-feeds:
    name: RSS Feeds
    runs-on: ubuntu-latest
    needs: [knowledge-data, check-upstream]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      # V17.0: Download to output/ to match expected path
      - name: Restore entity data from Artifact (V17.0)
        uses: actions/download-artifact@v4
        with:
          name: core-registry-v2
          path: output/
          run-id: ${{ needs.check-upstream.outputs.run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
            
      - name: Download knowledge data
        uses: actions/download-artifact@v4
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          
      - name: Generate RSS feeds
        run: node scripts/factory/lib/rss-generator.js ./output
        
      - name: Upload RSS feeds
        uses: actions/upload-artifact@v4
        with:
          name: rss-feeds
          path: output/rss/
          retention-days: 1

  # Job 7: Save to Cache for Factory 4/4 (V17.2: R2 upload moved to 4/4)
  save-to-cache:
    name: Save to Cache
    runs-on: ubuntu-latest
    needs: [explicit-links, alt-links, knowledge-links, knowledge-data, mesh-graph, rss-feeds, check-upstream]
    if: always() && needs.explicit-links.result == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
          
      - name: Download explicit relations
        uses: actions/download-artifact@v4
        with:
          name: explicit-relations
          path: output/cache/relations/
          
      - name: Download ALT relations (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: alt-relations
          path: output/cache/relations/alt-by-category/
          
      - name: Download knowledge links (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: knowledge-links
          path: output/cache/relations/
          
      - name: Download knowledge data (V16.2)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          
      - name: Download mesh graph (V16.2)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: mesh-graph
          path: output/cache/mesh/
          
      - name: Download RSS feeds (V16.2)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: rss-feeds
          path: output/rss/
          
      # V17.6: Use explicit linker-output path for cache consistency
      - name: Prepare Cache Directory
        run: |
          mkdir -p linker-output
          cp -r output/* linker-output/
          
      - name: Save Linker Output to Cache
        uses: actions/cache/save@v4
        with:
          path: linker-output/
          key: linker-${{ needs.check-upstream.outputs.run-id }}-output
          
      - name: Summary
        run: |
          echo "## üîó Knowledge Mesh V16.2 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| explicit.json | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| knowledge-links.json | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| cache/knowledge/ | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| cache/mesh/graph.json | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| rss/*.xml | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
