name: Data Integrity Health Check

# V1.1-LOCK: Scheduled integrity monitoring
# Validates manifest health and alerts on failures

on:
  schedule:
    # Run daily at 6 AM UTC (2 PM CST)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        default: false
        type: boolean

concurrency:
  group: integrity-check
  cancel-in-progress: true

jobs:
  integrity-check:
    name: Manifest Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm ci
      
      - name: Download L1 Manifest from R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üì• Downloading L1 manifest from R2..."
          mkdir -p data
          npx wrangler r2 object get ai-nexus-assets/ingest/manifest.json \
            --file=data/manifest.json \
            --remote || echo '{"status":"not_found"}' > data/manifest.json
          
          if [ -f data/manifest.json ]; then
            echo "‚úÖ L1 manifest downloaded"
            cat data/manifest.json | head -20
          else
            echo "‚ö†Ô∏è L1 manifest not found"
          fi
          
      - name: Run Integrity Check
        id: integrity
        run: |
          echo "üîç Running integrity-check.js..."
          node scripts/l5/integrity-check.js 2>&1 || echo "::set-output name=failed::true"
          
      - name: Report Status
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä Integrity Health Report"
          echo "=========================================="
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          
          if [ -f data/manifest.json ]; then
            VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('data/manifest.json')).version || 'unknown')")
            STATUS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('data/manifest.json')).status || 'unknown')")
            ENTITIES=$(node -e "console.log(JSON.parse(require('fs').readFileSync('data/manifest.json')).output?.total_entities || 0)")
            
            echo "L1 Manifest:"
            echo "  Version: $VERSION"
            echo "  Status: $STATUS"
            echo "  Entities: $ENTITIES"
          else
            echo "L1 Manifest: Not found"
          fi
          
          echo "=========================================="
          
      - name: Alert on Failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "‚ùå INTEGRITY CHECK FAILED!"
          echo "::error::Data integrity validation failed. Manual review required."
          
          # Send Slack notification if webhook is configured
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"‚ö†Ô∏è Data Integrity Check Failed!\n\nRun: ${{ github.run_id }}\nTime: '"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'\n\nPlease review: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              "$SLACK_WEBHOOK_URL" || echo "Slack notification failed"
          else
            echo "‚ö†Ô∏è SLACK_WEBHOOK_URL not configured, skipping notification"
          fi

