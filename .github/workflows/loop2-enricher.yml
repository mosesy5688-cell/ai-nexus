name: L2 Enricher - AI Content Enhancement

# V3.1 Constitution: Loop 2 - Enricher
# Frequency: Every 4 hours + After L1 Harvester
# Purpose: AI Summary â†’ Knowledge Graph â†’ Relationship Discovery

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_run:
    workflows: ["L1 Harvester - Daily Data Ingestion"]
    types: [completed]
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of models to process (0 for all)'
        required: false
        default: '100'
      source:
        description: 'Enrichment source (all/github/pwc)'
        required: false
        default: 'all'

jobs:
  enrich:
    name: Enrich Content
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # === GITHUB DATA ENRICHMENT ===
      - name: Enrich from GitHub
        if: ${{ inputs.source == 'all' || inputs.source == 'github' || github.event_name != 'workflow_dispatch' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“Š L2 Enricher: GitHub Data Enhancement..."
          LIMIT="${{ inputs.limit || '100' }}"
          node scripts/enrich-github-enhanced.js --remote --limit=$LIMIT 2>&1 | tee github-enrichment.log
          echo "âœ… GitHub enrichment completed"
        continue-on-error: true

      # === PWC (Papers With Code) ENRICHMENT ===
      - name: Enrich from PWC
        if: ${{ inputs.source == 'all' || inputs.source == 'pwc' || github.event_name != 'workflow_dispatch' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“„ L2 Enricher: PWC Paper Linking..."
          LIMIT="${{ inputs.limit || '100' }}"
          if [ -f scripts/enrich-pwc.js ]; then
            node scripts/enrich-pwc.js --remote --limit $LIMIT 2>&1 | tee pwc-enrichment.log
          else
            echo "âš ï¸ PWC enrichment script not found, skipping"
          fi
          echo "âœ… PWC enrichment completed"
        continue-on-error: true

      # === FUTURE: AI SUMMARY GENERATION ===
      # - name: Generate AI Summaries (Workers AI)
      #   env:
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #   run: |
      #     echo "ðŸ¤– Generating AI summaries..."
      #     node scripts/generate-ai-summaries.js
      #     echo "âœ… AI summaries generated"

      - name: Upload enrichment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: l2-enricher-logs
          path: |
            github-enrichment.log
            pwc-enrichment.log
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§  L2 Enricher Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub | ${{ steps.github-enrich.outcome || 'âœ…' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PWC | ${{ steps.pwc-enrich.outcome || 'âœ…' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
