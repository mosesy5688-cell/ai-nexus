name: Infra CI - Lint & Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  lint-and-build:
    name: Lint & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci

      - name: Constitutional CES Check (V5.1.2)
        run: npm run ces-check
      
      - name: Build Project
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Check Build Output
        run: |
          echo "ðŸ“¦ Verifying build artifacts..."
          
          # Check dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found"
            exit 1
          fi
          
          # Check for CSS files
          if ! ls dist/assets/*.css 1> /dev/null 2>&1; then
            echo "âŒ No CSS files found in dist/assets/"
            exit 1
          fi
          
          # Check for JS files
          if ! ls dist/assets/*.js 1> /dev/null 2>&1; then
            echo "âŒ No JS files found in dist/assets/"
            exit 1
          fi
          
          echo "âœ… Build artifacts verified"
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # =============================================================
  # V4.9.1 CEO IRON RULE: Frontend D1 = 0 Detection
  # Constitutional: Art.I-Extended - Frontend must not access D1
  # =============================================================
  constitutional-guard:
    name: Constitutional D1 Guard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Check for D1 Access in Frontend
        run: |
          echo "ðŸ›¡ï¸ Constitutional Guard: Checking for D1 access in frontend..."
          
          # CEO Iron Rule: Frontend D1 = 0
          # Detect any direct D1 database access in frontend PAGES only
          # NOTE: API endpoints and utils are EXCLUDED - they are backend code
          
          VIOLATIONS=0
          
          # Only check frontend pages (*.astro files in src/pages, excluding api/)
          # Store results in variable to avoid pipeline exit code issues
          FRONTEND_DB=$(find src/pages -type f -name "*.astro" ! -path "*/api/*" -exec grep -l "env\.DB\|\.prepare\s*(" {} \; 2>/dev/null || true)
          
          if [ -n "$FRONTEND_DB" ]; then
            echo "âŒ VIOLATION: D1 access found in frontend pages:"
            echo "$FRONTEND_DB"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "ðŸš¨ CONSTITUTION VIOLATION: Frontend D1 = 0"
            echo "ðŸ“– Reference: V4.9 Art.I-Extended, Pillar VIII"
            echo "ðŸ”§ Solution: Use R2 cache files instead of D1 queries"
            exit 1
          fi
          
          echo "âœ… Constitutional Guard: No frontend D1 access violations found"
          echo "â„¹ï¸  Note: API endpoints (src/pages/api/*) and utils are allowed to access D1"

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: lint-and-build
    continue-on-error: true  # Don't block deployment on smoke test failures
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/
      
      - name: Start Preview Server
        run: |
          npm run preview &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to be ready
          echo "â³ Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4321 > /dev/null; then
              echo "âœ… Server is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Server failed to start"
              exit 1
            fi
            sleep 1
          done
      
      - name: Test Homepage
        run: |
          echo "ðŸ§ª Testing homepage..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/)
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Homepage returned $STATUS"
            exit 1
          fi
          
          # Check for critical content
          CONTENT=$(curl -s http://localhost:4321/)
          if ! echo "$CONTENT" | grep -q "Free AI Tools"; then
            echo "âŒ Homepage missing title"
            exit 1
          fi
          
          echo "âœ… Homepage test passed"
      
      - name: Test Model Detail Page
        run: |
          echo "ðŸ§ª Testing model detail page..."
          
          # Test with a known model (adjust slug as needed)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/model/meta-llama--Llama-3-2-1B)
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "404" ]; then
            echo "âš ï¸ Model page returned $STATUS (acceptable if model doesn't exist)"
          else
            echo "âœ… Model page test passed"
          fi
      
      - name: Test Explore Page
        run: |
          echo "ðŸ§ª Testing explore page..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/explore)
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Explore page returned $STATUS"
            exit 1
          fi
          
          echo "âœ… Explore page test passed"
      
      - name: Test API Endpoints
        run: |
          echo "ðŸ§ª Testing API endpoints..."
          
          # Test search API (if exists)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4321/api/search?q=test)
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "404" ]; then
            echo "âš ï¸ Search API returned $STATUS"
          fi
          
          echo "âœ… API tests completed"
      
      - name: Cleanup
        if: always()
        run: |
          if [ -n "${{ env.SERVER_PID }}" ]; then
            kill ${{ env.SERVER_PID }} || true
          fi

  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    needs: lint-and-build
    continue-on-error: true  # Don't block deployment on lighthouse failures
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/
      
      - name: Start Preview Server
        run: |
          npm run preview &
          
          # Wait for server to be ready
          echo "â³ Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4321 > /dev/null; then
              echo "âœ… Server is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Server failed to start"
              exit 1
            fi
            sleep 1
          done
      
      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:4321/
            http://localhost:4321/explore
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
      
      - name: Check Lighthouse Scores
        run: |
          echo "ðŸ“Š Lighthouse scores recorded"
          echo "View results in job artifacts"

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          echo "âš ï¸ Security audit completed (warnings allowed)"
      
      - name: Check for Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before != '0000000000000000000000000000000000000000' && github.event.before || '' }}
          head: HEAD
          extra_args: --only-verified

  status-check:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [lint-and-build, smoke-tests, lighthouse, security-check]
    if: always()
    
    steps:
      - name: Check Job Status
        run: |
          echo "## ðŸ“Š CI Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint & Build**: ${{ needs.lint-and-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Informational Checks (non-blocking)" >> $GITHUB_STEP_SUMMARY
          echo "- **Smoke Tests**: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lighthouse**: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only require lint-and-build and security-check to pass
          # Smoke tests and lighthouse are informational (continue-on-error: true)
          if [ "${{ needs.lint-and-build.result }}" != "success" ] || \
             [ "${{ needs.security-check.result }}" != "success" ]; then
            echo "âŒ **Required CI checks failed. Please fix errors before merging.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **Required CI checks passed. Ready to merge.**" >> $GITHUB_STEP_SUMMARY
          fi
