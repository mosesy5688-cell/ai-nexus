# Factory 4/4 - Finalize V14.6
# Consolidated Stage 3.5 + 4.0
# 
# Triggers: workflow_run from Aggregate, or manual dispatch
# Inputs: factory-output artifact/cache from Aggregate stage
# Jobs: Relations, Knowledge Mesh, RSS, and Final R2 Upload

name: Factory 4/4 - Finalize

on:
  workflow_run:
    workflows: ["Factory 3/4 - Aggregate"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Aggregate workflow run ID'
        required: false
        type: string

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  R2_BUCKET: ai-nexus-assets
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NODE_OPTIONS: '--max-old-space-size=6144'

jobs:
  check-upstream:
    name: Check Upstream
    runs-on: ubuntu-latest
    outputs:
      upstream-run-id: ${{ steps.get-id.outputs.id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Verify Upstream Conclusion
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' }}
        run: |
          echo "ERROR: Upstream workflow '${{ github.event.workflow_run.name }}' failed with conclusion '${{ github.event.workflow_run.conclusion }}'."
          exit 1
      - name: Get ID
        id: get-id
        run: |
          AGGREGATE_RUN_ID=${{ inputs.run_id || github.event.workflow_run.id }}
          if [ -z "$AGGREGATE_RUN_ID" ] || [ "$AGGREGATE_RUN_ID" == "null" ]; then
            echo "Finding latest successful Aggregate run on main..."
            AGGREGATE_RUN_ID=$(gh run list --workflow factory-aggregate.yml --branch main --status success --limit 1 --json databaseId --jq '.[0].databaseId' | tr -d '[:space:]')
          fi
          echo "id=$AGGREGATE_RUN_ID" >> $GITHUB_OUTPUT

  explicit-links:
    name: Explicit Relations
    needs: check-upstream
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Entity Data from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.upstream-run-id }}-output
          restore-keys: cycle-
      - name: Generate explicit relations
        run: node scripts/factory/lib/relations-generator.js
      - name: Upload explicit relations
        uses: actions/upload-artifact@v4
        with:
          name: explicit-relations
          path: output/cache/relations/explicit.json
          retention-days: 1

  alt-links:
    name: ALT Relations
    needs: [explicit-links, check-upstream]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Entity Data from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.upstream-run-id }}-output
          restore-keys: cycle-
      - name: Compute ALT relations
        run: node scripts/factory/lib/alt-linker.js output/entities.json output
      - name: Upload ALT relations
        uses: actions/upload-artifact@v4
        with:
          name: alt-relations
          path: output/cache/relations/alt-by-category/
          retention-days: 1

  knowledge-links:
    name: Knowledge Links
    needs: [explicit-links, check-upstream]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Entity Data from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.upstream-run-id }}-output
          restore-keys: cycle-
      - name: Compute knowledge links
        run: node scripts/factory/lib/knowledge-linker.js output/entities.json output
      - name: Upload knowledge links
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-links
          path: output/cache/relations/knowledge-links.json
          retention-days: 1

  knowledge-data:
    name: Knowledge Data
    needs: [knowledge-links, check-upstream]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Download Registry Artifact
        run: gh run download ${{ needs.check-upstream.outputs.upstream-run-id }} -n core-registry-v2 -D output/
      - name: Download knowledge links
        uses: actions/download-artifact@v4
        with: { name: knowledge-links, path: output/cache/relations/ }
      - name: Generate knowledge data
        run: node scripts/factory/lib/knowledge-data-generator.js ./output
      - name: Upload knowledge data
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-data
          path: output/cache/knowledge/
          retention-days: 1

  mesh-graph:
    name: Mesh Graph
    needs: [explicit-links, alt-links, knowledge-links, check-upstream]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Download Registry Artifact
        run: gh run download ${{ needs.check-upstream.outputs.upstream-run-id }} -n core-registry-v2 -D output/
      - name: Download Relations
        uses: actions/download-artifact@v4
        with: { pattern: '*-relations', path: output/cache/relations/ }
      - name: Download knowledge links
        uses: actions/download-artifact@v4
        with: { name: knowledge-links, path: output/cache/relations/ }
      - name: Generate mesh graph
        run: node scripts/factory/lib/mesh-graph-generator.js ./output
      - name: Upload mesh graph
        uses: actions/upload-artifact@v4
        with:
          name: mesh-graph
          path: output/cache/mesh/
          retention-days: 1

  rss-feeds:
    name: RSS Feeds
    needs: [knowledge-data, check-upstream]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Download Registry Artifact
        run: gh run download ${{ needs.check-upstream.outputs.upstream-run-id }} -n core-registry-v2 -D output/
      - name: Download knowledge data
        uses: actions/download-artifact@v4
        with: { name: knowledge-data, path: output/cache/knowledge/ }
      - name: Generate RSS feeds
        run: node scripts/factory/lib/rss-generator.js ./output
      - name: Upload RSS feeds
        uses: actions/upload-artifact@v4
        with:
          name: rss-feeds
          path: output/rss/
          retention-days: 1

  upload:
    name: Final Upload to R2
    needs: [explicit-links, alt-links, knowledge-links, knowledge-data, mesh-graph, rss-feeds, check-upstream]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Base Output from Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: cycle-${{ needs.check-upstream.outputs.upstream-run-id }}-output
          restore-keys: cycle-
      - name: Download All Enrichment Artifacts
        uses: actions/download-artifact@v4
        with: { path: output/ }
      - name: Prepare Registry Backup for S3 Upload
        run: |
          mkdir -p output/meta/backup
          echo "âœ… aggregator.js has prepared baseline backups in output/meta/backup/"
      - name: Upload to R2 via S3 API
        env:
          R2_PREFIX_FILTER: checkpoint.json,entities.json,entities/,cache/entities/,cache/rankings/,cache/search/,cache/trending.json,cache/category_stats.json,cache/search-core.json,cache/search-full.json,cache/search-manifest.json,cache/relations/,cache/relations.json,cache/trend-data.json,cache/knowledge/,cache/mesh/,cache/graph.json,cache/reports/,daily/,meta/,sitemaps/,rss/,sitemap.xml
        run: node scripts/factory/r2-upload-s3.js
      - name: Purge & Warm CDN
        run: |
          PURGE_PATHS='["https://cdn.free2aitools.com/cache/trending.json","https://cdn.free2aitools.com/cache/search-core.json","https://cdn.free2aitools.com/cache/relations.json","https://cdn.free2aitools.com/sitemap.xml"]'
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" \
            --data "{\"files\":$PURGE_PATHS}"
      - name: Trigger Health Check
        run: gh workflow run daily-health-check.yml
        continue-on-error: true
