# Factory 4/4 - Upload
# V14.5 Phase 4: Modular Factory Architecture
# 
# Triggers: workflow_run from Aggregate, or manual dispatch
# Inputs: factory-output artifact from Aggregate stage
# Actions: Upload to R2, CDN purge, Health check
# 
# Constitution: Art 13.4 (Non-Destructive), Art 6.2 (CDN)

name: Factory 4/4 - Upload

on:
  workflow_run:
    workflows: ["Factory 3/4 - Aggregate"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Aggregate workflow run ID to download artifact from'
        required: true
        type: string

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  R2_BUCKET: ai-nexus-assets

jobs:
  upload:
    name: Upload to R2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Download factory output
      - name: Download Factory Output
        uses: actions/download-artifact@v4
        with:
          name: factory-output
          path: output/
          run-id: ${{ inputs.run_id || github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Pre-flight validation
      - name: Pre-flight Validation
        run: |
          echo "ðŸ” V14.5 Phase 4 - Pre-flight Validation"
          echo "========================================"
          
          # Check secrets
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "âŒ ERROR: Missing Cloudflare credentials"
            exit 1
          fi
          
          # Count files
          FILE_COUNT=$(find output -type f -name "*.json" 2>/dev/null | wc -l)
          echo "ðŸ“Š JSON files: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -lt 100 ]; then
            echo "âŒ ERROR: Only $FILE_COUNT files. Expected 100+. Aborting."
            echo "This prevents uploading empty/incomplete data to R2."
            exit 1
          fi
          
          # Check critical files
          CRITICAL_FILES=(
            "output/cache/trending.json"
            "output/cache/search-core.json"
            "output/cache/category_stats.json"
          )
          
          for f in "${CRITICAL_FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "âœ… $f"
            else
              echo "âš ï¸ WARNING: Missing $f"
            fi
          done
          
          echo "âœ… Pre-flight validation passed"

      # Upload to R2 using S3 API (V14.5 Phase 6 - 10x faster)
      - name: Upload to R2
        run: |
          echo "ðŸ“¤ Uploading to R2 via S3 API..."
          node scripts/factory/r2-upload-s3.js

      # CDN Purge
      - name: Purge CDN Cache
        run: |
          echo "ðŸ”„ Purging CDN cache..."
          
          PURGE_PATHS='["https://cdn.free2aitools.com/cache/trending.json","https://cdn.free2aitools.com/cache/search-core.json","https://cdn.free2aitools.com/cache/category_stats.json","https://cdn.free2aitools.com/cache/relations.json"]'
          
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{\"files\":$PURGE_PATHS}" \
            | jq '.success'

      # CDN Warming
      - name: Warm CDN Cache
        run: |
          echo "ðŸ”¥ Warming CDN cache..."
          
          WARM_URLS=(
            "https://cdn.free2aitools.com/cache/trending.json"
            "https://cdn.free2aitools.com/cache/search-core.json"
            "https://cdn.free2aitools.com/cache/category_stats.json"
          )
          
          for url in "${WARM_URLS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            echo "$url â†’ $STATUS"
          done

      # Trigger Health Check
      - name: Trigger Health Check
        run: |
          echo "ðŸ¥ Triggering Health Check..."
          gh workflow run health-check.yml || echo "Health check workflow not found"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # Trigger Image Processor (optional)
      - name: Trigger Image Processor
        run: |
          echo "ðŸ–¼ï¸ Triggering Image Processor..."
          gh workflow run image-processor.yml || echo "Image processor workflow not found"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Summary
        run: |
          echo "## Factory 4/4 - Upload Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Upload Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Files uploaded: $(find output -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- CDN purged: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- CDN warmed: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Health Check triggered" >> $GITHUB_STEP_SUMMARY
          echo "- Image Processor triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Factory Pipeline Complete!** ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
