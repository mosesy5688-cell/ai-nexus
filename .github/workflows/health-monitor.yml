# V4.8 Health Monitor Workflow
# 
# Constitution V4.8 Compliance:
# - Art.IX-Metrics: P95 monitoring
# - Art.Shadow: Shadow DB growth alerts
# - Art.I-Extended: Quota monitoring
#
# Schedule: Every 4 hours

name: V4.8 Health Monitor

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:  # Manual trigger

env:
  HEALTH_ENDPOINT: https://free2aitools.com/api/health
  ALERT_THRESHOLD_P95_MS: 5
  ALERT_THRESHOLD_SHADOW_COUNT: 100

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Health Status
        id: health
        run: |
          RESPONSE=$(curl -s "${{ env.HEALTH_ENDPOINT }}" || echo '{"status":"error"}')
          
          # Compact JSON for single-line storage
          RESPONSE_COMPACT=$(echo "$RESPONSE" | jq -c '.')
          echo "response=$RESPONSE_COMPACT" >> $GITHUB_OUTPUT
          
          # Extract status
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "error"')
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          # Extract P95
          P95=$(echo "$RESPONSE" | jq -r '.checks.guardian.p95_ms // "0"')
          echo "p95=$P95" >> $GITHUB_OUTPUT
          
          # Extract samples count
          SAMPLES=$(echo "$RESPONSE" | jq -r '.checks.guardian.samples // "0"')
          echo "samples=$SAMPLES" >> $GITHUB_OUTPUT
          
          # Extract Shadow count
          SHADOW=$(echo "$RESPONSE" | jq -r '.checks.d1.shadow_models // "0"')
          echo "shadow=$SHADOW" >> $GITHUB_OUTPUT
          
          # Extract Quarantine 24h
          QUARANTINE=$(echo "$RESPONSE" | jq -r '.checks.d1.quarantine_24h // "0"')
          echo "quarantine=$QUARANTINE" >> $GITHUB_OUTPUT

      - name: Check P95 Threshold (Art.IX-Metrics)
        if: ${{ steps.health.outputs.p95 != '0' }}
        run: |
          P95="${{ steps.health.outputs.p95 }}"
          SAMPLES="${{ steps.health.outputs.samples }}"
          echo "Guardian P95: ${P95}ms (samples: ${SAMPLES})"
          
          # Skip check if insufficient samples (< 10)
          if [ "$SAMPLES" -lt 10 ]; then
            echo "âš ï¸ Insufficient samples ($SAMPLES) - skipping P95 threshold check"
            exit 0
          fi
          
          if (( $(echo "$P95 > 50" | bc -l) )); then
            echo "::error::ðŸ”´ CRITICAL: Guardian P95 ${P95}ms > 50ms threshold"
            exit 1
          elif (( $(echo "$P95 > 20" | bc -l) )); then
            echo "::warning::ðŸŸ¡ WARNING: Guardian P95 ${P95}ms > 20ms target"
          else
            echo "âœ… Guardian P95 ${P95}ms is within target"
          fi

      - name: Check Shadow DB Growth (Art.Shadow)
        run: |
          SHADOW="${{ steps.health.outputs.shadow }}"
          echo "Shadow DB models: $SHADOW"
          
          if [ "$SHADOW" -gt 500 ]; then
            echo "::error::ðŸ”´ CRITICAL: Shadow DB has $SHADOW entries (>500)"
            exit 1
          elif [ "$SHADOW" -gt 100 ]; then
            echo "::warning::ðŸŸ¡ WARNING: Shadow DB has $SHADOW entries (>100)"
          else
            echo "âœ… Shadow DB entries: $SHADOW"
          fi

      - name: Check Quarantine Activity
        run: |
          QUARANTINE="${{ steps.health.outputs.quarantine }}"
          echo "Quarantine entries (24h): $QUARANTINE"
          
          if [ "$QUARANTINE" -gt 50 ]; then
            echo "::warning::ðŸŸ¡ WARNING: High quarantine activity: $QUARANTINE in 24h"
          else
            echo "âœ… Quarantine activity normal: $QUARANTINE in 24h"
          fi

      - name: Health Summary
        run: |
          echo "## V4.8 Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall Status | ${{ steps.health.outputs.status }} | ${{ steps.health.outputs.status == 'healthy' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Guardian P95 | ${{ steps.health.outputs.p95 }}ms | ${{ steps.health.outputs.p95 < 5 && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shadow DB | ${{ steps.health.outputs.shadow }} | ${{ steps.health.outputs.shadow < 100 && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quarantine (24h) | ${{ steps.health.outputs.quarantine }} | ${{ steps.health.outputs.quarantine < 50 && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
