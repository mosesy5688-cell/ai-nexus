# Daily Health Check Workflow V14.4
# Constitution Reference: Art 8.3 (Daily Health Check)
#
# Runs at 00:00 UTC daily to verify system integrity

name: Daily Health Check

on:
  schedule:
    - cron: '0 0 * * *'  # 00:00 UTC daily
  workflow_dispatch:

env:
  R2_BUCKET: ai-nexus-assets

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install wrangler
        run: npm install -g wrangler

      # Art 8.3.1: Verify R2 entity count
      - name: Check R2 Entity Count
        id: r2-check
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üìä Checking R2 entity count..."
          
          # Check if critical files exist
          TRENDING=$(wrangler r2 object get $R2_BUCKET/cache/trending.json --pipe 2>/dev/null | head -c 100 || echo "MISSING")
          SEARCH=$(wrangler r2 object get $R2_BUCKET/cache/search-core.json --pipe 2>/dev/null | head -c 100 || echo "MISSING")
          
          if [[ "$TRENDING" == "MISSING" ]]; then
            echo "‚ùå trending.json missing!"
            echo "trending=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ trending.json exists"
            echo "trending=true" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$SEARCH" == "MISSING" ]]; then
            echo "‚ùå search-core.json missing!"
            echo "search=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ search-core.json exists"
            echo "search=true" >> $GITHUB_OUTPUT
          fi

      # Art 8.3.2: Verify CDN availability (spot check)
      - name: Check CDN Availability
        id: cdn-check
        run: |
          echo "üåê Checking CDN availability..."
          
          URLS=(
            "https://free2aitools.com/"
            "https://free2aitools.com/models"
            "https://free2aitools.com/api/cache/trending.json"
          )
          
          FAILED=0
          for URL in "${URLS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" --max-time 10 || echo "000")
            if [[ "$STATUS" == "200" ]]; then
              echo "‚úÖ $URL -> $STATUS"
            else
              echo "‚ùå $URL -> $STATUS"
              FAILED=$((FAILED + 1))
            fi
          done
          
          if [[ $FAILED -gt 0 ]]; then
            echo "cdn_ok=false" >> $GITHUB_OUTPUT
          else
            echo "cdn_ok=true" >> $GITHUB_OUTPUT
          fi

      # Art 8.3.3: Verify Cache integrity
      - name: Check Cache Integrity
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üíæ Checking cache integrity..."
          
          # Check FNI history exists in cache
          FNI_HISTORY=$(wrangler r2 object get $R2_BUCKET/meta/backup/fni-history.json --pipe 2>/dev/null | head -c 50 || echo "MISSING")
          
          if [[ "$FNI_HISTORY" != "MISSING" ]]; then
            echo "‚úÖ FNI history backup exists"
          else
            echo "‚ö†Ô∏è FNI history backup missing (will regenerate)"
          fi

      # Art 8.3.4: Generate health report
      - name: Generate Health Report
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          
          cat > health-report.json << EOF
          {
            "date": "$DATE",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "checks": {
              "r2_trending": "${{ steps.r2-check.outputs.trending }}",
              "r2_search": "${{ steps.r2-check.outputs.search }}",
              "cdn_available": "${{ steps.cdn-check.outputs.cdn_ok }}"
            },
            "status": "$([ "${{ steps.r2-check.outputs.trending }}" == "true" ] && [ "${{ steps.cdn-check.outputs.cdn_ok }}" == "true" ] && echo "healthy" || echo "degraded")"
          }
          EOF
          
          echo "üìã Health Report:"
          cat health-report.json
          
          # Upload to R2
          wrangler r2 object put "$R2_BUCKET/meta/health/$DATE.json" --file=health-report.json
          echo "‚úÖ Health report uploaded to R2"

      # Summary
      - name: Summary
        run: |
          echo "## üè• Daily Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| R2 trending.json | ${{ steps.r2-check.outputs.trending == 'true' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| R2 search-core.json | ${{ steps.r2-check.outputs.search == 'true' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CDN Availability | ${{ steps.cdn-check.outputs.cdn_ok == 'true' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY

      # Alert on failure
      - name: Alert on Degraded Status
        if: steps.r2-check.outputs.trending == 'false' || steps.cdn-check.outputs.cdn_ok == 'false'
        run: |
          echo "‚ö†Ô∏è System is in degraded state!"
          echo "Consider triggering a manual Factory run to regenerate data."
          # Could add Slack/Discord webhook here
