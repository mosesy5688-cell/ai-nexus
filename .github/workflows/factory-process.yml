# Factory 2/4 - Process
# V14.5 Phase 4: Modular Factory Architecture
# 
# Triggers: workflow_run from Harvest, or manual dispatch
# Inputs: entity-data artifact from Harvest
# Outputs: shard results + processed entity files
# 
# Constitution: Art 3.1-3.4 (Factory Pipeline)

name: Factory 2/4 - Process

on:
  workflow_run:
    workflows: ["Factory 1/4 - Harvest"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of Harvest workflow (optional)'
        required: false
        type: string

jobs:
  # Validate upstream success
  check-upstream:
    name: Check Upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      upstream-run-id: ${{ steps.get-run-id.outputs.run_id }}
    steps:
      - name: Get Upstream Run ID
        id: get-run-id
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          fi

  # Matrix shards for parallel processing
  matrix-shards:
    name: Shard ${{ matrix.shard }}
    needs: check-upstream
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
      fail-fast: false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Download entity data from Harvest
      - name: Download Entity Data
        uses: actions/download-artifact@v4
        with:
          name: entity-data
          run-id: ${{ needs.check-upstream.outputs.upstream-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Move downloaded files to correct locations
      - name: Setup Data Directories
        run: |
          mkdir -p data cache artifacts output
          [ -f merged.json ] && mv merged.json data/merged.json
          [ -f fni-history.json ] && mv fni-history.json cache/fni-history.json
          [ -f weekly-accum.json ] && mv weekly-accum.json cache/weekly-accum.json
          
          echo "ðŸ“‚ Data structure:"
          ls -la data/ || true
          ls -la cache/ || true

      # Restore entity checksums for incremental processing
      - name: Restore Entity Checksums
        uses: actions/cache@v4
        with:
          path: cache/entity-checksums.json
          key: entity-checksums-${{ github.run_id }}
          restore-keys: |
            entity-checksums-

      # Process shard
      - name: Process Shard ${{ matrix.shard }}
        env:
          ENTITIES_PATH: data/merged.json
          FNI_HISTORY_PATH: cache/fni-history.json
          ARTIFACT_DIR: artifacts
        run: |
          echo "ðŸ”„ Processing Shard ${{ matrix.shard }}/20..."
          node scripts/factory/shard-processor.js --shard=${{ matrix.shard }} --total=20

      # Upload shard artifact
      - name: Upload Shard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard }}
          path: |
            artifacts/shard-${{ matrix.shard }}.json
            output/
          retention-days: 1

  # Aggregate and save checksums
  finalize:
    name: Finalize Processing
    needs: [check-upstream, matrix-shards]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Download shard 0 for checksum data
      - name: Download Shard 0
        uses: actions/download-artifact@v4
        with:
          name: shard-0
          path: ./shard-0/
        continue-on-error: true

      # Save entity checksums for next run
      - name: Save Entity Checksums
        uses: actions/cache/save@v4
        with:
          path: cache/entity-checksums.json
          key: entity-checksums-${{ github.run_id }}

      # Trigger next stage (via workflow_run - automatic)
      - name: Notify Aggregate Stage
        run: |
          echo "âœ… Shard ${{ matrix.shard }} complete. Factory 3/4 - Aggregate will start automatically after all shards complete."

      - name: Summary
        run: |
          echo "## Factory 2/4 - Process Complete âš™ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Shards: 20 parallel" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: shard-0 to shard-19" >> $GITHUB_STEP_SUMMARY
          echo "- Next: Factory 3/4 - Aggregate" >> $GITHUB_STEP_SUMMARY
