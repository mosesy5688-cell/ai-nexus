# Factory 3/4 - Aggregate
# V14.5 Phase 4: Modular Factory Architecture
# 
# Triggers: workflow_run from Process, or manual dispatch
# Inputs: shard-* artifacts from Process stage
# Outputs: trending.json, search-*.json, sitemaps, rankings
# 
# Constitution: Art 3.1 (Aggregator), Art 5 (Weekly), Art 6.3 (Search)

name: Factory 3/4 - Aggregate

on:
  workflow_run:
    workflows: ["Factory 2/4 - Process"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of Process workflow to get shard artifacts from'
        required: false
        type: string

jobs:
  # V14.5.3: Identify upstream Harvest run for full data restoration
  check-upstream:
    name: Check Upstream Harvest
    runs-on: ubuntu-latest
    outputs:
      harvest-id: ${{ steps.get-ids.outputs.harvest-id }}
      process-id: ${{ steps.get-ids.outputs.process-id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Run IDs (Harvest & Process)
        id: get-ids
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Start with the Process Run ID (Triggering event or manual input)
          PROCESS_RUN_ID=${{ inputs.run_id || github.event.workflow_run.id }}
          
          # 2. If PROCESS_RUN_ID is missing, find the latest successful Process run on MAIN
          if [ -z "$PROCESS_RUN_ID" ] || [ "$PROCESS_RUN_ID" == "null" ]; then
            echo "ðŸ” Manual dispatch: Finding latest successful Process run on main branch..."
            PROCESS_RUN_ID=$(gh run list --workflow factory-process.yml --branch main --status success --limit 1 --json databaseId --jq '.[0].databaseId' | tr -d '[:space:]')
          fi
          
          # 3. Find the latest successful Harvest run on MAIN (The Production Source of Truth)
          HARVEST_RUN_ID=$(gh run list --workflow factory-harvest.yml --branch main --status success --limit 1 --json databaseId --jq '.[0].databaseId' | tr -d '[:space:]')
          
          echo "harvest-id=$HARVEST_RUN_ID" >> $GITHUB_OUTPUT
          echo "process-id=$PROCESS_RUN_ID" >> $GITHUB_OUTPUT
          echo "âœ… Resolved Harvest ID (Main): $HARVEST_RUN_ID"
          echo "âœ… Resolved Process ID (Main): $PROCESS_RUN_ID"

  # Job 1: Core Merge (The Pivot - SPEC V2.0)
  merge-core:
    name: Merge Core Registry
    needs: check-upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      NODE_OPTIONS: "--max-old-space-size=8192"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci

      - name: Download Shard Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*
          path: ./downloaded/
          merge-multiple: true
          run-id: ${{ needs.check-upstream.outputs.process-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Organize Shards
        run: |
          mkdir -p artifacts output data cache
          # Fail if no shards were found (unless this is a specialized light run)
          SHARD_COUNT=$(find ./downloaded -name "shard-*.json" | wc -l)
          if [ "$SHARD_COUNT" -eq 0 ] && [ "${{ github.event.inputs.task || 'all' }}" != "health" ]; then
            echo "âŒ ERROR: No shard artifacts found from Run ${{ needs.check-upstream.outputs.process-id }}"
            exit 1
          fi
          find ./downloaded -name "shard-*.json" -exec mv {} artifacts/ \; 2>/dev/null || true
          if [ -d "./downloaded/output" ]; then cp -r ./downloaded/output/* output/ 2>/dev/null || true; fi

      - name: Clear Stale Context (V16.8.6 Hardening)
        run: rm -rf data/*.json cache/*.json # Force restoration or failure

      - name: Restore Harvest Context (SPEC V14.5)
        uses: actions/cache/restore@v4
        with:
          path: |
            data/merged.json
            data/merged_shard_*.json
          key: factory-entity-data-${{ needs.check-upstream.outputs.harvest-id }}
          restore-keys: |
            factory-entity-data-

      - name: Restore Previous State (Golden Cache)
        uses: actions/cache/restore@v4
        with:
          path: cache/
          key: global-registry-v2-${{ needs.check-upstream.outputs.harvest-id }}
          restore-keys: |
            global-registry-v2-

      - name: Run Core Merge & Health
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
        run: |
            echo "ðŸ”„ Running Merge-Core (V2.0 Sharding)..."
            node scripts/factory/aggregator.js --task=health
            node scripts/factory/aggregator.js --task=core

      - name: Upload Registry Artifact (Intra-Run Delivery)
        uses: actions/upload-artifact@v4
        with:
          name: core-registry-v2
          path: |
            output/entities.json
            cache/registry/
          retention-days: 1

      - name: Save Updated Golden Cache (Next Cycle Prep)
        uses: actions/cache/save@v4
        with:
          path: cache/
          key: global-registry-v2-${{ github.run_id }}

  # Parallel Satellite Jobs (SPEC V2.0)
  aggregate-search:
    name: "Agg: Search Index"
    needs: merge-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Core Registry
        uses: actions/download-artifact@v4
        with: { name: core-registry-v2, path: ./ }
      - name: Generate Search Indices
        env:
          ENTITIES_PATH: output/entities.json
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
        run: |
          export NODE_OPTIONS="--max-old-space-size=6144"
          node scripts/factory/aggregator.js --task=search
      - name: Upload Search Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agg-search
          path: output/cache/search*
          retention-days: 1

  aggregate-rankings:
    name: "Agg: Rankings"
    needs: merge-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Core Registry
        uses: actions/download-artifact@v4
        with: { name: core-registry-v2, path: ./ }
      - name: Generate Rankings
        env:
          ENTITIES_PATH: output/entities.json
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
        run: |
          export NODE_OPTIONS="--max-old-space-size=6144"
          node scripts/factory/aggregator.js --task=rankings
          node scripts/factory/aggregator.js --task=category
      - name: Upload Rankings Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agg-rankings
          path: |
            output/rankings/
            output/cache/category_stats.json
          retention-days: 1

  aggregate-trending:
    name: "Agg: Trending"
    needs: merge-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Core Registry
        uses: actions/download-artifact@v4
        with: { name: core-registry-v2, path: ./ }
      - name: Generate Trending
        env:
          ENTITIES_PATH: output/entities.json
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
        run: node scripts/factory/aggregator.js --task=trending
      - name: Upload Trending Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agg-trending
          path: output/cache/trending.json
          retention-days: 1

  aggregate-relations:
    name: "Agg: Knowledge Mesh"
    needs: merge-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Core Registry
        uses: actions/download-artifact@v4
        with: { name: core-registry-v2, path: ./ }
      - name: Generate Relations
        env:
          ENTITIES_PATH: output/entities.json
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
        run: |
          export NODE_OPTIONS="--max-old-space-size=7168"
          node scripts/factory/aggregator.js --task=relations
      - name: Upload Relations Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agg-relations
          path: output/cache/relations.json
          retention-days: 1

  aggregate-sitemap:
    name: "Agg: Sitemap"
    needs: merge-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Restore Core Registry
        uses: actions/download-artifact@v4
        with: { name: core-registry-v2, path: ./ }
      - name: Generate Sitemaps
        env:
          ENTITIES_PATH: output/entities.json
        run: |
          export NODE_OPTIONS="--max-old-space-size=6144"
          node scripts/factory/aggregator.js --task=sitemap
      - name: Upload Sitemap Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agg-sitemap
          path: |
            output/sitemaps/
            output/sitemap.xml
          retention-days: 1

  finalize:
    name: Finalize Aggregation
    needs: [aggregate-search, aggregate-rankings, aggregate-trending, aggregate-relations, aggregate-sitemap]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Consolidate All Results
        uses: actions/download-artifact@v4
        with:
          pattern: agg-*
          path: output/
          merge-multiple: true
      - name: Run Health Consolidation
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
        run: node scripts/factory/consolidate-health.js
      - name: Save Global Output Cache (for Stage 4/4)
        uses: actions/cache/save@v4
        with:
          path: output/
          key: entity-data-${{ github.run_id }}
      - name: Summary
        run: |
          echo "## Factory 3/4 - Aggregator V2.0 Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "Scale: 1M+ Readiness Verified" >> $GITHUB_STEP_SUMMARY
          echo "Jobs: Parallel (Search, Rankings, Trending, Relations)" >> $GITHUB_STEP_SUMMARY
