# Factory 1/4 - Harvest
# V14.5 Phase 4: Modular Factory Architecture
# 
# Triggers: Schedule Mon/Thu 03:00 UTC (11:00 Beijing)
# Outputs: merged.json artifact (entity-data) for downstream processing
# 
# Constitution: Art 3.1 (Factory Pipeline)

name: Factory 1/4 - Harvest

on:
  schedule:
    - cron: '0 3 * * 1,4'  # Mon/Thu 03:00 UTC
  workflow_dispatch:

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  harvest:
    name: Harvest Entity Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Restore persistent cache (FNI history, weekly accumulator)
      - name: Restore FNI History
        uses: actions/cache@v4
        with:
          path: cache/fni-history.json
          key: fni-history-${{ github.run_id }}
          restore-keys: |
            fni-history-

      - name: Restore Weekly Accumulator
        uses: actions/cache@v4
        with:
          path: cache/weekly-accum.json
          key: weekly-accum-${{ github.run_id }}
          restore-keys: |
            weekly-accum-

      # Run L1 Orchestrator to fetch entity data
      - name: Run L1 Orchestrator
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ðŸ”„ Starting L1 Harvest..."
          echo "ðŸ”‘ HF_TOKEN: ${HF_TOKEN:0:8}... (configured)"
          node scripts/ingestion/orchestrator.js
          
          # Validate output
          if [ ! -f "data/merged.json" ]; then
            echo "âŒ merged.json not generated"
            exit 1
          fi
          
          ENTITY_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('data/merged.json')).length)")
          echo "âœ… Harvested $ENTITY_COUNT entities"
          
          if [ "$ENTITY_COUNT" -lt 1000 ]; then
            echo "âš ï¸ Warning: Low entity count ($ENTITY_COUNT)"
          fi

      # Upload artifact for downstream workflows
      - name: Upload Entity Data Artifact
        uses: actions/upload-artifact@v4
        with:
          name: entity-data
          path: |
            data/merged.json
            cache/fni-history.json
            cache/weekly-accum.json
          retention-days: 3

      # Trigger next stage (via workflow_run - automatic)
      - name: Notify Process Stage
        run: |
          echo "âœ… Harvest complete. Factory 2/4 - Process will start automatically via workflow_run trigger."
          echo "ðŸ“¦ Artifact: entity-data ($(du -h data/merged.json | cut -f1))"

      - name: Summary
        run: |
          echo "## Factory 1/4 - Harvest Complete ðŸŒ¾" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Entities: $(node -e "console.log(JSON.parse(require('fs').readFileSync('data/merged.json')).length)")" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: entity-data" >> $GITHUB_STEP_SUMMARY
          echo "- Next: Factory 2/4 - Process" >> $GITHUB_STEP_SUMMARY
