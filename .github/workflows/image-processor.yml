# Image Processor Workflow V14.5
# Constitution Reference: Art 3.4 (Image Processing), V14.5 Architecture
# 
# Runs after Factory to download, convert (WebP), and upload entity images to R2

name: Image Processor V14.5

on:
  # Trigger after Factory Aggregate completes (To use GitHub Cache)
  workflow_run:
    workflows: ["Factory 3/4 - Aggregate"]
    types: [completed]
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of images to process per run'
        type: number
        default: 2000
      run_id:
        description: 'Aggregate run ID to restore cache from (Manual only)'
        type: string
        required: false

env:
  R2_BUCKET: ai-nexus-assets
  R2_ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

jobs:
  # V16.7: Identify upstream Aggregate run for reliable cache restoration
  check-upstream:
    name: Check Upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      upstream-run-id: ${{ steps.get-id.outputs.id }}
    steps:
      - name: Get ID
        id: get-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.run_id }}" ]; then
            echo "id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
          else
            # 3.5/4 LINKER and Image Processor are both triggered by 3/4 Aggregate.
            # We must resolve the parent Aggregate run ID to restore the correct cache.
            ID=${{ github.event.workflow_run.id }}
            echo "id=$ID" >> $GITHUB_OUTPUT
            echo "âœ… Targeting Parent Run: $ID"
          fi

  process-images:
    name: Process Entity Images
    needs: check-upstream
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tools/rust-img-optimizer/target/
          key: rust-img-${{ hashFiles('tools/rust-img-optimizer/Cargo.lock') }}

      - name: Build Rust Optimizer
        working-directory: tools/rust-img-optimizer
        run: cargo build --release

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # V16.7: Correct identity restoration using Resolved Upstream ID
      - name: Restore Registry from GitHub Cache
        uses: actions/cache/restore@v4
        with:
          path: output/
          key: entity-data-${{ needs.check-upstream.outputs.upstream-run-id }}
          restore-keys: |
            entity-data-

      # V16.4.1: Fetch Global Entity Registry (Cache Priority)
      - name: Fetch Global Entity Registry
        run: |
          mkdir -p data/images
          
          # Check if registry exists in cache
          if [ -d "output/meta/backup" ]; then
            echo "âœ… Verified: Registry backup exists in GitHub Cache. Using it."
            node scripts/factory/prepare-image-queue.js output/meta/backup ${{ inputs.batch_size || 2000 }}
          else
            echo "âš ï¸ Cache miss: Registry not found in output/meta/backup/. Falling back to R2..."
            mkdir -p data
            npx -y wrangler r2 object get $R2_BUCKET/meta/backup/global-registry.json --file=data/global-registry.json --remote
            node scripts/factory/prepare-image-queue.js data ${{ inputs.batch_size || 2000 }}
          fi

      - name: Download and Convert Images
        run: |
          echo "ðŸ–¼ï¸ Processing images..."
          node scripts/factory/download-images.js

      - name: Convert to WebP (Rust)
        working-directory: tools/rust-img-optimizer
        run: |
          echo "ðŸ”„ Converting to WebP..."
          mkdir -p ../../output/images
          find ../../data/images -name "*.jpg" | while read img; do
            type_dir=$(basename $(dirname "$img"))
            mkdir -p "../../output/images/$type_dir"
            base_name=$(basename "$img" .jpg)
            ./target/release/rust-img-optimizer convert --input "$img" --output "../../output/images/$type_dir/${base_name}.webp" --format webp --quality 75 --max-width 640 2>/dev/null || true
          done

      # V16.7: Standardized R2 Upload (WebP Only Policy)
      - name: Upload Images to R2 (S3 API)
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ai-nexus-assets
          R2_PREFIX_FILTER: images/
        run: |
          echo "ðŸ“¤ Uploading WebP images to R2..."
          node scripts/factory/r2-upload-s3.js

      - name: Update Global Registry (Progressive Drain)
        run: |
          echo "ðŸ“ Updating registry with CDN URLs..."
          # Move output/images to data/images locally for the processor to see them as 'processed'
          cp -r output/images/* data/images/
          node scripts/factory/lib/image-post-processor.js data/registry.json data/image-results.json
          
          # Sync back to output for persistence
          cp data/registry.json output/meta/backup/global-registry.json
          
      - name: Persist Updated Registry to GitHub Cache
        uses: actions/cache/save@v4
        with:
          path: output/
          key: entity-data-${{ needs.check-upstream.outputs.upstream-run-id }}-img

      - name: Summary
        run: |
          echo "## ðŸ–¼ï¸ Image Processor Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/image-results.json" ]; then
            cat data/image-results.json >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          WEBP_COUNT=$(find output/images -name "*.webp" | wc -l)
          echo "- WebP images created/uploaded: $WEBP_COUNT" >> $GITHUB_STEP_SUMMARY
