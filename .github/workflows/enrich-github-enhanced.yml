name: GitHub Data Enrichment (Enhanced)

on:
  schedule:
    - cron: '0 3 * * 1'  # Every Monday at 3 AM UTC
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of models to process (leave empty for all)'
        required: false
        default: '50'
      dry_run:
        description: 'Dry run mode (true/false)'
        required: false
        default: 'false'

jobs:
  enrich-github:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check enrichment need
        id: check
        run: |
          # This will be handled by the script itself (smart skip)
          echo "ready=true" >> $GITHUB_OUTPUT
      
      - name: Run enrichment
        id: enrich
        if: steps.check.outputs.ready == 'true'
        run: |
          LIMIT_ARG=""
          if [ -n "${{ inputs.limit }}" ]; then
            LIMIT_ARG="--limit=${{ inputs.limit }}"
          fi
          
          DRY_RUN_ARG=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_ARG="--dry-run"
          fi
          
          node scripts/enrich-github-enhanced.js --remote $LIMIT_ARG $DRY_RUN_ARG 2>&1 | tee enrichment.log
          
          # Extract metrics for summary
          SUCCESS=$(grep "âœ… Successful:" enrichment.log | awk '{print $3}' || echo "0")
          FAILED=$(grep "âŒ Failed:" enrichment.log | awk '{print $3}' || echo "0")
          SKIPPED=$(grep "â­ï¸  Skipped:" enrichment.log | awk '{print $3}' || echo "0")
          TOTAL=$(grep "ðŸ“ Total Processed:" enrichment.log | awk '{print $4}' || echo "0")
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Generate summary
        if: always() && steps.enrich.outcome != 'skipped'
        run: |
          {
            echo "## ðŸ“Š GitHub Enrichment Summary"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| âœ… Successful | ${{ steps.enrich.outputs.success }} |"
            echo "| âŒ Failed | ${{ steps.enrich.outputs.failed }} |"
            echo "| â­ï¸  Skipped | ${{ steps.enrich.outputs.skipped }} |"
            echo "| ðŸ“ Total | ${{ steps.enrich.outputs.total }} |"
            echo ""
            echo "**Triggered by**: ${{ github.event_name }}"
            echo "**Run ID**: ${{ github.run_id }}"
            echo "**Status**: ${{ job.status }}"
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Upload enrichment log
        if: always() && steps.enrich.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: enrichment-log
          path: enrichment.log
          retention-days: 30
      
      - name: Create issue on failure
        if: failure() && steps.enrich.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = '[Auto] GitHub Enrichment Failed';
            const body = `## ðŸš¨ Enrichment Workflow Failed
            
            **Run ID**: ${{ github.run_id }}
            **Time**: ${new Date().toISOString()}
            
            ### Metrics
            - Successful: ${{ steps.enrich.outputs.success || '0' }}
            - Failed: ${{ steps.enrich.outputs.failed || 'N/A' }}
            - Total: ${{ steps.enrich.outputs.total || '0' }}
            
            **Action Required**: Check workflow logs for details.
            
            [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,enrichment-failure'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', 'enrichment-failure', 'bug']
              });
            }
