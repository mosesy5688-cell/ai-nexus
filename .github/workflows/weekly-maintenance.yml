name: Weekly Maintenance

on:
  schedule:
    - cron: '0 4 * * 0' # Weekly on Sunday at 04:00 UTC
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Install Wrangler CLI globally
      - name: Install Wrangler
        run: npm install -g wrangler@3.8.0

      # Step 4: Create D1 backup (Core Step)
      - name: Create D1 backup
        run: |
          echo "Creating D1 backup for ai-nexus-db..."
          
          # Attempt to use --json flag for cleaner parsing
          if BACKUP_JSON=$(wrangler d1 backup create ai-nexus-db --json 2>/dev/null); then
             echo "✅ Backup created successfully (JSON output)"
             BACKUP_ID=$(echo "$BACKUP_JSON" | jq -r '.id')
          else
             echo "⚠️  JSON output failed, falling back to text parsing..."
             BACKUP_OUTPUT=$(wrangler d1 backup create ai-nexus-db 2>&1)
             echo "$BACKUP_OUTPUT"
             BACKUP_ID=$(echo "$BACKUP_OUTPUT" | grep -oP '(?<=ID:\s)[a-zA-Z0-9-]+' || echo "unknown")
          fi
          
          echo "Backup ID: $BACKUP_ID"
          
          # Create backup info file
          echo "D1 Backup Information" > ./backup.txt
          echo "=====================" >> ./backup.txt
          echo "Database: ai-nexus-db" >> ./backup.txt
          echo "Backup ID: $BACKUP_ID" >> ./backup.txt
          echo "Created at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ./backup.txt
          
          echo "✅ Backup info saved to backup.txt"
          cat ./backup.txt
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Step 5: Verify backup.txt
      - name: Verify backup file
        run: |
          if [ -f "./backup.txt" ]; then
            echo "✅ Backup file exists"
          else
            echo "❌ Error: backup.txt not found!"
            exit 1
          fi

      # Step 6: Upload backup info as artifact
      - name: Upload D1 backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: d1-backup
          path: ./backup.txt
          retention-days: 30
