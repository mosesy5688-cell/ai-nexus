name: Weekly Maintenance

on:
  schedule:
    - cron: '0 4 * * 0' # 每周日凌晨4点运行
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm install -g wrangler@3.8.0

      - name: Create D1 backup
        run: |
          echo "Creating D1 backup..."
          BACKUP_ID=$(wrangler d1 backup create ai-nexus-db --json | jq -r '.id')
          echo "Backup created with ID: $BACKUP_ID"
          echo "Backup ID: $BACKUP_ID" > ./backup.txt
          echo "Created at: $(date)" >> ./backup.txt
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Upload D1 backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: d1-backup
          path: ./backup.txt
          retention-days: 30
