# L5 Sitemap Generator Workflow
# V6.1 Constitution Compliant - Sidecar handles CPU-intensive sitemap generation
#
# Schedule: Daily at 2:00 AM UTC (after FNI computation)
# Ref: SPEC_SITEMAP_V6.1.md, MASTER_EXECUTION_PLAN_V6.2.md

name: L5 Sitemap Generator

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  generate-sitemaps:
    name: Generate Sitemaps
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install boto3

      - name: Generate Sitemaps
        env:
          R2_ENDPOINT: ${{ vars.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ vars.R2_BUCKET || 'ai-nexus-assets' }}
        run: |
          python scripts/sidecar/l5_sitemap_gen.py

      - name: Verify Sitemap Index
        env:
          R2_ENDPOINT: ${{ vars.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ vars.R2_BUCKET || 'ai-nexus-assets' }}
        run: |
          # Verify sitemap-index.xml was created
          python -c "
          import boto3
          import os
          from botocore.config import Config
          
          client = boto3.client(
              's3',
              endpoint_url=os.environ['R2_ENDPOINT'],
              aws_access_key_id=os.environ['R2_ACCESS_KEY_ID'],
              aws_secret_access_key=os.environ['R2_SECRET_ACCESS_KEY'],
              config=Config(signature_version='s3v4'),
          )
          
          response = client.head_object(
              Bucket=os.environ['R2_BUCKET'],
              Key='sitemaps/sitemap-index.xml'
          )
          print(f'‚úÖ sitemap-index.xml exists ({response[\"ContentLength\"]} bytes)')
          "

      - name: Report Status
        if: always()
        run: |
          echo "üó∫Ô∏è Sitemap generation completed at $(date -u)"
          echo "Next run: tomorrow at 2:00 AM UTC"
