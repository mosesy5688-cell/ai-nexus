name: Weekly Database Backup

on:
  schedule:
    - cron: '0 3 * * 0'  # Every Sunday at 3 AM UTC (11 AM Beijing Time)
  workflow_dispatch:     # Manual trigger support

jobs:
  backup-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      
      - name: Create D1 Backup
        id: backup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üîÑ Creating D1 backup..."
          
          # Create backup and capture output
          BACKUP_OUTPUT=$(wrangler d1 backup create ai-nexus-db --remote 2>&1)
          echo "$BACKUP_OUTPUT"
          
          # Extract backup ID (handle both JSON and text output)
          BACKUP_ID=$(echo "$BACKUP_OUTPUT" | grep -oP 'backup-[a-f0-9\-]+' | head -1 || echo "")
          
          if [ -z "$BACKUP_ID" ]; then
            echo "‚ùå Failed to extract backup ID"
            echo "$BACKUP_OUTPUT"
            exit 1
          fi
          
          echo "BACKUP_ID=$BACKUP_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Backup created: $BACKUP_ID"
          
          # Save backup metadata
          mkdir -p backups
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "$BACKUP_ID" > "backups/backup-$TIMESTAMP.txt"
          echo "Backup created at: $(date -u)" >> "backups/backup-$TIMESTAMP.txt"
          echo "Workflow run: ${{ github.run_id }}" >> "backups/backup-$TIMESTAMP.txt"
      
      - name: Verify Backup Exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üîç Verifying backup..."
          BACKUP_ID="${{ steps.backup.outputs.BACKUP_ID }}"
          
          # List backups and check if our backup exists
          BACKUP_LIST=$(wrangler d1 backup list ai-nexus-db --remote 2>&1)
          
          if echo "$BACKUP_LIST" | grep -q "$BACKUP_ID"; then
            echo "‚úÖ Backup verified: $BACKUP_ID exists in backup list"
          else
            echo "‚ùå Backup verification failed"
            echo "Backup list:"
            echo "$BACKUP_LIST"
            exit 1
          fi
      
      - name: Upload Backup Metadata
        uses: actions/upload-artifact@v4
        with:
          name: backup-metadata-${{ github.run_number }}
          path: backups/
          retention-days: 90
      
      - name: Notify Success (Slack)
        if: success() && vars.SLACK_WEBHOOK_URL != ''
        run: |
          BACKUP_ID="${{ steps.backup.outputs.BACKUP_ID }}"
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚úÖ Database Backup Successful\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Database Backup Completed*\n\n‚Ä¢ Backup ID: \`$BACKUP_ID\`\n‚Ä¢ Time: $(date -u)\n‚Ä¢ Workflow: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
                  }
                }
              ]
            }"
      
      - name: Notify Failure (Slack)
        if: failure() && vars.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"üö® Database Backup FAILED\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Database Backup Failed*\n\n‚Ä¢ Time: $(date -u)\n‚Ä¢ Workflow: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\n‚Ä¢ Please check logs immediately!\"
                  }
                }
              ]
            }"
      
      - name: Summary
        if: always()
        run: |
          echo "## üìä Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup ID**: ${{ steps.backup.outputs.BACKUP_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
