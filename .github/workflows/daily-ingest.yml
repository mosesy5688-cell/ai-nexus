name: Daily Ingest

on:
  schedule:
    - cron: '0 3 * * *' # Daily at 03:00 UTC
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Install Dependencies (Node & Rust)
      - name: Install Dependencies
        run: |
          npm ci
          # Rust is pre-installed on ubuntu-latest

      # Step 4: Fetch Metadata (Core Step)
      - name: Fetch Metadata
        run: |
          echo "Fetching metadata..."
          node scripts/fetch-metadata.js
          echo "✅ Metadata fetched"
        env:
          CF_PROXY_URL: ${{ secrets.CF_PROXY_URL }}

      # Step 5: Process Data with Rust (Core Step)
      - name: Process Data (Rust)
        run: |
          echo "Building and running Rust optimizer..."
          cd tools/rust-img-optimizer
          cargo run --release -- --input ../../data/raw.json --upload
          echo "✅ Data processed and upsert.sql generated"
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: "ai-nexus-assets"

      # Step 6: Install Wrangler CLI globally
      - name: Install Wrangler
        run: npm install -g wrangler@3.8.0

      # Step 7: Ensure last_updated column exists
      - name: Ensure last_updated column exists
        run: |
          echo "Checking if last_updated column exists..."
          wrangler d1 execute ai-nexus-db --command "ALTER TABLE models ADD COLUMN last_updated TEXT;" 2>&1 | tee column_result.txt || true
          if grep -q "duplicate column" column_result.txt; then
            echo "✅ Column 'last_updated' already exists"
          else
            echo "✅ Column 'last_updated' check completed"
          fi
          rm -f column_result.txt
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Step 8: Execute upsert SQL
      - name: Execute upsert SQL
        run: |
          if [ ! -f "./data/upsert.sql" ]; then
            echo "❌ Error: ./data/upsert.sql not found!"
            exit 1
          fi
          echo "Executing upsert.sql..."
          wrangler d1 execute ai-nexus-db --file=./data/upsert.sql
          echo "✅ Upsert completed successfully"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Step 9: Run link checker
      - name: Check active links
        run: |
          echo "Running link checker..."
          node scripts/check-links.cjs
          echo "✅ Link check completed"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Step 10: Upload artifacts
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingest-logs
          path: |
            data/raw.json
            data/upsert.sql
            data/active_links.json
