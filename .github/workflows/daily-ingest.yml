name: Daily Ingest

on:
  schedule:
    - cron: '0 3 * * *' # Daily at 03:00 UTC
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Install Dependencies (Node & Rust)
      - name: Install Dependencies
        run: |
          npm ci
          # Rust is pre-installed on ubuntu-latest

      # Step 4: Fetch Metadata (Multi-Source)
      # Step 4: Fetch Metadata (Multi-Source)
      - name: Fetch Model Metadata
        env:
          CF_PROXY_URL: ${{ secrets.CF_PROXY_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/run-collectors.js

      # Step 5: Process Raw Data (Loop 1.5)
      - name: Process Raw Data (Loop 1.5)
        run: node scripts/process-raw-data.js

      # Step 6: Process Data with Rust (Core Step)
      - name: Process Data (Rust)
        run: |
          echo "Building and running Rust optimizer..."
          (cd tools/rust-img-optimizer && cargo run --release -- --input ../../data/merged.json) > data/upsert.sql
          echo "‚úÖ Data processed and upsert.sql generated"
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: "ai-nexus-assets"
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_PUBLIC_URL_PREFIX: "https://cdn.free2aitools.com"
      
      # QUALITY GATE: Verify SQL contains image URLs
      - name: Validate SQL Output (Quality Gate)
        run: |
          echo "üîç Validating upsert.sql quality..."
          
          # Check file exists and has content
          if [ ! -s data/upsert.sql ]; then
            echo "‚ùå FATAL: upsert.sql is missing or empty!"
            exit 1
          fi
          
          # Check for cover_image_url field
          if ! grep -q "cover_image_url" data/upsert.sql; then
            echo "‚ùå FATAL: SQL does not contain 'cover_image_url' field!"
            echo "üìÑ SQL Content:"
            cat data/upsert.sql
            exit 1
          fi
          
          # Check for actual image URLs (not NULL)
          if ! grep -q "https://cdn.free2aitools.com" data/upsert.sql; then
            echo "‚ùå FATAL: SQL does not contain valid image URLs (https://cdn.free2aitools.com)!"
            echo "üìÑ SQL Content (first 100 lines):"
            head -n 100 data/upsert.sql
            echo "..."
            echo "üìä Statistics:"
            echo "  Total lines: $(wc -l < data/upsert.sql)"
            echo "  Lines with cover_image_url: $(grep -c 'cover_image_url' data/upsert.sql || echo 0)"
            echo "  Lines with NULL: $(grep -c "'NULL'" data/upsert.sql || echo 0)"
            exit 1
          fi
          
          echo "‚úÖ Quality Gate PASSED: SQL contains valid image URLs"
          echo "üìä SQL Quality Metrics:"
          echo "  Total INSERT statements: $(grep -c 'INSERT OR REPLACE' data/upsert.sql || echo 0)"
          echo "  With image URLs: $(grep -c 'https://cdn.free2aitools.com' data/upsert.sql || echo 0)"
        
      - name: Execute D1 Updates
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN slug TEXT;" || true
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN last_updated TEXT;" || true
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN is_rising_star INTEGER;" || true
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN related_ids TEXT;" || true
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN popularity_score REAL;" || true
          npx wrangler d1 execute ai-nexus-db --remote --file=./data/upsert.sql



      # Step 7: Upload artifacts
      - name: Upload ingest artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingest-logs
          path: |
            data/raw.json
            data/merged.json
            data/upsert.sql
