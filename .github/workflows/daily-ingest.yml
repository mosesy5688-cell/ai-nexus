name: Daily Ingest

on:
  schedule:
    - cron: '0 3 * * *' # Daily at 03:00 UTC
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Install Dependencies (Node & Rust)
      - name: Install Dependencies
        run: |
          npm ci
          # Rust is pre-installed on ubuntu-latest

      # Step 4: Fetch Metadata (Multi-Source)
      - name: Fetch Model Metadata
        env:
          CF_PROXY_URL: ${{ secrets.CF_PROXY_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/run-collectors.js

      # Step 5: Process Data with Rust (Core Step)
      - name: Process Data (Rust)
        run: |
          echo "Building and running Rust optimizer..."
          cd tools/rust-img-optimizer
          cargo run --release -- --input ../../data/raw.json --upload
          echo "âœ… Data processed and upsert.sql generated"
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: "ai-nexus-assets"

      # Step 6: Deploy to D1 using npx wrangler
      - name: Execute D1 Updates
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN slug TEXT;" || true
          npx wrangler d1 execute ai-nexus-db --remote --command "ALTER TABLE models ADD COLUMN last_updated TEXT;" || true
          npx wrangler d1 execute ai-nexus-db --remote --file=./data/upsert.sql



      # Step 7: Upload artifacts
      - name: Upload ingest artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingest-logs
          path: |
            data/raw.json
            data/upsert.sql
