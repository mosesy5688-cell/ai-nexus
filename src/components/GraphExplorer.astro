---
// src/components/GraphExplorer.astro
const { modelId } = Astro.props;
---

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 my-8" id="graph-explorer">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <span class="text-2xl">üï∏Ô∏è</span> Neural Network Explorer
        </h3>
        <div class="flex gap-2 text-xs">
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Model</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span> Paper</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span> Benchmark</span>
        </div>
    </div>
    
    <div id="graph-container" data-model-id={modelId} class="w-full h-[500px] bg-gray-50 dark:bg-gray-900 rounded-lg overflow-hidden relative cursor-move border border-gray-100 dark:border-gray-800">
        <div id="graph-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-gray-800/80 z-10 transition-opacity duration-300">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
                <p class="mt-2 text-gray-500 text-sm">Mapping neural connections...</p>
            </div>
        </div>
        <svg id="d3-graph" class="w-full h-full"></svg>
    </div>
</div>

<script type="module">
    // Import D3 from CDN to avoid heavy bundle (or use local if installed)
    // We use ES modules from d3-cdn for browser compatibility
    import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

    const container = document.getElementById('graph-container');
    if (!container) console.warn('[GraphExplorer] Container not found');
    
    const modelId = container?.dataset?.modelId; // Read from DOM
    if (!modelId) console.error('[GraphExplorer] modelId not found in dataset');
    
    // Continue only if we have everything
    if (container && modelId) {
        const svg = d3.select("#d3-graph");
        const loading = document.getElementById('graph-loading');

    
    // Config
    let width = container.clientWidth;
    let height = container.clientHeight;
    
    // Resize handler
    window.addEventListener('resize', () => {
        width = container.clientWidth;
        height = container.clientHeight;
        svg.attr("width", width).attr("height", height);
        simulation.force("center", d3.forceCenter(width / 2, height / 2));
        simulation.alpha(0.3).restart();
    });

    // Fetch Data
    async function loadGraphData() {
        try {
            console.log(`[Graph] Loading for ${modelId}`);
            const response = await fetch(`/api/graph/neighbors.json?id=${encodeURIComponent(modelId)}`);
            
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API Error ${response.status}: ${errText.substring(0, 100)}`);
            }
            
            const data = await response.json();
            
            // Handle empty data case
            if (!data.nodes || data.nodes.length === 0) {
                loading.innerHTML = '<p class="text-gray-500">No relationships mapped yet.</p>';
                loading.style.display = 'flex'; // Ensure visible
                return;
            }

            renderGraph(data);
            loading.style.opacity = '0';
            setTimeout(() => loading.style.display = 'none', 300);
        } catch (error) {
            console.error("[Graph Error]", error);
            loading.innerHTML = `<div class="text-center p-4"><p class="text-red-500 font-bold">Failed to load graph</p><p class="text-xs text-red-400 mt-1">${error.message}</p></div>`;
            loading.style.display = 'flex';
        }
    }

    // Force Simulation
    const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide(30));

    function renderGraph(data) {
        // Clear previous
        svg.selectAll("*").remove();

        const g = svg.append("g");

        // Zoom capability
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });
        svg.call(zoom);

        // Links
        const link = g.append("g")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
            .selectAll("line")
            .data(data.links)
            .join("line")
            .attr("stroke-width", d => Math.sqrt(d.value || 1));

        // Nodes
        const node = g.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
            .selectAll("circle")
            .data(data.nodes)
            .join("circle")
            .attr("r", d => d.id === modelId ? 12 : 8)
            .attr("fill", d => getNodeColor(d.group))
            .call(drag(simulation));

        // Labels
        const labels = g.append("g")
            .attr("class", "labels")
            .selectAll("text")
            .data(data.nodes)
            .join("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(d => d.name)
            .attr("fill", "currentColor")
            .attr("class", "text-xs font-medium dark:fill-white fill-gray-900 pointer-events-none");

        // Tooltip
        node.append("title")
            .text(d => `${d.name} (${d.group})`);

        // Click Event
        node.on("click", (event, d) => {
            if (d.group === 'model' && d.id !== modelId) {
                // Determine URL based on ID format (assuming 'author/name')
                // Simple slugify or use provided URL if available in data
                window.location.href = `/model/${d.id.replace(/\//g, '--')}`;
            } else if (d.url) {
                window.open(d.url, '_blank');
            }
        });

        // Simulation Tick
        simulation
            .nodes(data.nodes)
            .on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                
                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

        simulation.force("link").links(data.links);
    }

    function getNodeColor(group) {
        switch(group) {
            case 'main': return '#EF4444'; // Red (Current)
            case 'model': return '#3B82F6'; // Blue
            case 'paper': return '#8B5CF6'; // Purple
            case 'benchmark': return '#10B981'; // Green
            default: return '#6B7280';
        }
    }

    // Drag behavior
    function drag(simulation) {
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }

    // Load
    loadGraphData();
    } // End if (container && modelId)
</script>
