---
// src/components/ModelHero.astro
// Priority ðŸ¥‡: Hero Section with Prominent CTAs
// Constraints: SSR only, no client JS, string safety enforced

interface Props {
  name: string;
  description?: string;
  author: string;
  likes: number;
  downloads: number;
  pipelineTag?: string;
  linksData?: string; // JSON string: {source_url, docs_url, demo_url}
  lastUpdated?: string; // ISO 8601 date string
  license?: string;
}

const { 
  name, 
  description = '', 
  author, 
  likes, 
  downloads, 
  pipelineTag = '',
  linksData = '{}',
  lastUpdated,
  license
} = Astro.props;

import { formatMetric, formatRelativeTime } from '../utils/formatters';

// Parse links data with defensive checks
let links = { source_url: '', docs_url: '', demo_url: '' };
try {
  if (linksData && typeof linksData === 'string') {
    const parsed = JSON.parse(linksData);
    if (parsed && typeof parsed === 'object') {
      links = {
        source_url: parsed.source_url || '',
        docs_url: parsed.docs_url || '',
        demo_url: parsed.demo_url || ''
      };
    }
  }
} catch (e) {
  console.warn('Failed to parse links_data:', e);
}



// Determine if model is "popular" (>500K likes or downloads)
const isPopular = likes > 500000 || downloads > 500000;

// Determine if author is "verified" (Mock logic for now, can be expanded)
const verifiedAuthors = ['meta-llama', 'google', 'microsoft', 'mistralai', 'openai'];
const safeAuthor = author || '';
const isVerified = verifiedAuthors.some(v => safeAuthor.toLowerCase().includes(v));

// Extract first line of description as tagline
const tagline = description 
  ? description.split('\n')[0].substring(0, 120) 
  : `AI model by ${author}`;

// Generate initials for fallback icon
const initials = name
  .split(/[-_\/]/)
  .slice(0, 2)
  .map(word => word[0]?.toUpperCase() || '')
  .join('');
---

<div class="model-hero bg-white dark:bg-gray-800 rounded-xl p-8 mb-8 shadow-md border border-gray-200 dark:border-gray-700">
  <div class="flex flex-col md:flex-row gap-6 items-start">
    
    <!-- Icon/Avatar -->
    <div class="flex-shrink-0">
      <div class="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-md">
        {initials}
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <!-- Title Row with Badges -->
      <div class="flex flex-wrap items-center gap-3 mb-2">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white leading-tight">
          {name}
        </h1>
        
        {isPopular && (
          <span class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-1 rounded-full" title="Over 500k interactions">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            Popular
          </span>
        )}

        {isVerified && (
          <span class="inline-flex items-center gap-1 bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full" title="Verified Author">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
               <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            Verified
          </span>
        )}
      </div>

      <!-- Tagline -->
      <p class="text-lg text-gray-600 dark:text-gray-300 mb-4 leading-relaxed">
        {tagline}
      </p>

      <!-- CTAs Row -->
      <div class="flex flex-wrap gap-3 mb-6">
        {links.source_url && (
          <a 
            href={links.source_url} 
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            View Model
          </a>
        )}
        
        {links.docs_url && (
          <a 
            href={links.docs_url}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 bg-white hover:bg-gray-50 text-blue-600 font-semibold px-6 py-3 rounded-lg border-2 border-blue-600 transition-all duration-200 shadow-sm hover:shadow-md"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            Documentation
          </a>
        )}

        {/* Social Share Button */}
        <button 
          type="button"
          class="inline-flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 font-semibold px-4 py-3 rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md"
          onclick={`
            if (navigator.share) {
              navigator.share({
                title: '${name} - AI Nexus',
                text: 'Check out this AI model on AI Nexus!',
                url: window.location.href,
              }).catch(console.error);
            } else {
              // Fallback: Copy to clipboard
              navigator.clipboard.writeText(window.location.href);
              alert('Link copied to clipboard!');
            }
          `}
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
          Share
        </button>

        {/* Star Button (Placeholder) */}
        <button 
          type="button"
          class="inline-flex items-center gap-2 bg-white hover:bg-gray-50 text-yellow-600 font-semibold px-4 py-3 rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md"
          onclick="alert('Starring feature coming soon with User Accounts!')"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
          Star
        </button>
      </div>

      <!-- Metadata Pills (Quick Stats) -->
      <div class="flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400 items-center">
        <span class="inline-flex items-center gap-1.5" title="Author">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
          </svg>
          {author}
        </span>
        
        <span class="inline-flex items-center gap-1.5" title="Likes">
          <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
          </svg>
          <strong class="text-gray-900 dark:text-white">{formatMetric(likes)}</strong>
        </span>
        
        <span class="inline-flex items-center gap-1.5" title="Downloads">
          <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
          <strong class="text-gray-900 dark:text-white">{formatMetric(downloads)}</strong>
        </span>

        {lastUpdated && (
          <span class="inline-flex items-center gap-1.5" title={`Updated on ${lastUpdated}`}>
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Updated {formatRelativeTime(lastUpdated)}</span>
          </span>
        )}

        {license && (
          <span class="inline-flex items-center gap-1.5" title="License">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
            </svg>
            <span>{license}</span>
          </span>
        )}

        {pipelineTag && (
          <span class="inline-flex items-center gap-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2.5 py-0.5 rounded-full text-xs font-medium">
            {pipelineTag}
          </span>
        )}
      </div>
    </div>
  </div>
</div>

<style>
  /* Micro-animations for CTAs */
  .model-hero a {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Dark mode support for gradient */
  @media (prefers-color-scheme: dark) {
    .model-hero {
      background: linear-gradient(to bottom right, #1f2937, #111827);
    }
  }
</style>
