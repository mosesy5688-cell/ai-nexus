---
/**
 * CiteEntity.astro - V16.12 (Professional Safe Version)
 * V16.12: Flattened attributes and pre-calculated variables for build stability.
 * Compliance: Zero-Limit R2 architecture. No D1/KV.
 */
interface Props {
  id: string;
  name: string;
  author?: string;
  url?: string;
  type?: string;
  className?: string;
}

const { id = '', name, author = 'Free2AITools Contributors', url, type = 'model', className = '' } = Astro.props;
const currentYear = new Date().getFullYear();

const safeType = type || 'model';
const safeId = id || 'entity';

const bibtex = `@misc{${safeId.replace(/-/g, '_')},
  author = {${author}},
  title = {${name} ${safeType.charAt(0).toUpperCase() + safeType.slice(1)}},
  year = {${currentYear}},
  howpublished = {\\url{${url || `https://free2aitools.com/${safeType}/${safeId}`}}},
  note = {Accessed via Free2AITools Knowledge Fortress}
}`;

const apa = `${author}. (${currentYear}). ${name} [${safeType.charAt(0).toUpperCase() + safeType.slice(1)}]. Free2AITools. ${url || `https://free2aitools.com/${safeType}/${safeId}`}`;

const encodedBibtex = encodeURIComponent(bibtex);
const encodedApa = encodeURIComponent(apa);

// V16.12: Pre-calculate classes to avoid template complexity
const containerClass = `cite-entity bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-6 border border-gray-100 dark:border-gray-800 ${className}`;
const copyBtnClass = "cite-copy-btn text-[9px] font-black text-indigo-500 hover:text-indigo-400 uppercase tracking-widest transition-colors";
const codeBoxClass = "p-3 bg-white dark:bg-black/40 border border-gray-100 dark:border-gray-800 rounded-lg text-[10px] text-gray-600 dark:text-gray-400 font-mono overflow-x-auto whitespace-pre-wrap";
---

<div class={containerClass}>
  <div class="flex items-center gap-3 mb-6">
    <div class="p-2 bg-rose-500 rounded-lg shadow-lg shadow-rose-500/20">
      <span class="text-white">ðŸ“œ</span>
    </div>
    <div>
      <h3 class="text-sm font-black text-gray-900 dark:text-white uppercase tracking-widest">Cite this {type}</h3>
      <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">Academic & Research Attribution</p>
    </div>
  </div>

  <div class="space-y-4">
    <div class="space-y-2">
      <div class="flex items-center justify-between">
        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">BibTeX</span>
        <button class={copyBtnClass} data-copy={encodedBibtex}>Copy Snippet</button>
      </div>
      <pre class={codeBoxClass}><code set:text={bibtex}></code></pre>
    </div>

    <div class="space-y-2">
      <div class="flex items-center justify-between">
        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">APA Style</span>
        <button class={copyBtnClass} data-copy={encodedApa}>Copy Snippet</button>
      </div>
      <div class={`${codeBoxClass} italic`} set:text={apa}></div>
    </div>
  </div>
</div>

<script>
  function initCiteCopy() {
    document.querySelectorAll('.cite-copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const encoded = (btn as HTMLElement).dataset.copy || '';
        const text = decodeURIComponent(encoded);
        try {
          await navigator.clipboard.writeText(text);
          const original = btn.textContent;
          btn.textContent = 'âœ“ Copied';
          btn.classList.add('text-green-500');
          setTimeout(() => {
            btn.textContent = original;
            btn.classList.remove('text-green-500');
          }, 2000);
        } catch (e) {}
      });
    });
  }
  initCiteCopy();
  document.addEventListener('astro:after-swap', initCiteCopy);
</script>
