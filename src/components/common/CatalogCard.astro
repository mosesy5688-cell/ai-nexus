---
// src/components/common/CatalogCard.astro
// Refined Professional SSR Card for Entity Catalogs
// V17.4: Zero-Entropy Compliant (Clean Tech)

import { generateEntityUrl } from '../../utils/url-utils.js';
import { extractAuthor, getSourceMetadata, isActive as isRecentlyActive } from '../../utils/entity-utils.js';

const { item, type = 'model', isRisingStar = false } = Astro.props;

// Normalization Logic for SSR - V19.5 Fixed
const id = item.id || item.slug || '';
let baseName = item.title || item.name || item.displayName || '';
if (!baseName || baseName.toLowerCase() === 'unknown') {
    baseName = id.split('/').pop()?.split('--').pop()?.replace(/--/g, '/') || 'Untitled Entity';
}
const displayTitle = baseName;
const author = extractAuthor(id, item.author || item.creator || item.organization || 'Community');
const description = item.description || item.summary || item.seo_summary?.description || 'Structural intelligence indexing in progress...';
const truncatedDesc = description;

// Routing & Metadata - V19.1 Unification
const link = generateEntityUrl(item, type);
const isActive = isRecentlyActive(item.last_updated || item.lastModified);

const fni = Math.round(item.fni_score ?? item.fni ?? item.fniScore ?? 0);
const fniPercentile = item.fni_percentile || item.percentile || '';

// FNI Color Semantics (SPEC-CORE-FEATURES V1.0)
let fniBadgeClass = "bg-gray-100 dark:bg-zinc-800 text-gray-500";
if (fni >= 85) fniBadgeClass = "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400";
else if (fni >= 70) fniBadgeClass = "bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400";
else if (fni > 0) fniBadgeClass = "bg-rose-100 dark:bg-rose-900/30 text-rose-700 dark:text-rose-400";

// Color Mapping - Professional Muted Palette
let typeBadgeColor = 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400';
if (type === 'model') typeBadgeColor = 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400';
if (type === 'agent') typeBadgeColor = 'bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400';
if (type === 'dataset') typeBadgeColor = 'bg-sky-50 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400';
if (type === 'tool') typeBadgeColor = 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400';
if (type === 'paper') typeBadgeColor = 'bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400';
if (type === 'space') typeBadgeColor = 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';

const typeLabel = (item.pipeline_tag || item.primary_category || type).replace(/-/g, ' ');

// V19.1 Polymorphic Metrics Calculation
const formatCompact = (num) => new Intl.NumberFormat('en-US', { notation: "compact" }).format(num || 0);

const metrics = [];
if (type === 'model' || type === 'dataset' || type === 'space') {
    if (item.downloads > 0) metrics.push({ icon: 'üì•', value: formatCompact(item.downloads), label: 'Downloads' });
    if (item.likes > 0) metrics.push({ icon: '‚ù§Ô∏è', value: formatCompact(item.likes), label: 'Likes' });
    if (type === 'dataset' && item.size) metrics.push({ icon: 'üíæ', value: item.size, label: 'Size' });
    if (type === 'space' && item.runtime) {
        const stage = typeof item.runtime === 'object' ? (item.runtime.stage || 'Live') : item.runtime;
        metrics.push({ icon: 'üöÄ', value: stage, label: 'Runtime' });
    }
} else if (type === 'agent' || type === 'tool') {
    const stars = item.stars || item.github_stars || 0;
    const forks = item.forks || item.github_forks || 0;
    if (stars > 0) metrics.push({ icon: '‚≠ê', value: formatCompact(stars), label: 'Stars' });
    if (forks > 0) metrics.push({ icon: 'üç¥', value: formatCompact(forks), label: 'Forks' });
} else if (type === 'paper') {
    const citations = item.citations || 0;
    if (citations > 0) metrics.push({ icon: 'üìö', value: formatCompact(citations), label: 'Citations' });
    const year = item.published_date ? new Date(item.published_date).getFullYear() : null;
    if (year) metrics.push({ icon: 'üìÖ', value: year, label: 'Published' });
}
if (item.fni_score > 0) {
    // FNI is already in the top badge, but we can add more if needed
}
---

<a href={link} data-astro-prefetch class="entity-card group p-3 bg-white dark:bg-zinc-900 rounded-md transition-all border border-zinc-100 dark:border-zinc-800 hover:border-blue-500/50 block h-full flex flex-col" data-entity-id={id} data-entity-type={type}>
    <div class="flex items-center justify-between mb-2">
         <div class="flex items-center gap-2">
             <span class="text-[9px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded {typeBadgeColor}">{typeLabel}</span>
             {isActive && <span class="w-1 h-1 rounded-full bg-emerald-500 shrink-0" title="Recently updated"></span>}
         </div>
         <div class="flex items-center gap-2">
             {isRisingStar && <span class="text-[8px] font-black bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 px-1 py-0.5 rounded uppercase tracking-tighter">Rising</span>}
             {(fni > 0 || fniPercentile) && (
                <div class={`flex items-center gap-1 px-1.5 py-0.5 rounded ${fniBadgeClass} border border-black/5 dark:border-white/5`}>
                    <span class="text-[9px] font-bold">{fni > 0 ? fni : ''}</span>
                    {fniPercentile && (typeof fniPercentile === 'string' && fniPercentile.startsWith('top_')) ? (
                       <span class="text-[8px] opacity-80 font-bold border-l border-current/20 pl-1">{fniPercentile.replace('top_', 'Top ')}</span>
                    ) : (fniPercentile && typeof fniPercentile === 'number' && fniPercentile >= 90) ? (
                       <span class="text-[8px] opacity-80 font-bold border-l border-current/20 pl-1">Top {100 - fniPercentile}%</span>
                    ) : null}
                </div>
             )}
         </div>
    </div>
    
    <h3 class="text-xs sm:text-sm font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-1 mb-1.5" title={displayTitle}>
        {displayTitle}
    </h3>
    
    <p class="text-[9px] sm:text-[10px] text-gray-400 dark:text-zinc-500 mb-2 uppercase tracking-tight font-bold italic">by {author}</p>
    
    <p class="text-[10px] sm:text-[11px] text-gray-600 dark:text-zinc-400 line-clamp-2 mb-3 flex-grow leading-tight">
        {truncatedDesc}
    </p>

    <div class="flex items-center gap-3 pt-2 border-t border-zinc-50 dark:border-zinc-800 text-[9px] font-bold text-zinc-400 uppercase tracking-tighter">
        {metrics.map(m => (
            <div class="flex items-center gap-1" title={m.label}>
                <span>{m.value}</span>
                <span class="opacity-60">{m.label.charAt(0)}</span>
            </div>
        ))}
    </div>
</a>

<script>
    /**
     * V19.2 Lazy-Hydration System
     * Resolves missing backend data (descriptions/metrics) via client-side fetch when visible.
     */
    document.addEventListener('astro:page-load', () => {
        const cards = document.querySelectorAll('.entity-card');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(async entry => {
                if (entry.isIntersecting) {
                    const card = entry.target;
                    if (card.getAttribute('data-hydrated')) return;
                    
                    const id = card.getAttribute('data-entity-id');
                    if (!id) return;

                    try {
                        // V19.2: Fetch from Fused Storage (Primary)
                        const res = await fetch(`https://cdn.free2aitools.com/cache/fused/${id}.json.gz`);
                        if (!res.ok) throw new Error('Not found');
                        
                        // Transparent decompression handled by browser (Content-Encoding: gzip)
                        // If browser doesn't support it, fetch the .json fallback if needed, 
                        // but production CDN ensures .gz works.
                        const data = await res.json();
                        
                        // 1. Update Description if missing or placeholder
                        const descEl = card.querySelector('p.text-gray-600');
                        if (descEl && (descEl.textContent.trim().includes('Structural intelligence') || descEl.textContent.trim().length < 10)) {
                            descEl.textContent = data.description || data.summary || data.enriched?.display_description || descEl.textContent;
                        }

                        // 2. Update FNI if missing
                        if (data.fni_score > 0) {
                            const fniContainer = card.querySelector('.flex.items-center.gap-2:last-child');
                            if (fniContainer && !fniContainer.querySelector('.bg-emerald-100, .bg-amber-100, .bg-rose-100')) {
                                const fni = data.fni_score;
                                let color = "bg-gray-100 text-gray-500";
                                if (fni >= 85) color = "bg-emerald-100 text-emerald-700";
                                else if (fni >= 70) color = "bg-amber-100 text-amber-700";
                                else if (fni > 0) color = "bg-rose-100 text-rose-700";
                                
                                const badge = document.createElement('div');
                                badge.className = `flex items-center gap-1 px-1.5 py-0.5 rounded ${color} border border-black/5 text-[9px] font-bold`;
                                badge.innerHTML = `<span>${fni}</span>`;
                                fniContainer.prepend(badge);
                            }
                        }

                        // 3. Update Metrics (Inject if container is empty)
                        const metricsContainer = card.querySelector('.pt-2.border-t');
                        if (metricsContainer && metricsContainer.children.length === 0) {
                            const metrics = [];
                            if (data.downloads) metrics.push(`<span>${new Intl.NumberFormat('en-US',{notation:'compact'}).format(data.downloads)} üì•</span>`);
                            if (data.stars) metrics.push(`<span>${new Intl.NumberFormat('en-US',{notation:'compact'}).format(data.stars)} ‚≠ê</span>`);
                            if (data.citations) metrics.push(`<span>${new Intl.NumberFormat('en-US',{notation:'compact'}).format(data.citations)} üìö</span>`);
                            metricsContainer.innerHTML = metrics.join('<span class="opacity-20">|</span>');
                        }

                        card.setAttribute('data-hydrated', 'true');
                        observer.unobserve(card);
                    } catch (e) {
                        // Silent fail - keep placeholder
                    }
                }
            });
        }, { rootMargin: '100px' });

        cards.forEach(card => observer.observe(card));
    });
</script>
