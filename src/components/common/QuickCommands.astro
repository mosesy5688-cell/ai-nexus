---
/**
 * QuickCommands.astro
 * 
 * V16.2: Universal "Developer Fast-Path" component.
 * Provides copy-pasteable snippets for local deployment.
 */

interface Props {
  entity: any;
  type: 'model' | 'agent' | 'dataset' | 'paper' | 'space' | 'tool';
  className?: string;
}

const { entity, type, className = '' } = Astro.props;

// Logic for snippets
// Logic for snippets
const id = entity?.id || entity?.umid || '';
// V16.10: Precise namespace extraction (e.g., hf-model--unsloth--llama -> unsloth/llama)
const idParts = id.split('--');
const cleanId = idParts.length > 2 
    ? idParts.slice(1).join('/') 
    : (idParts.pop() || '');
    
const repoUrl = entity?.source_url || '';

const commands = [];

if (type === 'model') {
  // 1. Ollama (if likely compatible)
  const pCount = entity.params_billions || 0;
  if (pCount > 0 && pCount < 100) {
    commands.unshift({ // V18.5 Priority: Ollama first
      label: 'Ollama Run',
      cmd: `ollama run ${cleanId.includes('/') ? cleanId.split('/').pop() : cleanId}`,
      icon: 'ðŸ¦™'
    });
  }
  // 2. HF-CLI (Standard for Models)
  if (entity.source === 'huggingface' || repoUrl.includes('huggingface.co')) {
    commands.push({
      label: 'HF Download',
      cmd: `huggingface-cli download ${cleanId}`,
      icon: 'ðŸ¤—'
    });
    
    // 3. Pip Install (Transformers)
    if (entity.library_name === 'transformers' || entity.tags?.includes('transformers')) {
        commands.push({
            label: 'Install Lib',
            cmd: `pip install -U transformers`,
            icon: 'ðŸ“¦'
        });
    }
  }
} else if (type === 'agent' || type === 'tool') {
  const lang = (entity?.language || '').toLowerCase();
  const packageName = cleanId.split('/').pop()?.toLowerCase() || '';
  
  if (repoUrl && repoUrl.includes('github.com')) {
    commands.push({
      label: 'GitHub Clone',
      cmd: `git clone ${repoUrl}`,
      icon: 'ðŸ™'
    });
  }

  if (lang === 'javascript' || lang === 'typescript' || entity.tags?.includes('npm')) {
    commands.push({
      label: 'NPM Install',
      cmd: `npm install ${packageName || 'package-name'}`,
      icon: 'ðŸ“¦'
    });
  } else if (lang === 'python' || entity.tags?.includes('pip') || type === 'agent') {
    commands.push({
      label: 'PIP Install',
      cmd: `pip install ${packageName || 'package-name'}`,
      icon: 'ðŸ'
    });
  }
} else if (type === 'dataset') {
    const arxivId = entity?.arxiv_id || (id.includes('arxiv--') ? id.replace('arxiv--', '') : '');
    if (arxivId) {
        commands.push({
            label: 'BibTeX Citation',
            cmd: `gh arxiv cite ${arxivId}`,
            icon: 'ðŸ“œ'
        });
    }
}

// Global Source Check
if (repoUrl && repoUrl.includes('github.com') && commands.length < 2) {
    commands.push({
      label: 'Git Clone',
      cmd: `git clone ${repoUrl}`,
      icon: 'ðŸ™'
    });
}

if (commands.length === 0) return null;
---

<div class={`quick-commands-container space-y-4 ${className}`}>
  <h3 class="text-sm font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest flex items-center gap-2">
    <span>âš¡</span> Quick Commands
  </h3>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    {commands.map(item => (
      <div class="command-box group relative bg-zinc-950 border border-zinc-800 rounded-sm overflow-hidden transition-all hover:border-zinc-500 shadow-none">
        <div class="flex items-center justify-between px-3 py-1 bg-zinc-900 border-b border-zinc-800">
           <span class="text-[9px] font-black text-zinc-500 flex items-center gap-1 uppercase tracking-widest">
             <span>{item.icon}</span> {item.label}
           </span>
        </div>
        <div class="p-3 flex items-center justify-between gap-4 font-mono">
          <code class="text-[11px] text-zinc-300 truncate">{item.cmd}</code>
          <button 
            class="copy-btn p-1 rounded hover:bg-zinc-800 text-zinc-600 hover:text-zinc-300 transition-colors active:scale-95"
            data-cmd={item.cmd}
            title="Copy to clipboard"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>
          </button>
        </div>
      </div>
    ))}
  </div>
</div>

<script>
  function initQuickCopy() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const b = btn as HTMLButtonElement;
        const cmd = b.dataset.cmd || '';
        try {
          await navigator.clipboard.writeText(cmd);
          const originalHtml = b.innerHTML;
          b.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
          setTimeout(() => b.innerHTML = originalHtml, 2000);
        } catch (e) {}
      });
    });
  }
  initQuickCopy();
  document.addEventListener('astro:after-swap', initQuickCopy);
</script>
