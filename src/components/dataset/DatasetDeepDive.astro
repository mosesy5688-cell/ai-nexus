---
interface Props {
  dataset: any;
}

const { dataset } = Astro.props;
import FullReadmeSection from '../model-detail/FullReadmeSection.astro';
import ModelGallery from '../model-detail/ModelGallery.astro';

// V19: Use REAL data only ‚Äî no fabricated mock rows
const features = dataset.features;
const hasFeatures = features && (
  (Array.isArray(features) && features.length > 0) ||
  (typeof features === 'object' && Object.keys(features).length > 0)
);

// Derive column names from features object/array
const columns = hasFeatures
  ? (Array.isArray(features) ? features.map((f: any) => f.name || f) : Object.keys(features))
  : [];

// Derive field types from features (if object with type info)
const fieldTypes = hasFeatures && !Array.isArray(features)
  ? Object.entries(features).map(([name, info]: [string, any]) => ({
      name,
      type: typeof info === 'object' ? (info.dtype || info.type || 'unknown') : String(info)
    }))
  : (Array.isArray(features) ? features.map((f: any) => ({
      name: typeof f === 'string' ? f : (f.name || 'field'),
      type: typeof f === 'object' ? (f.dtype || f.type || 'unknown') : 'unknown'
    })) : []);

// Real row data (only if actual rows exist, never fabricated)
const realRows = Array.isArray(dataset.rows) && dataset.rows.length > 0 
  ? dataset.rows.slice(0, 10)
  : null;

const configs = Array.isArray(dataset.configs) 
  ? dataset.configs 
  : (typeof dataset.configs === 'string' ? JSON.parse(dataset.configs) : []);

// V19: Popularity metrics with defensive parsing
const downloads = dataset?.downloads ? Number(dataset.downloads) : null;
const likes = dataset?.likes ? Number(dataset.likes) : null;
---

<div class="space-y-12">
  {/* V16.2: Visual First - Auto Gallery */}
  {(dataset.image_url || dataset.body_content || dataset.description) && (
    <ModelGallery content={dataset.body_content || dataset.description} title="Dataset Preview & Visuals" />
  )}

  {/* V19: Popularity Metrics (if available) */}
  {(downloads || likes) && (
    <section class="flex flex-wrap gap-4">
      {downloads && (
        <div class="flex items-center gap-2 px-4 py-2 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
          <span class="text-lg">‚¨áÔ∏è</span>
          <div>
            <div class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Downloads</div>
            <div class="text-sm font-black text-gray-900 dark:text-white">{downloads >= 1e6 ? `${(downloads/1e6).toFixed(1)}M` : downloads.toLocaleString()}</div>
          </div>
        </div>
      )}
      {likes && (
        <div class="flex items-center gap-2 px-4 py-2 bg-rose-50 dark:bg-rose-900/20 rounded-xl border border-rose-100 dark:border-rose-800/30">
          <span class="text-lg">‚ù§Ô∏è</span>
          <div>
            <div class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Likes</div>
            <div class="text-sm font-black text-gray-900 dark:text-white">{likes.toLocaleString()}</div>
          </div>
        </div>
      )}
    </section>
  )}

  <!-- Section: Data Preview & Schema (Grid) -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
     <section class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-sm border border-gray-100 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
           <span class="p-2 bg-blue-500/10 rounded-lg text-blue-500">üëÅÔ∏è</span> Data Preview
        </h2>
        
        {realRows && columns.length > 0 ? (
          <div class="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-xl shadow-inner bg-gray-50/50 dark:bg-gray-900/50">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 font-mono text-[11px]">
              <thead class="bg-gray-50 dark:bg-gray-800">
                <tr>
                  {columns.map((col: string) => (
                    <th class="px-4 py-3 text-left text-[10px] font-black text-gray-400 uppercase tracking-widest">
                      {col}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                {realRows.map((row: any) => (
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    {columns.map((col: string) => (
                      <td class="px-4 py-3 whitespace-nowrap text-gray-600 dark:text-gray-400 truncate max-w-[200px]">
                        {row[col]?.toString() || '-'}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="text-center py-12 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-800">
            <div class="text-4xl mb-4 opacity-30">üìä</div>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-2">
              Row-level preview not available for this dataset.
            </p>
            <p class="text-[10px] text-gray-400 italic">
              Schema structure is shown in the Field Logic panel when available.
            </p>
            {dataset.source_url && (
              <a href={dataset.source_url} target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-xs shadow-lg hover:scale-105 transition-all">
                <span>üîó</span> Explore Full Dataset ‚Üó
              </a>
            )}
          </div>
        )}

        {realRows && (
          <p class="mt-4 text-[10px] text-gray-400 italic font-medium tracking-tight">
            * Showing {realRows.length} sample row{realRows.length > 1 ? 's' : ''} from indexed data.
          </p>
        )}
     </section>

     <section class="bg-indigo-50/30 dark:bg-indigo-900/10 rounded-2xl p-8 border border-indigo-100 dark:border-indigo-800/20">
        <h2 class="text-xs font-black mb-8 text-indigo-900 dark:text-indigo-200 uppercase tracking-widest flex items-center gap-2">
           <span>üß¨</span> Field Logic
        </h2>
        <div class="space-y-6">
           {fieldTypes.length > 0 ? (
             <div class="font-mono text-xs space-y-4">
               {fieldTypes.map((field: any) => (
                 <div class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-indigo-100/50 dark:border-indigo-900/30 flex justify-between items-center">
                    <span class="text-purple-600 dark:text-purple-400 font-bold truncate max-w-[120px]">{field.name}</span>
                    <span class="text-gray-400">{field.type}</span>
                 </div>
               ))}
             </div>
           ) : (
             <div class="text-center py-8">
               <div class="text-2xl mb-2 opacity-30">üß¨</div>
               <p class="text-xs text-gray-400 italic">Schema not yet indexed for this dataset.</p>
             </div>
           )}

           {configs.length > 0 && (
              <div class="pt-6 border-t border-indigo-100 dark:border-indigo-800/30">
                 <h3 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Available Configs</h3>
                 <div class="flex flex-wrap gap-1.5">
                   {configs.map((c: any) => (
                       <span class="px-2 py-0.5 bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300 rounded text-[10px] font-bold">
                         {c.config_name || c}
                       </span>
                   ))}
                 </div>
              </div>
           )}
        </div>
     </section>
  </div>

  <!-- Section: README / Dataset Card (V19: html_readme priority) -->
  <div class="relative">
     <div class="absolute -left-6 top-10 w-1 bg-blue-500/20 h-24 rounded-full blur-sm"></div>
     <FullReadmeSection 
       bodyContent={dataset.html_readme || dataset.body_content || dataset.description || dataset.abstract}
       type="dataset"
       initialCollapsed={false}
       maxPreviewLength={5000}
     />
  </div>
</div>
