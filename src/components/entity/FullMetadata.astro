---
/**
 * FullMetadata - V15.1 Curated Transparency Report
 * Implements Progressive Disclosure by grouping metadata and filtering internals.
 */
interface Props {
  entity: any;
  title?: string;
}

const { entity, title = "Transparency Report" } = Astro.props;

// Filter out internal fields (starting with _) and redundant raw data
const ignoreKeys = ['meta', 'meta_json', 'config', 'entityDefinition', 'computed', 'similar_models', 'similar_entities', 'body_content', 'description'];
const allKeys = Object.keys(entity).filter(k => !k.startsWith('_') && !ignoreKeys.includes(k));

// Define curated groups
const groups = [
  {
    name: "Identity & Source",
    icon: "üÜî",
    fields: ['id', 'slug', 'source', 'author', 'license', 'tags', 'url', 'homepage']
  },
  {
    name: "Technical Specs",
    icon: "‚öôÔ∏è",
    fields: ['architecture', 'params_billions', 'context_length', 'pipeline_tag', 'dtype', 'quant_method', 'inference_framework', 'vram_gb', 'vram_gb_est_q4', 'vram_is_estimated', 'vram_formula']
  },
  {
    name: "Engagement & Metrics",
    icon: "üìä",
    fields: ['likes', 'downloads', 'stars', 'forks', 'github_stars', 'citations', 'trending_score']
  }
];

// Helper to determine which fields are "Extra" (not in defined groups)
const groupedKeys = new Set(groups.flatMap(g => g.fields));
const extraKeys = allKeys.filter(k => !groupedKeys.has(k)).sort();

function formatValue(val: any): string {
  if (val === null || val === undefined) return '<span class="text-gray-400 italic">null</span>';
  if (typeof val === 'boolean') return val ? '<span class="text-emerald-500 font-bold">true</span>' : '<span class="text-rose-500 font-bold">false</span>';
  if (Array.isArray(val)) {
    return `<div class="flex flex-wrap gap-1">${val.map(v => `<span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-md text-[11px] font-medium text-gray-600 dark:text-gray-400 border border-gray-200/50 dark:border-gray-700/50">${v}</span>`).join('')}</div>`;
  }
  if (typeof val === 'object') {
    const str = JSON.stringify(val);
    if (str.length < 50) return `<span class="text-[11px] font-mono text-indigo-400">${str}</span>`;
    return `<details class="cursor-pointer"><summary class="text-[10px] text-gray-400 hover:text-indigo-400 transition-colors">View Complex Data</summary><pre class="text-[10px] bg-gray-50 dark:bg-gray-900/50 p-2 rounded-lg border border-gray-100 dark:border-gray-800 mt-1 overflow-x-auto max-h-40">${JSON.stringify(val, null, 2)}</pre></details>`;
  }
  if (typeof val === 'number') {
    return `<span class="font-mono font-bold text-indigo-600 dark:text-indigo-400">${val.toLocaleString()}</span>`;
  }
  return String(val);
}
---

<section class="mt-20 pt-12 border-t border-gray-100/50 dark:border-gray-800/50">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
    <div>
      <h2 class="text-3xl font-black text-gray-900 dark:text-white tracking-tight flex items-center gap-3">
        <span class="p-2 bg-indigo-50 dark:bg-indigo-950/30 rounded-xl text-xl shrink-0">üõ°Ô∏è</span> 
        {title}
      </h2>
      <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Verified data manifest for traceability and transparency.</p>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
      <span class="text-[11px] font-black uppercase tracking-[0.2em] text-gray-400 dark:text-gray-500">
        100% Data Disclosure Active
      </span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {groups.map(group => {
      const activeFields = group.fields.filter(f => entity[f] !== undefined);
      if (activeFields.length === 0) return null;
      
      return (
        <div class="group/card bg-gray-50/50 dark:bg-gray-900/40 border border-gray-100 dark:border-gray-800 rounded-2xl p-6 transition-all hover:shadow-xl hover:shadow-indigo-500/5 hover:border-indigo-500/20">
          <h3 class="flex items-center gap-2 text-xs font-black uppercase tracking-widest text-indigo-600 dark:text-indigo-400 mb-6 group-hover/card:translate-x-1 transition-transform">
            <span>{group.icon}</span> {group.name}
          </h3>
          
          <dl class="space-y-4">
            {activeFields.map(field => (
              <div>
                <dt class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-1">
                  {field.replace(/_/g, ' ')}
                </dt>
                <dd class="text-sm text-gray-700 dark:text-gray-200 break-words line-clamp-4 hover:line-clamp-none transition-all" set:html={formatValue(entity[field])}>
                </dd>
              </div>
            ))}
          </dl>
        </div>
      );
    })}
  </div>


  {extraKeys.length > 0 && (
    <div class="mt-8">
      <details class="group bg-white dark:bg-gray-800/30 border border-gray-100 dark:border-gray-800 rounded-2xl overflow-hidden transition-all shadow-sm">
        <summary class="flex items-center justify-between px-6 py-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/30 list-none transition-colors">
          <div class="flex items-center gap-3">
            <span class="text-lg">üß©</span>
            <span class="text-sm font-bold text-gray-600 dark:text-gray-300">Supplemental Attributes & Extended Config</span>
            <span class="px-2 py-0.5 bg-indigo-50 dark:bg-indigo-900/40 text-[10px] font-black text-indigo-400 rounded-md border border-indigo-100 dark:border-indigo-800">
              {extraKeys.length} items
            </span>
          </div>
          <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </summary>
        <div class="px-6 pb-6 pt-2">
           <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
             {extraKeys.map(key => (
               <div class="p-3 bg-gray-50/50 dark:bg-gray-900/50 rounded-xl border border-gray-100 dark:border-gray-800 hover:border-indigo-100 dark:hover:border-indigo-900 transition-colors">
                  <span class="block text-[9px] font-black text-gray-400 dark:text-gray-500 uppercase mb-1 tracking-widest">{key.replace(/_/g, ' ')}</span>
                  <div class="text-[11px] text-gray-600 dark:text-gray-300 break-words" set:html={formatValue(entity[key])}></div>
               </div>
             ))}
           </div>
        </div>
      </details>
    </div>
  )}

  <p class="mt-10 text-[11px] text-gray-400 font-medium flex items-center gap-2 justify-center opacity-60">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    Free2AITools Constitutional Data Pipeline: Curated disclosure mode active. (V15.x Standard)
  </p>
</section>
