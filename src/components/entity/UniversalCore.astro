---
/**
 * UniversalCore - V15.1 (Standardized Zone 3)
 * Adapts to all 6 entity types to provide maximum content density.
 * V16.4: Unified Routing and 404 Stability.
 */

import BenchmarkCard from '../benchmark/BenchmarkCard.astro';
import MiniTrendChart from '../charts/MiniTrendChart.astro';
import SimilarModels from '../model-detail/SimilarModels.astro';
import NeuralGraphExplorer from '../NeuralGraphExplorer.astro';
import MeshRelationMatrix from './MeshRelationMatrix.astro';
import { getRouteFromId, normalizeSlug } from '../../utils/knowledge-cache-reader.js';
import { getMeshProfile } from '../../utils/mesh-orchestrator.js';

interface Props {
  entity: any;
  type: 'model' | 'agent' | 'space' | 'tool' | 'dataset' | 'paper';
  meshRelations?: any[];
}

const { entity, type, meshRelations: propRelations = [] } = Astro.props;

// Identification
const entityId = entity?.id || entity?.name || '';
const entityName = entity?.name || entity?.title || 'Unknown';
let tagsArray = [];
try {
  if (entity?.tags) {
    if (typeof entity.tags === 'string') {
      if (entity.tags.trim().startsWith('[')) {
        tagsArray = JSON.parse(entity.tags);
      } else {
        tagsArray = entity.tags.split(',').map((t: string) => t.trim()).filter(Boolean);
      }
    } else if (Array.isArray(entity.tags)) {
      tagsArray = entity.tags;
    }
  }
} catch (e) {
  tagsArray = [];
}

// 1. Centralized Mesh Orchestration (V16.7)
let tiers = {
    explanation: { title: 'üéì Knowledge Base', nodes: [], icon: 'üéì' },
    core: { title: 'üîó Core Ecosystem', nodes: [], icon: '‚ö°' }, 
    utility: { title: 'üî¨ Research & Data', nodes: [], icon: 'üî¨' }, 
    digest: { title: 'üì∞ Timeline & Reports', nodes: [], icon: 'üì∞' }
};
let nodeRegistry = new Map();
let finalRelations = propRelations;

try {
    const profile = await getMeshProfile(Astro.locals, entityId, entity, type);
    if (profile) {
        tiers = profile.tiers;
        nodeRegistry = profile.nodeRegistry;
        if (profile.filteredRelations) {
            finalRelations = profile.filteredRelations;
        }
    }
} catch (e) {
    console.error('[UniversalCore] Mesh Orchestration Failed:', e);
}

// Feature availability
const hasBench = !!(entity?.mmlu || entity?.humaneval || entity?.avg_score || entity?.benchmark_avg);
const similarEntities = entity?.similar_models || entity?.similar_entities || entity?.relations?.links || [];

// 2. Cross-Component Deduplication
// Track all nodes already "spent" by the Hub (Tiers)
const renderedNodes = new Set();
if (tiers) {
    Object.values(tiers).forEach((t: any) => {
        if (t?.nodes) t.nodes.forEach((n: any) => renderedNodes.add(n.norm));
    });
}
Astro.locals.meshRenderedNodes = renderedNodes;

const enrichedTags = (tagsArray || []).map((tagObj: any) => {
   const tag = typeof tagObj === 'string' ? tagObj : (tagObj?.id || tagObj?.name || tagObj?.label || 'unknown');
   const normalizedTag = normalizeSlug(tag);
   return {
      name: tag,
      slug: normalizedTag,
      refs: 0, // Simplified for performance
      icon: 'üè∑Ô∏è'
   };
}).filter(tag => !renderedNodes.has(tag.slug));
---

<div class="space-y-16">
    <NeuralGraphExplorer currentModelId={entityId} entity={entity} type={type} meshTiers={tiers} />

    <div class="flex flex-col gap-16">
        {/* Primary Intelligence: Knowledge Mesh Hub */}
        <div class="mesh-hub-section animate-slide-up" style="animation-delay: 0.15s;">
           <div class="flex items-center justify-between mb-8">
              <div class="flex items-center gap-3">
                 <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <span class="text-xl text-white">üï∏Ô∏è</span>
                 </div>
                 <div>
                    <h3 class="text-lg font-black text-zinc-900 dark:text-white tracking-tighter uppercase">Intelligence Hive</h3>
                    <p class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Multi-source Relation Matrix</p>
                 </div>
              </div>
              <div class="h-px flex-1 mx-8 bg-zinc-100 dark:bg-zinc-800 hidden md:block"></div>
              <div class="flex items-center gap-1">
                 <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                 <span class="text-[8px] font-black text-zinc-500 uppercase">Live Index</span>
              </div>
           </div>
           
           <MeshRelationMatrix relations={finalRelations} entityId={entityId} />
        </div>

        {/* Secondary Intelligence: Technical Evidence (Benchmarks, Trends, SOTA) */}
        <div class="tech-evidence-section grid grid-cols-1 md:grid-cols-2 gap-10">
           {/* Technical Stats Sidebar Re-homed as Dense Block */}
           <div class="space-y-10">
              {hasBench && (
                <div class="benchmark-zone animate-slide-up">
                  <div class="flex items-center gap-2 mb-4 px-2">
                    <span class="text-indigo-500 font-black">‚öñÔ∏è</span>
                    <h3 class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.3em]">Verified Benchmarks</h3>
                  </div>
                  <BenchmarkCard 
                    umid={entityId}
                    name={entityName}
                    mmlu={entity?.mmlu}
                    humaneval={entity?.humaneval}
                    hellaswag={entity?.hellaswag}
                    arc_challenge={entity?.arc_challenge}
                    gsm8k={entity?.gsm8k}
                    truthfulqa={entity?.truthfulqa}
                    winogrande={entity?.winogrande}
                    avg_score={entity?.avg_score}
                    scores={entity?.meta_json?.benchmarks}
                  />
                </div>
              )}

              {/* V16.96: Academic SOTA & Lineage Extra */}
              {(entity.pwc_sota_count > 0 || entity.pwc_benchmarks?.length > 0) && (
                <div class="px-5 py-4 bg-teal-50/30 dark:bg-teal-900/10 rounded-3xl border border-teal-100/50 dark:border-teal-800/20 animate-slide-up" style="animation-delay: 0.15s;">
                   <div class="flex items-center gap-2 mb-3">
                      <span class="text-teal-600 dark:text-teal-400">üèÜ</span>
                      <span class="text-[10px] font-black text-teal-800 dark:text-teal-300 uppercase tracking-widest">SOTA Rank 1</span>
                   </div>
                   <div class="text-2xl font-black text-teal-900 dark:text-white leading-none mb-1">
                      {entity.pwc_sota_count} Benchmarks
                   </div>
                   <div class="text-[10px] text-teal-600 dark:text-teal-400 font-bold">Verified via Papers With Code</div>
                </div>
              )}
           </div>

           <div class="space-y-10">
              <div class="trend-zone p-6 bg-zinc-50 dark:bg-zinc-900/60 rounded-3xl border border-zinc-200 dark:border-zinc-800 animate-slide-up" style="animation-delay: 0.1s;">
                 <div class="flex items-center gap-3 mb-6 pb-2 border-b border-zinc-100 dark:border-zinc-800">
                    <span class="text-xl">üìà</span>
                    <h3 class="text-[10px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-[0.2em]">Momentum Index</h3>
                 </div>
                 <div class="relative min-h-[140px] flex items-center justify-center">
                    <MiniTrendChart entityId={entityId} width={380} height={140} />
                 </div>
              </div>

              {enrichedTags.length > 0 && (
                <div class="tag-zone p-6 bg-zinc-50/50 dark:bg-zinc-900/40 rounded-3xl border border-zinc-100 dark:border-zinc-800/50 animate-slide-up" style="animation-delay: 0.2s;">
                  <div class="flex items-center gap-3 mb-6 pb-2 border-b border-zinc-100 dark:border-zinc-800">
                    <span class="text-xl">üè∑Ô∏è</span>
                    <h3 class="text-[10px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-[0.2em]">Contextual Anchors</h3>
                  </div>
                  <div class="flex flex-wrap gap-2">
                     {enrichedTags.slice(0, 12).map((tag: any) => (
                        <a 
                          href={`/search?q=${encodeURIComponent(tag.name)}`} 
                          class="px-2.5 py-1 bg-white dark:bg-zinc-800 text-zinc-500 dark:text-zinc-400 rounded-md text-[10px] font-bold border border-zinc-100 dark:border-zinc-700 hover:border-indigo-500 transition-all"
                        >
                           {tag.name}
                        </a>
                     ))}
                  </div>
                </div>
              )}
           </div>
        </div>

        {/* Neural Discovery: Similar Entities */}
        {similarEntities.length > 0 && (
          <div class="related-discovery-zone pt-12 border-t border-zinc-100 dark:border-zinc-800 animate-slide-up" style="animation-delay: 0.3s;">
             <div class="flex items-center gap-3 mb-8">
               <span class="text-xl">üîÑ</span>
               <h3 class="text-xs font-black text-zinc-900 dark:text-white uppercase tracking-[0.2em]">Neural Associations</h3>
             </div>
             <SimilarModels models={similarEntities} currentModelId={entityId} />
          </div>
        )}
    </div>
</div>

<script is:inline>
  // V16.34: Trend Data Visibility Guard (Synchronized with MiniTrendChart)
  function checkTrendLoad() {
    const charts = document.querySelectorAll('.mini-trend');
    charts.forEach(chart => {
      const canvas = chart.querySelector('canvas');
      const fallback = chart.parentElement?.querySelector('#trend-fallback');
      
      // V16.34: Increased to 6s for production reliability.
      // If .hidden-permanent is set by the child, the mask stays hidden.
      setTimeout(() => {
        if (fallback && !fallback.classList.contains('hidden-permanent')) {
            if (canvas && !canvas.classList.contains('loaded')) {
                fallback.classList.remove('hidden');
            }
        }
      }, 6000);
    });
  }

  checkTrendLoad();
  document.addEventListener('astro:after-swap', checkTrendLoad);
</script>

<style>
  #trend-fallback.hidden-permanent {
    display: none !important;
  }
</style>
