---
/**
 * UniversalCore - V15.1 (Standardized Zone 3)
 * Adapts to all 6 entity types to provide maximum content density.
 * V16.4: Unified Routing and 404 Stability.
 */

import BenchmarkCard from '../benchmark/BenchmarkCard.astro';
import MiniTrendChart from '../charts/MiniTrendChart.astro';
import SimilarModels from '../model-detail/SimilarModels.astro';
import NeuralGraphExplorer from '../NeuralGraphExplorer.astro';
import MeshRelationMatrix from './MeshRelationMatrix.astro';
import { getMeshProfile, getRouteFromId } from '../../utils/knowledge-cache-reader.js';

interface Props {
  entity: any;
  type: 'model' | 'agent' | 'space' | 'tool' | 'dataset' | 'paper';
  meshRelations?: any[];
}

const { entity, type, meshRelations: propRelations = [] } = Astro.props;

// Identification
const entityId = entity?.id || entity?.name || '';
const entityName = entity?.name || entity?.title || 'Unknown';
let tagsArray = [];
try {
  if (entity?.tags) {
    if (typeof entity.tags === 'string') {
      if (entity.tags.trim().startsWith('[')) {
        tagsArray = JSON.parse(entity.tags);
      } else {
        tagsArray = entity.tags.split(',').map((t: string) => t.trim()).filter(Boolean);
      }
    } else if (Array.isArray(entity.tags)) {
      tagsArray = entity.tags;
    }
  }
} catch (e) {
  tagsArray = [];
}

// 1. Centralized Mesh Orchestration (V16.7)
const { tiers, nodeRegistry } = await getMeshProfile(Astro.locals, entityId, entity, type);

// Feature availability
const hasBench = !!(entity?.mmlu || entity?.humaneval || entity?.avg_score || entity?.benchmark_avg);
const similarEntities = entity?.similar_models || entity?.similar_entities || entity?.relations?.links || [];

// 2. Cross-Component Deduplication
// Track all nodes already "spent" by the Hub (Tiers)
const renderedNodes = new Set();
Object.values(tiers).forEach(t => t.nodes.forEach(n => renderedNodes.add(n.norm)));
Astro.locals.meshRenderedNodes = renderedNodes;

const enrichedTags = tagsArray.map((tagObj: any) => {
   const tag = typeof tagObj === 'string' ? tagObj : (tagObj?.id || tagObj?.name || tagObj?.label || 'unknown');
   const normalizedTag = tag.toLowerCase().replace(/[^a-z0-9]/g, '-');
   return {
      name: tag,
      slug: normalizedTag,
      refs: 0, // Simplified for performance
      icon: 'ðŸ§ '
   };
}).filter(tag => !renderedNodes.has(tag.slug));
---

<div class="space-y-12">
    <NeuralGraphExplorer currentModelId={entityId} entity={entity} type={type} meshTiers={tiers} />

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
        {/* Left: Benchmarks & Trends */}
        <div class="space-y-8">
           {hasBench && (
             <BenchmarkCard 
               umid={entityId}
               name={entityName}
               mmlu={entity?.mmlu}
               humaneval={entity?.humaneval}
               hellaswag={entity?.hellaswag}
               avg_score={entity?.avg_score}
             />
           )}

           <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
              <h3 class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                 <span>ðŸ“ˆ</span> Interest Trend
              </h3>
              <div class="relative min-h-[140px] flex items-center justify-center">
                <MiniTrendChart entityId={entityId} width={400} height={140} />
                {!entityId && (
                  <div class="absolute inset-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm flex items-center justify-center text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                    No Trend Data Available
                  </div>
                )}
              </div>
              <p class="text-[10px] text-gray-400 mt-4 leading-tight uppercase font-bold tracking-tighter">
                * Real-time activity index across HuggingFace, GitHub and Research citations.
              </p>
           </div>
        </div>
        
        {/* Right: Relations & Knowledge Tags */}
        <div class="space-y-10">
            <MeshRelationMatrix relations={meshRelations} entityId={entityId} />

            <div class="p-8 bg-indigo-50/20 dark:bg-indigo-900/10 rounded-2xl border border-indigo-100 dark:border-indigo-800/20">
              <h3 class="text-xs font-black text-indigo-900/60 dark:text-indigo-200/60 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                 <span class="text-lg">ðŸ§ </span> Semantic Knowledge
              </h3>
              <div class="flex flex-wrap gap-2">
                 {enrichedTags.map((tag: any) => (
                    <a 
                      href={getRouteFromId(`knowledge--${tag.slug}`, 'knowledge')} 
                      class="group relative px-3 py-1.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl text-[11px] font-bold border border-gray-100 dark:border-gray-700 hover:border-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all shadow-sm hover:shadow-md"
                    >
                       <span class="mr-1.5 opacity-60 group-hover:opacity-100">{tag.icon}</span>
                       #{tag.name}
                       {tag.refs > 0 && (
                          <span class="ml-2 px-1.5 py-0.5 bg-indigo-50 dark:bg-indigo-900/40 text-[9px] text-indigo-500 rounded-md border border-indigo-100 dark:border-indigo-800/50">
                             {tag.refs}
                          </span>
                       )}
                    </a>
                 ))}
                 {enrichedTags.length === 0 && <span class="text-sm text-gray-400 italic">No semantic tags indexed.</span>}
              </div>
           </div>

           {similarEntities.length > 0 && (
             <div class="space-y-4">
                <h3 class="text-[10px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] px-2">
                   <span>ðŸ”„</span> Related Node Sync
                </h3>
                <SimilarModels models={similarEntities} currentModelId={entityId} />
             </div>
           )}
        </div>
    </div>
</div>
