---
/**
 * EntityCard Component - V5.0
 * Art.X-Entity: Render by entity.definition
 * Art.X-Capability-Gating: Modules enabled by capability only
 * CES-001: Clean URL format
 * 
 * Polymorphic card component that renders differently based on entity type
 */
import { deriveEntityType, getEntityTier } from '../types/entity';
import { ENTITY_DEFINITIONS, entityHasCapability } from '../data/entity-definitions';
import { generateEntityUrl } from '../../utils/url-utils.js';
import FNIBadge from './FNIBadge.astro';
import FreshBadge from './FreshBadge.astro';

interface Props {
    entity: any;
    showFNI?: boolean;
}

const { entity, showFNI = true } = Astro.props;

// Derive entity type from ID
const entityId = entity.umid || entity.id || '';
const entityType = deriveEntityType(entityId) || 'model';
const definition = ENTITY_DEFINITIONS[entityType];
const tier = getEntityTier(entityType);

// Capability checks
const hasFNI = entityHasCapability(entityType, 'fni') && showFNI;
const hasCitations = entityHasCapability(entityType, 'citations');

// Common fields
const name = entity.name || entity.canonical_name || 'Untitled';
const author = entity.author || entity.organization || 'Unknown';
const description = entity.seo_summary || entity.description?.replace(/<[^>]*>?/gm, '') || 'No description available.';

// URL construction using clean URL format
const entityUrl = generateEntityUrl(entity, entityType);

// Display metadata
const icon = definition?.display?.icon || 'üì¶';
const color = definition?.display?.color || 'gray';
const label = definition?.display?.labelSingular || 'Item';

// Color classes mapping
const colorClasses: Record<string, { bg: string; text: string; border: string }> = {
    blue: { bg: 'bg-blue-50 dark:bg-blue-900/30', text: 'text-blue-700 dark:text-blue-300', border: 'border-blue-200 dark:border-blue-700' },
    green: { bg: 'bg-green-50 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-300', border: 'border-green-200 dark:border-green-700' },
    orange: { bg: 'bg-orange-50 dark:bg-orange-900/30', text: 'text-orange-700 dark:text-orange-300', border: 'border-orange-200 dark:border-orange-700' },
    yellow: { bg: 'bg-yellow-50 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-300', border: 'border-yellow-200 dark:border-yellow-700' },
    pink: { bg: 'bg-pink-50 dark:bg-pink-900/30', text: 'text-pink-700 dark:text-pink-300', border: 'border-pink-200 dark:border-pink-700' },
    gray: { bg: 'bg-gray-50 dark:bg-gray-800', text: 'text-gray-700 dark:text-gray-300', border: 'border-gray-200 dark:border-gray-700' },
};
const colorClass = colorClasses[color] || colorClasses.gray;

// Stats based on entity type
function formatNumber(num: any) {
    if (!num) return 0;
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num;
}
---

<a href={entityUrl} class={`group block bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden h-full border ${colorClass.border} hover:border-blue-300 dark:hover:border-blue-600`}>
    <div class="p-5 flex flex-col h-full">
        <!-- Entity Type Badge -->
        <div class="flex items-center justify-between mb-3">
            <span class={`inline-flex items-center gap-1.5 text-xs px-2 py-0.5 rounded-full ${colorClass.bg} ${colorClass.text}`}>
                <span>{icon}</span>
                <span>{label}</span>
            </span>
            
            {/* B.10: Freshness Badge */}
            <FreshBadge lastModified={entity.lastModified || entity.last_updated} />
            
            <!-- FNI Badge for Model entities only (Art.X-Entity-FNI) -->
            {hasFNI && entity.fni_score > 0 && (
                <FNIBadge 
                    fniScore={entity.fni_score || 0}
                    fniPercentile={entity.fni_percentile || 0}
                    fniP={entity.fni_p || 0}
                    fniV={entity.fni_v || 0}
                    fniC={entity.fni_c || 0}
                    fniU={entity.fni_u || 0}
                />
            )}
        </div>

        <!-- Entity Name -->
        <h3 class="text-lg font-bold text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors mb-1" title={name}>
            {name}
        </h3>
        
        <!-- Author/Organization -->
        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mb-3">
            <span>by {author}</span>
            {entity.pipeline_tag && entityType === 'model' && (
                <span class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-gray-600 dark:text-gray-300">
                    {entity.pipeline_tag}
                </span>
            )}
        </div>

        <!-- Description -->
        <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed line-clamp-3 flex-grow">
            {description.substring(0, 150)}{description.length > 150 ? '...' : ''}
        </p>

        <!-- Footer: Stats based on entity type -->
        <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
            <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                {/* Model-specific stats */}
                {entityType === 'model' && (
                    <>
                        <div class="flex items-center gap-1" title={`${(entity.likes || 0).toLocaleString()} likes`}>
                            ‚ù§Ô∏è <span class="font-medium">{formatNumber(entity.likes)}</span>
                        </div>
                        <div class="flex items-center gap-1" title={`${(entity.downloads || 0).toLocaleString()} downloads`}>
                            üì• <span class="font-medium">{formatNumber(entity.downloads)}</span>
                        </div>
                    </>
                )}
                
                {/* Dataset-specific stats */}
                {entityType === 'dataset' && (
                    <>
                        <div class="flex items-center gap-1" title={`${(entity.likes || 0).toLocaleString()} likes`}>
                            ‚ù§Ô∏è <span class="font-medium">{formatNumber(entity.likes)}</span>
                        </div>
                        {entity.size && (
                            <div class="flex items-center gap-1" title="Dataset size">
                                üíæ <span class="font-medium">{entity.size}</span>
                            </div>
                        )}
                    </>
                )}
                
                {/* Paper-specific stats */}
                {entityType === 'paper' && hasCitations && (
                    <>
                        <div class="flex items-center gap-1" title={`${(entity.citations || 0).toLocaleString()} citations`}>
                            üìö <span class="font-medium">{formatNumber(entity.citations)}</span>
                        </div>
                        {entity.published_date && (
                            <div class="flex items-center gap-1">
                                üìÖ <span class="font-medium">{new Date(entity.published_date).getFullYear()}</span>
                            </div>
                        )}
                    </>
                )}
                
                {/* Benchmark-specific stats */}
                {entityType === 'benchmark' && (
                    <>
                        {entity.num_models && (
                            <div class="flex items-center gap-1" title={`${entity.num_models} models evaluated`}>
                                üß† <span class="font-medium">{entity.num_models} models</span>
                            </div>
                        )}
                    </>
                )}
                
                {/* Agent-specific stats */}
                {entityType === 'agent' && (
                    <>
                        {entity.stars && (
                            <div class="flex items-center gap-1" title={`${(entity.stars || 0).toLocaleString()} stars`}>
                                ‚≠ê <span class="font-medium">{formatNumber(entity.stars)}</span>
                            </div>
                        )}
                        {entity.forks && (
                            <div class="flex items-center gap-1" title="Forks">
                                üç¥ <span class="font-medium">{formatNumber(entity.forks)}</span>
                            </div>
                        )}
                        {entity.language && (
                            <span class="px-1.5 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded text-[10px]">
                                {entity.language}
                            </span>
                        )}
                    </>
                )}
                
                {/* Space-specific stats */}
                {entityType === 'space' && (
                    <>
                        {entity.likes && (
                            <div class="flex items-center gap-1" title={`${(entity.likes || 0).toLocaleString()} likes`}>
                                ‚ù§Ô∏è <span class="font-medium">{formatNumber(entity.likes)}</span>
                            </div>
                        )}
                        {entity.runtime && (
                            <span class="px-1.5 py-0.5 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 rounded text-[10px]">
                                {entity.runtime}
                            </span>
                        )}
                        {entity.sdk && (
                            <span class="px-1.5 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded text-[10px]">
                                {entity.sdk}
                            </span>
                        )}
                    </>
                )}
                
                {/* Tier indicator */}
                <div class={`flex items-center gap-1 px-1.5 py-0.5 rounded ${colorClass.bg} ${colorClass.text}`}>
                    <span class="text-[10px] uppercase font-medium">{tier}</span>
                </div>
            </div>
        </div>
    </div>
</a>
