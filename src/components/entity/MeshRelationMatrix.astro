---
// src/components/entity/MeshRelationMatrix.astro
// V21.0: Professional Knowledge context matrix
import { stripPrefix, getRouteFromId } from '@/utils/mesh-routing-core';

interface Relation {
    target_id: string;
    target_name?: string;
    relation_type: string;
    confidence: number;
    target_type: string;
}

interface Props {
    relations: Relation[];
    entityId: string;
}

const { relations = [], entityId } = Astro.props;

const categories: Record<string, { label: string, icon: string, relations: Relation[] }> = {
    // V18.6 Priority: Technical Lineage
    BASED_ON: { label: 'Lineage / Base', icon: 'ðŸ§¬', relations: [] },
    STACK: { label: 'Technical Stack', icon: 'ðŸ› ï¸', relations: [] },
    
    // Other relations
    USES: { label: 'Dependencies', icon: 'ðŸ”Œ', relations: [] },
    TRAINED_ON: { label: 'Knowledge Base', icon: 'ðŸ“š', relations: [] },
    CITES: { label: 'Academic Impact', icon: 'ðŸ“„', relations: [] },
    DEMO_OF: { label: 'Live Demos', icon: 'ðŸš€', relations: [] },
    EXPLAINS: { label: 'Knowledge Mesh', icon: 'ðŸ’¡', relations: [] },
    FEATURED_IN: { label: 'Highlights', icon: 'ðŸŒŸ', relations: [] },
    ALTERNATIVE: { label: 'Alternatives', icon: 'ðŸ”„', relations: [] },
    KNOWLEDGE: { label: 'Technical Articles', icon: 'ðŸŽ“', relations: [] },
    REPORT: { label: 'Intelligence Reports', icon: 'ðŸ“°', relations: [] },
    RELATED: { label: 'Associations', icon: 'ðŸ”—', relations: [] }
};

const seenTargetsGlobal = new Set();
const renderedNodes = Astro.locals.meshRenderedNodes || new Set();

relations.forEach(rel => {
    if (!rel || !rel.target_id) return;
    const type = rel.relation_type || 'RELATED';
    const targetId = stripPrefix(rel.target_id);
    if (renderedNodes.has(targetId) && !['knowledge', 'report'].includes(rel.target_type || '')) return;

    let catKey = type;
    if (rel.target_type === 'knowledge') catKey = 'KNOWLEDGE';
    if (rel.target_type === 'report') catKey = 'REPORT';

    const cat = categories[catKey] || categories['RELATED'];
    if (!cat) return;
    
    const catCheckKey = `${type}|${targetId}`;
    if (seenTargetsGlobal.has(catCheckKey)) return;
    seenTargetsGlobal.add(catCheckKey);
    cat.relations.push(rel);
});

const activeCategories = Object.entries(categories).filter(([_, cat]) => cat.relations.length > 0);

const typeIcons: Record<string, string> = {
    model: 'ðŸ§ ',
    agent: 'ðŸ¤–',
    dataset: 'ðŸ“Š',
    paper: 'ðŸ“„',
    space: 'ðŸŽ®',
    tool: 'ðŸ”§',
    knowledge: 'ðŸ’¡',
    report: 'ðŸ“…'
};
---

{activeCategories.length > 0 && (
    <div class="space-y-12">
        {activeCategories.map(([_, group]) => (
            <div class="animate-fade-in">
                <div class="flex items-center gap-3 mb-6 pb-2 border-b border-zinc-100 dark:border-zinc-800">
                    <span class="text-xl">{group.icon}</span>
                    <h4 class="text-xs font-black text-zinc-900 dark:text-white uppercase tracking-[0.2em]">{group.label}</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-3" id={`relation-grid-${group.label.replace(/\s+/g, '-')}`}>
                    {group.relations.slice(0, 12).map((rel, index) => (
                        <a 
                            href={getRouteFromId(rel.target_id, rel.target_type)}
                            class={`group flex items-center justify-between p-2.5 bg-zinc-50 dark:bg-zinc-900/40 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:border-indigo-500 transition-colors`}
                        >
                            <div class="flex items-center gap-3 min-w-0">
                                <div class="w-8 h-8 flex items-center justify-center bg-white dark:bg-zinc-800 rounded-md border border-zinc-100 dark:border-zinc-700 shadow-sm group-hover:scale-110 transition-transform">
                                   <span class="text-lg grayscale group-hover:grayscale-0 transition-all">{typeIcons[rel.target_type] || 'ðŸ“Ž'}</span>
                                </div>
                                <div class="flex flex-col min-w-0">
                                    <span class="text-xs font-black text-zinc-800 dark:text-zinc-200 truncate tracking-tight">
                                        {rel.target_name || stripPrefix(rel.target_id).split('--').pop()?.replace(/-/g, ' ')}
                                    </span>
                                    <div class="flex items-center gap-1.5">
                                       <span class="text-[8px] font-black text-zinc-400 dark:text-zinc-500 uppercase tracking-widest">{rel.target_type}</span>
                                       {rel.confidence > 0.8 && rel.relation_type !== 'ALTERNATIVE' && <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 border border-emerald-400/30" title="Nexus Verified Relation"></span>}
                                       {rel.relation_type === 'ALTERNATIVE' && (
                                           <div class="flex items-center gap-1 bg-indigo-50 dark:bg-indigo-950/30 px-1 rounded-sm border border-indigo-100/50 dark:border-indigo-900/30">
                                               <span class="text-[7px] font-black text-indigo-500 dark:text-indigo-400 uppercase">Match {Math.round(rel.confidence * 100)}%</span>
                                               <span class="text-[7px]" title="Algorithmic Cluster Match">ðŸ¤–</span>
                                           </div>
                                       )}
                                    </div>
                                </div>
                            </div>
                            <span class="text-zinc-300 group-hover:text-indigo-500 transition-colors text-xs">â†’</span>
                        </a>
                    ))}
                </div>

                {group.relations.length > 4 && (
                    <button 
                        class="show-more-relations-btn mt-4 w-full py-2 border border-dashed border-zinc-200 dark:border-zinc-800 rounded-lg text-[9px] font-black uppercase tracking-widest text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all flex items-center justify-center gap-2"
                        data-target={`relation-grid-${group.label.replace(/\s+/g, '-')}`}
                    >
                        <span>ðŸ“¦</span>
                        <span>View {group.relations.length - 4} More Nodes in this Hive</span>
                    </button>
                )}
            </div>
        ))}
    </div>
)}

<script is:inline>
    function initRelationFolding() {
        const buttons = document.querySelectorAll('.show-more-relations-btn');
        buttons.forEach(btn => {
            btn.onclick = () => {
                const targetId = btn.dataset.target;
                const grid = document.getElementById(targetId);
                if (grid) {
                    const extra = grid.querySelectorAll('.extra-relation');
                    extra.forEach(el => el.classList.toggle('hidden'));
                    const isHidden = extra[0].classList.contains('hidden');
                    btn.textContent = isHidden ? `+ View ${extra.length} Additional Nodes` : '- Collapse View';
                }
            };
        });
    }
    initRelationFolding();
    document.addEventListener('astro:after-swap', initRelationFolding);
</script>
