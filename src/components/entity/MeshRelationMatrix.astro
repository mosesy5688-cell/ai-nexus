---
/**
 * MeshRelationMatrix.astro
 * V16.2 Knowledge Mesh Visualization
 * Groups and displays bidirectional relations between AI nodes.
 */
import { stripPrefix, getRouteFromId } from '../../utils/knowledge-cache-reader.js';

interface Relation {
    target_id: string;
    target_name?: string;
    relation_type: string;
    confidence: number;
    target_type: string;
}

interface Props {
    relations: Relation[];
    entityId: string;
}

const { relations = [], entityId } = Astro.props;

// Categorize relations by their semantic meaning
const categories: Record<string, { label: string, icon: string, relations: Relation[] }> = {
    STACK: { label: 'Technical Stack', icon: 'ðŸ› ï¸', relations: [] },
    BASED_ON: { label: 'Lineage', icon: 'ðŸ§¬', relations: [] },
    USES: { label: 'Dependencies', icon: 'ðŸ”Œ', relations: [] },
    TRAINED_ON: { label: 'Knowledge Base', icon: 'ðŸ“š', relations: [] },
    CITES: { label: 'Academic Impact', icon: 'ðŸ“„', relations: [] },
    DEMO_OF: { label: 'Live Demos', icon: 'ðŸš€', relations: [] },
    EXPLAINS: { label: 'Knowledge Mesh', icon: 'ðŸ’¡', relations: [] },
    FEATURED_IN: { label: 'Highlights', icon: 'ðŸŒŸ', relations: [] },
    ALTERNATIVE: { label: 'Alternatives', icon: 'ðŸ”„', relations: [] },
    KNOWLEDGE: { label: 'Knowledge Articles', icon: 'ðŸŽ“', relations: [] },
    REPORT: { label: 'Daily Reports', icon: 'ðŸ“°', relations: [] },
    RELATED: { label: 'Associations', icon: 'ðŸ”—', relations: [] }
};

// Populate categories with target-level de-duplication (V16.4 Stability)
const seenTargetsGlobal = new Set();

// V16.4: Cross-Component Deduplication
const renderedNodes = Astro.locals.meshRenderedNodes || new Set();

relations.forEach(rel => {
    if (!rel || !rel.target_id) return;
    
    const type = rel.relation_type || 'RELATED';
    const targetId = stripPrefix(rel.target_id);
    const normTarget = targetId;
    
    if (renderedNodes.has(normTarget) && !['knowledge', 'report'].includes(rel.target_type || '')) return;

    let catKey = type;
    if (rel.target_type === 'knowledge') catKey = 'KNOWLEDGE';
    if (rel.target_type === 'report') catKey = 'REPORT';

    const cat = categories[catKey] || categories['RELATED'];
    if (!cat) return;
    
    const catCheckKey = `${type}|${targetId}`;
    if (seenTargetsGlobal.has(catCheckKey)) return;
    seenTargetsGlobal.add(catCheckKey);

    cat.relations.push(rel);
});

const activeCategories = Object.entries(categories).filter(([_, cat]) => cat.relations.length > 0);

const typeIcons: Record<string, string> = {
    model: 'ðŸ§ ',
    agent: 'ðŸ¤–',
    dataset: 'ðŸ“Š',
    paper: 'ðŸ“„',
    space: 'ðŸŽ®',
    tool: 'ðŸ”§',
    knowledge: 'ðŸ’¡',
    report: 'ðŸ“…'
};
---

{activeCategories.length > 0 && (
    <div class="mesh-relation-matrix space-y-10">
        {activeCategories.map(([_, group]) => (
            <div class="relation-category animate-fade-in">
                <h4 class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                    <span class="text-lg">{group.icon}</span>
                    {group.label}
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id={`relation-grid-${group.label.replace(/\s+/g, '-')}`}>
                    {group.relations.map((rel, index) => (
                        <a 
                            href={getRouteFromId(rel.target_id, rel.target_type)}
                            class={`group flex items-center justify-between p-4 bg-white dark:bg-gray-800/40 rounded-xl border border-gray-100 dark:border-gray-700/50 hover:border-indigo-400 dark:hover:border-indigo-500/50 hover:shadow-md transition-all duration-300 ${index >= 6 ? 'hidden extra-relation' : ''}`}
                        >
                            <div class="flex items-center gap-3 min-w-0">
                                <span class="text-xl group-hover:scale-125 transition-transform duration-300">
                                    {typeIcons[rel.target_type] || 'ðŸ“Ž'}
                                </span>
                                <div class="flex flex-col truncate">
                                    <span class="font-bold text-gray-900 dark:text-gray-100 truncate text-sm">
                                        {rel.target_name || stripPrefix(rel.target_id).split('--').pop()?.replace(/-/g, ' ')}
                                    </span>
                                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider opacity-60">
                                        {rel.target_type}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                {rel.confidence > 0.9 && (
                                    <span class="flex h-2 w-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.6)]"></span>
                                )}
                                <span class="text-indigo-600 dark:text-indigo-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                </span>
                            </div>
                        </a>
                    ))}
                </div>

                {group.relations.length > 6 && (
                    <button 
                        class="show-more-relations-btn mt-4 text-[11px] font-black uppercase tracking-widest text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 transition-colors flex items-center gap-2"
                        data-target={`relation-grid-${group.label.replace(/\s+/g, '-')}`}
                    >
                        <span>+ View {group.relations.length - 6} More Relations</span>
                    </button>
                )}
            </div>
        ))}
    </div>
)}

<script>
    function initRelationFolding() {
        const buttons = document.querySelectorAll('.show-more-relations-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = (btn as HTMLElement).dataset.target;
                const grid = document.getElementById(targetId!);
                if (grid) {
                    const extra = grid.querySelectorAll('.extra-relation');
                    extra.forEach(el => el.classList.toggle('hidden'));
                    
                    const isHidden = extra[0].classList.contains('hidden');
                    const span = btn.querySelector('span');
                    if (span) {
                        span.textContent = isHidden ? `+ View ${extra.length} More Relations` : '- Show Less';
                    }
                }
            });
        });
    }

    initRelationFolding();
    document.addEventListener('astro:after-swap', initRelationFolding);
</script>
