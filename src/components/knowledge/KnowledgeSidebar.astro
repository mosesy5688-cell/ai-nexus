---
// src/components/knowledge/KnowledgeSidebar.astro
import { getMeshProfile } from '../../utils/mesh-orchestrator';
import { getRouteFromId } from '../../utils/mesh-routing-core';

interface Props {
  slug: string;
  meshTiers?: any;
}

const { slug, meshTiers: propTiers } = Astro.props;
let tiers = propTiers;

// Fallback dynamic fetch if not passed by parent
if (!tiers && slug) {
    try {
        const profile = await getMeshProfile(Astro.locals, `knowledge--${slug}`, null, 'knowledge');
        tiers = profile.tiers;
    } catch (e) {
        console.error('[KnowledgeSidebar] Failed to fetch dynamic mesh:', e);
    }
}

const relatedModels = tiers?.core?.nodes || [];
---

<aside class="used-in-section">
  <h3>ğŸ”— Used In (Models referencing this concept)</h3>
  <p class="used-in-description">
    {relatedModels.length > 0 
      ? `This article is grounded by ${relatedModels.length} models in the ecosystem:` 
      : 'This knowledge base article is referenced by the following model pages:'}
  </p>
  <div class="used-in-grid">
    {relatedModels.length > 0 ? (
      relatedModels.slice(0, 10).map((node: any) => (
        <a href={getRouteFromId(node.id, node.type || 'model')} class="used-in-card">
          {node.icon} {node.name}
        </a>
      ))
    ) : (
      <>
        <a href="/ranking" class="used-in-card">ğŸ” Explore Models</a>
        <a href="/ranking" class="used-in-card">ğŸ† Rankings</a>
        <a href="/knowledge" class="used-in-card">ğŸ“š More Articles</a>
      </>
    )}
  </div>
  
  {relatedModels.length > 0 && (
    <p class="mt-4 text-[10px] text-gray-500 italic">Showing top grounded models from the Knowledge Mesh.</p>
  )}

  <p class="used-in-note">
    ğŸ“– CEO Iron Rule: Each knowledge article must be cited by 3+ entity pages
  </p>
</aside>
