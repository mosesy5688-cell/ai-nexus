---
/**
 * KnowledgeGroundedEntities - V16.2
 * Displays technical entities (models, agents, papers) linked to a knowledge concept.
 */
import { getRouteFromId } from '../../utils/mesh-routing-core.js';

interface Props {
  meshTiers: any;
}

const { meshTiers } = Astro.props;
---

{meshTiers && (
  <div class="mt-12 p-8 bg-indigo-50/50 dark:bg-indigo-900/10 rounded-3xl border border-indigo-100 dark:border-indigo-900/30">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-3">
       <span>ðŸ§¬</span> Grounded Entities
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      {Object.entries(meshTiers).map(([key, tier]: [string, any]) => {
        // Grounded entities should only show models, agents, tools, etc, not other knowledge base articles
        if (key === 'explanation') return null;
        if (tier.nodes.length === 0) return null;
        
        const displayNodes = tier.nodes;
        const hasExtra = displayNodes.length > 8;

        return (
          <div>
            <h3 class="text-xs font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
              <span>{tier.icon}</span>
              {tier.title}
            </h3>
            <ul class="space-y-3 relation-group" data-max="8">
              {displayNodes.map((node: any, index: number) => (
                <li class={`${index >= 8 ? 'hidden extra-rel' : ''}`}>
                  <a href={getRouteFromId(node.id, node.type)} class="group flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 hover:border-indigo-500 transition-all shadow-sm">
                    <div class="flex items-center gap-3">
                       <span class="text-xl filter grayscale group-hover:grayscale-0 transition-all">{node.icon}</span>
                       <span class="text-sm font-bold text-gray-700 dark:text-gray-300 group-hover:text-indigo-600 transition-colors uppercase tracking-tight">{node.name}</span>
                    </div>
                    <span class="text-[10px] font-black text-gray-400 group-hover:text-indigo-500 transition-colors">{node.type.toUpperCase()} â†’</span>
                  </a>
                </li>
              ))}
              {hasExtra && (
                <button class="expand-rels-btn w-full mt-4 py-3 px-4 bg-white/50 dark:bg-gray-800/50 border border-dashed border-gray-200 dark:border-gray-700 rounded-xl text-[10px] font-black uppercase text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all shadow-sm" data-count={displayNodes.length - 8}>
                  + Expand {displayNodes.length - 8} Related {tier.title}
                </button>
              )}
            </ul>
          </div>
        );
      })}
    </div>
  </div>
)}

<script is:inline>
  function initKnowledgeFolding() {
    const buttons = document.querySelectorAll('.expand-rels-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const group = btn.closest('.relation-group');
        if (group) {
          const extra = group.querySelectorAll('.extra-rel');
          extra.forEach(el => el.classList.toggle('hidden'));
          const isHidden = extra[0].classList.contains('hidden');
          const count = btn.dataset.count;
          btn.textContent = isHidden ? `+ Expand ${count} Related Entities` : '- Collapse View';
        }
      });
    });
  }
  initKnowledgeFolding();
  document.addEventListener('astro:after-swap', initKnowledgeFolding);
  document.addEventListener('astro:page-load', initKnowledgeFolding);
</script>
