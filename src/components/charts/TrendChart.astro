---
/**
 * TrendChart Component - V12 Phase 10
 * 
 * Constitution Compliant:
 * - Chart.js renders client-side (no Worker compute)
 * - Data from pre-computed L5 cache
 * - Lightweight (~60KB bundled)
 * 
 * @component
 */

interface Props {
  type?: 'line' | 'bar' | 'doughnut';
  height?: string;
}

const { type = 'line', height = '300px' } = Astro.props;
---

<div class="trend-chart-container" style={`height: ${height}`}>
  <canvas id="trend-chart" class="w-full h-full"></canvas>
</div>

<script>
  import Chart from 'chart.js/auto';
  import { R2_CACHE_URL } from '../../config/constants.ts';
  
  async function initChart() {
    const canvas = document.getElementById('trend-chart') as HTMLCanvasElement;
    if (!canvas) return;
    
    try {
      // V16.32: Adaptive Fetching (V14.4 Zero-Runtime compliant)
      const TREND_URL = `${R2_CACHE_URL}/cache/trend-data.json`;
      const TRENDING_URL = `${R2_CACHE_URL}/cache/trending.json`;
      
      let res = await fetch(TRENDING_URL);
      if (!res.ok) {
          console.warn('[TrendChart] trending.json failed, trying local fallback...');
          res = await fetch('/cache/trending.json');
      }

      if (!res.ok) throw new Error('Trend assets not available');
      
      const trending = await res.json();
      
      // Calculate Ecosystem Distribution (Models vs Agents vs Papers vs etc)
      const stats = {
          models: trending.models?.length || 0,
          agents: trending.agents?.length || 0,
          papers: trending.papers?.length || 0,
          spaces: trending.spaces?.length || 0,
          datasets: trending.datasets?.length || 0
      };

      const labels = ['Models', 'Agents', 'Research Papers', 'Spaces', 'Datasets'];
      const counts = [stats.models, stats.agents, stats.papers, stats.spaces, stats.datasets];
      const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#64748b'];

      // Create distribution chart
      new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Trending Resources Count',
              data: counts,
              backgroundColor: colors,
              borderRadius: 8,
              barThickness: 40
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y', // Horizontal bars look better for labels
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              cornerRadius: 8
            }
          },
          scales: {
            x: {
              grid: { display: false },
              title: {
                 display: true,
                 text: 'Resource Count (Top 1000)'
              }
            },
            y: {
              grid: { display: false }
            }
          }
        }
      });
    } catch (err) {
      console.warn('[TrendChart] Could not load trend data:', err);
      canvas.parentElement!.innerHTML = `
        <div class="flex items-center justify-center h-full text-gray-400">
          <span>ðŸ“Š Trend data loading...</span>
        </div>
      `;
    }
  }
  
  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChart);
  } else {
    initChart();
  }
</script>

<style>
  .trend-chart-container {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  :global(.dark) .trend-chart-container {
    background: rgb(31, 41, 55);
  }
</style>
