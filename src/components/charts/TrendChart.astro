---
/**
 * TrendChart Component - V12 Phase 10
 * 
 * Constitution Compliant:
 * - Chart.js renders client-side (no Worker compute)
 * - Data from pre-computed L5 cache
 * - Lightweight (~60KB bundled)
 * 
 * @component
 */

interface Props {
  type?: 'line' | 'bar' | 'doughnut';
  height?: string;
  minimalist?: boolean; // V16.34: Professional "Clean" mode
  title?: string;
}

const { 
  type = 'bar', 
  height = '300px', 
  minimalist = false,
  title = 'Ecosystem Distribution'
} = Astro.props;
---

<div class={`trend-chart-container ${minimalist ? 'minimalist' : ''}`} style={`height: ${height}`} data-type={type}>
  {title && <h4 class="chart-title">{title}</h4>}
  <canvas id="trend-chart" class="w-full h-full"></canvas>
</div>

<script>
  import Chart from 'chart.js/auto';
  import { R2_CACHE_URL } from '../../config/constants.ts';
  
  async function initChart() {
    const container = document.querySelector('.trend-chart-container') as HTMLElement;
    const canvas = document.getElementById('trend-chart') as HTMLCanvasElement;
    if (!canvas || !container) return;

    const minimalist = container.classList.contains('minimalist');
    
    try {
      const type = container.dataset.type || 'bar';
      const paths = type === 'line' 
        ? [`${R2_CACHE_URL}/cache/trends.json.gz`, `${R2_CACHE_URL}/cache/trends.json`]
        : [`${R2_CACHE_URL}/cache/trending.json.gz`, `${R2_CACHE_URL}/cache/trending.json`];
      
      let res = null;
      let rawData = null;

      for (const p of paths) {
          res = await fetch(p);
          if (res.ok) {
              const isGzip = p.endsWith('.gz');
              // Check if browser already decompressed it (Content-Encoding: gzip)
              const isAlreadyDecompressed = res.headers.get('Content-Encoding') === 'gzip';
              
              if (isGzip && !isAlreadyDecompressed) {
                  try {
                      const ds = new (window as any).DecompressionStream('gzip');
                      const decompressedStream = res.body.pipeThrough(ds);
                      const response = new Response(decompressedStream);
                      rawData = await response.json();
                  } catch (e) {
                      console.warn('[TrendChart] Manual decompression failed:', e);
                      // Fallback: maybe it's actually raw text despite no header
                      const text = await res.text();
                      rawData = JSON.parse(text);
                  }
              } else {
                  rawData = await res.json();
              }
              if (rawData) break;
          }
      }

      if (!rawData) {
          console.warn(`[TrendChart] Fetch failed for ${type}, trying local fallback...`);
          const CDN = 'https://cdn.free2aitools.com';
          const localPaths = type === 'line' ? [`${CDN}/cache/trend-data.json.gz`, `${CDN}/cache/trend-data.json`] : [`${CDN}/cache/trending.json.gz`, `${CDN}/cache/trending.json`];
          for (const lp of localPaths) {
              const res2 = await fetch(lp);
              if (res2.ok) {
                  // Local usually handled by server/vite, but let's be safe
                  rawData = await res2.json();
                  if (rawData) break;
              }
          }
      }

      if (!rawData) throw new Error('Trend assets not available');
      let labels = [];
      let datasets = [];

      if (type === 'line') {
          // Historical View (e.g. Reports Page)
          labels = rawData.weeks || [];
          datasets = [
              {
                  label: rawData.model_count?.label || 'Total Models',
                  data: rawData.model_count?.data || [],
                  borderColor: '#6366f1',
                  backgroundColor: '#6366f120',
                  fill: true,
                  tension: 0.4,
                  pointRadius: 4,
                  pointBackgroundColor: '#6366f1'
              }
          ];
      } else {
          // Distribution View (e.g. Homepage)
          const stats = {
              models: rawData.models?.length || 0,
              agents: rawData.agents?.length || 0,
              papers: rawData.papers?.length || 0,
              spaces: rawData.spaces?.length || 0,
              datasets: rawData.datasets?.length || 0
          };

          labels = ['Models', 'Agents', 'Papers', 'Spaces', 'Datasets'];
          const counts = [stats.models, stats.agents, stats.papers, stats.spaces, stats.datasets];
          
          const colors = minimalist 
            ? ['#6366f190', '#8b5cf690', '#10b98190', '#f59e0b90', '#64748b90']
            : ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#64748b'];

          datasets = [
            {
              data: counts,
              backgroundColor: colors,
              borderRadius: 6,
              barThickness: minimalist ? 20 : 35
            }
          ];
      }

      new Chart(canvas, {
        type: type as any,
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: type === 'bar' ? 'y' : 'x',
          plugins: {
            legend: { display: type === 'line' },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              padding: 12,
              cornerRadius: 8,
              titleFont: { size: 12, weight: 'bold' },
              bodyFont: { size: 11 }
            }
          },
          scales: {
            x: {
              display: true,
              grid: { display: false },
              ticks: { color: '#94a3b8', font: { size: 10 } }
            },
            y: {
              grid: { 
                display: type === 'line',
                color: 'rgba(148, 163, 184, 0.1)' 
              },
              ticks: { 
                color: minimalist ? '#64748b' : '#475569', 
                font: { size: minimalist ? 11 : 12, weight: '500' } 
              }
            }
          }
        }
      });
    } catch (err) {
      console.warn('[TrendChart] Could not load trend data:', err);
      container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400 text-xs uppercase tracking-widest font-bold">Pulse Synchronizing...</div>`;
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChart);
  } else {
    initChart();
  }
</script>

<style>
  .trend-chart-container {
    background: transparent;
    padding: 1rem;
    position: relative;
  }
  
  .chart-title {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #94a3b8;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chart-title::before {
    content: '‚óè';
    color: #10b981;
    font-size: 8px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
  }

  .trend-chart-container.minimalist {
    padding: 0;
  }

  .trend-chart-container.minimalist .chart-title {
    margin-bottom: 1rem;
  }
</style>
