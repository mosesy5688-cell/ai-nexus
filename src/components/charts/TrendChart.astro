---
/**
 * TrendChart Component - V12 Phase 10
 * 
 * Constitution Compliant:
 * - Chart.js renders client-side (no Worker compute)
 * - Data from pre-computed L5 cache
 * - Lightweight (~60KB bundled)
 * 
 * @component
 */

interface Props {
  type?: 'line' | 'bar' | 'doughnut';
  height?: string;
  minimalist?: boolean; // V16.34: Professional "Clean" mode
  title?: string;
}

const { 
  type = 'bar', 
  height = '300px', 
  minimalist = false,
  title = 'Ecosystem Distribution'
} = Astro.props;
---

<div class={`trend-chart-container ${minimalist ? 'minimalist' : ''}`} style={`height: ${height}`}>
  {title && <h4 class="chart-title">{title}</h4>}
  <canvas id="trend-chart" class="w-full h-full"></canvas>
</div>

<script>
  import Chart from 'chart.js/auto';
  import { R2_CACHE_URL } from '../../config/constants.ts';
  
  async function initChart() {
    const container = document.querySelector('.trend-chart-container') as HTMLElement;
    const canvas = document.getElementById('trend-chart') as HTMLCanvasElement;
    if (!canvas || !container) return;

    const minimalist = container.classList.contains('minimalist');
    
    try {
      const TRENDING_URL = `${R2_CACHE_URL}/cache/trending.json`;
      
      let res = await fetch(TRENDING_URL);
      if (!res.ok) {
          console.warn('[TrendChart] trending.json failed, trying local fallback...');
          res = await fetch('/cache/trending.json');
      }

      if (!res.ok) throw new Error('Trend assets not available');
      
      const trending = await res.json();
      
      const stats = {
          models: trending.models?.length || 0,
          agents: trending.agents?.length || 0,
          papers: trending.papers?.length || 0,
          spaces: trending.spaces?.length || 0,
          datasets: trending.datasets?.length || 0
      };

      const labels = ['Models', 'Agents', 'Papers', 'Spaces', 'Datasets'];
      const counts = [stats.models, stats.agents, stats.papers, stats.spaces, stats.datasets];
      
      // Professional Muted Palette
      const colors = minimalist 
        ? ['#6366f190', '#8b5cf690', '#10b98190', '#f59e0b90', '#64748b90']
        : ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#64748b'];

      new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              data: counts,
              backgroundColor: colors,
              borderRadius: 6,
              barThickness: minimalist ? 20 : 35
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              padding: 12,
              cornerRadius: 8,
              titleFont: { size: 12, weight: 'bold' },
              bodyFont: { size: 11 }
            }
          },
          scales: {
            x: {
              display: !minimalist,
              grid: { display: false },
              ticks: { color: '#94a3b8', font: { size: 10 } }
            },
            y: {
              grid: { display: false },
              ticks: { 
                color: minimalist ? '#64748b' : '#475569', 
                font: { size: minimalist ? 11 : 12, weight: '500' } 
              }
            }
          }
        }
      });
    } catch (err) {
      console.warn('[TrendChart] Could not load trend data:', err);
      container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400 text-xs uppercase tracking-widest font-bold">Pulse Synchronizing...</div>`;
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChart);
  } else {
    initChart();
  }
</script>

<style>
  .trend-chart-container {
    background: transparent;
    padding: 1rem;
    position: relative;
  }
  
  .chart-title {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #94a3b8;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chart-title::before {
    content: '‚óè';
    color: #10b981;
    font-size: 8px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
  }

  .trend-chart-container.minimalist {
    padding: 0;
  }

  .trend-chart-container.minimalist .chart-title {
    margin-bottom: 1rem;
  }
</style>
