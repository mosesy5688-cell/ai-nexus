---
// src/components/ModelCard.astro
// V3.1 Phase 4: Enhanced with VRAM, Size, Active Status
// Optimized: text-focused, extended description, simpler design
// V5.0.0: CES-001 Clean URL format
import { generateEntityUrl } from '../utils/url-utils.js';

const { model, isRisingStar } = Astro.props;

// Generate clean URL without source prefix or encoding
const modelUrl = generateEntityUrl(model, 'model');
const description = model.seo_summary || model.description?.replace(/<[^>]*>?/gm, '') || 'No description available.';

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num || 0;
}

function getSourceIcon(source) {
    switch(source?.toLowerCase()) {
        case 'huggingface': return 'ü§ó';
        case 'github': return '‚≠ê';
        case 'pytorch': return 'üî•';
        default: return 'üì¶';
    }
}

function getSourceLabel(source) {
    switch(source?.toLowerCase()) {
        case 'huggingface': return 'Hugging Face';
        case 'github': return 'GitHub';
        case 'pytorch': return 'PyTorch';
        default: return 'Source';
    }
}

// Parse tags if string
const tagsArray = typeof model.tags === 'string' ? JSON.parse(model.tags || '[]') : (model.tags || []);

// V3.1 Phase 4: Parse extended metadata
let meta = {};
try { 
    meta = typeof model.meta_json === 'string' ? JSON.parse(model.meta_json || '{}') : (model.meta_json || {}); 
} catch (e) { meta = {}; }
const ext = meta.extended || {};

// V3.1 Phase 4: VRAM Calculation (params_billions ‚Üí VRAM estimate)
const params = ext.params_billions || 0;
const hasQuant = (ext.quantizations?.length || 0) > 0;
const vram = params ? Math.ceil(hasQuant ? (params * 0.6 + 2) : (params * 2.2 + 4)) : null;

// V3.1 Phase 4: Size Tag
const sizeTag = params ? (params >= 1 ? `${params}B` : `${Math.round(params*1000)}M`) : null;

// V3.1 Phase 4: Active Status (updated within 30 days)
const lastUpdate = new Date(model.last_updated || model.lastModified || 0);
const daysSinceUpdate = (Date.now() - lastUpdate.getTime()) / (1000 * 3600 * 24);
const isActive = daysSinceUpdate <= 30 && lastUpdate.getTime() > 0;
---

<a href={modelUrl} class="group block bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden h-full border border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600">
    <div class="p-5 flex flex-col h-full">
        <!-- Header: Source + Active + Rising Star -->
        <div class="flex items-center justify-between mb-3">
            <span class="inline-flex items-center gap-1.5 text-xs text-gray-500 dark:text-gray-400">
                <span>{getSourceIcon(model.source)}</span>
                <span>{getSourceLabel(model.source)}</span>
                {isActive && (
                    <span class="w-2 h-2 rounded-full bg-green-500 ring-2 ring-green-200 dark:ring-green-900" title="Active (updated within 30 days)"></span>
                )}
            </span>
            <div class="flex items-center gap-2">
                {isRisingStar && (
                    <span class="text-xs bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 px-2 py-0.5 rounded-full font-medium">
                        üî• Rising
                    </span>
                )}
            </div>
        </div>

        <!-- V12 Phase 9: FNI Percentile Badge -->
        {model.fni_score > 0 && (
            <div class="flex items-center gap-2 mb-2">
                <span class={`text-xs font-bold px-2 py-0.5 rounded-full ${
                    (model.fni_percentile === 'top_0.1%' || model.fni_percentile === 'top_1%') ? 'bg-gradient-to-r from-yellow-400 to-amber-500 text-white' :
                    (model.fni_percentile === 'top_5%' || model.fni_percentile === 'top_10%') ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white' :
                    model.fni_percentile === 'top_25%' ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white' :
                    model.fni_score >= 60 ? 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' :
                    'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300'
                }`} title={`FNI Score: ${model.fni_score?.toFixed?.(1) || model.fni_score}`}>
                    üõ°Ô∏è {model.fni_percentile?.startsWith?.('top_') ? 
                        model.fni_percentile.replace('top_', 'Top ').replace('%', '%') : 
                        `FNI ${Math.round(model.fni_score)}`}
                </span>
            </div>
        )}

        <!-- V3.1 Phase 4: Size + VRAM Badges -->
        {(sizeTag || vram) && (
            <div class="flex flex-wrap gap-2 mb-2">
                {sizeTag && (
                    <span class="text-xs font-mono font-bold px-2 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded">
                        {sizeTag}
                    </span>
                )}
                {vram && (
                    <span class={`text-xs font-bold px-2 py-0.5 rounded ${vram <= 12 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : vram <= 24 ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'}`} title={hasQuant ? 'Quantized estimate' : 'Full precision estimate'}>
                        üíæ {vram}GB VRAM
                    </span>
                )}
            </div>
        )}

        <!-- Model Name -->
        <h3 class="text-lg font-bold text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors mb-1" title={model.name}>
            {model.name}
        </h3>
        
        <!-- Author + Pipeline Tag -->
        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mb-3">
            <span>by {model.author}</span>
            {model.pipeline_tag && (
                <span class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-gray-600 dark:text-gray-300">
                    {model.pipeline_tag}
                </span>
            )}
        </div>

        <!-- Description (Zero-Limit: Managed via CSS line-clamp) -->
        <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed line-clamp-4 flex-grow">
            {description}
        </p>

        <!-- Footer: Tags + Stats -->
        <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
            <!-- Tags (up to 2) -->
            {tagsArray.length > 0 && (
                <div class="flex flex-wrap gap-1 mb-2">
                    {tagsArray.map((tag) => (
                        <span class="text-xs px-2 py-0.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full">
                            {tag}
                        </span>
                    ))}
                </div>
            )}
            
            <!-- Stats -->
            <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                <div class="flex items-center gap-1" title={`${(model.likes || 0).toLocaleString()} likes`}>
                    ‚ù§Ô∏è <span class="font-medium">{formatNumber(model.likes)}</span>
                </div>
                <div class="flex items-center gap-1" title={`${(model.downloads || 0).toLocaleString()} downloads`}>
                    üì• <span class="font-medium">{formatNumber(model.downloads)}</span>
                </div>
                {model.github_stars > 0 && (
                    <div class="flex items-center gap-1" title={`${model.github_stars.toLocaleString()} GitHub stars`}>
                        ‚≠ê <span class="font-medium">{formatNumber(model.github_stars)}</span>
                    </div>
                )}
            </div>
        </div>
    </div>
</a>