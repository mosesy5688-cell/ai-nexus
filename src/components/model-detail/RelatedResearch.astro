---
/**
 * RelatedResearch Component - B.7 Knowledge Linking UI
 * Displays entity relations from D1:
 * - Research Papers (paper_id relations)
 * - Related Models (base_model/variant relations)
 * - Training Datasets (dataset_id relations)
 * 
 * @component
 */

interface Props {
  modelId: string;
}

const { modelId } = Astro.props;
import { R2_CACHE_URL } from '../../config/constants.ts';

import { getRouteFromId, stripPrefix } from '../../utils/mesh-routing-core.js';

interface Relation {
  source_id: string;
  target_id: string;
  relation_type: string;
  confidence: number;
}

interface RelationsResponse {
  entity_id: string;
  relations: Relation[];
  count: number;
}

let relations: Relation[] = [];
let paperRelations: Relation[] = [];
let baseModelRelations: Relation[] = [];
let variantRelations: Relation[] = [];
let datasetRelations: Relation[] = [];

try {
  // V16.33: CDN-First Resilient Fetch
  // V18.12: Prefers fused data if available
  const normalizedId = modelId.replace(/:/g, '--');
  const cdnUrl = `${R2_CACHE_URL}/cache/relations/${normalizedId}.json`;
  
  const response = await fetch(cdnUrl);
  if (response.ok) {
    const data: RelationsResponse = await response.json();
    relations = data.relations || [];
    
    // Group by type using standardized routing
    paperRelations = relations.filter(r => r.relation_type === 'paper_id' || r.target_id.includes('paper'));
    baseModelRelations = relations.filter(r => r.relation_type === 'base_model');
    variantRelations = relations.filter(r => r.relation_type === 'variant' && r.source_id === modelId);
    datasetRelations = relations.filter(r => r.relation_type === 'dataset_id');
  }
} catch (e) {
  console.error('Failed to fetch relations:', e);
}

const hasContent = paperRelations.length > 0 || baseModelRelations.length > 0 || variantRelations.length > 0 || datasetRelations.length > 0;
---

{hasContent && (
  <section class="related-research mt-8 bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-zinc-100 dark:border-zinc-700">
    <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white flex items-center gap-2">
      <span>ğŸ”—</span> Knowledge Context & Lineage
    </h2>
    
    {paperRelations.length > 0 && (
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ“„ Research Papers
        </h3>
        <div class="flex flex-wrap gap-2">
          {paperRelations.map(rel => (
            <a 
              href={getRouteFromId(rel.target_id, 'paper')}
              class="inline-flex items-center gap-1 px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-sm hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors"
            >
              ğŸ“„ {stripPrefix(rel.target_id)}
            </a>
          ))}
        </div>
      </div>
    )}
    
    {baseModelRelations.length > 0 && (
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ§¬ Based On
        </h3>
        <div class="flex flex-wrap gap-2">
          {baseModelRelations.map(rel => (
            <a 
              href={getRouteFromId(rel.target_id, 'model')}
              class="inline-flex items-center px-3 py-1 bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-200 rounded-full text-sm hover:bg-zinc-200 transition-colors"
            >
              {stripPrefix(rel.target_id)}
            </a>
          ))}
        </div>
      </div>
    )}
    
    {variantRelations.length > 0 && (
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ”€ Variants
        </h3>
        <div class="flex flex-wrap gap-2">
          {variantRelations.map(rel => {
            const name = stripPrefix(rel.target_id).split('--').pop() || '';
            return (
              <a 
                href={getRouteFromId(rel.target_id, 'model')}
                class="inline-flex items-center gap-2 px-3 py-1 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-full text-sm hover:bg-emerald-100 transition-colors"
              >
                <span>{name}</span>
              </a>
            );
          })}
        </div>
      </div>
    )}
                <span>{name}</span>
                {vramEst && (
                  <span class="text-xs bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-300 px-1.5 py-0.5 rounded">
                    ~{vramEst}GB
                  </span>
                )}
              </a>
            );
          })}
        </div>
        <!-- V12: Explore Same Family button -->
        {baseModels.length > 0 && (
          <a 
            href={getRouteFromId(baseModels[0], 'model')}
            class="inline-flex items-center gap-1 mt-3 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all shadow-sm"
          >
            <span>ğŸ”</span> View Base Model
          </a>
        )}
      </div>
    )}
    
    {datasets.length > 0 && (
      <div>
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ“Š Training Data
        </h3>
        <div class="flex flex-wrap gap-2">
          {datasets.map(datasetId => (
            <a 
              href={getRouteFromId(datasetId, 'dataset')}
              class="inline-flex items-center gap-1 px-3 py-1 bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-full text-sm hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-colors"
            >
              {stripPrefix(datasetId)}
            </a>
          ))}
        </div>
      </div>
    )}
  </section>
)}
