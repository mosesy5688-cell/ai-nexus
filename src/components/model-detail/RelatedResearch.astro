---
/**
 * RelatedResearch Component - B.7 Knowledge Linking UI
 * Displays entity relations from D1:
 * - Research Papers (paper_id relations)
 * - Related Models (base_model/variant relations)
 * - Training Datasets (dataset_id relations)
 * 
 * @component
 */

interface Props {
  modelId: string;
}

const { modelId } = Astro.props;

interface Relation {
  source_id: string;
  target_id: string;
  relation_type: string;
  confidence: number;
}

interface RelationsResponse {
  entity_id: string;
  relations: Relation[];
  count: number;
}

let relations: Relation[] = [];
let papers: string[] = [];
let baseModels: string[] = [];
let variants: string[] = [];
let datasets: string[] = [];

try {
  // Fetch relations from API
  const apiUrl = import.meta.env.DEV 
    ? `http://localhost:8787/api/relations/${encodeURIComponent(modelId)}`
    : `https://free2aitools.com/api/relations/${encodeURIComponent(modelId)}`;
  
  const response = await fetch(apiUrl);
  if (response.ok) {
    const data: RelationsResponse = await response.json();
    relations = data.relations || [];
    
    // Group by type
    papers = relations
      .filter(r => r.relation_type === 'paper_id')
      .map(r => r.target_id.replace('arxiv:', ''));
    
    baseModels = relations
      .filter(r => r.relation_type === 'base_model')
      .map(r => r.target_id.replace('base:', ''));
    
    variants = relations
      .filter(r => r.relation_type === 'variant' && r.source_id === modelId)
      .map(r => r.target_id);
    
    datasets = relations
      .filter(r => r.relation_type === 'dataset_id')
      .map(r => r.target_id.replace('dataset:', ''));
  }
} catch (e) {
  console.error('Failed to fetch relations:', e);
}

const hasContent = papers.length > 0 || baseModels.length > 0 || variants.length > 0 || datasets.length > 0;
---

{hasContent && (
  <section class="related-research mt-8 bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
    <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white flex items-center gap-2">
      <span>ğŸ”—</span> Knowledge Links
    </h2>
    
    {papers.length > 0 && (
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ“„ Research Papers
        </h3>
        <div class="flex flex-wrap gap-2">
          {papers.map(paperId => (
            <a 
              href={`/paper/${paperId}`}
              class="inline-flex items-center gap-1 px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-sm hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors"
            >
              ğŸ“„ arXiv:{paperId}
            </a>
          ))}
        </div>
      </div>
    )}
    
    {baseModels.length > 0 && (
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ”€ Based On
        </h3>
        <div class="flex flex-wrap gap-2">
          {baseModels.map(baseName => (
            <span class="inline-flex items-center px-3 py-1 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full text-sm">
              {baseName}
            </span>
          ))}
        </div>
      </div>
    )}
    
    {variants.length > 0 && (
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ”€ Variants
        </h3>
        <div class="flex flex-wrap gap-2">
          {variants.map(variantId => {
            const name = variantId.split(':').pop() || '';
            // V12: Extract size from name pattern (7b, 70b, etc.)
            const sizeMatch = name.match(/(\d+\.?\d*)b/i);
            const sizeB = sizeMatch ? parseFloat(sizeMatch[1]) : null;
            const vramEst = sizeB ? Math.ceil(sizeB * 0.6 + 2) : null;
            return (
              <a 
                href={`/model/${variantId.replace('huggingface:', '').replace(/:/g, '/')}`}
                class="inline-flex items-center gap-2 px-3 py-1 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-sm hover:bg-green-100 dark:hover:bg-green-900/50 transition-colors"
              >
                <span>{name}</span>
                {vramEst && (
                  <span class="text-xs bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-300 px-1.5 py-0.5 rounded">
                    ~{vramEst}GB
                  </span>
                )}
              </a>
            );
          })}
        </div>
        <!-- V12: Explore Same Family button -->
        {baseModels.length > 0 && (
          <a 
            href={`/models?q=${encodeURIComponent(baseModels[0])}`}
            class="inline-flex items-center gap-1 mt-3 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all shadow-sm"
          >
            <span>ğŸ”</span> Explore Same Family
          </a>
        )}
      </div>
    )}
    
    {datasets.length > 0 && (
      <div>
        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">
          ğŸ“Š Training Data
        </h3>
        <div class="flex flex-wrap gap-2">
          {datasets.map(datasetId => (
            <a 
              href={datasetId.includes('/') 
                ? `https://huggingface.co/datasets/${datasetId}`
                : `/datasets/${datasetId}`}
              target={datasetId.includes('/') ? "_blank" : "_self"}
              rel={datasetId.includes('/') ? "noopener noreferrer" : undefined}
              class="inline-flex items-center gap-1 px-3 py-1 bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-full text-sm hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-colors"
            >
              {datasetId}
              {datasetId.includes('/') && (
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              )}
            </a>
          ))}
        </div>
      </div>
    )}
  </section>
)}
