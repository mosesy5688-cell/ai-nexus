---
/**
 * MarkdownRenderer.astro
 * 
 * B.6: Full README Display Component
 * Supports GFM Markdown + Images + Syntax Highlighting via 'marked'
 * 
 * @component
 */
import { marked } from 'marked';

interface Props {
  content: string;
  maxLength?: number;
  className?: string;
}

const { content, maxLength, className = '' } = Astro.props;

// Clean and prepare content
let processedContent = content || '';

// Remove YAML frontmatter if present (V15.8: Resilient Regex)
processedContent = processedContent.replace(/^---\s*[\s\S]*?---\s*\n?/g, '');

// Apply max length if specified
if (maxLength && processedContent.length > maxLength) {
  processedContent = processedContent.substring(0, maxLength) + '...';
}

// Convert markdown to HTML (server-side)
const renderedHtml = await marked.parse(processedContent);
---

<div class={`markdown-content prose prose-slate dark:prose-invert max-w-none 
            prose-headings:font-bold prose-a:text-indigo-600 dark:prose-a:text-indigo-400
            prose-pre:bg-[#0a0a0a] prose-pre:border prose-pre:border-gray-800
            prose-img:rounded-xl prose-img:shadow-lg ${className}`}
     set:html={renderedHtml}
/>

<script>
  // Simplified copy for markdown blocks
  function initMarkdownCopy() {
    document.querySelectorAll('.markdown-copy-btn').forEach(btn => {
      // Avoid double listeners if script runs multiple times
      if (btn.getAttribute('data-init')) return;
      btn.setAttribute('data-init', 'true');

      btn.addEventListener('click', async () => {
        const b = btn as HTMLButtonElement;
        const code = b.dataset.code || '';
        const text = b.querySelector('.btn-text');
        const icon = b.querySelector('.btn-icon');
        
        try {
            await navigator.clipboard.writeText(code);
            if (text) text.textContent = 'Done!';
            if (icon) icon.textContent = 'âœ…';
            
            setTimeout(() => {
              if (text) text.textContent = 'Copy';
              if (icon) icon.textContent = 'ðŸ“‹';
            }, 2000);
        } catch (err) {
            console.error('Copy failed', err);
        }
      });
    });
  }

  // V16.2: Smart Tooltips Logic
  const KNOWLEDGE_TERMS: Record<string, string> = {
    'MMLU': 'Massive Multitask Language Understanding - a benchmark for general intelligence.',
    'HumanEval': 'Coding benchmark by OpenAI to test Python generation capabilities.',
    'RAG': 'Retrieval-Augmented Generation - connecting LLMs to external data sources.',
    'Quantization': 'Compression technique (GGUF/AWQ) to run large models on consumer GPUs.',
    'VRAM': 'Video RAM - the memory required on your GPU to load model weights.',
    'Context Length': 'The maximum number of tokens a model can process in one go.',
    'FNI': 'Fair Nexus Index - our proprietary trust and transparency score.',
    'Transformer': 'The core neural network architecture behind all modern LLMs.'
  };

  function initSmartTooltips() {
    const containers = document.querySelectorAll('.markdown-content');
    containers.forEach(container => {
      if (container.getAttribute('data-tooltips') === 'true') return;
      
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null);
      let nodesToReplace = [];
      let currentNode;

      while (currentNode = walker.nextNode()) {
        const text = currentNode.textContent || '';
        let hasMatch = false;
        
        Object.keys(KNOWLEDGE_TERMS).forEach(term => {
          if (new RegExp(`\\b${term}\\b`, 'i').test(text)) {
            hasMatch = true;
          }
        });

        if (hasMatch && currentNode.parentElement?.tagName !== 'A' && currentNode.parentElement?.tagName !== 'CODE') {
          nodesToReplace.push(currentNode);
        }
      }

      nodesToReplace.forEach(node => {
        let text = node.textContent || '';
        let html = text;
        
        Object.entries(KNOWLEDGE_TERMS).forEach(([term, desc]) => {
          const regex = new RegExp(`\\b(${term})\\b`, 'gi');
          html = html.replace(regex, `<span class="knowledge-tooltip cursor-help border-b border-dotted border-indigo-400/50 text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 transition-colors" title="${desc}">$1</span>`);
        });

        if (html !== text) {
          const span = document.createElement('span');
          span.innerHTML = html;
          node.parentNode?.replaceChild(span, node);
        }
      });
      
      container.setAttribute('data-tooltips', 'true');
    });
  }

  // Initial load
  initMarkdownCopy();
  initSmartTooltips();
  
  // Run on page transition if needed (Astro View Transitions)
  document.addEventListener('astro:after-swap', () => {
    initMarkdownCopy();
    initSmartTooltips();
  });
</script>

<style>
  .markdown-content :global(pre) {
    max-height: 500px;
    overflow-y: auto;
  }
  
  .markdown-content :global(code) {
    font-family: 'Fira Code', 'JetBrains Mono', monospace;
  }

  .markdown-content :global(.scrollbar-thin::-webkit-scrollbar) {
    height: 4px;
    width: 4px;
  }
  .markdown-content :global(.scrollbar-thin::-webkit-scrollbar-thumb) {
    background-color: #444;
    border-radius: 4px;
  }
  
  .markdown-content :global(img) {
    max-height: 500px;
    object-fit: contain;
  }
  
  .markdown-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
  }
  
  .markdown-content :global(th),
  .markdown-content :global(td) {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: left;
  }
  
  .markdown-content :global(th) {
    background: #f3f4f6;
    font-weight: 600;
  }
  
  :global(.dark) .markdown-content :global(th) {
    background: #374151;
  }
  
  :global(.dark) .markdown-content :global(th),
  :global(.dark) .markdown-content :global(td) {
    border-color: #4b5563;
  }

  /* Tooltip Styles */
  .markdown-content :global(.knowledge-tooltip) {
    position: relative;
    text-decoration: none;
  }
</style>
