---
/**
 * MarkdownRenderer.astro
 * 
 * B.6: Full README Display Component
 * Supports Markdown + Images + Syntax Highlighting
 * 
 * @component
 */

interface Props {
  content: string;
  maxLength?: number;
  className?: string;
}

const { content, maxLength, className = '' } = Astro.props;

// Clean and prepare content
let processedContent = content || '';

// Remove YAML frontmatter if present (V15.8: Resilient Regex)
processedContent = processedContent.replace(/^---\s*[\s\S]*?---\s*\n?/g, '');

// Apply max length if specified
if (maxLength && processedContent.length > maxLength) {
  processedContent = processedContent.substring(0, maxLength) + '...';
}

// Convert basic markdown to HTML (server-side)
// Note: For full markdown parsing, consider marked or remark
function simpleMarkdownToHtml(md: string): string {
  let html = md;
  
  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3 class="text-lg font-semibold mt-6 mb-3 text-gray-900 dark:text-white">$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold mt-8 mb-4 text-gray-900 dark:text-white">$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold mt-8 mb-4 text-gray-900 dark:text-white">$1</h1>');
  
  // Bold and italic
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  
  // Code blocks (triple backticks)
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    const langClass = lang ? `language-${lang}` : '';
    const cleanCode = code.trim();
    return `
      <div class="code-block-wrapper relative group my-6 rounded-xl overflow-hidden border border-gray-800 shadow-2xl bg-black">
        <div class="flex items-center justify-between px-4 py-1.5 bg-[#0a0a0a] border-b border-gray-800">
          <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest font-mono">${lang || 'code'}</span>
          <button 
            class="markdown-copy-btn flex items-center gap-1 px-2 py-0.5 bg-gray-800 hover:bg-white text-gray-400 hover:text-black text-[10px] font-bold rounded transition-all active:scale-95"
            data-code="${escapeHtml(cleanCode)}"
          >
            <span class="btn-icon">ðŸ“‹</span>
            <span class="btn-text">Copy</span>
          </button>
        </div>
        <pre class="p-4 overflow-x-auto text-sm scrollbar-thin scrollbar-thumb-gray-800 m-0"><code class="${langClass} text-white selection:bg-indigo-500/30">${escapeHtml(cleanCode)}</code></pre>
      </div>
    `;
  });
  
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code class="bg-black text-indigo-300 px-1.5 py-0.5 rounded text-sm border border-gray-800 font-mono shadow-sm">$1</code>');
  
  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-indigo-600 dark:text-indigo-400 font-bold hover:underline">$1</a>');
  
  // Images
  html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="max-w-full h-auto rounded-xl my-6 shadow-lg border border-gray-100 dark:border-gray-800" loading="lazy" />');
  
  // Lists
  html = html.replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>');
  html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul class="list-disc list-inside space-y-2 my-6 text-gray-700 dark:text-gray-300">$&</ul>');
  
  // Numbered lists
  html = html.replace(/^\d+\. (.+)$/gm, '<li class="ml-4">$1</li>');
  
  // Blockquotes
  html = html.replace(/^> (.+)$/gm, '<blockquote class="border-l-4 border-indigo-500 pl-4 py-1 italic text-gray-600 dark:text-gray-400 my-6 bg-indigo-50/30 dark:bg-indigo-900/10 rounded-r">$1</blockquote>');
  
  // Horizontal rules
  html = html.replace(/^---$/gm, '<hr class="border-gray-200 dark:border-gray-800 my-10" />');
  
  // Paragraphs (double newlines)
  html = html.replace(/\n\n/g, '</p><p class="mb-5 leading-relaxed text-gray-800 dark:text-gray-200">');
  
  // Wrap in paragraph
  if (!html.startsWith('<')) {
    html = '<p class="mb-5 leading-relaxed text-gray-800 dark:text-gray-200">' + html + '</p>';
  }
  
  return html;
}

function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

const renderedHtml = simpleMarkdownToHtml(processedContent);
---

<div class={`markdown-content prose dark:prose-invert max-w-none ${className}`}>
  <Fragment set:html={renderedHtml} />
</div>

<script>
  // Simplified copy for markdown blocks
  function initMarkdownCopy() {
    document.querySelectorAll('.markdown-copy-btn').forEach(btn => {
      // Avoid double listeners if script runs multiple times
      if (btn.getAttribute('data-init')) return;
      btn.setAttribute('data-init', 'true');

      btn.addEventListener('click', async () => {
        const b = btn as HTMLButtonElement;
        const code = b.dataset.code || '';
        const text = b.querySelector('.btn-text');
        const icon = b.querySelector('.btn-icon');
        
        try {
            await navigator.clipboard.writeText(code);
            if (text) text.textContent = 'Done!';
            if (icon) icon.textContent = 'âœ…';
            
            setTimeout(() => {
              if (text) text.textContent = 'Copy';
              if (icon) icon.textContent = 'ðŸ“‹';
            }, 2000);
        } catch (err) {
            console.error('Copy failed', err);
        }
      });
    });
  }

  // Initial load
  initMarkdownCopy();
  
  // Run on page transition if needed (Astro View Transitions)
  document.addEventListener('astro:after-swap', initMarkdownCopy);
</script>

<style>
  .markdown-content :global(pre) {
    max-height: 500px;
    overflow-y: auto;
  }
  
  .markdown-content :global(code) {
    font-family: 'Fira Code', 'JetBrains Mono', monospace;
  }

  .markdown-content :global(.scrollbar-thin::-webkit-scrollbar) {
    height: 4px;
    width: 4px;
  }
  .markdown-content :global(.scrollbar-thin::-webkit-scrollbar-thumb) {
    background-color: #444;
    border-radius: 4px;
  }
  
  .markdown-content :global(img) {
    max-height: 500px;
    object-fit: contain;
  }
  
  .markdown-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
  }
  
  .markdown-content :global(th),
  .markdown-content :global(td) {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: left;
  }
  
  .markdown-content :global(th) {
    background: #f3f4f6;
    font-weight: 600;
  }
  
  :global(.dark) .markdown-content :global(th) {
    background: #374151;
  }
  
  :global(.dark) .markdown-content :global(th),
  :global(.dark) .markdown-content :global(td) {
    border-color: #4b5563;
  }
</style>
