---
/**
 * MarkdownRenderer.astro
 * 
 * B.6: Full README Display Component
 * Supports GFM Markdown + Images + Syntax Highlighting via 'marked'
 * V16.5: Refactored to external modules for Art 5.1 compliance (< 250 lines)
 * 
 * @component
 */
import { marked } from 'marked';
import '../../styles/markdown-premium.css';

interface Props {
  content: string;
  className?: string;
}

const { content, className = '' } = Astro.props;

// 1. Table of Contents Extraction
const headers: { depth: number; text: string; slug: string }[] = [];
const renderer = new marked.Renderer();

// Clean and prepare content
let processedContent = content || '';
// Remove YAML frontmatter if present (V21.15.5: Resilient Multiline)
processedContent = processedContent.replace(/^\s*---\s*[\s\S]*?---\s*\n?/m, '');

renderer.heading = (args) => {
  // marked v13+: args is an object with { text, depth, raw, tokens }
  const text = args.text || '';
  const depth = args.depth || 1;
  
  // Extract plain text for slug if text contains icons/tags
  const textContent = typeof text === 'string' ? text : (typeof text === 'object' ? (text as any).text : String(text));
  const slug = textContent.toLowerCase().replace(/[^\w]+/g, '-');
  
  if (depth <= 3) {
    headers.push({ depth, text: textContent, slug });
  }
  return `<h${depth} id="${slug}">${text}</h${depth}>`;
};

// 2. Code Block Injection (Copy Buttons)
renderer.code = (args) => {
  // marked v13+: args is an object with { text, lang, raw, escaped }
  const code = args.text || '';
  const language = args.lang || 'text';
  const escapedCode = code.replace(/"/g, '&quot;');
  return `
    <div class="relative group my-4">
      <button class="markdown-copy-btn absolute top-2 right-2 p-2 bg-gray-800/50 hover:bg-gray-700/80 text-white rounded-md opacity-0 group-hover:opacity-100 transition-all border border-gray-600/30 backdrop-blur-sm z-10"
              data-code="${escapedCode}" title="Copy code">
        <span class="btn-icon text-sm">ðŸ“‹</span>
        <span class="btn-text hidden">Copy</span>
      </button>
      <pre class="relative"><code class="language-${language || 'text'}">${code}</code></pre>
    </div>
  `;
};

// Convert markdown to HTML (server-side)
const renderedHtml = await marked.parse(processedContent, { renderer });
---

{headers.length > 1 && (
  <nav class="markdown-toc mb-10 p-6 bg-gradient-to-br from-gray-50 to-white dark:from-gray-900/50 dark:to-gray-900/10 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm relative overflow-hidden group">
    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
      <span class="text-4xl">ðŸ“‘</span>
    </div>
    <div class="flex items-center gap-2 mb-4">
      <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-pulse"></div>
      <div class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 dark:text-gray-500">Document Outline</div>
    </div>
    <ul class="space-y-2 border-l-2 border-gray-100 dark:border-gray-800/50 ml-1">
      {headers.map(h => (
        <li class={`${h.depth === 1 ? 'mt-3 first:mt-0' : ''}`}>
          <a href={`#${h.slug}`} 
             class={`block py-0.5 pl-4 -ml-[2px] border-l-2 border-transparent hover:border-indigo-500 text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all
                    ${h.depth === 1 ? 'text-[13px] font-black uppercase tracking-tight' : 'text-xs font-medium'}
                    ${h.depth === 3 ? 'pl-8 opacity-70' : ''}`}>
            {h.text}
          </a>
        </li>
      ))}
    </ul>
    <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-800/50 flex justify-between items-center">
       <span class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">AI-Optimized Extraction</span>
       <a href="#" class="text-[9px] font-black text-indigo-500 uppercase tracking-widest hover:underline">â†‘ Core Focus</a>
    </div>
  </nav>
)}

<div class={`markdown-content prose prose-slate dark:prose-invert max-w-none 
            prose-headings:font-bold prose-a:text-indigo-600 dark:prose-a:text-indigo-400
            prose-pre:bg-[#0a0a0a] prose-pre:border prose-pre:border-gray-800
            prose-img:rounded-xl prose-img:shadow-lg ${className}`}
     set:html={renderedHtml}
/>

<script>
  import { initMarkdownCopy, initSmartTooltips, resolveImageUrls } from '../../scripts/markdown-controller.js';

  function run() {
    initMarkdownCopy();
    initSmartTooltips();
    resolveImageUrls();
  }

  // Initial load
  run();
  
  // Run on page transition if needed (Astro View Transitions)
  document.addEventListener('astro:after-swap', run);
</script>
