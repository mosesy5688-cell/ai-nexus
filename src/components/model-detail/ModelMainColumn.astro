---
// src/components/model-detail/ModelMainColumn.astro
import FNITrustPanel from '../FNITrustPanel.astro';
import BenchmarkRawTable from '../benchmark/BenchmarkRawTable.astro';
import NeuralExplorer from '../NeuralExplorer.astro';
import ModelNotices from './ModelNotices.astro';
import ModelResources from './ModelResources.astro';
import EntityLinksSection from '../EntityLinksSection.astro';
import TechSpecsFull from '../entity/TechSpecsFull.astro';
import FullReadmeSection from './FullReadmeSection.astro';
// Phase B.8: New components for user understanding
import BenchmarkScores from './BenchmarkScores.astro';
import CodeExample from './CodeExample.astro';
import GGUFList from './GGUFList.astro';


interface Props {
  model: any;
  hasFNI: boolean;
  hasBenchmarkCap: boolean;
  modelName: string;
  modelId: string;
}

const { model, hasFNI, hasBenchmarkCap, modelName, modelId } = Astro.props;

// V8.0: Safely extract meta_json fields (may be string or object)
let metaJson: Record<string, any> = {};
try {
  if (model.meta_json) {
    metaJson = typeof model.meta_json === 'string' 
      ? JSON.parse(model.meta_json) 
      : model.meta_json;
  }
} catch (e) {
  console.warn('[ModelMainColumn] Failed to parse meta_json:', e);
}
---

<div class="lg:col-span-2 space-y-8">
  <!-- FNI Trust Panel -->
  {hasFNI && (
    <FNITrustPanel 
      fniScore={model.fni_score || 0}
      fniPercentile={model.fni_percentile || 0}
      fniP={model.fni_p || 0}
      fniV={model.fni_v || 0}
      fniC={model.fni_c || 0}
      fniU={model.fni_u || 0}
      fniCommentary={model.fni_commentary || null}
      modelName={modelName}
      modelId={modelId}
    />
  )}
  
  {/* V15.15: Consolidating redundant items - NeuralExplorer moved to Zone 3 (UniversalCore) */}
  
  <TechSpecsFull 
    entity={model} 
    type="model"
  />
  
  {/* Phase B.8: Benchmark Scores with semantic explanations (V15.9 Unified Fallback) */}
  <BenchmarkScores benchmarks={{
    mmlu: metaJson.extended?.benchmarks?.mmlu || (model.mmlu ? { score: model.mmlu, source: 'R2 Cache', confidence: 'high' } : null),
    gsm8k: metaJson.extended?.benchmarks?.gsm8k || (model.gsm8k ? { score: model.gsm8k, source: 'R2 Cache', confidence: 'high' } : null),
    human_eval: metaJson.extended?.benchmarks?.human_eval || (model.humaneval ? { score: model.humaneval, source: 'R2 Cache', confidence: 'high' } : null),
    arc: metaJson.extended?.benchmarks?.arc || (model.arc_challenge ? { score: model.arc_challenge, source: 'R2 Cache', confidence: 'high' } : null),
  }} />

  {/* V15.8: GGUF File List (Zone 4) */}
  <GGUFList files={model.siblings} modelId={modelId} />
  
  {/* Phase B.8: Code Example from README (Robust Hydration) */}
  <CodeExample 
    code={metaJson.extended?.example_code || metaJson.example_code || metaJson.code_snippet || metaJson.usage || metaJson.sample_code} 
    language={metaJson.extended?.example_lang || metaJson.example_lang || metaJson.language || 'python'} 
  />
  
  <!-- B.6: Full README/Model Card Section -->
  <FullReadmeSection 
    bodyContent={model.body_content}
    type="model"
    initialCollapsed={true}
    maxPreviewLength={3000}
  />

  
  <!-- Missing Data & Limitations -->
  <ModelNotices 
    entityLabel={model.entityDefinition?.display?.labelSingular || 'Model'}
    sourceUrl={model.source_url}
    sourceTrail={model.source_trail}
    license={model.license_spdx}
    hasDescription={!!model.description}
    hasSeoSummary={!!model.seo_summary}
  />
  
  <!-- Related Papers/Datasets -->
  <ModelResources 
    relatedPapers={model.related_papers}
    relatedDatasets={model.related_datasets}
  />
  
  <!-- Entity Links -->
  <EntityLinksSection modelId={modelId} modelName={modelName} />
</div>
