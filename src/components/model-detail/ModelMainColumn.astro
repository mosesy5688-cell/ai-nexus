---
// src/components/model-detail/ModelMainColumn.astro
import ModelNotices from './ModelNotices.astro';

import FullReadmeSection from './FullReadmeSection.astro';
// Phase B.8: New components for user understanding
import BenchmarkScores from './BenchmarkScores.astro';
import GGUFList from './GGUFList.astro';
import ModelGallery from './ModelGallery.astro';
import ArchitectureSchema from './ArchitectureSchema.astro';
import MarkdownRenderer from './MarkdownRenderer.astro';


interface Props {
  model: any;
  modelId: string;
  cleanDescription: string;
  jsonld: any;
}

const { model, modelName, modelId, cleanDescription, jsonld } = Astro.props;

// V8.0: Safely extract meta_json fields (may be string or object)
let metaJson: Record<string, any> = {};
try {
  if (model.meta_json) {
    metaJson = typeof model.meta_json === 'string' 
      ? JSON.parse(model.meta_json) 
      : model.meta_json;
  }
} catch (e) {
  console.warn('[ModelMainColumn] Failed to parse meta_json:', e);
}
---

<div class="lg:col-span-2 space-y-8">
  {/* V16.2: Visual First - Auto Gallery */}
  {model.gallery_images?.length > 0 && <ModelGallery images={model.gallery_images} />}

  {/* V15.8: GGUF File List (Zone 4) */}
  <GGUFList files={model.siblings} modelId={modelId} />
  
  {/* V16.2: Technical Setup & Implementation (Consolidated) */}
  {(model.installation || model.configuration || model.usage) && (
    <section class="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-8 border border-gray-100 dark:border-gray-800 shadow-inner">
       <h2 class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest mb-8 flex items-center gap-2">
          <span>⚙️</span> Technical Implementation
       </h2>
       
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {/* V16.10: Visual Architectural Skeleton */}
          <div class="space-y-4">
             <h3 class="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <span class="w-2 h-2 bg-indigo-500 rounded-full"></span> Internal Architecture
             </h3>
             <ArchitectureSchema 
               layers={model.num_layers} 
               heads={model.num_heads} 
               experts={model.moe_experts} 
               activeExperts={model.moe_active} 
               hiddenSize={model.hidden_size}
               architecture={model.architecture}
             />
             
             {/* V16.8.12: Semantic Benchmark Scores (Signal Restoration) */}
             <BenchmarkScores benchmarks={model.benchmarks || metaJson.benchmarks} />
          </div>

          <div class="space-y-8">
            {model.installation && (
              <div class="space-y-4">
                 <h3 class="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span> Installation
                 </h3>
                 <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700">
                    <MarkdownRenderer content={model.installation} />
                 </div>
              </div>
            )}

            {model.usage && (
              <div class="space-y-4">
                 <h3 class="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span> Usage Example
                 </h3>
                 <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700">
                    <MarkdownRenderer content={model.usage} />
                 </div>
              </div>
            )}
          </div>
        </div>

       {model.configuration && (
         <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-800 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
            <dt class="text-sm font-bold leading-6 text-gray-900 dark:text-white uppercase tracking-tighter">Config Logic</dt>
            <dd class="mt-1 text-sm leading-6 text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">
               <MarkdownRenderer content={model.configuration} />
            </dd>
         </div>
       )}
    </section>
  )}

  {/* B.6: Primary Model Documentation */}
  <div class="relative">
     <div class="absolute -left-6 top-10 w-1 bg-indigo-500/20 h-24 rounded-full blur-sm"></div>
     <FullReadmeSection 
       bodyContent={model.html_readme || model.body_content}
       model={model}
       type="model"
       initialCollapsed={false}
       maxPreviewLength={5000}
     />
  </div>

  
  <!-- Missing Data & Limitations -->
  <ModelNotices 
    entityLabel={model.entityDefinition?.display?.labelSingular || 'Model'}
    sourceUrl={model.source_url}
    sourceTrail={model.source_trail}
    license={model.license_spdx}
    hasDescription={!!model.description}
    hasSeoSummary={!!model.seo_summary}
  />
  
  {/* Legacy ModelResources & EntityLinks removed - redundant with Neural Mesh Hub (V16) */}
  {/* CiteEntity removed here to avoid duplication with UniversalCore rendering */}
</div>
