---
import { stripPrefix, getRouteFromId } from '../../utils/knowledge-cache-reader.js';
/**
 * RelationsPanel - V15.1 Knowledge Graph Display
 * Shows explicit relationships: base_model, datasets, papers, demos, knowledge
 */
interface KnowledgeLink {
  slug: string;
  title: string;
  icon: string;
}

interface Props {
  baseModel?: string | null;
  datasetsUsed?: string[];
  arxivRefs?: string[];
  relatedSpaces?: string[];
  knowledgeLinks?: KnowledgeLink[];
}

const { baseModel, datasetsUsed = [], arxivRefs = [], relatedSpaces = [], knowledgeLinks = [] } = Astro.props;

const hasRelations = baseModel || datasetsUsed.length > 0 || arxivRefs.length > 0 || relatedSpaces.length > 0 || knowledgeLinks.length > 0;
---

{hasRelations && (
  <section class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700 shadow-sm">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-8 h-8 rounded-lg bg-purple-50 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
        </svg>
      </div>
      <h2 class="text-sm font-black text-gray-900 dark:text-white uppercase tracking-wider">
        Knowledge Context
      </h2>
    </div>
    
    <div class="divide-y divide-gray-50 dark:divide-gray-700/50">
      {baseModel && (
        <div class="py-4 first:pt-0">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest">Base Model</span>
          </div>
          <a href={getRouteFromId(baseModel, 'model')}
             class="group flex items-center justify-between p-3 rounded-xl bg-indigo-50/30 dark:bg-indigo-900/10 border border-indigo-100/50 dark:border-indigo-800/50 hover:border-indigo-300 transition-all">
            <div class="flex items-center gap-3">
              <span class="text-lg">ðŸ§¬</span>
              <span class="text-sm font-bold text-gray-800 dark:text-gray-200">{baseModel}</span>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-400 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      )}

      {datasetsUsed.filter(Boolean).length > 0 && (
        <div class="py-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest">Trained On</span>
          </div>
          <div class="flex flex-wrap gap-2">
            {datasetsUsed.filter(Boolean).map(ds => (
              <a href={getRouteFromId(ds, 'dataset')}
                 class="px-3 py-1.5 bg-green-50/50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg text-xs font-bold border border-green-100/50 dark:border-green-800/30 hover:border-green-400 transition-all">
                {ds}
              </a>
            ))}
          </div>
        </div>
      )}

      {arxivRefs.filter(Boolean).length > 0 && (
        <div class="py-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest">Scientific Papers</span>
          </div>
          <div class="flex flex-col gap-2" id="papers-container">
            {arxivRefs.filter(Boolean).map(arxiv => (
              <a href={getRouteFromId(`arxiv--${arxiv}`, 'paper')}
                 class="group flex items-center gap-3 p-3 rounded-xl bg-blue-50/30 dark:bg-blue-900/10 border border-blue-100/50 dark:border-blue-800/50 hover:border-blue-300 transition-all"
                 data-arxiv={arxiv}>
                <span class="text-lg">ðŸ“„</span>
                <span class="paper-title text-sm font-bold text-gray-800 dark:text-gray-200 truncate">{arxiv.startsWith('arxiv:') ? arxiv : `arXiv:${arxiv}`}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-auto text-blue-400 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7-7 7" />
                </svg>
              </a>
            ))}
          </div>
        </div>
      )}

      {relatedSpaces.filter(Boolean).length > 0 && (
        <div class="py-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest">Live Demos</span>
          </div>
          <div class="flex flex-wrap gap-2">
            {relatedSpaces.filter(Boolean).map(space => (
              <a href={getRouteFromId(space, 'space')}
                 class="px-3 py-1.5 bg-orange-50/50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 rounded-lg text-xs font-bold border border-orange-100/50 dark:border-orange-800/30 hover:border-orange-400 transition-all">
                {space.split('/').pop()}
              </a>
            ))}
          </div>
        </div>
      )}

      {knowledgeLinks.filter(l => l && l.slug).length > 0 && (
        <div class="py-4 last:pb-0">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest">Knowledge Base</span>
          </div>
          <div class="flex flex-wrap gap-2">
            {knowledgeLinks.filter(l => l && l.slug).map(link => (
              <a href={`/knowledge/${link.slug}`}
                 class="px-3 py-1.5 bg-purple-50/50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-lg text-xs font-bold border border-purple-100/50 dark:border-purple-800/30 hover:border-purple-400 transition-all flex items-center gap-2">
                <span class="text-sm">{link.icon}</span>
                <span>{link.title}</span>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>

    <script is:inline>
      // Paper title hydration
      async function loadPaperTitles() {
        try {
          const res = await fetch('/cache/paper-titles.json');
          if (!res.ok) return;
          const data = await res.json();
          
          document.querySelectorAll('[data-arxiv]').forEach(el => {
            const arxivId = el.getAttribute('data-arxiv');
            const title = data.titles?.[arxivId];
            if (title) {
              const titleEl = el.querySelector('.paper-title');
              if (titleEl) {
                titleEl.textContent = title;
                titleEl.title = title;
              }
            }
          });
        } catch (e) {}
      }
      loadPaperTitles();
    </script>
  </section>
)}
