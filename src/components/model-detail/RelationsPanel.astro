---
import { stripPrefix, getRouteFromId } from '../../utils/knowledge-cache-reader.js';
/**
 * RelationsPanel - V15.1 Knowledge Graph Display
 * Shows explicit relationships: base_model, datasets, papers, demos, knowledge
 */
interface KnowledgeLink {
  slug: string;
  title: string;
  icon: string;
}

interface Props {
  baseModel?: string | null;
  datasetsUsed?: string[];
  arxivRefs?: string[];
  relatedSpaces?: string[];
  knowledgeLinks?: KnowledgeLink[];
}

const { baseModel, datasetsUsed = [], arxivRefs = [], relatedSpaces = [], knowledgeLinks = [] } = Astro.props;

const hasRelations = baseModel || datasetsUsed.length > 0 || arxivRefs.length > 0 || relatedSpaces.length > 0 || knowledgeLinks.length > 0;
---

<section class="bg-white dark:bg-zinc-900 rounded-2xl p-6 border border-zinc-200 dark:border-zinc-800 shadow-sm">
    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-zinc-100 dark:border-zinc-800">
      <div class="w-8 h-8 rounded-lg bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center text-zinc-600 dark:text-zinc-400 border border-zinc-200 dark:border-zinc-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
        </svg>
      </div>
      <h2 class="text-sm font-black text-zinc-900 dark:text-white uppercase tracking-widest">
        Entity Lineage & Context
      </h2>
    </div>
    
    <div class="space-y-6">
      {baseModel && (
        <div>
          <h4 class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.2em] mb-2">Base Architecture</h4>
          <a href={getRouteFromId(baseModel, 'model')}
             class="group flex items-center justify-between p-3 rounded-xl bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 hover:border-indigo-500 transition-colors">
            <span class="text-sm font-black text-zinc-900 dark:text-zinc-100 truncate">{baseModel}</span>
            <span class="text-zinc-300 group-hover:text-indigo-500 transition-colors">â†’</span>
          </a>
        </div>
      )}

      {datasetsUsed.filter(Boolean).length > 0 && (
        <div class="pt-6 border-t border-zinc-100 dark:border-zinc-800">
          <h4 class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.2em] mb-3">Trained On</h4>
          <div class="flex flex-wrap gap-2 relation-group" data-max="8">
            {datasetsUsed.filter(Boolean).map((ds, index) => (
              <a href={getRouteFromId(ds, 'dataset')}
                 class={`px-3 py-1 bg-white dark:bg-zinc-900 text-zinc-700 dark:text-zinc-300 rounded border border-zinc-200 dark:border-zinc-700 text-xs font-bold hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors ${index >= 8 ? 'hidden extra-rel' : ''}`}>
                {ds}
              </a>
            ))}
            {datasetsUsed.length > 8 && (
              <button class="expand-rels-btn text-[10px] font-black uppercase text-indigo-500 hover:underline" data-count={datasetsUsed.length - 8}>
                + {datasetsUsed.length - 8} more
              </button>
            )}
          </div>
        </div>
      )}

      {arxivRefs.filter(Boolean).length > 0 && (
        <div class="pt-6 border-t border-zinc-100 dark:border-zinc-800">
          <h4 class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.2em] mb-3">Scientific Papers</h4>
          <div class="space-y-2 relation-group" id="papers-container" data-max="4">
            {arxivRefs.filter(Boolean).map((arxiv, index) => (
              <a href={getRouteFromId(`arxiv--${arxiv}`, 'paper')}
                 class={`group flex items-center gap-3 p-3 rounded-lg border border-zinc-100 dark:border-zinc-800 hover:border-indigo-500 transition-colors ${index >= 4 ? 'hidden extra-rel' : ''}`}
                 data-arxiv={arxiv}>
                <span class="text-[13px] font-bold text-zinc-700 dark:text-zinc-300 paper-title truncate">{arxiv}</span>
              </a>
            ))}
            {arxivRefs.length > 4 && (
              <button class="expand-rels-btn w-full mt-2 py-2 text-[10px] font-black uppercase text-indigo-500 bg-zinc-50 dark:bg-zinc-800 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/10 transition-colors" data-count={arxivRefs.length - 4}>
                + Expand {arxivRefs.length - 4} Scientific References
              </button>
            )}
          </div>
        </div>
      )}

      {(relatedSpaces.length > 0 || knowledgeLinks.length > 0) && (
        <div class="pt-6 border-t border-zinc-100 dark:border-zinc-800 text-[10px]">
          <h4 class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.2em] mb-3">Linked Resources</h4>
          <div class="flex flex-wrap gap-2">
            {knowledgeLinks.filter(l => l && l.slug).map(link => (
              <a href={`/knowledge/${link.slug}`}
                 class="px-3 py-1.5 bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 rounded border border-zinc-200 dark:border-zinc-700 text-xs font-black uppercase tracking-tight hover:bg-zinc-200 transition-colors">
                {link.title}
              </a>
            ))}
            {relatedSpaces.filter(Boolean).map(space => (
              <a href={getRouteFromId(space, 'space')}
                 class="px-3 py-1.5 bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 rounded border border-zinc-200 dark:border-zinc-700 text-xs font-bold transition-colors">
                {space.split('/').pop()}
              </a>
            ))}
          </div>
        </div>
      )}
    </div>

    <script is:inline>
      async function loadPaperTitles() {
        try {
          const res = await fetch('https://cdn.free2aitools.com/cache/paper-titles.json');
          if (!res.ok) return;
          const data = await res.json();
          document.querySelectorAll('[data-arxiv]').forEach(el => {
            const arxivId = el.getAttribute('data-arxiv');
            const title = data.titles?.[arxivId];
            if (title) {
              const titleEl = el.querySelector('.paper-title');
              if (titleEl) { titleEl.textContent = title; titleEl.title = title; }
            }
          });
        } catch (e) {}
      }
      
      function initPanelFolding() {
        const buttons = document.querySelectorAll('.expand-rels-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const group = btn.closest('.relation-group');
            if (group) {
              const extra = group.querySelectorAll('.extra-rel');
              extra.forEach(el => el.classList.toggle('hidden'));
              const isHidden = extra[0].classList.contains('hidden');
              const count = btn.dataset.count;
              if (btn.classList.contains('w-full')) {
                btn.textContent = isHidden ? `+ Expand ${count} Scientific References` : '- Collapse References';
              } else {
                btn.textContent = isHidden ? `+ ${count} more` : '- Show less';
              }
            }
          });
        });
      }
      
      loadPaperTitles();
      initPanelFolding();
      document.addEventListener('astro:after-swap', () => { loadPaperTitles(); initPanelFolding(); });
      document.addEventListener('astro:page-load', () => { loadPaperTitles(); initPanelFolding(); });
    </script>
  </section>
)}
