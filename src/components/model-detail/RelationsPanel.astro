---
/**
 * RelationsPanel - V15.0 Knowledge Graph Display
 * Shows explicit relationships: base_model, datasets, papers, demos, knowledge
 */
interface KnowledgeLink {
  slug: string;
  title: string;
  icon: string;
}

interface Props {
  baseModel?: string | null;
  datasetsUsed?: string[];
  arxivRefs?: string[];
  relatedSpaces?: string[];
  knowledgeLinks?: KnowledgeLink[];
}

const { baseModel, datasetsUsed = [], arxivRefs = [], relatedSpaces = [], knowledgeLinks = [] } = Astro.props;

const hasRelations = baseModel || datasetsUsed.length > 0 || arxivRefs.length > 0 || relatedSpaces.length > 0 || knowledgeLinks.length > 0;
---

{hasRelations && (
  <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
      ðŸ”— Knowledge Context
    </h2>
    
    <div class="space-y-4">
      {baseModel && (
        <div class="flex items-start gap-3">
          <span class="text-purple-500 mt-1">ðŸ§¬</span>
          <div>
            <span class="text-sm text-gray-500 dark:text-gray-400">Based on</span>
            <a href={`/model/${baseModel.replace(/\//g, '--')}`}
               class="block text-indigo-600 dark:text-indigo-400 hover:underline font-medium">
              {baseModel}
            </a>
          </div>
        </div>
      )}

      {datasetsUsed.length > 0 && (
        <div class="flex items-start gap-3">
          <span class="text-green-500 mt-1">ðŸ“Š</span>
          <div>
            <span class="text-sm text-gray-500 dark:text-gray-400">Trained on</span>
            <div class="flex flex-wrap gap-2 mt-1">
              {datasetsUsed.slice(0, 5).map(ds => (
                <a href={`/dataset/${ds.replace(/\//g, '--')}`}
                   class="px-2 py-1 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-md text-sm hover:bg-green-100 dark:hover:bg-green-900/50 transition-colors">
                  {ds}
                </a>
              ))}
              {datasetsUsed.length > 5 && (
                <span class="px-2 py-1 text-gray-500 text-sm">+{datasetsUsed.length - 5} more</span>
              )}
            </div>
          </div>
        </div>
      )}

      {arxivRefs.length > 0 && (
        <div class="flex items-start gap-3">
          <span class="text-blue-500 mt-1">ðŸ“„</span>
          <div>
            <span class="text-sm text-gray-500 dark:text-gray-400">Related Papers</span>
            <div class="flex flex-col gap-2 mt-1" id="papers-container">
              {arxivRefs.slice(0, 3).map(arxiv => (
                <a href={`/paper/arxiv--${arxiv}`}
                   class="flex items-center gap-2 px-2 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-md text-sm hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors"
                   data-arxiv={arxiv}>
                  <span class="paper-title">arXiv:{arxiv}</span>
                  <span class="text-xs opacity-60">â†’</span>
                </a>
              ))}
              {arxivRefs.length > 3 && (
                <span class="px-2 py-1 text-gray-500 text-sm">+{arxivRefs.length - 3} more</span>
              )}
            </div>
          </div>
        </div>
      )}

      <script>
        // V12: Fetch paper titles from cache
        async function loadPaperTitles() {
          try {
            const res = await fetch('/api/cache/paper-titles.json');
            if (!res.ok) return;
            const data = await res.json();
            
            document.querySelectorAll('[data-arxiv]').forEach(el => {
              const arxivId = el.getAttribute('data-arxiv');
              const title = data.titles?.[arxivId];
              if (title) {
                const titleEl = el.querySelector('.paper-title');
                if (titleEl) {
                  titleEl.textContent = title.length > 40 ? title.substring(0, 40) + '...' : title;
                  titleEl.title = title;
                }
              }
            });
          } catch (e) { /* Paper titles not cached yet */ }
        }
        loadPaperTitles();
      </script>

      {relatedSpaces.length > 0 && (
        <div class="flex items-start gap-3">
          <span class="text-orange-500 mt-1">ðŸš€</span>
          <div>
            <span class="text-sm text-gray-500 dark:text-gray-400">Try Demo</span>
            <div class="flex flex-wrap gap-2 mt-1">
              {relatedSpaces.slice(0, 3).map(space => (
                <a href={`/space/${space.replace(/\//g, '--')}`}
                   class="px-2 py-1 bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-md text-sm hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-colors">
                  {space.split('/').pop()}
                </a>
              ))}
            </div>
          </div>
        </div>
      )}

      {knowledgeLinks.length > 0 && (
        <div class="flex items-start gap-3">
          <span class="text-purple-500 mt-1">ðŸ“š</span>
          <div>
            <span class="text-sm text-gray-500 dark:text-gray-400">Learn More</span>
            <div class="flex flex-wrap gap-2 mt-1">
              {knowledgeLinks.slice(0, 4).map(link => (
                <a href={`/knowledge/${link.slug}`}
                   class="px-2 py-1 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-md text-sm hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-colors flex items-center gap-1">
                  <span>{link.icon}</span>
                  {link.title}
                </a>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  </section>
)}
