---
/**
 * CompareButton.astro
 * 
 * B.14 P0: "Compare This Model" button
 * Allows users to quickly add models to comparison list from detail page
 * 
 * @component
 */

interface Props {
  modelId: string;
  modelName: string;
  className?: string;
}

const { modelId, modelName, className = '' } = Astro.props;

// Encode model ID for URL
const encodedModelId = encodeURIComponent(modelId);
---

<div class={`compare-button-wrapper ${className}`}>
  <a 
    href={`/compare?add=${encodedModelId}`}
    class="compare-btn group inline-flex items-center gap-2 px-4 py-2.5 
           bg-gradient-to-r from-indigo-500 to-purple-600 
           hover:from-indigo-600 hover:to-purple-700
           text-white font-medium rounded-lg shadow-md 
           hover:shadow-lg transition-all duration-200"
    data-model-id={modelId}
    data-model-name={modelName}
  >
    <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </svg>
    <span>Compare This Model</span>
  </a>
  
  <!-- Quick add to cart (localStorage based) -->
  <button 
    id="add-to-compare-btn"
    class="ml-2 p-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 
           rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 
           transition-all duration-200 group"
    data-model-id={modelId}
    data-model-name={modelName}
    title="Add to compare list"
  >
    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
    </svg>
    <span class="sr-only">Add to compare list</span>
  </button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const addBtn = document.getElementById('add-to-compare-btn');
    
    if (addBtn) {
      addBtn.addEventListener('click', () => {
        const modelId = addBtn.dataset.modelId || '';
        const modelName = addBtn.dataset.modelName || '';
        
        // B.14 P2: localStorage compare cart
        const compareList = JSON.parse(localStorage.getItem('compareModels') || '[]');
        
        // Check if already in list
        if (compareList.find((m: any) => m.id === modelId)) {
          alert(`${modelName} is already in your compare list!`);
          return;
        }
        
        // Max 5 models for comparison
        if (compareList.length >= 5) {
          alert('Compare list is full (max 5 models). Please remove one first.');
          return;
        }
        
        // Add to list
        compareList.push({
          id: modelId,
          name: modelName,
          addedAt: new Date().toISOString()
        });
        
        localStorage.setItem('compareModels', JSON.stringify(compareList));
        
        // Visual feedback
        addBtn.classList.add('bg-green-100', 'dark:bg-green-900');
        addBtn.querySelector('svg')?.classList.add('text-green-500');
        
        // Show confirmation
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
        toast.innerHTML = `âœ“ Added ${modelName} to compare list`;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 2000);
      });
    }
    
    // Check if model is already in compare list on load
    const checkExisting = () => {
      const addBtn = document.getElementById('add-to-compare-btn');
      if (!addBtn) return;
      
      const modelId = addBtn.dataset.modelId;
      const compareList = JSON.parse(localStorage.getItem('compareModels') || '[]');
      
      if (compareList.find((m: any) => m.id === modelId)) {
        addBtn.classList.add('bg-indigo-100', 'dark:bg-indigo-900');
        addBtn.querySelector('svg')?.classList.replace('text-gray-500', 'text-indigo-500');
        addBtn.setAttribute('title', 'Already in compare list');
      }
    };
    
    checkExisting();
  });
</script>

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>
