---
// src/components/model-detail/ModelSidebar.astro
// V6.2: Pass all available specs fields for complete data display
// B.6: Added meta_json display for complete information
// B.8: Added DeploymentInfo for VRAM/difficulty
import SpecsTable from '../specs/SpecsTable.astro';
import ModelInfoTable from '../ModelInfoTable.astro';
import NeuralGraphExplorer from '../NeuralGraphExplorer.astro';
import DeploymentInfo from './DeploymentInfo.astro';
import { parseJSONField } from '../../utils/data-service';

interface Props {
  model: any;
  modelId: string;
}

const { model, modelId } = Astro.props;

// V6.2: Check if any specs data is available
const hasSpecsData = model.params_billions || model.context_length || 
                     model.architecture || model.architecture_family ||
                     model.has_gguf || model.has_ollama || model.deploy_score ||
                     model.vocab_size || model.hidden_size || model.num_layers;

// B.6: Extract meta_json fields
const metaJson = typeof model.meta_json === 'string' 
  ? parseJSONField(model.meta_json) || {}
  : (model.meta_json || {});

const libraryName = metaJson.library_name;
const storageBytes = metaJson.storage_bytes;
const filesCount = metaJson.files_count;
const isGated = metaJson.gated;
const quantization = metaJson.quantization;
const hasMetaInfo = libraryName || storageBytes || filesCount || isGated || quantization;

// Format bytes
function formatBytes(bytes: number | undefined): string {
  if (!bytes) return '--';
  if (bytes >= 1e9) return `${(bytes / 1e9).toFixed(1)} GB`;
  if (bytes >= 1e6) return `${(bytes / 1e6).toFixed(1)} MB`;
  if (bytes >= 1e3) return `${(bytes / 1e3).toFixed(1)} KB`;
  return `${bytes} B`;
}
---

<aside class="space-y-6">
  <!-- V14.2: Compare CTA Button -->
  <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-4 shadow-lg">
    <h3 class="text-sm font-semibold text-white/80 uppercase tracking-wide mb-3">üìä Compare Models</h3>
    <button 
      id="add-to-compare-btn"
      data-model-id={modelId}
      data-model-name={model.name || modelId}
      class="w-full px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition-colors border border-white/30"
    >
      + Add to Compare
    </button>
    <a 
      href="/compare" 
      class="block w-full mt-2 px-4 py-2 bg-white text-indigo-600 rounded-lg font-medium text-center hover:bg-indigo-50 transition-colors"
    >
      View Compare Page
    </a>
    <p id="compare-status" class="text-xs text-white/70 mt-2 text-center hidden"></p>
  </div>

  {/* V14.3: HIDDEN - Run on Cloud Affiliate CTAs (2026-01-04)
      Reason: Feature temporarily disabled per user request
      To re-enable: Remove the comment wrapper around this section
  
  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700">
    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">
      ‚òÅÔ∏è Run on Cloud
    </h3>
    <div class="space-y-2">
      <a 
        href={`https://replicate.com/p/${model.name?.split('/')[1] || modelId}?ref=free2aitools`}
        target="_blank"
        rel="noopener sponsored"
        class="flex items-center justify-between w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors group"
      >
        <span class="flex items-center gap-2">
          <span class="text-lg">üöÄ</span>
          <span class="font-medium text-gray-700 dark:text-gray-200">Replicate</span>
        </span>
        <span class="text-xs text-gray-400 group-hover:text-blue-500">Run ‚Üí</span>
      </a>
      <a 
        href="https://runpod.io?ref=free2aitools"
        target="_blank"
        rel="noopener sponsored"
        class="flex items-center justify-between w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-lg transition-colors group"
      >
        <span class="flex items-center gap-2">
          <span class="text-lg">‚ö°</span>
          <span class="font-medium text-gray-700 dark:text-gray-200">RunPod GPU</span>
        </span>
        <span class="text-xs text-gray-400 group-hover:text-purple-500">Deploy ‚Üí</span>
      </a>
      {model.source === 'huggingface' && (
        <a 
          href={`https://huggingface.co/${model.name}/deploy?ref=free2aitools`}
          target="_blank"
          rel="noopener sponsored"
          class="flex items-center justify-between w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded-lg transition-colors group"
        >
          <span class="flex items-center gap-2">
            <span class="text-lg">ü§ó</span>
            <span class="font-medium text-gray-700 dark:text-gray-200">HF Inference</span>
          </span>
          <span class="text-xs text-gray-400 group-hover:text-yellow-600">Try ‚Üí</span>
        </a>
      )}
    </div>
    <p class="text-xs text-gray-400 dark:text-gray-500 mt-2 text-center">Affiliate links help support this project</p>
  </div>
  END HIDDEN */}

  {hasSpecsData && (
    <SpecsTable 
      params_billions={model.params_billions || null}
      context_length={model.context_length || null}
      vocab_size={model.vocab_size || null}
      hidden_size={model.hidden_size || null}
      num_layers={model.num_layers || null}
      architecture={model.architecture || null}
      architecture_family={model.architecture_family || null}
      deploy_score={model.deploy_score || null}
    />
  )}
  
  {/* B.8: Deployment Info with VRAM estimation */}
  <DeploymentInfo 
    paramsB={model.params_billions || 0}
    hasGguf={model.has_gguf || false}
    hasAwq={metaJson.quantization?.toLowerCase().includes('awq')}
    hasGptq={metaJson.quantization?.toLowerCase().includes('gptq')}
    libraryName={libraryName}
  />
  
  <!-- B.6: Quick Meta Info from meta_json -->
  {hasMetaInfo && (
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
      <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">
        Quick Info
      </h3>
      <dl class="space-y-2 text-sm">
        {libraryName && (
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Library</dt>
            <dd class="text-gray-900 dark:text-white font-medium">{libraryName}</dd>
          </div>
        )}
        {storageBytes && (
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Size</dt>
            <dd class="text-gray-900 dark:text-white font-mono">{formatBytes(storageBytes)}</dd>
          </div>
        )}
        {filesCount && (
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Files</dt>
            <dd class="text-gray-900 dark:text-white">{filesCount}</dd>
          </div>
        )}
        {quantization && (
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Quant</dt>
            <dd>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                {quantization}
              </span>
            </dd>
          </div>
        )}
        {isGated && (
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Access</dt>
            <dd>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                ‚ö†Ô∏è Gated
              </span>
            </dd>
          </div>
        )}
      </dl>
    </div>
  )}
  
  <ModelInfoTable model={{
    ...model,
    id: model.id || '',
    umid: model.umid || '',
    slug: model.slug || '',
    pipeline_tag: model.pipeline_tag || null,
    source_url: model.source_url || null
  }} />
  
   <NeuralGraphExplorer currentModelId={modelId} />
</aside>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const STORAGE_KEY = 'compareModels';
    const MAX_COMPARE = 4;
    const btn = document.getElementById('add-to-compare-btn');
    const status = document.getElementById('compare-status');
    
    if (!btn) return;
    
    const modelId = btn.dataset.modelId;
    const modelName = btn.dataset.modelName;
    
    // Check if already added
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const alreadyAdded = saved.some(m => m.id === modelId);
    
    if (alreadyAdded) {
      btn.textContent = '‚úì Added to Compare';
      btn.classList.add('bg-white/40');
    }
    
    btn.addEventListener('click', () => {
      let models = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      
      if (models.some(m => m.id === modelId)) {
        // Remove from list
        models = models.filter(m => m.id !== modelId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(models));
        btn.textContent = '+ Add to Compare';
        btn.classList.remove('bg-white/40');
        if (status) { status.textContent = 'Removed from compare list'; status.classList.remove('hidden'); }
      } else {
        if (models.length >= MAX_COMPARE) {
          if (status) { status.textContent = `Max ${MAX_COMPARE} models. Remove one first.`; status.classList.remove('hidden'); }
          return;
        }
        models.push({ id: modelId, name: modelName });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(models));
        btn.textContent = '‚úì Added to Compare';
        btn.classList.add('bg-white/40');
        if (status) { status.textContent = `${models.length}/${MAX_COMPARE} models selected`; status.classList.remove('hidden'); }
      }
    });
  });
</script>
