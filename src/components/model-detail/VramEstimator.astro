---
/**
 * VramEstimator.astro
 * 
 * V8.1-LOCK Phase 2: VRAM Estimation Component
 * DATA_DISCLOSURE_TRISTATE: Explicit formula with disclaimer
 * 
 * Formula: Math.ceil(params * 0.6 + 2) GB
 * Based on FP16 precision, excludes KV cache and parallel overhead
 * 
 * @component
 */
import { estimateVRAM } from '../../utils/vram-calculator.js';

interface Props {
  paramsB?: number | string;  // params_billions from D1
}

const { paramsB } = Astro.props;

// Parse params (could be number or string)
const params = typeof paramsB === 'string' ? parseFloat(paramsB) : paramsB;

// V15.19 Standard: Default to Q4 (0.75x) for 4-bit mainstream standard
const estimatedVram = params && !isNaN(params) 
  ? estimateVRAM(params, 'q4', 8192) 
  : null;

// Show component only if we have valid params
const hasData = estimatedVram !== null && params && params > 0;
---

{hasData && (
  <div class="vram-estimator bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-xl p-5 border border-purple-200 dark:border-purple-800 shadow-sm">
    <div class="flex flex-col gap-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-2xl">ðŸ’¾</div>
          <div>
            <p class="text-[10px] uppercase font-black text-purple-600/70 dark:text-purple-400/70 tracking-widest">Est. VRAM Memory</p>
            <p class="text-3xl font-black text-purple-900 dark:text-purple-100 italic">
              ~<span id="vram-value">{estimatedVram}</span> <span class="text-sm font-normal not-italic opacity-50">GB</span>
            </p>
          </div>
        </div>
        
        <div class="status-badge px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-tighter bg-purple-200 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 border border-purple-300 dark:border-purple-700" id="compatibility-status">
           Ready to Deploy
        </div>
      </div>

      <!-- GPU Interactive Selector -->
      <div class="gpu-selector mt-2">
        <label for="gpu-preset" class="text-[9px] font-mono text-gray-500 mb-1 block uppercase">Test Hardware Compatibility</label>
        <select 
          id="gpu-preset" 
          class="w-full bg-white dark:bg-black/40 border border-purple-200 dark:border-purple-800 rounded-lg px-3 py-2 text-xs font-bold text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ring-purple-500/50 appearance-none cursor-pointer"
          data-required={estimatedVram}
        >
          <option value="0">Select your GPU...</option>
          <option value="8">RTX 3070 / 4060 Ti (8GB)</option>
          <option value="12">RTX 3060 / 4070 (12GB)</option>
          <option value="16">RTX 4080 / T4 / Mac (16GB)</option>
          <option value="24">RTX 3090 / 4090 (24GB)</option>
          <option value="48">RTX 6000 Ada / A6000 (48GB)</option>
          <option value="80">A100 / H100 (80GB)</option>
        </select>
      </div>
      
      <p class="text-[9px] text-purple-600/50 dark:text-purple-400/50 font-mono leading-tight">
        * Based on 4-bit Quantization (Q4_K_M). Actual usage may vary by context length.
      </p>
    </div>
  </div>
)}

<script>
  function initVramInteractivity() {
    const select = document.getElementById('gpu-preset') as HTMLSelectElement;
    const status = document.getElementById('compatibility-status');
    const required = parseFloat(select?.dataset.required || '0');

    if (!select || !status) return;

    select.addEventListener('change', () => {
      const selectedVram = parseFloat(select.value);
      if (selectedVram === 0) {
        status.textContent = 'Select Hardware';
        status.className = 'status-badge px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-tighter bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-700';
        return;
      }

      if (selectedVram >= required) {
        status.textContent = 'âœ“ Compatible';
        status.className = 'status-badge px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-tighter bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800';
      } else {
        const diff = (required - selectedVram).toFixed(1);
        status.textContent = `âš  Missing ${diff}GB`;
        status.className = 'status-badge px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-tighter bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-800';
      }
    });
  }

  initVramInteractivity();
  document.addEventListener('astro:after-swap', initVramInteractivity);
</script>
