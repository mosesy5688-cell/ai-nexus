---
/**
 * VramEstimator.astro
 * 
 * V8.1-LOCK Phase 2: VRAM Estimation Component
 * DATA_DISCLOSURE_TRISTATE: Explicit formula with disclaimer
 * 
 * Formula: Math.ceil(params * 0.6 + 2) GB
 * Based on FP16 precision, excludes KV cache and parallel overhead
 * 
 * @component
 */
import { estimateVRAM } from '../../utils/vram-calculator.js';

interface Props {
  paramsB?: number | string;  // params_billions from D1
  contextLen?: number | string;
  moe_experts?: number | string;
  moe_active?: number | string;
}

const { paramsB, contextLen, moe_experts, moe_active } = Astro.props;

// Parse params (could be number or string)
const params = typeof paramsB === 'string' ? parseFloat(paramsB) : paramsB;

// Parse context (could be number or string)
const context = typeof contextLen === 'string' ? parseInt(contextLen) : (contextLen || 8192);

// V15.19 Standard: Default to Q4 (0.75x) for 4-bit mainstream standard
const estimatedVram = params && !isNaN(params) 
  ? estimateVRAM(params, 'q4', context, { experts: moe_experts, active: moe_active }) 
  : null;

const isMoe = Boolean(moe_experts);

// Show component only if we have valid params
const hasData = estimatedVram !== null && params && params > 0;
---

{hasData && (
  <div class="vram-estimator bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-xl p-5 border border-purple-200 dark:border-purple-800 shadow-sm">
    <div class="flex flex-col gap-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-xl">ðŸ’¾</div>
          <div>
            <p class="text-[9px] uppercase font-black text-purple-600/70 dark:text-purple-400/70 tracking-widest">Est. VRAM Benchmark</p>
            <p class="text-2xl font-black text-purple-900 dark:text-purple-100 italic tracking-tighter">
              ~<span id="vram-value">{estimatedVram}</span> <span class="text-xs font-normal not-italic opacity-50 ml-1">GB</span>
            </p>
          </div>
        </div>
        
        <div class="status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-purple-200 dark:bg-purple-900/40 text-purple-800 dark:text-purple-300 border border-purple-300/50 dark:border-purple-700/50" id="compatibility-status">
           Analyze Hardware
        </div>
      </div>

      <!-- GPU Interactive Selector -->
      <div class="gpu-selector mt-2">
        <label for="gpu-preset" class="text-[9px] font-mono text-gray-500 mb-1 block uppercase">Test Hardware Compatibility</label>
        <select 
          id="gpu-preset" 
          class="w-full bg-white dark:bg-black/40 border border-purple-200 dark:border-purple-800 rounded-lg px-3 py-2 text-xs font-bold text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ring-purple-500/50 appearance-none cursor-pointer"
          data-required={estimatedVram}
        >
          <option value="0">Select your GPU...</option>
          <option value="8">RTX 3070 / 4060 Ti (8GB)</option>
          <option value="12">RTX 3060 / 4070 (12GB)</option>
          <option value="16">RTX 4080 / T4 / Mac (16GB)</option>
          <option value="24">RTX 3090 / 4090 (24GB)</option>
          <option value="48">RTX 6000 Ada / A6000 (48GB)</option>
          <option value="80">A100 / H100 (80GB)</option>
        </select>
      </div>
      
      <p class="text-[9px] text-purple-600/60 dark:text-purple-400/60 font-medium leading-tight italic">
        * Technical estimation for FP16/Q4 weights. Does not include OS overhead or long-context batching. 
        <span class="block mt-1 font-bold text-red-500/80 uppercase">For Technical Reference Only.</span>
      </p>
    </div>
  </div>
)}

<script>
  function initVramInteractivity() {
    const select = document.getElementById('gpu-preset') as HTMLSelectElement;
    const status = document.getElementById('compatibility-status');
    const vramDisplay = document.getElementById('vram-value');
    
    if (!select || !status) return;

    function updateStatus(required: number) {
      const selectedVram = parseFloat(select.value);
      if (selectedVram === 0) {
        status!.textContent = 'Analyze Hardware';
        status!.className = 'status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-purple-200 dark:bg-purple-900/40 text-purple-800 dark:text-purple-300 border border-purple-300/50 dark:border-purple-700/50';
        return;
      }

      if (selectedVram >= required) {
        status!.textContent = 'âœ“ Compatible';
        status!.className = 'status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800';
      } else {
        const diff = (required - selectedVram).toFixed(1);
        status!.textContent = `âš  Missing ${diff}GB`;
        status!.className = 'status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-800';
      }
    }

    select.addEventListener('change', () => {
      const required = parseFloat(select.dataset.required || '0');
      updateStatus(required);
    });

    // V16.10: Dynamic Backfilling from Neural Mining
    window.addEventListener('neural-mining-complete', (e: any) => {
      const mined = e.detail;
      if (!mined || !mined.params_billions) return;

      console.log('[VramEstimator] Recalculating with mined data:', mined);
      
      // Since we are zero-runtime, we re-run the estimate logic here
      // V16.2 Formula: VRAM â‰ˆ Params * 0.75 + KV + OS
      const params = mined.params_billions;
      const ctx = mined.context_length || 8192;
      
      const weightUsage = params * 0.75;
      const kvCache = params > 30 ? 2.0 : 0.8;
      const total = (weightUsage + kvCache + 0.5).toFixed(1);

      if (vramDisplay) {
        vramDisplay.textContent = total;
        vramDisplay.classList.add('text-green-500', 'animate-pulse');
      }
      
      select.dataset.required = total;
      updateStatus(parseFloat(total));

      // Ensure the container is visible if it was hidden
      const wrapper = document.querySelector('.vram-estimator');
      if (wrapper) (wrapper as HTMLElement).style.display = 'block';
    });
  }

  initVramInteractivity();
  document.addEventListener('astro:after-swap', initVramInteractivity);
</script>
