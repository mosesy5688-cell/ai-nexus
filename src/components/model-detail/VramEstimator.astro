---
/**
 * VramEstimator.astro
 * 
 * V8.1-LOCK Phase 2: VRAM Estimation Component
 * DATA_DISCLOSURE_TRISTATE: Explicit formula with disclaimer
 * 
 * Formula: Math.ceil(params * 0.6 + 2) GB
 * Based on FP16 precision, excludes KV cache and parallel overhead
 * 
 * @component
 */
import { estimateVRAM } from '../../utils/vram-calculator.js';

interface Props {
  paramsB?: number | string;  // params_billions from D1
}

const { paramsB } = Astro.props;

// Parse params (could be number or string)
const params = typeof paramsB === 'string' ? parseFloat(paramsB) : paramsB;

// V15.19 Standard: Default to Q4 (0.75x) for 4-bit mainstream standard
const estimatedVram = params && !isNaN(params) 
  ? estimateVRAM(params, 'q4', 8192) 
  : null;

// Show component only if we have valid params
const hasData = estimatedVram !== null && params && params > 0;
---

{hasData && (
  <div class="vram-estimator bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-xl p-4 border border-purple-200 dark:border-purple-800">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl">ğŸ’¾</div>
        <div>
          <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">Est. VRAM Required</p>
          <p class="text-2xl font-bold text-purple-900 dark:text-purple-100">
            ~{estimatedVram} GB
          </p>
        </div>
      </div>
      
      <!-- V8.1-LOCK: DATA_DISCLOSURE_TRISTATE - Explicit formula tooltip -->
      <div class="relative group">
        <button class="text-purple-500 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300" aria-label="VRAM estimation info">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
        
        <!-- Tooltip -->
        <div class="absolute right-0 top-8 w-64 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 text-xs opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
          <p class="font-semibold text-gray-900 dark:text-white mb-2">Estimation Formula</p>
          <code class="block bg-black text-white p-2 rounded mb-2 font-mono border border-gray-700">
            VRAM â‰ˆ (Params Ã— 0.75) + 0.8GB (KV) + 0.5GB (OS)
          </code>
          <p class="text-gray-600 dark:text-gray-400 mb-1">
            Standard: 4-bit Quantized (Q4_K_M).
          </p>
          <p class="text-gray-500 dark:text-gray-500 italic">
            âš ï¸ KV Cache estimate based on 8B-scale @ 8k context.
          </p>
        </div>
      </div>
    </div>
    
    <!-- V8.1-LOCK: Explicit disclaimer per Trust Protocol -->
    <p class="text-xs text-purple-600/70 dark:text-purple-400/70 mt-2">
      ğŸ“‹ Estimate only. Actual requirements may vary.
    </p>
  </div>
)}
