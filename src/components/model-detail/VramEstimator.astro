---
/**
 * VramEstimator.astro
 * 
 * V8.1-LOCK Phase 2: VRAM Estimation Component
 * DATA_DISCLOSURE_TRISTATE: Explicit formula with disclaimer
 * 
 * Formula: Math.ceil(params * 0.6 + 2) GB
 * Based on FP16 precision, excludes KV cache and parallel overhead
 * 
 * @component
 */
import { estimateVRAM } from '../../utils/vram-calculator.js';

interface Props {
  paramsB?: number | string;  // params_billions from D1
  contextLen?: number | string;
  moe_experts?: number | string;
  moe_active?: number | string;
}

const { paramsB, contextLen, moe_experts, moe_active } = Astro.props;

// Parse params (could be number or string)
const params = typeof paramsB === 'string' ? parseFloat(paramsB) : paramsB;

// Parse context (could be number or string)
const context = typeof contextLen === 'string' ? parseInt(contextLen) : (contextLen || 8192);

// V15.19 Standard: Default to Q4 (0.75x) for 4-bit mainstream standard
const estimatedVram = params && !isNaN(params) 
  ? estimateVRAM(params, 'q4', context, { experts: moe_experts, active: moe_active }) 
  : null;

const isMoe = Boolean(moe_experts);

// Show component only if we have valid params
const hasData = estimatedVram !== null && params && params > 0;
---

{hasData && (
  <div class="vram-estimator bg-white/40 dark:bg-zinc-900/40 backdrop-blur-xl rounded-2xl p-6 border border-zinc-200/50 dark:border-zinc-800/50 shadow-xl shadow-indigo-500/5 group transition-all hover:border-indigo-500/30">
    <div class="flex flex-col gap-6">
      <div class="flex items-start justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/30 group-hover:scale-105 transition-transform">
             <span class="text-2xl">ðŸ’¾</span>
          </div>
          <div>
            <p class="text-[10px] uppercase font-black text-indigo-500 dark:text-indigo-400 tracking-[0.2em] mb-1">Compute Threshold</p>
            <p class="text-3xl font-black text-zinc-900 dark:text-white italic tracking-tighter leading-none">
              ~<span id="vram-value">{estimatedVram}</span> <span class="text-xs font-normal not-italic opacity-40 ml-1 uppercase tracking-widest">GB VRAM</span>
            </p>
          </div>
        </div>
        
        <div class="flex items-center gap-2">
           <div class="flex items-center gap-1.5 px-2 py-1 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400 text-[9px] font-black uppercase tracking-widest border border-indigo-200/50 dark:border-indigo-800/50">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
              </span>
              <span>Interactive</span>
           </div>
           <div class="status-badge px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest bg-zinc-100 dark:bg-zinc-800 text-zinc-500 border border-zinc-200 dark:border-zinc-700 shadow-sm transition-colors" id="compatibility-status">
              Analyze Hardware
           </div>
        </div>
      </div>

      <!-- GPU Interactive Selector -->
      <div class="gpu-selector">
        <label for="gpu-preset" class="text-[9px] font-black text-zinc-400 mb-2 block uppercase tracking-widest">Hardware Compatibility Test</label>
        <div class="relative">
          <select 
            id="gpu-preset" 
            class="w-full bg-zinc-50 dark:bg-black/40 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-3 text-xs font-black text-zinc-700 dark:text-zinc-200 focus:outline-none focus:ring-2 ring-indigo-500/20 appearance-none cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-800/60 transition-colors"
            data-required={estimatedVram}
          >
            <option value="0">Select GPU Architecture...</option>
            <option value="8">RTX 3070 / 4060 Ti / Mac 8GB</option>
            <option value="12">RTX 3060 / 4070 (12GB)</option>
            <option value="16">RTX 4080 / T4 / Mac 16GB</option>
            <option value="24">RTX 3090 / 4090 / Mac 24GB</option>
            <option value="32">Mac M1/M2/M3 (32GB Unified)</option>
            <option value="48">RTX 6000 Ada / Mac 48GB</option>
            <option value="64">Mac M2/M3 (64GB Unified)</option>
            <option value="80">A100 / H100 (80GB)</option>
            <option value="128">Mac Ultra (128GB Unified)</option>
          </select>
          <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-400">
             <span class="text-[10px]">â–¼</span>
          </div>
        </div>
      </div>
      
      <p class="text-[9px] text-zinc-400 font-bold leading-relaxed uppercase tracking-tight">
        * Static estimation for <span class="text-indigo-500">4-Bit Quantization</span>. 
        {estimatedVram > 40 && <span class="text-amber-500 font-black ml-1">[Multi-GPU / Unified Memory Required]</span>}
      </p>
    </div>
  </div>
)}

<script>
  function initVramInteractivity() {
    const select = document.getElementById('gpu-preset') as HTMLSelectElement;
    const status = document.getElementById('compatibility-status');
    const vramDisplay = document.getElementById('vram-value');
    
    if (!select || !status) return;

    function updateStatus(required: number) {
      const selectedVram = parseFloat(select.value);
      if (selectedVram === 0) {
        status!.textContent = 'Analyze Hardware';
        status!.className = 'status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-purple-200 dark:bg-purple-900/40 text-purple-800 dark:text-purple-300 border border-purple-300/50 dark:border-purple-700/50';
        return;
      }

      if (selectedVram >= required) {
        status!.textContent = 'âœ“ Compatible';
        status!.className = 'status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800';
      } else {
        const diff = (required - selectedVram).toFixed(1);
        status!.textContent = `âš  Missing ${diff}GB`;
        status!.className = 'status-badge px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-800';
      }
    }

    select.addEventListener('change', () => {
      const required = parseFloat(select.dataset.required || '0');
      updateStatus(required);
    });

    // V16.10: Dynamic Backfilling from Neural Mining
    window.addEventListener('neural-mining-complete', (e: any) => {
      const mined = e.detail;
      if (!mined || !mined.params_billions) return;

      console.log('[VramEstimator] Recalculating with mined data:', mined);
      
      // Since we are zero-runtime, we re-run the estimate logic here
      // V16.2 Formula: VRAM â‰ˆ Params * 0.75 + KV + OS
      const params = mined.params_billions;
      const ctx = mined.context_length || 8192;
      
      const weightUsage = params * 0.75;
      const kvCache = params > 30 ? 2.0 : 0.8;
      const total = (weightUsage + kvCache + 0.5).toFixed(1);

      if (vramDisplay) {
        vramDisplay.textContent = total;
        vramDisplay.classList.add('text-green-500', 'animate-pulse');
      }
      
      select.dataset.required = total;
      updateStatus(parseFloat(total));

      // Ensure the container is visible if it was hidden
      const wrapper = document.querySelector('.vram-estimator');
      if (wrapper) (wrapper as HTMLElement).style.display = 'block';
    });
  }

  initVramInteractivity();
  document.addEventListener('astro:after-swap', initVramInteractivity);
</script>
