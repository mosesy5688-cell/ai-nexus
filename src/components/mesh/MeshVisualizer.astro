---
import { loadCachedJSON } from '../../utils/loadCachedJSON.js';

/**
 * MeshVisualizer V18.12.0
 * Visualizes the 8-node knowledge graph from cache/mesh/graph.json
 * Displays nodes and edges in a navigable format
 */

const CDN_BASE = 'https://cdn.free2aitools.com';

// Fetch mesh stats from CDN
let meshStats = { nodes: 0, edges: 0, by_type: {} };

try {
  // V18.12.0: Use loadCachedJSON for transparent .gz fallback and decompression
  const { data } = await loadCachedJSON('cache/mesh/stats.json', { locals: Astro.locals });
  if (data) {
    meshStats = data;
  } else {
    // Fallback stats for V16.8.15 R5.7.3 (Unified Factory Sync)
    meshStats = { 
      nodes: 125152, 
      edges: 47685, 
      by_type: { 
        model: 51502, paper: 55257, agent: 148, space: 1022, 
        dataset: 16140, tool: 1050, knowledge: 29, report: 1,
        concept: 3
      } 
    };
  }
} catch (e) {
  // Use defaults from above
}

// Node type icons, colors and navigation links
const typeConfig = {
  model: { icon: 'ğŸ¤–', color: 'bg-blue-500', label: 'Models', href: '/models' },
  paper: { icon: 'ğŸ“„', color: 'bg-purple-500', label: 'Papers', href: '/papers' },
  agent: { icon: 'ğŸ¤–', color: 'bg-emerald-500', label: 'Agents', href: '/agents' },
  space: { icon: 'ğŸš€', color: 'bg-orange-500', label: 'Spaces', href: '/spaces' },
  dataset: { icon: 'ğŸ“Š', color: 'bg-cyan-500', label: 'Datasets', href: '/datasets' },
  tool: { icon: 'ğŸ”§', color: 'bg-amber-500', label: 'Tools', href: '/tools' },
  knowledge: { icon: 'ğŸ“š', color: 'bg-indigo-500', label: 'Knowledge', href: '/knowledge' },
  report: { icon: 'ğŸ“°', color: 'bg-rose-500', label: 'Reports', href: '/reports' }
};

const nodesByType = meshStats.by_type || {};
const totalNodes = meshStats.nodes || 0;
const totalEdges = meshStats.edges || 0;
---

<section class="mesh-visualizer bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
  <div class="flex items-center justify-between mb-5">
    <div>
      <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
        <span class="text-2xl">ğŸ•¸ï¸</span>
        Knowledge Mesh
      </h2>
      <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-0.5">
        8-node interconnected knowledge graph
      </p>
    </div>
    <div class="flex items-center gap-3 text-[11px]">
      <div class="flex items-center gap-1.5 px-2 py-1 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-100 dark:border-gray-700">
        <span class="font-bold text-indigo-600">{totalNodes.toLocaleString()}</span>
        <span class="text-gray-500">nodes</span>
      </div>
      <div class="flex items-center gap-1.5 px-2 py-1 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-100 dark:border-gray-700">
        <span class="font-bold text-emerald-600">{totalEdges.toLocaleString()}</span>
        <span class="text-gray-500">edges</span>
      </div>
    </div>
  </div>

  <!-- Interactive Navigation Mesh -->
  <div class="grid grid-cols-2 xs:grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3">
    {Object.entries(typeConfig).map(([type, config]) => {
      const count = nodesByType[type] || 0;
      
      return (
        <a href={config.href} class="group flex flex-col items-center p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-md transition-all">
          <div class={`w-10 h-10 ${config.color} rounded-xl flex items-center justify-center text-white text-xl shadow-sm group-hover:scale-110 transition-transform`}>
            {config.icon}
          </div>
          <div class="text-center mt-2">
            <div class="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-tighter">
              {config.label}
            </div>
            <div class="text-[11px] font-medium text-gray-400">
              {count > 0 ? count.toLocaleString() : '-'}
            </div>
          </div>
        </a>
      );
    })}
  </div>
</section>
