---
/**
 * AffiliateCard.astro
 * 
 * Loop 6 Merchant Engine - Frontend Component
 * Displays contextual commercial recommendations based on model properties.
 * 
 * Features:
 * - Type-based layouts (cloud_gpu, hardware, api_provider, cloud_inference, cloud_service)
 * - FTC/AdSense compliant "Sponsored" labels
 * - Responsive design (desktop sidebar, mobile bottom)
 */

interface AffiliateSlot {
    rule_id: string;
    type: string;
    provider: string;
    title: string;
    description: string;
    cta_text: string;
    affiliate_url: string | null;
    icon: string;
    matched_at?: string;
}

interface Props {
    slots: AffiliateSlot[];
    modelName?: string;
}

const { slots = [], modelName = 'this model' } = Astro.props;

// Filter to only enabled/valid slots with affiliate URLs
const validSlots = slots.filter(slot => slot && slot.affiliate_url);

// Type-based styling configurations
const typeStyles: Record<string, { bg: string; border: string; cta: string; badge: string }> = {
    cloud_gpu: {
        bg: 'bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20',
        border: 'border-purple-200 dark:border-purple-800',
        cta: 'bg-purple-600 hover:bg-purple-700',
        badge: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'
    },
    hardware: {
        bg: 'bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20',
        border: 'border-amber-200 dark:border-amber-800',
        cta: 'bg-amber-600 hover:bg-amber-700',
        badge: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200'
    },
    api_provider: {
        bg: 'bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20',
        border: 'border-emerald-200 dark:border-emerald-800',
        cta: 'bg-emerald-600 hover:bg-emerald-700',
        badge: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200'
    },
    cloud_inference: {
        bg: 'bg-gradient-to-br from-pink-50 to-rose-50 dark:from-pink-900/20 dark:to-rose-900/20',
        border: 'border-pink-200 dark:border-pink-800',
        cta: 'bg-pink-600 hover:bg-pink-700',
        badge: 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'
    },
    cloud_service: {
        bg: 'bg-gradient-to-br from-cyan-50 to-sky-50 dark:from-cyan-900/20 dark:to-sky-900/20',
        border: 'border-cyan-200 dark:border-cyan-800',
        cta: 'bg-cyan-600 hover:bg-cyan-700',
        badge: 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200'
    },
    generic: {
        bg: 'bg-gradient-to-br from-gray-50 to-slate-50 dark:from-gray-900/20 dark:to-slate-900/20',
        border: 'border-gray-200 dark:border-gray-700',
        cta: 'bg-gray-600 hover:bg-gray-700',
        badge: 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200'
    }
};

function getStyles(type: string) {
    return typeStyles[type] || typeStyles.generic;
}
---

{validSlots.length > 0 && (
    <div class="affiliate-card-container space-y-4">
        <!-- FTC Compliance Header -->
        <div class="flex items-center justify-between">
            <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Recommended for You
            </h3>
            <span class="text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                Sponsored
            </span>
        </div>

        {validSlots.map((slot) => {
            const styles = getStyles(slot.type);
            return (
                <div class={`rounded-xl border p-4 transition-all hover:shadow-md ${styles.bg} ${styles.border}`}>
                    <!-- Provider Badge -->
                    <div class="flex items-center justify-between mb-3">
                        <span class={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${styles.badge}`}>
                            <span class="mr-1">{slot.icon}</span>
                            {slot.provider}
                        </span>
                        <span class="text-xs text-gray-400">Affiliate</span>
                    </div>

                    <!-- Title & Description -->
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">
                        {slot.title}
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 line-clamp-2">
                        {slot.description}
                    </p>

                    <!-- CTA Button -->
                    <a 
                        href={slot.affiliate_url}
                        target="_blank"
                        rel="noopener noreferrer sponsored"
                        class={`inline-flex items-center justify-center w-full px-4 py-2.5 text-white font-medium rounded-lg transition-all shadow-sm hover:shadow-md ${styles.cta}`}
                    >
                        {slot.cta_text}
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>
            );
        })}

        <!-- Disclosure Footer (for FTC compliance) -->
        <p class="text-xs text-gray-400 dark:text-gray-500 text-center">
            We may earn a commission from qualifying purchases.
        </p>
    </div>
)}

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .affiliate-card-container {
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
