---
/**
 * Entity Links Section V4.8.2
 * Displays model relationships: siblings, same_architecture
 * 
 * CONSTITUTIONAL COMPLIANCE:
 * - Art.1-E: All R2 data must be user-accessible
 * - Frontend D1 = 0: Uses L8 precomputed cache only
 * - V4.8.2: Reads from /api/cache/entity_links.json
 */
interface Props {
    modelId: string;
    modelName: string;
}

const { modelId, modelName } = Astro.props;

// V4.8.2: Fetch entity links from L8 cache (R2), NOT D1
let linkedModels: { id: string; name: string; slug: string; link_type: string }[] = [];
let cacheVersion = '';

try {
    const res = await fetch(new URL('/cache/entity_links.json', Astro.url.origin));
    if (res.ok) {
        const cache = await res.json();
        cacheVersion = cache.version || 'unknown';
        
        // V6.3: entity_links.json is an ARRAY of links, not an object
        // Format: { source: "huggingface:...", target: "huggingface:...", ... }
        const allLinks = cache.links || [];
        
        // Normalize modelId for matching (convert slug format to colon format)
        const normalizedId = modelId.replace(/--/g, ':');
        
        // Filter links where this model is the source
        const modelLinks = allLinks.filter((link: any) => 
            link.source === normalizedId || 
            link.source === modelId ||
            link.source?.toLowerCase() === normalizedId.toLowerCase()
        );
        
        linkedModels = modelLinks.slice(0, 10).map((link: any) => ({
            id: link.target,
            name: link.target_name || 'Unknown',
            slug: (link.target || '').replace(/:/g, '--'),
            link_type: link.type || 'related'
        }));
    }
} catch (e) {
    console.error('[EntityLinks] Cache fetch error:', e);
    // Graceful degradation: show "Data unavailable" 
}

const hasLinks = linkedModels.length > 0;
---

{hasLinks ? (
    <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
        <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white flex items-center gap-2">
            ğŸ”— Related Models
            <span class="text-xs font-normal text-gray-400">{cacheVersion}</span>
        </h2>
        <div class="space-y-3">
            {linkedModels.map(link => (
                <a 
                    href={`/model/${link.slug}`}
                    class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                >
                    <span class="font-medium text-gray-900 dark:text-white truncate max-w-xs">
                        {link.name}
                    </span>
                    <span class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-full">
                        {link.link_type === 'sibling' ? 'ğŸ“¦ Sibling' : 
                         link.link_type === 'same_architecture' ? 'ğŸ—ï¸ Same Arch' : 
                         'ğŸ”— Related'}
                    </span>
                </a>
            ))}
        </div>
    </section>
) : (
    <section class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-6 border border-dashed border-gray-300 dark:border-gray-700">
        <h2 class="text-xl font-bold mb-2 text-gray-500 dark:text-gray-400 flex items-center gap-2">
            ğŸ”— Related Models
        </h2>
        <p class="text-sm text-gray-400 dark:text-gray-500">
            Data unavailable
        </p>
    </section>
)}
