---
/**
 * Neural Graph Explorer V15.22
 * Art.11-G: Version-locked static graph with LOCAL INJECTION
 * CES Compliance: Refactored to < 250 lines. Styles and Scripts extracted.
 */
import { fetchMeshRelations, fetchConceptMetadata } from '../utils/knowledge-cache-reader.js';
import '../styles/neural-graph.css';
import '../styles/neural-graph-d3.css';


interface Props {
    currentModelId?: string;
    entity?: any;
}

const { currentModelId, entity } = Astro.props;
const rootId = currentModelId || entity?.id;

// Graph data structures
let graphNodes = [];
let graphLinks = [];
let relatedNodes = [];

try {
    let [rawRelations, rawConceptMeta] = await Promise.all([
        fetchMeshRelations(Astro.locals, rootId, { ssrOnly: true }).catch(() => []),
        fetchConceptMetadata(Astro.locals).catch(() => [])
    ]);

    const nodeMap = new Map();
    const conceptMap = new Map();
    rawConceptMeta.forEach(c => c && (c.id || c.slug) && conceptMap.set(c.id || `concept--${c.slug}`, c));

    const ensureNode = (id, typeHint = 'model') => {
        if (!id || typeof id !== 'string' || nodeMap.has(id)) return;
        let type = typeHint || (id.includes('concept--') ? 'concept' : id.includes('report--') ? 'report' : id.includes('arxiv--') ? 'paper' : 'model');
        const meta = conceptMap.get(id);
        nodeMap.set(id, { id, name: meta?.title || id.split('--').pop().split(':').pop(), author: meta?.category || '', type, icon: meta?.icon || (type === 'concept' ? 'üß†' : 'üì¶') });
    };

    if (rootId) {
        nodeMap.set(rootId, { id: rootId, name: entity?.name || rootId, author: entity?.author || '', type: entity?.type || 'model', icon: entity?.icon || 'üéØ' });
    }

    rawRelations.forEach(rel => {
        if (!rel?.source_id || !rel?.target_id) return;
        ensureNode(rel.source_id, rel.source_type);
        ensureNode(rel.target_id, rel.target_type);
        graphLinks.push({ source: rel.source_id, target: rel.target_id, type: rel.relation_type || 'RELATED', weight: rel.confidence || 0.8 });
    });

    // V15.21: Local Relation Injection (Mined Data)
    if (rootId && entity) {
        const inject = (tid, type, relType) => {
            if (!tid) return;
            ensureNode(tid, type);
            if (!graphLinks.some(l => (l.source === rootId && l.target === tid) || (l.source === tid && l.target === rootId))) {
                graphLinks.push({ source: rootId, target: tid, type: relType, weight: 1.0 });
            }
        };
        if (entity.base_model) inject(`model--${entity.base_model.replace(/\//g, '--')}`, 'model', 'BASED_ON');
        if (Array.isArray(entity.arxiv_refs)) entity.arxiv_refs.forEach(id => inject(`arxiv--${id}`, 'paper', 'CITED_IN'));
        if (Array.isArray(entity.datasets_used)) entity.datasets_used.forEach(id => inject(`dataset--${id.replace(/\//g, '--')}`, 'dataset', 'TRAINED_ON'));
        if (Array.isArray(entity.similar_models)) entity.similar_models.forEach(id => inject(`model--${id.replace(/\//g, '--')}`, 'model', 'SIMILAR'));
    }

    graphNodes = Array.from(nodeMap.values());
    if (rootId && graphLinks.length > 0) {
        const relatedIds = new Set();
        graphLinks.forEach(l => {
            const sid = typeof l.source === 'string' ? l.source : l.source.id;
            const tid = typeof l.target === 'string' ? l.target : l.target.id;
            if (sid === rootId) relatedIds.add(tid); else if (tid === rootId) relatedIds.add(sid);
        });
        relatedNodes = graphNodes.filter(n => relatedIds.has(n.id) && n.id !== rootId).slice(0, 16);
    }

    if (relatedNodes.length === 0) {
        relatedNodes = [{ id: 'concept--mmlu', name: 'MMLU Benchmark', author: 'standard', type: 'concept', icon: 'üß™' }, { id: 'concept--fni', name: 'FNI Score Index', author: 'system', type: 'concept', icon: 'üî•' }];
    }
} catch (e) {
    console.error('[NeuralGraphExplorer] SSR Critical Failure:', e);
}
---

<section class="neural-graph-explorer" id="neural-graph-explorer">
    <div class="header">
        <div class="title-group">
            <h3 class="title">üï∏Ô∏è Neural Hub Explorer</h3>
            <p class="subtitle">Interconnecting Models, Knowledge & Reports</p>
        </div>
        <div class="view-controls">
            <button class="view-btn active" data-view="grid">Perspective</button>
            <button class="view-btn" data-view="graph">Interactive Map</button>
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="view-pane active" id="pane-grid">
            <div class="related-grid">
                {relatedNodes.map(node => {
                    const cleanId = node.id.replace(/^(hf-model|hf-agent|hf-tool|hf-dataset|hf-space|model|agent|tool|dataset|space|kb|concept|report|arxiv|paper)--/g, '');
                    const urlSlug = cleanId.replace(/--/g, '/').replace(/:/g, '/');
                    let path = node.type === 'concept' ? `/knowledge/${urlSlug}` : node.type === 'report' ? `/reports/${urlSlug}` : node.type === 'paper' ? `/paper/${urlSlug}` : `/${node.type}/${urlSlug}`;
                    return (
                        <a href={path} class={`related-card type-${node.type}`}>
                            <div class="card-header">
                                <span class="node-icon">{node.icon || 'üì¶'}</span>
                                <span class="model-name">{node.name}</span>
                                <span class={`type-badge color-${node.type}`}>{node.type}</span>
                            </div>
                            <div class="card-meta"><span class="author">{node.author}</span></div>
                        </a>
                    );
                })}
            </div>
        </div>

        <div class="view-pane" id="pane-graph">
            <div class="d3-canvas" id="d3-container" data-id={rootId} data-nodes={JSON.stringify(graphNodes)} data-links={JSON.stringify(graphLinks)}>
                <div class="graph-loading" style="display:none;"><div class="spinner"></div><span>Initializing...</span></div>
                <svg id="visual-graph"></svg>
                <div id="graph-hover-card" class="graph-hover-card" style="display:none;">
                    <div class="card-type-tag">MODEL</div><div class="card-title">-</div><div class="card-meta">-</div><div class="card-footer">Click to Explore</div>
                </div>
                <div class="graph-legend">
                    <div class="legend-item"><span class="dot model"></span> Model</div>
                    <div class="legend-item"><span class="dot paper"></span> Paper</div>
                    <div class="legend-item"><span class="dot dataset"></span> Dataset</div>
                    <div class="legend-item"><span class="dot concept"></span> Concept</div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    import { initNeuralGraph } from '../scripts/neural-graph-client.js';
    initNeuralGraph('d3-container');
</script>
