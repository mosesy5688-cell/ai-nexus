---
/**
 * Neural Mesh Hub V16.2
 * Unified knowledge orchestration for all 6 entity types.
 * Optimized for Zero-Runtime and Bidirectional Discovery.
 */
import { fetchMeshRelations, fetchGraphMetadata, stripPrefix } from '../utils/knowledge-cache-reader.js';
import rankingsData from '../data/rankings.json';
import '../styles/neural-graph.css';

interface Props {
    currentModelId?: string;
    entity?: any;
    type?: string;
}

const { currentModelId, entity, type = 'model' } = Astro.props;
const rootId = currentModelId || entity?.id;
const normRoot = stripPrefix(rootId);

// Data containers - V16.2 4-Tier Topology
let tiers = {
    explanation: { title: 'üß† Concept & Explanation', nodes: [], icon: 'üß†', zone: 'Z3.1' }, // knowledge--
    core: { title: 'üíé Core Ecosystem', nodes: [], icon: '‚ö°', zone: 'Z3.2' },       // model--, tool--, dataset--
    utility: { title: 'üîß Utility & Research', nodes: [], icon: 'üõ†Ô∏è', zone: 'Z3.3' },   // agent--, space--, arxiv--
    digest: { title: 'üì∞ Timeline & Reports', nodes: [], icon: 'üì∞', zone: 'Z3.4' }     // report--
};

try {
    const [rawRelations, graphMeta] = await Promise.all([
        fetchMeshRelations(Astro.locals, rootId, { ssrOnly: true }).catch(() => []),
        fetchGraphMetadata(Astro.locals).catch(() => ({}))
    ]);

    const nodeMap = new Map();
    const seenIds = new Set();
    if (normRoot) seenIds.add(normRoot);

    const ensureNode = (id, typeHint = 'model') => {
        const nid = id;
        const norm = stripPrefix(nid);
        if (seenIds.has(norm)) return nodeMap.get(norm);
        
        const meta = graphMeta[nid] || {};
        const nodeType = meta.t || typeHint || (
            nid.includes('knowledge--') || nid.includes('kb--') ? 'knowledge' : 
            nid.includes('arxiv--') ? 'paper' : 
            nid.includes('report--') ? 'report' :
            nid.includes('dataset--') ? 'dataset' : 
            nid.includes('space--') ? 'space' : 
            nid.includes('agent--') ? 'agent' : 
            nid.includes('tool--') ? 'tool' : 
            'model'
        );
        const parts = nid.split('--');
        const nodeAuthor = meta.author || (parts.length > 2 ? parts[parts.length-2].replace(/-/g, ' ') : (nid.startsWith('arxiv--') || nid.startsWith('paper--')) ? 'Research Paper' : (nid.startsWith('knowledge--') || nid.startsWith('kb--')) ? 'AI Knowledge Base' : 'Ecosystem Node');
        
        const node = { 
            id: nid, 
            name: meta.n || nid.split('--').pop().replace(/-/g, ' ').toUpperCase(), 
            type: nodeType, 
            icon: meta.icon || (nodeType === 'knowledge' ? 'üß†' : nodeType === 'paper' ? 'üìÑ' : nodeType === 'space' ? 'üöÄ' : nodeType === 'dataset' ? 'üìä' : nodeType === 'agent' ? 'ü§ñ' : nodeType === 'tool' ? 'üõ†Ô∏è' : nodeType === 'report' ? 'üì∞' : 'üì¶'),
            author: nodeAuthor,
            hub: meta.hub || false,
            relation: '' // Explicit relation label
        };
        nodeMap.set(norm, node);
        seenIds.add(norm);
        return node;
    };

    // Process Bidirectional Mesh
    rawRelations.forEach(rel => {
        const isOut = rel.norm_source === normRoot;
        const isIn = rel.norm_target === normRoot;
        if (!isOut && !isIn) return;

        const neighborId = isOut ? rel.target_id : rel.source_id;
        
        // Circular Reference Protection
        if (stripPrefix(neighborId) === normRoot) return;

        const node = ensureNode(neighborId, isOut ? rel.target_type : rel.source_type);
        if (!node) return;

        // Relation Label from Spec Section 4
        const rType = (rel.relation_type || '').toUpperCase();
        node.relation = rType;

        // Tier Assignment
        if (node.type === 'knowledge') {
            tiers.explanation.nodes.push(node);
        } else if (node.type === 'model' || node.type === 'tool' || node.type === 'dataset') {
            tiers.core.nodes.push(node);
        } else if (node.type === 'agent' || node.type === 'space' || node.type === 'paper') {
            tiers.utility.nodes.push(node);
        } else if (node.type === 'report') {
            tiers.digest.nodes.push(node);
        }
    });

    // Matrix-Specific Injection (V16.3: Improved Local Density)
    if (entity) {
        // A. Global Mined Relations (from hydrator)
        if (Array.isArray(entity.arxiv_refs)) {
            entity.arxiv_refs.forEach(ref => {
                const node = ensureNode(`arxiv--${ref}`, 'paper');
                if (node) {
                    node.relation = 'CITES';
                    if (!tiers.utility.nodes.find(n => n.id === node.id)) tiers.utility.nodes.push(node);
                }
            });
        }
        if (Array.isArray(entity.datasets_used)) {
            entity.datasets_used.forEach(ds => {
                const node = ensureNode(`dataset--${ds.replace(/\//g, '--')}`, 'dataset');
                if (node) {
                    node.relation = 'TRAINED_ON';
                    if (!tiers.core.nodes.find(n => n.id === node.id)) tiers.core.nodes.push(node);
                }
            });
        }
        if (Array.isArray(entity.similar_models)) {
            entity.similar_models.forEach(m => {
                const node = ensureNode(`model--${m.replace(/\//g, '--')}`, 'model');
                if (node) {
                    node.relation = 'RELATED';
                    if (!tiers.core.nodes.find(n => n.id === node.id)) tiers.core.nodes.push(node);
                }
            });
        }

        // B. Type-Specific Injections
        if (type === 'model') {
            if (entity.base_model) {
                const node = ensureNode(`hf-model--${entity.base_model.replace(/\//g, '--')}`, 'model');
                if (node) {
                    node.relation = 'BASED_ON';
                    if (!tiers.core.nodes.find(n => n.id === node.id)) tiers.core.nodes.push(node);
                }
            }
        } else if (type === 'agent') {
            if (entity.framework) {
                const node = ensureNode(`tool--${entity.framework.toLowerCase()}`, 'tool');
                if (node) {
                    node.relation = 'STACK';
                    if (!tiers.core.nodes.find(n => n.id === node.id)) tiers.core.nodes.push(node);
                }
            }
        } else if (type === 'space') {
            const modelsUsed = entity.meta_json?.models_used || entity.models_used || [];
            modelsUsed.forEach(m => {
               const node = ensureNode(`model--${m.replace(/\//g, '--')}`, 'model');
               if (node) {
                   node.relation = 'USES';
                   if (!tiers.core.nodes.find(n => n.id === node.id)) tiers.core.nodes.push(node);
               }
            });
        }

        // C. Knowledge Links (Global)
        if (Array.isArray(entity.knowledge_links)) {
            entity.knowledge_links.forEach(l => {
                const slug = typeof l === 'string' ? l : l.slug;
                const node = ensureNode(`knowledge--${slug}`, 'knowledge');
                if (node) {
                    node.relation = 'EXPLAINS';
                    if (node && !node.name && typeof l !== 'string' && l.title) node.name = l.title;
                    if (!tiers.explanation.nodes.find(n => n.id === node.id)) tiers.explanation.nodes.push(node);
                }
            });
        }
    }
} catch (e) {
    console.error('[NeuralMeshHub] V16.2 Execution Error:', e);
}

const hasRelations = Object.values(tiers).some(t => t.nodes.length > 0);
---

{hasRelations && (
<section class="neural-graph-explorer" id="neural-mesh-hub">
    <div class="header">
        <div class="title-group">
            <h3 class="title">üï∏Ô∏è Neural Mesh Hub</h3>
            <p class="subtitle">Interconnecting Research, Data & Ecosystem</p>
        </div>
    </div>
    
    <div class="mesh-container space-y-10 mt-8">
        {Object.entries(tiers).map(([key, tier]) => tier.nodes.length > 0 && (
            <div class={`mesh-tier mesh-tier-${key}`} data-zone={tier.zone}>
                <div class="tier-header flex items-center gap-3 mb-6">
                    <span class="tier-icon text-xl p-2 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-100 dark:border-gray-800 shadow-sm">
                        {tier.icon}
                    </span>
                    <div class="flex-1">
                        <h4 class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em]">
                            {tier.title}
                        </h4>
                        <div class="h-px w-full bg-gradient-to-r from-gray-100 dark:from-gray-800 to-transparent mt-2"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    {tier.nodes.map(node => {
                        const cleanId = node.id.replace(/^(hf-model|hf-agent|hf-tool|hf-dataset|hf-space|model|agent|tool|dataset|space|kb|concept|knowledge|report|arxiv|paper|huggingface|huggingface_deepspec|github|replicate)[:\-]+/, '')
                                               .replace(/^(hf-model|hf-agent|hf-tool|hf-dataset|hf-space|huggingface_deepspec|knowledge|kb|report|arxiv|dataset|tool)--/, '');
                        const urlSlug = cleanId.replace(/--/g, '/').replace(/:/g, '/');
                        let path = node.type === 'knowledge' ? `/knowledge/${urlSlug}` : node.type === 'report' ? `/reports/${urlSlug}` : node.type === 'paper' ? `/paper/${urlSlug}` : `/${node.type}/${urlSlug}`;
                        
                        return (
                            <a href={path} class={`mesh-node group relative p-4 bg-white dark:bg-gray-800/40 border border-gray-100 dark:border-gray-700/50 rounded-2xl hover:border-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/5 transition-all duration-300`}>
                                <div class="flex items-start gap-4">
                                    <div class="node-icon-wrapper relative">
                                        <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all duration-500 block">
                                            {node.icon || 'üì¶'}
                                        </span>
                                        {node.relation && (
                                            <span class="relation-badge absolute -top-2 -right-2 px-1.5 py-0.5 bg-indigo-500 text-[8px] font-black text-white rounded shadow-sm uppercase tracking-tighter">
                                                {node.relation}
                                            </span>
                                        )}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between gap-2 mb-1">
                                            <span class="text-sm font-bold text-gray-900 dark:text-white truncate group-hover:text-indigo-500 transition-colors">
                                                {node.name}
                                            </span>
                                            <span class="text-[8px] font-black uppercase tracking-tighter px-1.5 py-0.5 rounded bg-gray-50 dark:bg-gray-900 text-gray-400 border border-gray-100 dark:border-gray-800">
                                                {node.type}
                                            </span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 dark:text-gray-400 line-clamp-1">
                                            {node.author || 'Ecosystem Node'}
                                        </p>
                                    </div>
                                    <div class="flex flex-col justify-center opacity-30 group-hover:opacity-100 transition-opacity">
                                        <span class="text-indigo-500 translate-x-0 group-hover:translate-x-1 transition-transform">‚Üí</span>
                                    </div>
                                </div>
                            </a>
                        );
                    })}
                </div>
            </div>
        ))}
    </div>
</section>
)}

<style>
    .neural-graph-explorer {
        padding: 1.5rem;
    }
    @media (max-width: 640px) {
        .neural-graph-explorer {
            padding: 1rem;
        }
    }
</style>
