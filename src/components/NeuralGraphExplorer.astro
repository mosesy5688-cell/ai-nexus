---
/**
 * Neural Mesh Hub V16.2
 * Unified knowledge orchestration for all 6 entity types.
 * Optimized for Zero-Runtime and Bidirectional Discovery.
 */
import { fetchMeshRelations, fetchGraphMetadata, stripPrefix, isMatch, getRouteFromId } from '../utils/knowledge-cache-reader.js';
import rankingsData from '../data/rankings.json';
import '../styles/neural-graph.css';

interface Props {
    currentModelId?: string;
    entity?: any;
    type?: string;
    meshTiers?: any;
}

const { currentModelId, entity, type = 'model', meshTiers } = Astro.props;
const rootId = currentModelId || entity?.id;
const normRoot = stripPrefix(rootId);

// V16.7 Global Orchestration
import { getMeshProfile } from '../utils/mesh-orchestrator.js';

// 4-Tier Topology
let tiers = meshTiers || {
    explanation: { title: 'üéì Knowledge Base', nodes: [], icon: 'üéì', zone: 'Z3.1' },
    core: { title: 'üîó Core Ecosystem', nodes: [], icon: '‚ö°', zone: 'Z3.2' }, 
    utility: { title: 'üî¨ Research & Data', nodes: [], icon: 'üî¨', zone: 'Z3.3' }, 
    digest: { title: 'üì∞ Timeline & Reports', nodes: [], icon: 'üì∞', zone: 'Z3.4' }
};

try {
    if (!meshTiers && rootId) {
        const profile = await getMeshProfile(Astro.locals, rootId, entity, type);
        tiers = profile.tiers;
    }
} catch (e) {
    console.error('[NeuralMeshHub] V16.7 Orchestration Error:', e);
}

const hasRelations = Object.values(tiers).some(t => t.nodes.length > 0);
---

{hasRelations && (
<div class="neural-graph-wrapper bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
    <section class="neural-graph-explorer" id="neural-mesh-hub">
        <div class="header">
            <div class="title-group">
                <h3 class="title">üï∏Ô∏è Neural Mesh Hub</h3>
                <p class="subtitle">Interconnecting Research, Data & Ecosystem</p>
            </div>
        </div>
        
        <div class="mesh-container space-y-10 mt-8">
            {Object.entries(tiers).map(([key, tier]) => tier.nodes.length > 0 && (
                <div class={`mesh-tier mesh-tier-${key}`} data-zone={tier.zone}>
                    <div class="tier-header flex items-center gap-3 mb-6">
                        <span class="tier-icon text-xl p-2 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-100 dark:border-gray-800 shadow-sm">
                            {tier.icon}
                        </span>
                        <div class="flex-1">
                            <h4 class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em]">
                                {tier.title}
                            </h4>
                            <div class="h-px w-full bg-gradient-to-r from-gray-100 dark:from-gray-800 to-transparent mt-2"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        {tier.nodes.map(node => {
                            const path = getRouteFromId(node.id, node.type);
                            
                            return (
                                <a href={path} class={`mesh-node group relative p-4 bg-white dark:bg-gray-800/40 border border-gray-100 dark:border-gray-700/50 rounded-2xl hover:border-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/5 transition-all duration-300`}>
                                    <div class="flex items-start gap-4">
                                        <div class="node-icon-wrapper relative">
                                            <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all duration-500 block">
                                                {node.icon || 'üì¶'}
                                            </span>
                                            {node.relation && (
                                                <span class="relation-badge absolute -top-2 -right-2 px-1.5 py-0.5 bg-indigo-500 text-[8px] font-black text-white rounded shadow-sm uppercase tracking-tighter">
                                                    {node.relation}
                                                </span>
                                            )}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between gap-2 mb-1">
                                                <span class="text-sm font-bold text-gray-900 dark:text-white truncate group-hover:text-indigo-500 transition-colors">
                                                    {node.name}
                                                </span>
                                                <span class="text-[8px] font-black uppercase tracking-tighter px-1.5 py-0.5 rounded bg-gray-50 dark:bg-gray-900 text-gray-400 border border-gray-100 dark:border-gray-800">
                                                    {node.type}
                                                </span>
                                            </div>
                                            <p class="text-[10px] text-gray-500 dark:text-gray-400 line-clamp-1">
                                                {node.author || 'Ecosystem Node'}
                                            </p>
                                        </div>
                                        <div class="flex flex-col justify-center opacity-30 group-hover:opacity-100 transition-opacity">
                                            <span class="text-indigo-500 translate-x-0 group-hover:translate-x-1 transition-transform">‚Üí</span>
                                        </div>
                                    </div>
                                </a>
                            );
                        })}
                    </div>
                </div>
            ))}
        </div>
    </section>
</div>
)}

<script is:inline>
  // V16.34: Neural Mesh Hub Stability Guard
  function validateMeshHub() {
    const hub = document.getElementById('neural-mesh-hub');
    if (!hub) return;
    
    const nodes = hub.querySelectorAll('.mesh-node');
    // If orchestration failed and zero nodes were rendered, hide the entire section
    // to prevent showing an empty "Knowledge Base" header.
    if (nodes.length === 0) {
      const wrapper = hub.closest('.neural-graph-wrapper');
      if (wrapper) {
        wrapper.style.display = 'none';
        console.warn('[NeuralMesh] Hub stability guard triggered: Zero nodes.');
      }
    }
  }

  // Run on load and view transitions
  validateMeshHub();
  document.addEventListener('astro:after-swap', validateMeshHub);
  document.addEventListener('astro:page-load', validateMeshHub);
</script>

<style>
    .neural-graph-explorer {
        padding: 1.5rem;
    }
    @media (max-width: 640px) {
        .neural-graph-explorer {
            padding: 1rem;
        }
    }
    /* V16.34: Stability Visuals */
    .neural-graph-wrapper {
        min-height: 50px;
    }
</style>
