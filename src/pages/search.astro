---
/**
 * V16.2: Search Page (Static Client-Side)
 * 
 * Refactored to align with Zero-Runtime Constitution.
 * - Removed SSR fetch logic.
 * - Removed /api/search dependency.
 * - Implemented client-side hydration with MiniSearch.
 */
import Layout from '@/layouts/Layout.astro';

export const prerender = true;

const entityTypes = [
  { id: 'all', label: 'All', icon: 'üîç' },
  { id: 'model', label: 'Models', icon: 'ü§ñ' },
  { id: 'space', label: 'Spaces', icon: 'üöÄ' },
  { id: 'agent', label: 'Agents', icon: 'ü§ñ' },
  { id: 'dataset', label: 'Datasets', icon: 'üìä' },
  { id: 'paper', label: 'Papers', icon: 'üìÑ' },
];
---

<Layout title="Search AI Index - Free2AI">
    <meta slot="head" name="robots" content="noindex, follow" />
    
    <main class="max-w-4xl mx-auto min-h-screen py-4">
        <!-- Search Header -->
        <div class="mb-6">
            <h1 id="search-title" class="text-2xl font-black text-gray-900 dark:text-white mb-2 tracking-tighter">
                Neural Mesh Discovery
            </h1>
            
            <!-- Search Form -->
            <form id="results-search-form" class="space-y-4">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="results-search-box"
                        name="q" 
                        placeholder="Search precision technical insights..."
                        class="flex-1 px-4 py-2 text-sm border border-gray-200 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 focus:ring-2 focus:ring-indigo-500/50 focus:outline-none transition-all"
                        minlength="2"
                    />
                    <button 
                        type="submit"
                        class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-black text-sm tracking-widest uppercase"
                    >
                        Search
                    </button>
                </div>
                
                <!-- Type Filter -->
                <div class="flex flex-wrap gap-2">
                    {entityTypes.map(type => (
                        <label class="type-filter-label flex items-center gap-1.5 px-3 py-1 rounded-md cursor-pointer transition-all bg-gray-50 dark:bg-gray-900 text-gray-500 border border-gray-100 dark:border-gray-800 hover:border-indigo-500/50">
                            <input type="radio" name="type" value={type.id} class="sr-only" checked={type.id === 'all'} />
                            <span class="text-sm">{type.icon}</span>
                            <span class="text-[12px] font-black uppercase tracking-wider">{type.label}</span>
                        </label>
                    ))}
                </div>
            </form>
        </div>

        <!-- Smart Trigger for Full Search -->
        <div id="full-search-prompt" class="mb-8 p-4 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl hidden">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h3 class="font-semibold text-indigo-900 dark:text-indigo-300">Limited results found in top models.</h3>
                    <p class="text-sm text-indigo-700 dark:text-indigo-400">Would you like to search the full index of 150K+ models?</p>
                </div>
                <button id="load-full-index-btn" class="whitespace-nowrap px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-bold">
                    Load Full Index (~30MB)
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="search-loading" class="hidden py-12 text-center text-gray-500">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-blue-600 rounded-full mb-4" role="status"></div>
            <p>Initializing search engine...</p>
        </div>

        <!-- Results Area -->
        <div id="search-results-container" class="space-y-8">
            <!-- Will be populated by JS -->
        </div>

        <!-- Empty State -->
        <div id="search-empty-state" class="hidden text-center py-16">
            <div class="text-6xl mb-4">üîç</div>
            <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No results found</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6">Try different keywords or load the full index.</p>
        </div>
    </main>
</Layout>

<script>
    import { initSearch, performSearch, loadFullSearchIndex, getSearchStatus } from '../scripts/home-search.js';
    import { getRouteFromId } from '../utils/mesh-routing-core.js';

    const dom = {
        form: document.getElementById('results-search-form'),
        box: document.getElementById('results-search-box'),
        title: document.getElementById('search-title'),
        results: document.getElementById('search-results-container'),
        loading: document.getElementById('search-loading'),
        empty: document.getElementById('search-empty-state'),
        prompt: document.getElementById('full-search-prompt'),
        fullBtn: document.getElementById('load-full-index-btn')
    };

    async function handleSearch() {
        const query = dom.box.value.trim();
        const type = dom.form.querySelector('input[name="type"]:checked')?.value || 'all';

        if (query.length < 2) return;

        dom.loading.classList.remove('hidden');
        dom.results.innerHTML = '';
        dom.empty.classList.add('hidden');
        dom.prompt.classList.add('hidden');

        await initSearch();
        const results = await performSearch(query, 40);
        const filtered = type === 'all' ? results : results.filter(r => r.type === type);

        // SPEC-SEARCH-V18.2: Clean descriptions (Remove thumbnails/HTML)
        const cleaned = filtered.map(item => ({
            ...item,
            description: (item.description || "").replace(/<img[^>]*>/gi, "").replace(/<p[^>]*>/gi, "").replace(/<\/p>/gi, " ").trim()
        }));

        dom.loading.classList.add('hidden');

        if (cleaned.length === 0) {
            dom.empty.classList.remove('hidden');
            const status = getSearchStatus();
            if (!status.isFullSearchActive) dom.prompt.classList.remove('hidden');
        } else {
            renderResults(cleaned);
        }

        // Update URL
        const url = new URL(window.location);
        url.searchParams.set('q', query);
        url.searchParams.set('type', type);
        window.history.replaceState({}, '', url);
        dom.title.textContent = `Search Results for "${query}"`;
    }

    function renderResults(items) {
        dom.results.innerHTML = `
            <section class="animate-in fade-in duration-500">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-[10px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em]">
                        Neural Mesh Matches (${items.length})
                    </h2>
                </div>
                <div class="flex flex-col border-t border-zinc-200 dark:border-zinc-800">
                    ${items.map(item => {
                        const type = item.type || 'model';
                        const slug = item.slug || item.id;
                        const path = getRouteFromId(slug, type);
                        const fni = Math.round(item.fni_score || item.fni || 0);
                        
                        return `
                        <a href="${path}" class="flex flex-col gap-1.5 py-3 px-2 border-b border-zinc-100 dark:border-zinc-900 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-colors group">
                            <!-- Top Row: Type, Name, and FNI Score -->
                            <div class="flex items-center justify-between gap-2 w-full">
                                <div class="flex items-center gap-2 min-w-0">
                                    <span class="text-[8px] sm:text-[9px] font-bold px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 text-zinc-500 rounded uppercase tracking-tighter border border-zinc-200/50 dark:border-zinc-700/50 flex-shrink-0">
                                        ${type}
                                    </span>
                                    <h3 class="text-xs sm:text-sm font-bold text-zinc-900 dark:text-zinc-100 group-hover:text-blue-600 truncate">
                                        ${item.name}
                                    </h3>
                                </div>
                                
                                ${fni > 0 ? `
                                    <div class="text-emerald-600 dark:text-emerald-400 font-black text-[10px] sm:text-[11px] flex-shrink-0">
                                        FNI ${fni}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Bottom Row: Author and Description (Stacked below) -->
                            <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-zinc-500 dark:text-zinc-400">
                                <span class="text-[10px] sm:text-[11px] font-medium truncate">
                                    by ${item.author || 'Open Source'}
                                </span>
                                
                                <p class="text-[10px] sm:text-[11px] line-clamp-1 opacity-70 sm:opacity-100 italic sm:not-italic">
                                    ${item.description || ''}
                                </p>
                            </div>
                        </a>
                    `;}).join('')}
                </div>
            </section>
        `;
    }

    // Init Logic
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const q = urlParams.get('q');
        const t = urlParams.get('type') || 'all';

        if (q) {
            dom.box.value = q;
            const radio = dom.form.querySelector(`input[value="${t}"]`);
            if (radio) radio.checked = true;
            await handleSearch();
        }

        dom.form.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSearch();
        });

        dom.form.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                // Update UI state
                document.querySelectorAll('.type-filter-label').forEach(lbl => {
                    lbl.classList.remove('bg-blue-600', 'text-white');
                    lbl.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                });
                const label = radio.closest('.type-filter-label');
                label.classList.add('bg-blue-600', 'text-white');
                label.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                handleSearch();
            });
        });

        dom.fullBtn.addEventListener('click', async () => {
            dom.fullBtn.textContent = 'Loading...';
            dom.fullBtn.disabled = true;
            await loadFullSearchIndex();
            dom.fullBtn.classList.add('hidden');
            handleSearch();
        });
    });
</script>
