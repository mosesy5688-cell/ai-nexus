---
/**
 * V16.2: Search Page (Static Client-Side)
 * 
 * Refactored to align with Zero-Runtime Constitution.
 * - Removed SSR fetch logic.
 * - Removed /api/search dependency.
 * - Implemented client-side hydration with MiniSearch.
 */
import Layout from '@/layouts/Layout.astro';

export const prerender = true;

const entityTypes = [
  { id: 'all', label: 'All', icon: 'üîç' },
  { id: 'model', label: 'Models', icon: 'ü§ñ' },
  { id: 'space', label: 'Spaces', icon: 'üöÄ' },
  { id: 'agent', label: 'Agents', icon: 'ü§ñ' },
  { id: 'dataset', label: 'Datasets', icon: 'üìä' },
  { id: 'paper', label: 'Papers', icon: 'üìÑ' },
];
---

<Layout title="Search AI Index - Free2AI">
    <meta slot="head" name="robots" content="noindex, follow" />
    
    <main class="max-w-4xl mx-auto min-h-screen py-4">
        <!-- Search Header -->
        <div class="mb-6">
            <h1 id="search-title" class="text-2xl font-black text-gray-900 dark:text-white mb-2 tracking-tighter">
                Neural Mesh Discovery
            </h1>
            
            <!-- Search Form -->
            <form id="results-search-form" class="space-y-4">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="results-search-box"
                        name="q" 
                        placeholder="Search precision technical insights..."
                        class="flex-1 px-4 py-2 text-sm border border-gray-200 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 focus:ring-2 focus:ring-indigo-500/50 focus:outline-none transition-all"
                        minlength="2"
                    />
                    <button 
                        type="submit"
                        class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-black text-sm tracking-widest uppercase"
                    >
                        Search
                    </button>
                </div>
                
                <!-- Type Filter -->
                <div class="flex flex-wrap gap-2">
                    {entityTypes.map(type => (
                        <label class="type-filter-label flex items-center gap-1.5 px-3 py-1 rounded-md cursor-pointer transition-all bg-gray-50 dark:bg-gray-900 text-gray-500 border border-gray-100 dark:border-gray-800 hover:border-indigo-500/50">
                            <input type="radio" name="type" value={type.id} class="sr-only" checked={type.id === 'all'} />
                            <span class="text-sm">{type.icon}</span>
                            <span class="text-[12px] font-black uppercase tracking-wider">{type.label}</span>
                        </label>
                    ))}
                </div>
            </form>
        </div>

        <!-- Smart Trigger for Full Search -->
        <div id="full-search-prompt" class="mb-8 p-4 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl hidden">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h3 class="font-semibold text-indigo-900 dark:text-indigo-300">Limited results found in top models.</h3>
                    <p class="text-sm text-indigo-700 dark:text-indigo-400">Would you like to search the full index of 150K+ models?</p>
                </div>
                <button id="load-full-index-btn" class="whitespace-nowrap px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-bold">
                    Load Full Index (~30MB)
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="search-loading" class="hidden py-12 text-center text-gray-500">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-blue-600 rounded-full mb-4" role="status"></div>
            <p>Initializing search engine...</p>
        </div>

        <!-- Results Area -->
        <div id="search-results-container" class="space-y-8">
            <!-- Will be populated by JS -->
        </div>

        <!-- Empty State -->
        <div id="search-empty-state" class="hidden text-center py-16">
            <div class="text-6xl mb-4">üîç</div>
            <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No results found</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6">Try different keywords or load the full index.</p>
        </div>
    </main>
</Layout>

<script>
    import { loadFullSearchIndex } from '../scripts/home-search.js';
    import { setupSearchUI } from '../scripts/search-ui-controller.js';
    
    // Init Logic
    document.addEventListener('astro:page-load', async () => {
        const dom = {
            form: document.getElementById('results-search-form'),
            box: document.getElementById('results-search-box'),
            title: document.getElementById('search-title'),
            results: document.getElementById('search-results-container'),
            loading: document.getElementById('search-loading'),
            empty: document.getElementById('search-empty-state'),
            prompt: document.getElementById('full-search-prompt'),
            fullBtn: document.getElementById('load-full-index-btn')
        };

        if (!dom.form) return;

        const { handleSearch } = setupSearchUI(dom);

        const urlParams = new URLSearchParams(window.location.search);
        const q = urlParams.get('q');
        const t = urlParams.get('type') || 'all';

        if (q) {
            dom.box.value = q;
            const radio = dom.form.querySelector(`input[value="${t}"]`);
            if (radio) radio.checked = true;
            await handleSearch();
        }

        dom.form.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSearch();
        });

        dom.form.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                // Update UI state
                document.querySelectorAll('.type-filter-label').forEach(lbl => {
                    lbl.classList.remove('bg-blue-600', 'text-white');
                    lbl.classList.add('bg-gray-50', 'dark:bg-gray-900', 'text-gray-500');
                });
                const label = radio.closest('.type-filter-label');
                label.classList.add('bg-blue-600', 'text-white');
                label.classList.remove('bg-gray-50', 'dark:bg-gray-900', 'text-gray-500');
                handleSearch();
            });
        });

        dom.fullBtn.addEventListener('click', async () => {
            dom.fullBtn.textContent = 'Loading...';
            dom.fullBtn.disabled = true;
            await loadFullSearchIndex();
            dom.fullBtn.classList.add('hidden');
            handleSearch();
        });
    });
</script>
