---
import Layout from '@/layouts/Layout.astro';
import ReportCard from '@/components/ReportCard.astro';
import DailyTrendingSection from '@/components/DailyTrendingSection.astro';
import TrendChart from '@/components/charts/TrendChart.astro';

// V16.2: Fetch reports from CDN (SPEC-KNOWLEDGE-MESH-V16.2 Section 8)
const CDN_BASE = 'https://cdn.free2aitools.com';
let reports = [];

try {
    const paths = [`${CDN_BASE}/cache/reports/index.json.gz`, `${CDN_BASE}/cache/reports/index.json` || []];
    for (const p of paths) {
        const res = await fetch(p);
        if (res.ok) {
            let data;
            if (p.endsWith('.gz')) {
                const ds = new DecompressionStream('gzip');
                const decompressedStream = res.body.pipeThrough(ds);
                const response = new Response(decompressedStream);
                data = await response.json();
            } else {
                data = await res.json();
            }
            
            reports = (data.reports || []).map(r => ({
                reportId: r.id,
                title: r.title,
                date: r.date,
                summary: `${r.highlights || 0} highlights from AI ecosystem today`,
                highlights: r.highlights
            }));
            if (reports.length > 0) break;
        }
    }
} catch (e) {
    console.warn('[Reports] CDN fetch failed, using fallback:', e.message);
    // Fallback to static file if exists
    try {
        const fallback = await Astro.glob('../../data/reports.json');
        reports = fallback[0]?.default || [];
    } catch {
        reports = [];
    }
}

const latestReport = reports.length > 0 ? reports[0] : null;

// V16.2.5: Fallback to Daily Reports if index.json is empty
if (!latestReport) {
    const now = new Date();
    for (let i = 0; i < 7; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        const dateKey = d.toISOString().split('T')[0];
        try {
            // V18.2: Support compressed daily reports directly in reports/
            const paths = [
                `${CDN_BASE}/cache/reports/${dateKey}.json.gz`,
                `${CDN_BASE}/cache/reports/${dateKey}.json`
            ];
            
            for (const p of paths) {
                const dRes = await fetch(p);
                if (dRes.ok) {
                    let dData;
                    if (p.endsWith('.gz')) {
                        const ds = new DecompressionStream('gzip');
                        const decompressedStream = dRes.body.pipeThrough(ds);
                        const response = new Response(decompressedStream);
                        dData = await response.json();
                    } else {
                        dData = await dRes.json();
                    }

                    reports.push({
                        reportId: dateKey,
                        title: `Daily AI Update: ${dateKey}`,
                        date: dData.generated || dData.datePublished || dateKey,
                        summary: dData.summary || dData.daily_brief?.summary || "Daily neural mesh synchronization report.",
                        highlights: dData.highlights?.length || dData.daily_brief?.new_entities_count || 0
                    });
                    break;
                }
            }
            if (reports.length >= 5) break;
        } catch (e) {}
    }
}

const finalLatest = reports.length > 0 ? reports[0] : null;
const olderReports = reports.length > 1 ? reports.slice(1, 5) : [];

const pageTitle = "AI Industry Daily Reports";
const pageDescription = "Stay updated with the latest trends, breakthroughs, and popular models in the open-source AI landscape with our daily reports.";
---

<!-- V14.4 Art 5.6: News-style Reports Listing -->
<Layout title={pageTitle} description={pageDescription}>
  <div class="container mx-auto px-4 py-16">
    <header class="text-center mb-16 max-w-2xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-black text-zinc-900 dark:text-white tracking-tighter mb-4">
        AI Intelligence Reports
      </h1>
      <p class="text-lg text-zinc-500 dark:text-zinc-400 font-medium leading-relaxed mb-8">
        Technical briefings, ecosystem trends, and model velocity analysis for decision-makers.
      </p>
      
      <div class="flex justify-center items-center gap-6">
        <a href="/reports/archive" class="px-4 py-1.5 bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-xs font-black uppercase tracking-widest border border-zinc-200 dark:border-zinc-700 rounded-lg hover:bg-zinc-100 transition-colors">
          Daily Archive
        </a>
        <a href="/reports/annual" class="px-4 py-1.5 bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-xs font-black uppercase tracking-widest border border-zinc-200 dark:border-zinc-700 rounded-lg hover:bg-zinc-100 transition-colors">
          Annual Reports
        </a>
      </div>
    </header>

    <!-- Live Pulse Section -->
    <section class="mb-20">
      <div class="flex items-center gap-4 mb-10">
        <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter">Live Market Pulse</h2>
        <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
      </div>
      <DailyTrendingSection />
    </section>

    <!-- Trend Charts Section -->
    <section class="mb-20">
      <div class="flex items-center gap-4 mb-10">
        <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter">Velocity Trends</h2>
        <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
      </div>
      <div class="bg-white dark:bg-zinc-900 p-8 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm">
        <TrendChart type="line" height="350px" />
      </div>
    </section>

    {finalLatest ? (
      <div class="space-y-20">
        <!-- Latest Briefing -->
        <section>
          <div class="flex items-center gap-4 mb-10">
            <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter text-indigo-600 dark:text-indigo-400">Featured Briefing</h2>
            <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
          </div>
          
          <div class="relative bg-zinc-900 dark:bg-black rounded-3xl p-10 md:p-12 text-white border border-zinc-800 overflow-hidden group">
            <div class="absolute top-0 right-0 w-64 h-full bg-indigo-500/10 blur-[100px] pointer-events-none transition-opacity group-hover:opacity-100 opacity-50"></div>
            
            <div class="relative max-w-3xl">
              <div class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-4">Latest Publication â€¢ {new Date(finalLatest.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
              <h2 class="text-3xl md:text-5xl font-black tracking-tighter mb-6">{finalLatest.title}</h2>
              <p class="text-lg md:text-xl text-zinc-400 font-medium leading-relaxed mb-10 italic">"{finalLatest.summary}"</p>
              
              <a href={`/reports/${finalLatest.reportId}`} class="inline-flex items-center gap-4 px-8 py-4 bg-white text-black rounded-xl font-black text-sm uppercase tracking-widest hover:bg-zinc-200 transition-all active:scale-95 shadow-xl">
                Read Full Briefing <span>â†’</span>
              </a>
            </div>
          </div>
        </section>

        <!-- Intelligence Archive Grid -->
        <section>
          <div class="flex items-center gap-4 mb-10">
            <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter">Recent Intelligence</h2>
            <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {olderReports.map(report => <ReportCard report={report} />)}
          </div>
          
          <div class="text-center mt-12">
            <a href="/reports/archive" class="px-6 py-3 border border-zinc-200 dark:border-zinc-800 rounded-xl text-xs font-black uppercase tracking-widest text-zinc-500 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors">
              View Full Archive &rarr;
            </a>
          </div>
        </section>
      </div>
    ) : (
      <div class="py-24 text-center">
        <div class="text-4xl mb-6">ðŸ“¡</div>
        <p class="text-zinc-500 dark:text-zinc-400 font-medium uppercase tracking-widest text-xs">
          Neural Mesh Synchronizing... No daily reports available.
        </p>
      </div>
    )}
  </div>
</Layout>
