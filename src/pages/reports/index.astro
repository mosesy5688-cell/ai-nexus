---
import Layout from '@/layouts/Layout.astro';
import ReportCard from '@/components/ReportCard.astro';
import DailyTrendingSection from '@/components/DailyTrendingSection.astro';
import TrendChart from '@/components/charts/TrendChart.astro';
import { getRouteFromId } from '@/utils/mesh-routing-core';

// V16.2: Fetch reports from CDN (SPEC-KNOWLEDGE-MESH-V16.2 Section 8)
const CDN_BASE = 'https://cdn.free2aitools.com';
let reports = [];

try {
    const paths = [`${CDN_BASE}/cache/reports/index.json.gz`, `${CDN_BASE}/cache/reports/index.json`];
    for (const p of paths) {
        const res = await fetch(p);
        if (res.ok) {
            let data;
            if (p.endsWith('.gz')) {
                try {
                    const resClone = res.clone();
                    const ds = new DecompressionStream('gzip');
                    const decompressedStream = resClone.body.pipeThrough(ds);
                    const response = new Response(decompressedStream);
                    data = await response.json();
                } catch (decompressError) {
                    console.warn(`[Reports] Gzip failed for ${res.url}, falling back to plain JSON.`);
                    data = await res.json();
                }
            } else {
                data = await res.json();
            }
            
            reports = (data.reports || []).map(r => ({
                reportId: r.id,
                title: r.title,
                date: r.date,
                summary: `${r.highlights || 0} highlights from AI ecosystem today`,
                highlights: r.highlights
            }));
            if (reports.length > 0) break;
        }
    }
} catch (e) {
    console.warn('[Reports] CDN fetch failed, attempting daily recovery:', e.message);
}

// V16.2.5: Fallback to Daily Reports if index.json is empty
if (!reports || reports.length === 0) {
    const now = new Date();
    for (let i = 0; i < 7; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        const dateKey = d.toISOString().split('T')[0];
        try {
            // V18.2: Consistent CDN pathing for daily blocks
            const paths = [
                `${CDN_BASE}/cache/reports/daily/${dateKey}.json.gz`,
                `${CDN_BASE}/cache/reports/daily/${dateKey}.json`
            ];
            
            for (const p of paths) {
                const dRes = await fetch(p);
                if (dRes.ok) {
                    let dData;
                    if (p.endsWith('.gz')) {
                        try {
                            const resClone = dRes.clone();
                            const ds = new DecompressionStream('gzip');
                            const decompressedStream = resClone.body.pipeThrough(ds);
                            const response = new Response(decompressedStream);
                            dData = await response.json();
                        } catch (decompressError) {
                            console.warn(`[Reports] Daily Gzip failed for ${dRes.url}, falling back to plain JSON.`);
                            dData = await dRes.json();
                        }
                    } else {
                        dData = await dRes.json();
                    }

                    reports.push({
                        reportId: dateKey,
                        title: `Daily AI Update: ${dateKey}`,
                        date: dData.generated || dData.datePublished || dateKey,
                        summary: dData.summary || dData.daily_brief?.summary || "Daily neural mesh synchronization report.",
                        highlights: dData.highlights?.length || dData.daily_brief?.new_entities_count || 0
                    });
                    break;
                }
            }
            if (reports.length >= 5) break;
        } catch (e) {}
    }
}

const finalLatest = reports.length > 0 ? reports[0] : null;
const olderReports = reports.length > 1 ? reports.slice(1) : [];

const pageTitle = "AI Industry Daily Reports";
const pageDescription = "Stay updated with the latest trends, breakthroughs, and popular models in the open-source AI landscape with our daily reports.";
---

<!-- V14.4 Art 5.6: News-style Reports Listing -->
<Layout title={pageTitle} description={pageDescription}>
  <div class="container mx-auto px-4 py-16">
    <header class="text-center mb-12 max-w-xl mx-auto">
      <h1 class="text-3xl md:text-4xl font-bold text-zinc-900 dark:text-white tracking-tight mb-3">
        Intelligence Reports
      </h1>
      <p class="text-base text-zinc-500 dark:text-zinc-400 font-medium leading-normal mb-6">
        Technical briefings, ecosystem trends, and model velocity analysis for the neural landscape.
      </p>
      
      <div class="flex justify-center items-center gap-6">
        <a href="/reports/archive" class="px-4 py-1.5 bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-xs font-black uppercase tracking-widest border border-zinc-200 dark:border-zinc-700 rounded-lg hover:bg-zinc-100 transition-colors">
          Daily Archive
        </a>
        <a href="/reports/annual" class="px-4 py-1.5 bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-xs font-black uppercase tracking-widest border border-zinc-200 dark:border-zinc-700 rounded-lg hover:bg-zinc-100 transition-colors">
          Annual Reports
        </a>
      </div>
    </header>

    <!-- Live Pulse Section -->
    <section class="mb-20">
      <div class="flex items-center gap-4 mb-10">
        <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter">Live Market Pulse</h2>
        <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
      </div>
      <DailyTrendingSection />
    </section>

    <!-- Trend Charts Section -->
    <section class="mb-20">
      <div class="flex items-center gap-4 mb-10">
        <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter">Velocity Trends</h2>
        <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
      </div>
      <div class="bg-white dark:bg-zinc-900 p-8 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm">
        <TrendChart type="line" height="350px" />
      </div>
    </section>

    {finalLatest ? (
      <div class="space-y-20">
        <!-- Latest Briefing -->
        <section>
          <div class="flex items-center gap-4 mb-10">
            <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter text-indigo-600 dark:text-indigo-400">Featured Briefing</h2>
            <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
          </div>
          
          <div class="relative bg-zinc-900 dark:bg-black rounded-2xl p-8 md:p-10 text-white border border-zinc-800 overflow-hidden group">
            <div class="absolute top-0 right-0 w-64 h-full bg-indigo-500/10 blur-[100px] pointer-events-none transition-opacity group-hover:opacity-100 opacity-50"></div>
            
            <div class="relative max-w-3xl">
              <div class="text-[9px] font-bold text-indigo-400 uppercase tracking-[0.1em] mb-3">Latest Publication â€¢ {new Date(finalLatest.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
              <h2 class="text-2xl md:text-3xl font-bold tracking-tight mb-4">{finalLatest.title}</h2>
              <p class="text-base md:text-lg text-zinc-400 font-medium leading-normal mb-8 italic">"{finalLatest.summary}"</p>
              
              <a href={getRouteFromId(finalLatest.reportId, 'report')} class="inline-flex items-center gap-3 px-6 py-3 bg-white text-black rounded-lg font-bold text-xs uppercase tracking-wider hover:bg-zinc-200 transition-all active:scale-95 shadow-lg">
                Access Briefing <span>â†’</span>
              </a>
            </div>
          </div>
        </section>

        <!-- Intelligence Archive Grid -->
        <section>
          <div class="flex items-center gap-4 mb-10">
            <h2 class="text-xl font-black text-zinc-900 dark:text-white uppercase tracking-tighter">Recent Intelligence</h2>
            <div class="h-px flex-grow bg-zinc-100 dark:bg-zinc-800"></div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {olderReports.map(report => <ReportCard report={report} />)}
          </div>
          
          <div class="text-center mt-10">
            <a href="/reports/archive" class="px-5 py-2.5 border border-zinc-200 dark:border-zinc-800 rounded-lg text-[10px] font-bold uppercase tracking-wider text-zinc-500 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors">
              Full Archive &rarr;
            </a>
          </div>
        </section>
      </div>
    ) : (
      <div class="py-24 text-center">
        <div class="text-4xl mb-6">ðŸ“¡</div>
        <p class="text-zinc-500 dark:text-zinc-400 font-medium uppercase tracking-widest text-xs">
          Neural Mesh Synchronizing... No daily reports available.
        </p>
      </div>
    )}
  </div>
</Layout>
