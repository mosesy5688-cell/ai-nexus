---
import Layout from '@/layouts/Layout.astro';
import { Markdown } from '@astrojs/markdown-component';
import ModelCard from '@/components/ModelCard.astro';

export async function getStaticPaths() {
    // Import all reports from both the main file and the archives
    const reports = await Astro.glob('../../data/reports.json').then(res => res[0].default);
    const archivedReportModules = await Astro.glob('../../data/report-archives/*.json');
    const archivedReports = archivedReportModules.map(module => module.default);

    // Combine and deduplicate reports
    const allReports = [...reports, ...archivedReports];
    const uniqueReports = Array.from(new Map(allReports.map(report => [report.reportId, report])).values());

    return uniqueReports.map(report => ({
        params: { slug: report.reportId },
        props: { report },
    }));
}

const { report } = Astro.props;
const allModels = await Astro.glob('../../data/models.json').then(res => res[0].default);

const featuredModels = report.featuredModelIds
    ? report.featuredModelIds.map(id => allModels.find(m => m.id === id)).filter(Boolean)
    : [];
---

<Layout title={report.title} description={report.summary}>
    <main class="container mx-auto px-4 py-12">
        <article class="max-w-4xl mx-auto">
            <header class="mb-8 text-center">
                <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white">{report.title}</h1>
                <p class="mt-2 text-lg text-gray-500 dark:text-gray-400">
                    {new Date(report.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}
                </p>
            </header>

            <div class="prose prose-lg dark:prose-invert max-w-none mx-auto">
                {report.sections.map(section => (
                    <section class="mb-12">
                        <h2 class="text-2xl font-bold border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">{section.heading}</h2>
                        <Markdown content={section.content} />
                    </section>
                ))}
            </div>
        </article>
    </main>
</Layout>