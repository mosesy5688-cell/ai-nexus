
---
import Layout from '@/layouts/Layout.astro';
import { marked } from 'marked';

import { loadEntityStreams } from '../../utils/packet-loader.js';
import { hydrateEntity } from '../../utils/entity-cache-reader-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

let report = null;

// V16.7.2: Hybrid Loading - CDN First (Unified Loader)
try {
    const { entity, _meta } = await loadEntityStreams('report', slugStr);
    if (entity) {
        report = hydrateEntity(entity, 'report');
        // V16.8.30: Defensive Title Restoration
        report.title = report.title || report.name || `Daily Technical Briefing: ${slugStr}`;
    }
} catch (e) {
    console.warn(`[Report Detail] Unified loader failed for ${slugStr}:`, e.message);
}

if (!report) {
    // Fallback: Check build-time local modules (Legacy/Initial reports)
    const reportSlug = slugStr.replace(/^daily\//, '');
    const reportModules = import.meta.glob('../../data/report-archives/*.json', { eager: true });
    for (const path in reportModules) {
        if (path.includes(reportSlug)) {
            report = (reportModules[path] as any).default;
            if (report) report = hydrateEntity(report, 'report');
            break;
        }
    }
}

if (!report) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=report-not-found');
}

const pageTitle = report.title || `AI Daily Report - ${slug}`;
const pageDescription = (report.summary || report.subtitle || "").substring(0, 160);
const contentHtml = marked.parse(report.content);
---

<Layout title={pageTitle} description={pageDescription} canonical={`/reports/${reportSlug}`}>
  <div class="container mx-auto px-4 py-12">
    <article class="prose dark:prose-invert max-w-4xl mx-auto">
      <Fragment set:html={contentHtml} />
    </article>
  </div>
</Layout>