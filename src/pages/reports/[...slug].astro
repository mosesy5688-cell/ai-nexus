
---
import Layout from '@/layouts/Layout.astro';
import { marked } from 'marked';

const { slug } = Astro.params;

const CDN_BASE = 'https://cdn.free2aitools.com';
let report = null;

// V16.7.2: Hybrid Loading - CDN First (Static Fallback)
try {
    // Attempt dynamic fetch for post-build reports
    const res = await fetch(`${CDN_BASE}/cache/reports/daily/${slug}.json`);
    if (res.ok) {
        report = await res.json();
    }
} catch (e) {
    console.warn(`[Report Detail] CDN fetch failed for ${slug}, relying on build-time bundle.`);
}

if (!report) {
    // Fallback: Check build-time local modules (Legacy/Initial reports)
    const reportModules = import.meta.glob('../../data/report-archives/*.json', { eager: true });
    for (const path in reportModules) {
        if (path.includes(slug)) {
            report = reportModules[path].default;
            break;
        }
    }
}

if (!report) {
  return Astro.redirect('/404');
}

const pageTitle = report.title || `AI Daily Report - ${slug}`;
const pageDescription = (report.summary || report.subtitle || "").substring(0, 160);
const contentHtml = marked.parse(report.content);
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="container mx-auto px-4 py-12">
    <article class="prose dark:prose-invert max-w-4xl mx-auto">
      <Fragment set:html={contentHtml} />
    </article>
  </div>
</Layout>