
---
import Layout from '@/layouts/Layout.astro';
import { marked } from 'marked';

const { slug } = Astro.params;

const CDN_BASE = 'https://cdn.free2aitools.com';
let report = null;

const reportSlug = slug.replace(/^daily\//, '');

// V16.7.2: Hybrid Loading - CDN First (Static Fallback)
try {
    // V18.2: Support gzipped reports at root cache/reports/
    const paths = [
        `${CDN_BASE}/cache/reports/${reportSlug}.json.gz`,
        `${CDN_BASE}/cache/reports/${reportSlug}.json`
    ];
    
    for (const p of paths) {
        const res = await fetch(p);
        if (res.ok) {
            if (p.endsWith('.gz')) {
                const ds = new DecompressionStream('gzip');
                const decompressedStream = res.body.pipeThrough(ds);
                const response = new Response(decompressedStream);
                report = await response.json();
            } else {
                report = await res.json();
            }
            if (report) break;
        }
    }
} catch (e) {
    console.warn(`[Report Detail] CDN fetch failed for ${slug}, relying on build-time bundle.`);
}

if (!report) {
    // Fallback: Check build-time local modules (Legacy/Initial reports)
    const reportModules = import.meta.glob('../../data/report-archives/*.json', { eager: true });
    for (const path in reportModules) {
        if (path.includes(reportSlug)) {
            report = reportModules[path].default;
            break;
        }
    }
}

if (!report) {
  return Astro.redirect('/404');
}

const pageTitle = report.title || `AI Daily Report - ${slug}`;
const pageDescription = (report.summary || report.subtitle || "").substring(0, 160);
const contentHtml = marked.parse(report.content);
---

<Layout title={pageTitle} description={pageDescription} canonical={`/reports/${reportSlug}`}>
  <div class="container mx-auto px-4 py-12">
    <article class="prose dark:prose-invert max-w-4xl mx-auto">
      <Fragment set:html={contentHtml} />
    </article>
  </div>
</Layout>