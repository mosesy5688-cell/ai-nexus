---
/**
 * Category Ranking Page - V5.2 Refactored
 * Constitution V4.9: Art.X-Entity-List - Lists segregated by type
 * SEO: Independent routes with unique canonical, JSON-LD ItemList
 */

export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import ModelCard from '../../components/ModelCard.astro';
import RankingHeader from '../../components/ranking/RankingHeader.astro';
import RankingCategoryPills from '../../components/ranking/RankingCategoryPills.astro';
import RankingPagination from '../../components/ranking/RankingPagination.astro';
import RankingSeoFooter from '../../components/ranking/RankingSeoFooter.astro';
import { RANKING_CATEGORIES, getCategoryConfig } from '../../data/ranking-categories';

const { category } = Astro.params;
const categoryConfig = getCategoryConfig(category || '');

if (!categoryConfig) {
  return Astro.redirect('/ranking');
}

const pageTitle = categoryConfig.seoTitle;
const pageDescription = categoryConfig.description;
const canonicalUrl = `https://free2aitools.com/ranking/${category}`;

// V5.1.2 Constitution: Load from L8 Precompute cache
let models: any[] = [];
let generatedAt = new Date().toISOString();
let currentPage = 1;
let totalPages = 1;
let totalItems = 0;

try {
  const pageParam = Astro.url.searchParams.get('page');
  currentPage = pageParam ? parseInt(pageParam, 10) : 1;
  if (isNaN(currentPage) || currentPage < 1) currentPage = 1;

  const metaUrl = new URL(`/cache/rankings/${category}/meta.json`, Astro.url.origin);
  const pageUrl = new URL(`/cache/rankings/${category}/p${currentPage}.json`, Astro.url.origin);

  const [metaRes, pageRes] = await Promise.all([
    fetch(metaUrl).catch(() => null),
    fetch(pageUrl)
  ]);

  if (metaRes && metaRes.ok) {
    const metaData = await metaRes.json();
    totalItems = metaData.total || 0;
    totalPages = metaData.pages || 1;
    generatedAt = metaData.generated_at || generatedAt;
  }

  if (pageRes.ok) {
    const pageData = await pageRes.json();
    models = pageData.items || [];
  }
} catch (e) {
  console.error('[Ranking Category] Cache fetch error:', e);
}

// JSON-LD for SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": categoryConfig.title,
  "description": categoryConfig.description,
  "url": canonicalUrl,
  "numberOfItems": models.length,
  "itemListElement": models.slice(0, 10).map((model, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "item": {
      "@type": "SoftwareApplication",
      "name": model.name,
      "description": model.description?.substring(0, 200) || `${model.name} AI model`,
      "url": `https://free2aitools.com/model/${model.slug || model.umid}`,
      "applicationCategory": "AI Model",
      "author": { "@type": "Organization", "name": model.author || "Unknown" }
    }
  }))
};
---

<Layout title={pageTitle} description={pageDescription}>
  <link slot="head" rel="canonical" href={canonicalUrl} />
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <div class="container mx-auto px-4 py-12">
    <RankingHeader 
      categoryTitle={categoryConfig.title} 
      categoryDescription={categoryConfig.description} 
      generatedAt={generatedAt} 
    />

    <RankingCategoryPills currentCategory={category || ''} />

    {models.length > 0 ? (
      <>
        {currentPage === 1 && (
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
              <span>üèÜ</span> Top Ranked
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              {models.slice(0, 3).map((model, index) => (
                <div class={`relative ${index === 0 ? 'md:scale-105' : ''}`}>
                  <div class="absolute -top-3 -left-3 w-10 h-10 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-white font-bold shadow-lg z-10">
                    #{index + 1}
                  </div>
                  <ModelCard model={model} />
                </div>
              ))}
            </div>
          </section>
        )}

        <section>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <span>üìä</span> {currentPage === 1 ? 'Full Rankings' : `Rankings (Page ${currentPage})`}
            </h2>
            <span class="text-sm text-gray-500">
              Showing {models.length} of {totalItems} models
            </span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {models.slice(currentPage === 1 ? 3 : 0).map(model => (
              <ModelCard model={model} />
            ))}
          </div>
          
          <RankingPagination currentPage={currentPage} totalPages={totalPages} />
        </section>
      </>
    ) : (
      <div class="text-center py-20 bg-gray-50 dark:bg-gray-800/30 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700">
        <div class="text-6xl mb-6">üèóÔ∏è</div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Ranking is being built</h2>
        <p class="text-gray-600 dark:text-gray-400 max-w-md mx-auto mb-6">
          Data pipeline is active. Rankings will appear automatically once enough entities are materialized.
        </p>
        <div class="flex justify-center gap-4">
          <a href="/explore" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
            Explore Raw Index
          </a>
        </div>
      </div>
    )}

    <RankingSeoFooter categoryTitle={categoryConfig.title} seoContent={categoryConfig.seoContent} />
  </div>

  <script src="../../scripts/ranking-client.js"></script>
</Layout>
