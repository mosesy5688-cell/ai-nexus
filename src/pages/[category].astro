---
/**
 * [category].astro
 * V6.0.1 Category Listing Page with Client-Side Pagination
 * 
 * SEO: Static-generated landing pages for each category
 * Constitution Annex A.2.1 - 5 Primary Categories
 */

import Layout from '../layouts/Layout.astro';
import ModelCard from '../components/ModelCard.astro';

// ISR Static Generation - Expert recommendation
export const prerender = true;

export function getStaticPaths() {
  return [
    { params: { category: 'text-generation' } },
    { params: { category: 'knowledge-retrieval' } },
    { params: { category: 'vision-multimedia' } },
    { params: { category: 'automation-workflow' } },
    { params: { category: 'infrastructure-ops' } },
  ];
}

const { category } = Astro.params;

// Category metadata
const CATEGORY_META: Record<string, { name: string; description: string; icon: string }> = {
  'text-generation': {
    name: 'Text Generation & Content Creation',
    description: 'Discover open-source language models for chat, code generation, content writing, summarization, and translation.',
    icon: 'üí¨'
  },
  'knowledge-retrieval': {
    name: 'Knowledge Retrieval & Data Analysis',
    description: 'Find embedding models, RAG solutions, and AI for document analysis, Q&A systems, and data insights.',
    icon: 'üîç'
  },
  'vision-multimedia': {
    name: 'Vision & Multimedia Processing',
    description: 'Explore image generation, video AI, speech recognition, and music synthesis models.',
    icon: 'üé®'
  },
  'automation-workflow': {
    name: 'Automation & Workflow Integration',
    description: 'Build AI agents, automation pipelines, and intelligent recommendation systems.',
    icon: '‚ö°'
  },
  'infrastructure-ops': {
    name: 'Infrastructure & Optimization',
    description: 'Tools for model fine-tuning, deployment optimization, and inference acceleration.',
    icon: 'üîß'
  }
};

const meta = CATEGORY_META[category!] || CATEGORY_META['text-generation'];

// V6.0.1: Fetch models from CDN rankings
let models: any[] = [];
let totalCount = 0;

try {
  const rankingsUrl = `https://cdn.free2aitools.com/cache/rankings/${category}/p1.json`;
  const response = await fetch(rankingsUrl);
  if (response.ok) {
    const data = await response.json();
    models = data.models || [];
    totalCount = models.length;
  }
} catch (e) {
  console.error(`[Category] Failed to fetch rankings for ${category}:`, e);
}

const pageTitle = `${meta.name} - Free AI Models | Free2AITools`;
const pageDescription = meta.description;

// Pagination config
const ITEMS_PER_PAGE = 24;
const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
const initialModels = models.slice(0, ITEMS_PER_PAGE);
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-4 mb-4">
        <span class="text-5xl">{meta.icon}</span>
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            {meta.name}
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">
            <span id="model-count">{totalCount.toLocaleString()}</span> models available
          </p>
        </div>
      </div>
      <p class="text-lg text-gray-600 dark:text-gray-400 max-w-3xl">
        {meta.description}
      </p>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
      <div class="flex flex-wrap gap-4 items-center">
        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
          Sort by:
        </label>
        <select id="sort-select" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
          <option value="best">Best Match</option>
          <option value="recent">Most Recent</option>
          <option value="popular">Most Popular</option>
        </select>
        <span class="text-sm text-gray-500 dark:text-gray-400">
          Page <span id="current-page">1</span> of <span id="total-pages">{totalPages}</span>
        </span>
      </div>
    </div>

    <!-- Model Grid -->
    <div id="model-grid" class="model-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {initialModels.length > 0 ? (
        initialModels.map((model: any) => (
          <ModelCard model={model} />
        ))
      ) : (
        <div class="col-span-full py-12 text-center text-gray-500">
          <p class="text-lg">No models found in this category yet.</p>
          <p class="text-sm mt-2">Check back soon as we're adding more models!</p>
        </div>
      )}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="pagination mt-8 flex justify-center">
        <nav id="pagination-nav" class="flex items-center gap-2">
          <button 
            id="prev-btn"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            ‚Üê Previous
          </button>
          <div id="page-numbers" class="flex items-center gap-1">
            <!-- Page numbers will be generated by JS -->
          </div>
          <button 
            id="next-btn"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next ‚Üí
          </button>
        </nav>
      </div>
    )}
  </main>

  <!-- Embed all models data for client-side pagination -->
  <script define:vars={{ models, totalPages, ITEMS_PER_PAGE, category }}>
    window.__CATEGORY_DATA__ = {
      models: models,
      totalPages: totalPages,
      itemsPerPage: ITEMS_PER_PAGE,
      category: category,
      currentPage: 1
    };
  </script>

  <script src="../scripts/category-client.js"></script>
</Layout>
