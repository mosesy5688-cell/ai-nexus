---
/**
 * [category].astro
 * V16.9.23 Unified Category Navigation
 * Standardized for all 6 entity types (Models, Agents, Datasets, Papers, Spaces, Tools).
 * Constitution V16.2 Knowledge Mesh Compliance.
 */

import Layout from '../layouts/Layout.astro';
import ListingControls from '../components/common/ListingControls.astro';
import CatalogCard from '../components/common/CatalogCard.astro';
import { fetchCatalogData, truncateListingItem } from '../utils/catalog-fetcher.js';
import { CATEGORY_METADATA } from '../utils/category-mapping.js';

const { category } = Astro.params;

// V18.12.5.10: Route Guard - Prevent collision with system routes
const RESERVED_ROUTES = ['models', 'ranking', 'agents', 'spaces', 'datasets', 'papers', 'tools', 'search', 'about', 'compliance'];
if (RESERVED_ROUTES.includes(category!)) {
    return Astro.redirect('/404?source=routing-clash&id=' + category);
}

const meta = CATEGORY_METADATA[category!] || {
  label: category!.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' '),
  icon: 'üìÅ',
  description: `Explore top AI resources in the ${category} category.`
};

// V16.9.23: Use unified fetcher for fallback and multi-type support
const { items: rawItems = [], source } = await fetchCatalogData(category, (Astro as any).locals.runtime);
const items = (rawItems || []).slice(0, 100).map(truncateListingItem).filter(Boolean);

const pageTitle = `${meta.label} - AI Technical Index | Free2AI`;
const pageDescription = `Discover the best ${meta.label} AI models, agents, tools and research. Updated daily.`;

// V18.10.2: Explicit Edge Caching
Astro.response.headers.set('Cache-Control', 'public, s-maxage=3600, stale-while-revalidate=86400');
---

<Layout title={pageTitle} description={pageDescription}>
    <main class="min-h-screen py-4">
        <header class="mb-12">
            <div class="flex items-center gap-4 mb-4">
                <span class="text-5xl">{meta.icon}</span>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white tracking-tight">
                        {meta.label} <span class="text-indigo-600">Archive</span>
                    </h1>
                    <p class="text-[10px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] mt-1">
                        V16.2 Knowledge Mesh Indexed
                    </p>
                </div>
            </div>
            <p class="text-base text-gray-600 dark:text-zinc-400 max-w-2xl">
                The authoritative directory of {meta.label.toLowerCase()} intelligence. Sharded across models, agents, datasets, and research.
            </p>
        </header>

        <ListingControls type="all" searchId="category-search" categoryFilterId="category-filter" />

        <div id="category-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {items.map((item: any) => (
                <div class="animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <CatalogCard item={item} type={item.type || 'model'} />
                </div>
            ))}
            {items.length === 0 && (
                <div class="col-span-full py-20 text-center border-2 border-dashed border-gray-100 dark:border-gray-800 rounded-3xl">
                    <span class="text-4xl block mb-4 opacity-50">üì°</span>
                    <p class="text-gray-400 font-bold uppercase tracking-widest text-sm">Synchronizing category data...</p>
                    <p class="text-xs text-gray-500 mt-2 italic">Real-time indexing in progress for ${category}</p>
                </div>
            )}
        </div>

        <div id="pagination" class="mt-16 flex justify-center items-center gap-4"></div>
    </main>

    <script define:vars={{ initialData: items, category }}>
        window.__CATALOG_DATA__ = initialData;
    </script>

    <script>
        import { UniversalCatalog } from '../scripts/lib/UniversalCatalog.js';
        
        const init = () => {
            // Get category from URL path for the dataUrl
            const pathParts = window.location.pathname.split('/');
            const category = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

            new UniversalCatalog({
                initialData: window.__CATALOG_DATA__ || [],
                type: 'all', // Show all types in category view
                gridId: 'category-grid',
                searchId: 'category-search',
                dataUrl: `https://cdn.free2aitools.com/cache/rankings/${category}/p1.json`
            });
        };

        document.addEventListener('DOMContentLoaded', init);
        document.addEventListener('astro:after-swap', init);
    </script>
</Layout>
