---
/**
 * [category].astro
 * V6.1 Category Listing Page with Client-Side Pagination
 * V3.2 Phase 7: Added CategoryFilters sidebar
 * 
 * SEO: Static-generated landing pages for each category
 * Constitution Annex A.2.1 - 5 Primary Categories
 */

import Layout from '../layouts/Layout.astro';
import ModelCard from '../components/ModelCard.astro';
import CategoryFilters from '../components/category/CategoryFilters.astro';
import TopPicks from '../components/category/TopPicks.astro';

// SSR Mode - Dynamic data-driven rendering
// export const prerender = true;


const { category } = Astro.params;

// Category metadata
const CATEGORY_META: Record<string, { name: string; description: string; icon: string }> = {
  'text-generation': {
    name: 'Text Generation & Content Creation',
    description: 'Discover open-source language models for chat, code generation, content writing, summarization, and translation.',
    icon: 'üí¨'
  },
  'knowledge-retrieval': {
    name: 'Knowledge Retrieval & Data Analysis',
    description: 'Find embedding models, RAG solutions, and AI for document analysis, Q&A systems, and data insights.',
    icon: 'üîç'
  },
  'vision-multimedia': {
    name: 'Vision & Multimedia Processing',
    description: 'Explore image generation, video AI, speech recognition, and music synthesis models.',
    icon: 'üé®'
  },
  'automation-workflow': {
    name: 'Automation & Workflow Integration',
    description: 'Build AI agents, automation pipelines, and intelligent recommendation systems.',
    icon: '‚ö°'
  },
  'infrastructure-ops': {
    name: 'Infrastructure & Optimization',
    description: 'Tools for model fine-tuning, deployment optimization, and inference acceleration.',
    icon: 'üîß'
  },
  'image-generation': {
    name: 'Image Generation & Multimedia Processing',
    description: 'Explore high-quality models for text-to-image, video synthesis, and creative AI.',
    icon: 'üé®'
  }
};

const meta = CATEGORY_META[category!] || {
  name: category!.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ') + ' - Technical Index',
  description: `Explore top AI models in the ${category} category. Powered by Free2AI.`,
  icon: 'üìÅ'
};

// V6.0.1: Fetch models from CDN rankings
let models: any[] = [];
let totalCount = 0;

try {
  const rankingsUrl = `https://cdn.free2aitools.com/cache/rankings/${category}/p1.json`;
  const response = await fetch(rankingsUrl);
  if (response.ok) {
    const data = await response.json();
    // V10.1 / V16.6 Fix: CDN returns 'entities' for Universal Protocol
    models = data.entities || data.items || data.models || [];
    totalCount = data.totalEntities || data.total_items || models.length;
  }
} catch (e) {
  console.error(`[Category] Failed to fetch rankings for ${category}:`, e);
}

const pageTitle = `${meta.name} - Technical Index | Free2AI`;
const pageDescription = meta.description + " Powered by Free2AI.";

// Pagination config
const ITEMS_PER_PAGE = 24;
const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
const initialModels = models.slice(0, ITEMS_PER_PAGE);
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-4 mb-3">
        <span class="text-4xl">{meta.icon}</span>
        <div>
          <h1 class="text-2xl font-black text-gray-900 dark:text-white tracking-tighter">
            {meta.name}
          </h1>
          <p class="text-[12px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">
            <span id="model-count">{totalCount.toLocaleString()}</span> Entities Indexed
          </p>
        </div>
      </div>
      <p class="text-lg text-gray-600 dark:text-gray-400 max-w-3xl">
        {meta.description}
      </p>
    </header>

    <!-- Top Picks Section (Phase 7) -->
    <TopPicks models={models} category={category} />

    <!-- Two Column Layout: Filters + Content -->
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Sidebar Filters (Phase 7: Simplified) -->
      <CategoryFilters category={category} />
      
      <!-- Main Content -->
      <div class="flex-1">
        <!-- Sort Bar (Updated for FNI default) -->
        <div class="filter-bar mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex items-center gap-3">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                Sort by:
              </label>
              <select id="sort-select" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                <option value="fni" selected>üõ°Ô∏è FNI Score (Recommended)</option>
                <option value="popular">‚¨áÔ∏è Most Downloads</option>
                <option value="recent">üÜï Most Recent</option>
              </select>
            </div>
            <span class="text-sm text-gray-500 dark:text-gray-400">
              Page <span id="current-page">1</span> of <span id="total-pages">{totalPages}</span>
            </span>
          </div>
        </div>

        <!-- Model Grid -->
    <div id="model-grid" class="model-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {initialModels.length > 0 ? (
        initialModels.map((model: any) => (
          <ModelCard model={model} />
        ))
      ) : (
        <div class="col-span-full py-12 text-center text-gray-500">
          <p class="text-lg">No models found in this category yet.</p>
          <p class="text-sm mt-2">Check back soon as we're adding more models!</p>
        </div>
      )}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="pagination mt-8 flex justify-center">
        <nav id="pagination-nav" class="flex items-center gap-2">
          <button 
            id="prev-btn"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            ‚Üê Previous
          </button>
          <div id="page-numbers" class="flex items-center gap-1">
            <!-- Page numbers will be generated by JS -->
          </div>
          <button 
            id="next-btn"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next ‚Üí
          </button>
        </nav>
      </div>
    )}
      </div>  <!-- Close flex-1 -->
    </div>  <!-- Close flex container -->
  </main>

  <!-- Embed all models data for client-side pagination -->
  <script define:vars={{ models, totalPages, ITEMS_PER_PAGE, category }}>
    window.__CATEGORY_DATA__ = {
      models: models,
      totalPages: totalPages,
      itemsPerPage: ITEMS_PER_PAGE,
      category: category,
      currentPage: 1
    };
  </script>

  <script src="../scripts/category-client.js"></script>
</Layout>
