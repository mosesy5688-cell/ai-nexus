---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import FullMetadata from '../../components/entity/FullMetadata.astro';
import ModelMainColumn from '../../components/model-detail/ModelMainColumn.astro';
import ModelSidebar from '../../components/model-detail/ModelSidebar.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import RelatedResearch from '../../components/model-detail/RelatedResearch.astro';
import RelatedKnowledge from '../../components/model-detail/RelatedKnowledge.astro';
import VramEstimator from '../../components/model-detail/VramEstimator.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import EntityRelations from '../../components/entity/EntityRelations.astro';
import CoreDesktop from '../../components/model-detail/CoreDesktop.astro';
import MiniTrendChart from '../../components/charts/MiniTrendChart.astro';
import ModelZones from '../../components/model-detail/ModelZones.astro';
import QuickStart from '../../components/model-detail/QuickStart.astro';
import { getModelFromCache } from '../../utils/entity-cache-reader';
import { deriveEntityType, ENTITY_DEFINITIONS } from '../../data/entity-definitions';
import { cleanDescription, generateModelJsonLd, hasCapability } from '../../utils/model-page-helpers';

const { slug } = Astro.params;
let model = null;
let error = null;
let similarModels = [];
let tagsArray = [];
let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";
let cleanedDesc = "";

try {
  if (!slug) throw new Error("No slug provided");
  
  model = await getModelFromCache(slug, Astro.locals);

  // V14: Handle malformed 'u/' prefix - redirect to search
  if (!model) {
    const parts = Array.isArray(slug) ? slug : slug.split('/');
    if (parts[0] === 'u' && parts.length === 2) {
      return Astro.redirect(`/search?q=${encodeURIComponent(parts[1])}`, 302);
    }
  }
  if (model) {
    const resolution = deriveEntityType(model);
    model.entityType = resolution.type;
    model.entityDefinition = ENTITY_DEFINITIONS[model.entityType];

    // Similar models logical stub (D1 banned)
    if (model.similar_models && Array.isArray(model.similar_models)) {
        const rawSimilar = model.similar_models;
        const resolvedPromises = rawSimilar.map(async (item) => {
            if (typeof item === 'string') {
                return await getModelFromCache(item, Astro.locals);
            }
            return item;
        });
        similarModels = (await Promise.all(resolvedPromises)).filter(Boolean);
    }

    tagsArray = Array.isArray(model.tags) ? model.tags : [];
    
    const modelName = model.name || model.canonical_name || model.id || 'Unknown Model';
    pageTitle = `${modelName} - AI Model Insights & Benchmarks`;
    
    const cleanDescriptionFn = (desc) => !desc ? '' : desc
      .replace(/^---[\s\S]*?---\s*/m, '').replace(/^---\s*\n?[\s\S]*$/m, '')
      .replace(/\blibrary_name:\s*\w+/gi, '').replace(/\blicense:\s*[^\s]+/gi, '')
      .replace(/\bpipeline_tag:\s*\w+/gi, '').replace(/\bbase_model\b[^.]*\.?/gi, '')
      .replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim();
    
    cleanedDesc = cleanDescriptionFn(model.description);
    pageDescription = model.seo_summary?.description || 
                      (cleanedDesc ? cleanedDesc.substring(0, 160) : `Deep dive into ${modelName}.`);
  }
} catch (e) {
  console.error("Error loading model:", e);
  error = e;
  Astro.response.status = 500;
}

if (!model && !error) {
  Astro.response.status = 404;
}

// Capability Gating
const hasFNI = hasCapability(model, 'fni_score') && (model?.fni_score !== undefined || model?.fni_percentile !== undefined);
const hasBenchmarks = hasCapability(model, 'benchmarks');
const hasBench = Boolean(model?.mmlu || model?.benchmark_mmlu || model?.benchmark_hellaswag || model?.benchmark_arc);
const placeholderImage = '/images/models/default-model.jpg';
const coverImage = model?.cover_image_url || placeholderImage;
const modelName = model?.name || model?.canonical_name || 'Unknown Model';
const modelId = model?.umid || model?.id || '';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = model ? getUseCases(tagsArray, model.pipeline_tag, 'model', model.fni_score) : { goodFor: [], limits: [] };

const jsonld = generateModelJsonLd(model, Array.isArray(slug) ? slug.join('/') : slug, coverImage);
---

<EntityLayout 
  entity={model} 
  type="model" 
  title={pageTitle} 
  description={pageDescription}
  image={coverImage}
  jsonld={jsonld}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={modelName}
      entityType="model"
      entityIcon={model?.entityDefinition?.display?.icon || 'ðŸ§ '}
      entityLabel={model?.entityDefinition?.display?.labelSingular || 'Model'}
      verified={false} 
      author={model?.author}
      lastUpdated={model?.last_updated}
      description={model?.seo_summary?.description || cleanedDesc}
      fniScore={model?.fni_score}
      fniPercentile={model?.fni_percentile}
    >
       <div slot="actions" class="flex gap-2">
          <a href={model?.source_url} target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition-all">
             View Source
          </a>
       </div>
    </EntityHeader>

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />

    {/* Zone 3: Core (Desktop) */}
    <div slot="core-desktop">
       <CoreDesktop
          model={model}
          tagsArray={tagsArray}
          hasBench={hasBench}
          modelId={modelId}
          modelName={modelName}
          similarModels={similarModels}
       />
    </div>

    {/* Zone 3: Core (Mobile Tabs) */}
    <div slot="core-knowledge">
       <RelationsPanel
          baseModel={model?.base_model}
          datasetsUsed={model?.datasets_used || []}
          arxivRefs={model?.arxiv_refs || []}
       />
       <RelatedKnowledge tags={tagsArray} description={model?.description || ''} />
    </div>

    <div slot="core-similar">
       {similarModels.length > 0 ? (
          <ModelCarousel models={similarModels} />
       ) : (
          <p class="text-gray-500 italic p-4 text-center">No similar models found.</p>
       )}
    </div>

     <div slot="core-benchmarks">
         {hasBench && (
           <BenchmarkCard 
             umid={modelId}
             name={modelName}
             mmlu={model?.mmlu || model?.benchmark_mmlu}
             humaneval={model?.humaneval || model?.benchmark_humaneval}
             hellaswag={model?.hellaswag || model?.benchmark_hellaswag}
             arc_challenge={model?.arc_challenge || model?.benchmark_arc}
             avg_score={model?.avg_score || model?.benchmark_avg || 0}
           />
         )}
     </div>

     <div slot="core-trends">
        <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
          <h3 class="font-bold mb-4 text-gray-900 dark:text-white">Interaction Trend</h3>
          <MiniTrendChart entityId={modelId} width={500} height={200} />
        </div>
     </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
       <div class="space-y-12">
          <QuickStart 
            modelId={modelId}
            modelName={modelName}
            pipeline_tag={model?.pipeline_tag}
            author={model?.author}
          />
          <ModelMainColumn 
             model={model} 
             hasFNI={hasFNI} 
             hasBenchmarkCap={hasBenchmarks} 
             modelName={modelName} 
             modelId={modelId} 
           />
       </div>
    </div>

    <div slot="sidebar" class="space-y-12">
       <ModelSidebar model={model} modelId={modelId} />
       <ModelNavigation 
          pipelineTag={model?.pipeline_tag}
          hasGguf={model?.has_gguf}
       />
    </div>

    <div slot="full-metadata">
       <FullMetadata entity={model} />
    </div>
  
    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={model?.source} lastUpdated={model?.last_updated} />
    </div>
</EntityLayout>