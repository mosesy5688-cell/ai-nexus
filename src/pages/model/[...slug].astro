---
import Layout from '../../layouts/Layout.astro';
import RelatedModels from '../../components/RelatedModels.astro';
import { getModelBySlug } from '../../utils/db'; // 假设这是您的DB工具函数引用

const { slug } = Astro.params;

// 初始化变量，防止 undefined 错误
let model = null;
let relatedModels = [];
let error = null;
let pageTitle = "AI Model Details";
let pageDescription = "View details for this AI model.";

// --- 阶段 1: 数据获取与防御性解析 ---
try {
  if (!slug) {
    throw new Error("No slug provided");
  }

  // 获取原始数据
  const result = await getModelBySlug(slug);
  
  if (result) {
    model = result;
    
    // [防御性检查 1] 确保 model 是对象
    if (typeof model !== 'object') {
       console.error("Critical: Model is not an object:", model);
       model = null;
    } else {
        // [防御性检查 2] 处理 description (防止它是对象)
        if (typeof model.description !== 'string') {
            // 如果是对象则转字符串，如果是 null 则给空串
            model.description = model.description ? String(model.description) : ""; 
        }

        // [防御性检查 3] 处理 related_ids (从 JSON 字符串转为数组)
        if (model.related_ids) {
            try {
                const parsed = typeof model.related_ids === 'string' 
                    ? JSON.parse(model.related_ids) 
                    : model.related_ids;
                
                if (Array.isArray(parsed)) {
                    // 这里假设您有逻辑将 ID 列表转换为模型对象列表
                    // 如果 relatedModels 已经在 getModelBySlug 中处理好，则直接赋值
                    // 这里的核心是确保它是一个数组
                    relatedModels = parsed; 
                }
            } catch (jsonErr) {
                console.warn("Failed to parse related_ids:", jsonErr);
                relatedModels = [];
            }
        }
    }
  }
} catch (e) {
  console.error("SSR Error fetching model:", e);
  error = e.message;
  // 注意：这里不 return error 对象，而是允许页面继续渲染（显示错误提示或404）
}

// --- 阶段 2: 路由控制 (唯一的 return 点) ---
if (!model) {
  console.log(`Model not found for slug: ${slug}, returning 404.`);
  return new Response(null, {
    status: 404,
    statusText: 'Not Found'
  });
}

// --- 阶段 3: 布局参数安全生成 ---
// 确保传入 Layout 的绝对是字符串，杜绝 [object Object]
pageTitle = typeof model.name === 'string' && model.name.trim() !== ''
    ? `${model.name} - AI Nexus`
    : "AI Model Details - AI Nexus";

pageDescription = typeof model.description === 'string' 
    ? model.description.substring(0, 160).replace(/[\n\r]/g, ' ') + "..."
    : "Explore this AI model on AI Nexus.";

// [调试探针] 输出最终传给模板的数据类型
console.log('RENDER CHECK:', {
    slug,
    modelNameType: typeof model.name,
    descType: typeof model.description,
    pageTitle,
    relatedCount: Array.isArray(relatedModels) ? relatedModels.length : 'Not Array'
});
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8">
    
    {/* 错误展示区 */}
    {error && (
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <p>System Error: {error}</p>
        </div>
    )}

    <article class="prose lg:prose-xl mx-auto">
      {/* 标题区 */}
      <h1 class="text-3xl font-bold mb-4">{model.name}</h1>
      
      {/* 元数据区 */}
      <div class="flex flex-wrap gap-2 mb-6 text-sm text-gray-600">
        {model.author && <span class="bg-gray-100 px-2 py-1 rounded">Author: {String(model.author)}</span>}
        {model.pipeline_tag && <span class="bg-blue-100 px-2 py-1 rounded">Task: {String(model.pipeline_tag)}</span>}
        <span>Likes: {Number(model.likes || 0)}</span>
        <span>Downloads: {Number(model.downloads || 0)}</span>
      </div>

      {/* 封面图 (如果有) */}
      {model.cover_image_url && typeof model.cover_image_url === 'string' && (
          <img 
            src={model.cover_image_url} 
            alt={`${model.name} cover`}
            class="w-full h-auto rounded-lg shadow-md mb-8 object-cover max-h-[400px]"
            loading="lazy"
          />
      )}

      {/* 描述内容区 - 确保渲染的是 string */}
      <div class="bg-white p-6 rounded-lg shadow-sm border mb-8">
        <h2 class="text-xl font-semibold mb-4">Model Description</h2>
        <div class="whitespace-pre-wrap font-sans text-gray-800">
            {model.description || "No description available."}
        </div>
      </div>

      {/* 相关推荐区 */}
      {Array.isArray(relatedModels) && relatedModels.length > 0 && (
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">Related Models</h2>
          <RelatedModels models={relatedModels} />
        </div>
      )}
    </article>
  </main>
</Layout>
