---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import ModelHero from '../../components/ModelHero.astro';
import TabbedContent from '../../components/TabbedContent.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import { getModelBySlug } from '../../utils/db';

const { slug } = Astro.params;

// åˆå§‹åŒ–å˜é‡ï¼Œé˜²æ­¢ undefined é”™è¯¯
let model = null;
let relatedModels = [];
let relatedIds = [];
let error = null;
let pageTitle = "AI Model Details";
let pageDescription = "View details for this AI model.";

// --- é˜¶æ®µ 1: æ•°æ®è·å–ä¸é˜²å¾¡æ€§è§£æ ---
try {
  if (!slug) {
    throw new Error("No slug provided");
  }

  // è·å–åŸå§‹æ•°æ®
  const result = await getModelBySlug(slug, Astro.locals);
  
  if (result) {
    model = result;
    
    // [é˜²å¾¡æ€§æ£€æŸ¥ 1] ç¡®ä¿ model æ˜¯å¯¹è±¡
    if (typeof model !== 'object') {
       console.error("Critical: Model is not an object:", model);
       model = null;
    } else {
        // [é˜²å¾¡æ€§æ£€æŸ¥ 2] å¤„ç† description (é˜²æ­¢å®ƒæ˜¯å¯¹è±¡)
        if (typeof model.description !== 'string') {
            model.description = model.description ? String(model.description) : ""; 
        }

        // [é˜²å¾¡æ€§æ£€æŸ¥ 3] å¤„ç† related_ids
        if (model.related_ids) {
            try {
                const parsed = JSON.parse(model.related_ids);
                if (Array.isArray(parsed)) {
                    relatedIds = parsed;
                }
            } catch (e) {
                console.warn("Failed to parse related_ids JSON:", e);
                relatedIds = [];
            }
        }
    }
        
    // ğŸ”¥ SMART FALLBACK & ULTIMATE FALLBACK
    if (relatedIds.length === 0) {
        try {
            const db = Astro.locals?.runtime?.env?.DB;
            if (db) {
                // Attempt 1: Tag-based fallback
                if (model.pipeline_tag) {
                    const stmt = db.prepare(`
                        SELECT id, name, author, likes, downloads, cover_image_url, description 
                        FROM models 
                        WHERE pipeline_tag = ? AND id != ?
                        ORDER BY downloads DESC 
                        LIMIT 6
                    `);
                    const { results } = await stmt.bind(model.pipeline_tag, model.id).all();
                    relatedModels = results || [];
                }

                // Attempt 2: Ultimate Fallback (Top Downloads) if still empty
                if (relatedModels.length === 0) {
                     const stmt = db.prepare(`
                        SELECT id, name, author, likes, downloads, cover_image_url, description 
                        FROM models 
                        WHERE id != ?
                        ORDER BY downloads DESC 
                        LIMIT 6
                    `);
                    const { results } = await stmt.bind(model.id).all();
                    relatedModels = results || [];
                }
            }
        } catch (fallbackErr) {
            console.warn("Fallback strategies failed:", fallbackErr);
        }
    }
  }
} catch (e) {
  console.error("SSR Error fetching model:", e);
  error = e.message;
}

// --- é˜¶æ®µ 2: è·¯ç”±æ§åˆ¶ ---
// --- é˜¶æ®µ 2: è·¯ç”±æ§åˆ¶ ---
if (!model || typeof model !== 'object' || !model.id || !model.name) {
  Astro.response.status = 404;
  Astro.response.statusText = 'Not Found';
  error = "Model not found or invalid data returned.";
  // Don't return early, let the Layout render with the error message
}

// --- é˜¶æ®µ 3: å¸ƒå±€å‚æ•°å®‰å…¨ç”Ÿæˆ ---
if (model) {
    pageTitle = typeof model.name === 'string' && model.name.trim() !== ''
        ? `${model.name} - AI Nexus`
        : "AI Model Details - AI Nexus";

    pageDescription = typeof model.description === 'string' 
        ? model.description.substring(0, 160).replace(/[\n\r]/g, ' ') + "..."
        : "Explore this AI model on AI Nexus.";
}

// --- é˜¶æ®µ 4: ç”Ÿæˆ links_data ---
const linksData = model ? JSON.stringify({
  source_url: model.source_url || `https://huggingface.co/${model.id}`,
  docs_url: model.docs_url || (model.source_url ? `${model.source_url}#readme` : ''),
  demo_url: model.demo_url || ''
}) : '{}';
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Fallback: Inject CSS directly in body if head injection fails -->
  
  <main class="container mx-auto px-4 py-8">
    
    {error ? (
        <div class="max-w-4xl mx-auto text-center py-12">
            <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-8 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold mb-4">Model Not Found</h2>
                <p class="mb-6">{error}</p>
                <a href="/" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700">
                    Return Home
                </a>
            </div>
        </div>
    ) : (
        <article class="lg:prose-xl mx-auto">
          <ModelHero 
            name={model.name}
            description={model.description}
            author={model.author}
            likes={Number(model.likes || 0)}
            downloads={Number(model.downloads || 0)}
            pipelineTag={model.pipeline_tag}
            linksData={linksData}
            lastUpdated={model.last_updated}
            license={model.license}
          />

          <TabbedContent
            overview={model.description || ""}
            quickStart={model.quick_start || ""}
            useCases={model.use_cases || ""}
            resources={model.resources || ""}
          />

          <div class="mt-12">
            <h2 class="text-2xl font-bold mb-6">Related Models</h2>
            <ModelCarousel 
                models={relatedModels} 
            />
          </div>
        </article>
    )}
  </main>
</Layout>
