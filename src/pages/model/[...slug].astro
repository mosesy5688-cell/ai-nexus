---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference.js';
import VramEstimator from '../../components/model-detail/VramEstimator.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import { fetchEntityFromR2, normalizeEntitySlug, hydrateEntity, augmentEntity } from '../../utils/entity-cache-reader-core.js';
import { deriveEntityType, ENTITY_DEFINITIONS } from '../../data/entity-definitions.js';
import { cleanDescription, generateModelJsonLd, hasCapability } from '../../utils/model-page-helpers.ts';
import { getModelFromCache } from '../../utils/entity-cache-reader.js';
import { loadSpecs, loadBenchmarks } from '../../utils/loadCachedJSON.js';
import { loadEntityStreams } from '../../utils/packet-loader.js';
import { getRouteFromId } from '../../utils/mesh-routing-core.js';

// V16.7.0: Component Restoration for High-Density Display
import UniversalCore from '../../components/entity/UniversalCore.astro';
import CiteEntity from '../../components/common/CiteEntity.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import ModelMainColumn from '../../components/model-detail/ModelMainColumn.astro';
import QuickCommands from '../../components/common/QuickCommands.astro';
import FNITrustPanel from '../../components/FNITrustPanel.astro';


const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
let model = null;
let error = null;
let similarModels = [];
let tagsArray = [];
let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";
let cleanedDesc = "";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug provided");
  // 2. Efficient Data Loading (3-Stream Parallel V16.5)
  const type = 'model';
  // V16.5: Static Assembly Architecture
  const { entity, html, mesh, _meta } = await loadEntityStreams(type, slugStr);
  
  // 3. Validation & 404 Handling (Zero-Entropy V16.8.15.2)
  // Ensure we have a valid entity and not just a metadata stub (fused fallback with no detail)
  // A valid model detail MUST have a source_url or a valid description.
  const hasIdentity = entity.name || model?.name;
  const hasContent = entity.source_url || entity.description?.length > 10 || entity.fni_score > 0;
  const isValidEntity = entity && hasIdentity && hasContent;
  
  if (!entity || !_meta.available || !isValidEntity) {
    // V15.12: Explicit 404 for unknown entities or corrupted shards
    console.warn(`[Astro] 404 Triggered for ${slugStr}: Metadata available: ${_meta.available}, Valid Entity: ${!!isValidEntity}`);
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=entity-not-found&id=' + encodeURIComponent(slugStr));
  }

  // 4. Transform & Prepare
  model = hydrateEntity(entity, type);
  meshRelations = mesh || []; 
  tagsArray = model?.tags || [];

  const displayModelName = model?.name || model?.canonical_name || 'Unknown Model';
  pageTitle = `${displayModelName} - AI Model Insights & Benchmarks`;
  cleanedDesc = cleanDescription(model?.description || '');
  pageDescription = model?.seo_summary?.description || cleanedDesc || `Deep dive into ${displayModelName}.`;
  
  // V16.5: Explicit HTML Assignment (Stream B Source)
  model.html_readme = html || model.html_readme || null; 

} catch (e) {
  console.error("Error loading model:", e);
  error = e;
  // V16.99: Suppress 500 to allow "Mesh Node Building" fallback UI
  // Astro.response.status = 500; 
}

if (!model && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=model-not-found');
}

// Capability Gating
const hasFNI = hasCapability(model, 'fni_score') && (model?.fni_score !== undefined || model?.fni_percentile !== undefined);
const hasBenchmarks = hasCapability(model, 'benchmarks');
const hasBench = Boolean(model?.mmlu || model?.benchmark_mmlu || model?.benchmark_hellaswag || model?.benchmark_arc);
const placeholderImage = '/images/models/default-model.jpg';
const coverImage = model?.cover_image_url || placeholderImage;
const modelName = model?.name || 'Unknown Model';
const displayAuthor = model?.author || 'Independent / Community';
const entityId = model?.id || slugStr;
const modelId = entityId;

// V15.0: Derived Use Cases and Limits
const derivedUseCases = model ? getUseCases(tagsArray, model.pipeline_tag, 'model', model.fni_score) : { goodFor: [], limits: [] };
const jsonld = generateModelJsonLd(model, Array.isArray(slug) ? slug.join('/') : slug, coverImage);
const canonicalPath = model ? getRouteFromId(model.id || model.umid || slugStr, 'model') : undefined;
---

<EntityLayout 
  entity={model} 
  type="model" 
  title={pageTitle} 
  description={pageDescription}
  image={coverImage}
  jsonld={jsonld}
  canonical={canonicalPath}
>
    {/* Zone 1: Hero */}
    {model && (
      <EntityHeader 
        slot="hero"
        name={modelName}
        entityType="model"
        entityIcon={model.entityDefinition?.display?.icon || 'ðŸ§ '}
        entityLabel={model.entityDefinition?.display?.labelSingular || 'Model'}
        verified={false} 
        author={model.author}
        lastUpdated={model.last_updated}
        description={model.seo_summary?.description || cleanedDesc}
        fniScore={model.fni_score}
        fniPercentile={model.fni_percentile}
        fniCommentary={model.fni_commentary}
        paramsB={model.params_billions}
        sourceUrl={model.source_url}
        entityId={modelId}
        hasImage={Boolean(model.image_url)}
        trend_7d={model.trend_7d}
      />
    )}

    {/* Zone 2: Insights Extra */}
    {model && (
      <div slot="insights-extra" class="mt-4 space-y-8">
         <div class="passport-block animate-slide-up" style="animation-delay: 0.2s;">
            <ModelInfoTable 
              type="model"
              model={{
                ...model,
                displayName: modelName
              }} 
            />
         </div>
         {model.params_billions && <VramEstimator paramsB={model.params_billions} contextLen={model.context_length} />}
      </div>
    )}
    
    {/* Zone 1.5: Use Cases */}
    {model && (
      <ZoneUseCases 
        slot="use-cases" 
        usecases={getUseCases(model)} 
      />
    )}

    {/* Zone 3: CORE (Knowledge Mesh & Relations) */}
    {model && (
      <div slot="core-desktop" class="space-y-16">
         <UniversalCore entity={model} type="model" meshRelations={meshRelations} />
         
         <div class="cite-block animate-slide-up" style="animation-delay: 0.4s;">
            <CiteEntity 
              id={modelId} 
              name={modelName} 
              author={model.author} 
              url={model.source_url} 
              type="model" 
            />
         </div>
      </div>
    )}
  
    {model && (
      <div slot="deep-dive" class="space-y-12">
         {/* Zone 4.1: Developer Quick Tools (Always-On) */}
         <div class="space-y-8">
            <QuickCommands entity={model} type="model" />
            {hasFNI && (
              <FNITrustPanel 
                fniScore={model.fni_score}
                fniPercentile={model.fni_percentile}
                fniCommentary={model.fni_commentary}
                modelName={modelName}
                modelId={modelId}
              />
            )}
            {model.vram_estimate > 0 && <VramEstimator paramsB={model.params_billions} contextLen={model.context_length} />}
         </div>

         {/* Zone 4.2: Primary Documentation / Technical Content */}
         <div class="pt-8 border-t border-gray-100 dark:border-gray-800">
            <div class="space-y-12">
              <section class="mb-12">
                 <ModelNavigation />
              </section>
              <ModelMainColumn 
                model={model} 
                modelId={modelId}
                modelName={modelName}
                cleanDescription={cleanedDesc}
                jsonld={jsonld}
              />
            </div>
         </div>
      </div>
    )}

    {/* Zone 5: Community */}
    {model && (
      <div slot="community">
          <AiDisclaimer source={model.source} lastUpdated={model.last_updated} />
      </div>
    )}
</EntityLayout>