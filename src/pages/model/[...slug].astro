---
export const prerender = false;

/**
 * Model Detail Page V5.1.2 (Refactored)
 * Constitution V4.9 Entity-First Architecture
 * Compliant with CES V5.1.2 Anti-Monolith (<250 lines)
 */

import Layout from '../../layouts/Layout.astro';
import ModelHeader from '../../components/model-detail/ModelHeader.astro';
import ModelMainColumn from '../../components/model-detail/ModelMainColumn.astro';
import ModelSidebar from '../../components/model-detail/ModelSidebar.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';

// V4.9.1: Constitutional D1 = 0 - Use R2 cache reader instead of D1 queries
import { getModelFromCache } from '../../utils/entity-cache-reader';
import { deriveEntityType, ENTITY_DEFINITIONS } from '../../data/entity-definitions';

const { slug } = Astro.params;

let model = null;
let error = null;
let similarModels = [];
let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";

try {
  if (!slug) throw new Error("No slug provided");
  
  // V4.9.1: Const D1 = 0 - Read from R2 cache only
  model = await getModelFromCache(slug, Astro.locals);

  if (model) {
    const resolution = deriveEntityType(model);
    model.entityType = resolution.type;
    model.entityDefinition = ENTITY_DEFINITIONS[model.entityType];

    // Similar models logical stub (D1 banned)
    if (model.similar_models && Array.isArray(model.similar_models)) {
        similarModels = model.similar_models;
    }

    const modelName = model.name || model.canonical_name || 'Unknown Model';
    pageTitle = `${modelName} - AI Model Insights & Benchmarks`;
    pageDescription = model.seo_summary?.description || 
                      (model.description ? model.description.substring(0, 160) : `Deep dive into ${modelName}.`);
  }
} catch (e) {
  console.error("Error loading model:", e);
  error = e;
  Astro.response.status = 500;
}

if (!model && !error) {
  Astro.response.status = 404;
  Astro.response.headers.set('Cache-Control', 'no-store, no-cache, max-age=0');
}

// Capability Gating Helpers
const hasCapability = (capId) => {
    if (!model || !model.entityDefinition?.capabilities) return true;
    return model.entityDefinition.capabilities.includes(capId);
};
const hasFNI = hasCapability('fni_score') && (model?.fni_score !== undefined || model?.fni_percentile !== undefined);
const hasBenchmarks = hasCapability('benchmarks');
const hasBench = Boolean(model?.mmlu || model?.benchmark_mmlu || model?.benchmark_hellaswag || model?.benchmark_arc);

const placeholderImage = '/images/models/default-model.jpg';
const coverImage = model?.cover_image_url || placeholderImage;
const modelName = model?.name || model?.canonical_name || 'Unknown Model';
const modelId = model?.umid || model?.id || '';
const cleanDesc = model?.description ? model.description.replace(/<[^>]*>?/gm, '') : '';
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="model-detail-page bg-gray-50 dark:bg-gray-900 min-h-screen">
    {error ? (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-red-50 text-red-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Error Loading Page</h1>
          <p class="text-gray-600 mb-6">{error.message}</p>
          <a href="/explore" class="inline-block bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Browse Models</a>
        </div>
      </div>
    ) : model ? (
      <article class="container mx-auto px-4 py-8 max-w-7xl">
        <ModelHeader 
          modelName={modelName}
          entityType={model.entityType}
          entityIcon={model.entityDefinition?.display?.icon}
          entityLabel={model.entityDefinition?.display?.labelSingular}
          verified={false} 
          author={model.author}
          lastUpdated={model.last_updated}
          seoDescription={model.seo_summary?.description}
          cleanDescription={cleanDesc}
        />

        {hasBench && hasBenchmarks && (
          <section class="mb-8">
            <BenchmarkCard 
              umid={model.umid || model.id || ''}
              name={modelName}
              mmlu={model.mmlu || model.benchmark_mmlu}
              humaneval={model.humaneval || model.benchmark_humaneval}
              hellaswag={model.hellaswag || model.benchmark_hellaswag}
              arc_challenge={model.arc_challenge || model.benchmark_arc}
              avg_score={model.avg_score || model.benchmark_avg || 0}
            />
          </section>
        )}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <ModelMainColumn 
            model={model} 
            hasFNI={hasFNI} 
            hasBenchmarkCap={hasBenchmarks} 
            modelName={modelName} 
            modelId={modelId} 
          />
          
          <ModelSidebar 
            model={model} 
            modelId={modelId} 
          />
        </div>

        {similarModels.length > 0 && (
          <section class="mt-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Similar Models</h2>
             <ModelCarousel models={similarModels} />
          </section>
        )}

        <ModelNavigation 
          pipelineTag={model.pipeline_tag}
          hasGguf={model.has_gguf}
        />
      </article>
    ) : (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-yellow-50 text-yellow-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Model Not Found</h1>
          <p class="text-gray-600 mb-6">The model you are looking for does not exist or has been removed.</p>
          <a href="/explore" class="inline-block bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Browse Models</a>
        </div>
      </div>
    )}
  </main>
</Layout>

<style>
  .model-detail-page {
    padding-top: 1rem;
  }
</style>