---
// This is an Astro dynamic route page for server-side rendering (SSR).
//It replaces the logic from the manual `functions/[[path]].js`.
import Layout from '@/layouts/Layout.astro';

export const prerender = false; // This page must be SSR.

const { slug } = Astro.params;
const { locals } = Astro; // Access runtime context provided by the Cloudflare adapter

let model = null;
let error = null;

if (!slug) {
    return Astro.redirect('/', 301);
}

try {
    // This logic is the exact reverse of the link creation in the frontend.
    const modelId = slug.replace(/--/g, '/');
    
    // Access the D1 database via locals.runtime
    const db = locals.runtime?.env?.DB;

    if (db) {
        // Try two queries:
        // 1. First, try to find by splitting author/name (most common case)
        // 2. If not found, try to find by id directly
        
        // Split into author and name (name might contain slashes)
        const firstSlashIndex = modelId.indexOf('/');
        
        if (firstSlashIndex !== -1) {
            const author = modelId.substring(0, firstSlashIndex);
            const name = modelId.substring(firstSlashIndex + 1);
            
            // Try query by author and name
            let stmt = db.prepare('SELECT * FROM models WHERE author = ? AND name = ?');
            model = await stmt.bind(author, name).first();
            
            // If not found, try by id (for models without separate author field)
            if (!model) {
                stmt = db.prepare('SELECT * FROM models WHERE id = ?');
                model = await stmt.bind(modelId).first();
            }
        } else {
            // No slash, just query by id
            const stmt = db.prepare('SELECT * FROM models WHERE id = ?');
            model = await stmt.bind(modelId).first();
        }
    } else {
        throw new Error("Database connection is not available.");
    }

} catch (e) {
    console.error(`Error fetching model with slug "${slug}":`, e);
    error = e.message;
}

// If model is not found, Astro will automatically render the 404 page.
if (!model) {
    return new Response(null, { status: 404, statusText: 'Not Found' });
}

const pageTitle = `${model.name} - AI Model Details | Free AI Tools`;
const descriptionText = (() => {
    if (typeof model.description === 'string') {
        return model.description;
    } else if (model.description && typeof model.description === 'object') {
        return model.description.text || JSON.stringify(model.description);
    }
    return '';
})();
const pageDescription = descriptionText ? descriptionText.substring(0, 160) : `Details for the AI model ${model.name} by ${model.author || 'Unknown'}.`;

// Debug logging
console.log(`Rendering model: ${model.name}, Author: ${model.author || '(no author field)'}, Description type: ${typeof model.description}`);
---
<Layout title={pageTitle} description={pageDescription}>
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <a href="/" class="text-blue-600 hover:underline">&larr; Back to Home</a>
            <div class="flex items-center justify-between mt-4">
                <div>
                    <h1 class="text-4xl font-bold">{model.name}</h1>
                    <p class="text-lg text-gray-600">by {model.author}</p>
                </div>
                <div class="flex gap-4">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        ❤️ {model.likes || 0}
                    </span>
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        ⬇️ {model.downloads || 0}
                    </span>
                </div>
            </div>
        </header>

        {model.link_status === 'broken' && (
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6" role="alert">
                <strong class="font-bold">Warning:</strong>
                <span class="block sm:inline"> The source link for this model appears to be broken.</span>
            </div>
        )}

        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-6">
                {model.cover_image_url && (
                    <img 
                        src={model.cover_image_url} 
                        alt={`Cover for ${model.name}`} 
                        class="w-full h-auto rounded-lg shadow-lg object-cover max-h-96"
                    />
                )}

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">About this Model</h2>
                    
                    {model.seo_summary ? (
                        <div class="prose dark:prose-invert max-w-none mb-6">
                            <h3 class="text-lg font-medium text-blue-600">AI Generated Overview</h3>
                            <p class="text-gray-700 dark:text-gray-300">{model.seo_summary}</p>
                        </div>
                    ) : null}

                    <h3 class="text-lg font-medium mt-4">Original Description</h3>
                    <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap text-sm">
                        {descriptionText || 'No description available.'}
                    </p>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Comments</h2>
                    <div id="comments-section">
                        <!-- Comments will be loaded here via client-side JS or separate component -->
                        <p class="text-gray-500 italic">Comments loading...</p>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Tags</h3>
                    <div class="flex flex-wrap gap-2">
                        {model.tags && (() => {
                            try {
                                const tags = typeof model.tags === 'string' ? JSON.parse(model.tags) : model.tags;
                                return Array.isArray(tags) ? tags.map(tag => (
                                    <a href={`/?tag=${tag}`} class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600">
                                        {tag}
                                    </a>
                                )) : null;
                            } catch (e) { return null; }
                        })()}
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Metadata</h3>
                    <ul class="space-y-2 text-sm">
                        <li><strong>Pipeline:</strong> {model.pipeline_tag || 'Unknown'}</li>
                        <li><strong>Indexed:</strong> {new Date(model.first_indexed).toLocaleDateString()}</li>
                        <li>
                            <strong>Source:</strong> 
                            <a href={model.source_url || `https://huggingface.co/${model.id}`} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline ml-1">
                                Visit Source
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </main>
    </div>
</Layout>