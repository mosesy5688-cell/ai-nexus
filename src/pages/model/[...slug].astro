---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import ModelHero from '../../components/ModelHero.astro';
import TabbedContent from '../../components/TabbedContent.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import { getModelBySlug } from '../../utils/db';

const { slug } = Astro.params;

// ÂàùÂßãÂåñÂèòÈáèÔºåÈò≤Ê≠¢ undefined ÈîôËØØ
let model = null;
let relatedModels = [];
let relatedIds = [];
let error = null;
let pageTitle = "AI Model Details";
let pageDescription = "View details for this AI model.";

// --- Èò∂ÊÆµ 1: Êï∞ÊçÆËé∑Âèñ‰∏éÈò≤Âæ°ÊÄßËß£Êûê ---
try {
  if (!slug) {
    throw new Error("No slug provided");
  }

  // Ëé∑ÂèñÂéüÂßãÊï∞ÊçÆ
  const result = await getModelBySlug(slug, Astro.locals);
  
  if (result) {
    model = result;
    
    // [Èò≤Âæ°ÊÄßÊ£ÄÊü• 1] Á°Æ‰øù model ÊòØÂØπË±°
    if (typeof model !== 'object') {
       console.error("Critical: Model is not an object:", model);
       model = null;
    } else {
        // [Èò≤Âæ°ÊÄßÊ£ÄÊü• 2] Â§ÑÁêÜ description (Èò≤Ê≠¢ÂÆÉÊòØÂØπË±°)
        if (typeof model.description !== 'string') {
            model.description = model.description ? String(model.description) : ""; 
        }

            const db = Astro.locals?.runtime?.env?.DB;
            if (db) {
                const placeholders = relatedIds.map(() => '?').join(',');
                const stmt = db.prepare(`
                    SELECT id, name, author, likes, downloads, cover_image_url, description 
                    FROM models 
                    WHERE id IN (${placeholders})
                `);
                const { results } = await stmt.bind(...relatedIds).all();
                relatedModels = results || [];
            }
        } catch (queryErr) {
            console.warn("Failed to query related_ids:", queryErr);
        }
    }

    // üî• STEP 2: SMART FALLBACK & ULTIMATE FALLBACK (if still no data)
    if (relatedModels.length === 0) {
        try {
            const db = Astro.locals?.runtime?.env?.DB;
            if (db) {
                // Attempt 1: Tag-based fallback
                if (model.pipeline_tag) {
                    const stmt = db.prepare(`
                        SELECT id, name, author, likes, downloads, cover_image_url, description 
                        FROM models 
                        WHERE pipeline_tag = ? AND id != ?
                        ORDER BY downloads DESC 
                        LIMIT 6
                    `);
                    const { results } = await stmt.bind(model.pipeline_tag, model.id).all();
                    relatedModels = results || [];
                }

                // Attempt 2: Ultimate Fallback (Top Downloads) if still empty
} catch (e) {
  console.error("SSR Error fetching model:", e);
  error = e.message;
}

// --- Èò∂ÊÆµ 2: Ë∑ØÁî±ÊéßÂà∂ ---
// --- Èò∂ÊÆµ 2: Ë∑ØÁî±ÊéßÂà∂ ---
if (!model || typeof model !== 'object' || !model.id || !model.name) {
  Astro.response.status = 404;
  Astro.response.statusText = 'Not Found';
  error = "Model not found or invalid data returned.";
  // Don't return early, let the Layout render with the error message
}

// --- Èò∂ÊÆµ 3: Â∏ÉÂ±ÄÂèÇÊï∞ÂÆâÂÖ®ÁîüÊàê ---
if (model) {
    pageTitle = typeof model.name === 'string' && model.name.trim() !== ''
        ? `${model.name} - AI Nexus`
        : "AI Model Details - AI Nexus";

    pageDescription = typeof model.description === 'string' 
        ? model.description.substring(0, 160).replace(/[\n\r]/g, ' ') + "..."
        : "Explore this AI model on AI Nexus.";
}

// --- Èò∂ÊÆµ 4: ÁîüÊàê links_data ---
const linksData = model ? JSON.stringify({
  source_url: model.source_url || `https://huggingface.co/${model.id}`,
  docs_url: model.docs_url || (model.source_url ? `${model.source_url}#readme` : ''),
  demo_url: model.demo_url || ''
}) : '{}';
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Fallback: Inject CSS directly in body if head injection fails -->
  
  <main class="container mx-auto px-4 py-8">
    
    {error ? (
        <div class="max-w-4xl mx-auto text-center py-12">
            <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-8 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold mb-4">Model Not Found</h2>
                <p class="mb-6">{error}</p>
                <a href="/" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700">
                    Return Home
                </a>
            </div>
        </div>
    ) : (
          </div>
        </article>
    )}
  </main>
</Layout>
