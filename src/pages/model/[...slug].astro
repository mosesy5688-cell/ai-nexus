---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import ModelHero from '../../components/ModelHero.astro';
import TabbedContent from '../../components/TabbedContent.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import Comments from '../../components/Comments.astro';
import { getModelBySlug } from '../../utils/db';

const { slug } = Astro.params;

// Initialize variables
let model = null;
let relatedModels = [];
let relatedIds = [];
let error = null;
let pageTitle = "AI Model Details";
let pageDescription = "View details for this AI model.";

// ---------------------------------------------------
// Stage 1: Fetch data with defensive checks
// ---------------------------------------------------
try {
  if (!slug) {
    throw new Error("No slug provided");
  }

  const result = await getModelBySlug(slug, Astro.locals);
  if (result) {
    model = result;
    // Defensive: ensure model is an object
    if (typeof model !== "object" || model === null) {
      console.error("Critical: Model is not an object:", model);
      model = null;
    } else {
      // Defensive: description should be a string
      if (typeof model.description !== "string") {
        model.description = model.description ? String(model.description) : "";
      }
      // Defensive: parse related_ids if present
      if (model.related_ids) {
        try {
          const parsed = JSON.parse(model.related_ids);
          if (Array.isArray(parsed)) {
            relatedIds = parsed;
          }
        } catch (e) {
          console.warn("Failed to parse related_ids JSON:", e);
          relatedIds = [];
        }
      }
    }

    // STEP 1: Query explicit related IDs
    if (relatedIds.length > 0) {
      try {
        const db = Astro.locals?.runtime?.env?.DB;
        if (db) {
          const placeholders = relatedIds.map(() => "?").join(",");
          const stmt = db.prepare(`
            SELECT id, name, author, likes, downloads, cover_image_url, description, resources
            FROM models
            WHERE id IN (${placeholders})
          `);
          const { results } = await stmt.bind(...relatedIds).all();
          relatedModels = results || [];
        }
      } catch (queryErr) {
        console.warn("Failed to query related_ids:", queryErr);
      }
    }

    // STEP 2: Fallback to tag‑based or top‑downloads if needed
    if (relatedModels.length === 0) {
      try {
        const db = Astro.locals?.runtime?.env?.DB;
        if (db) {
          // Tag‑based fallback
          if (model.pipeline_tag) {
            const stmt = db.prepare(`
              SELECT id, name, author, likes, downloads, cover_image_url, description, resources
              FROM models
              WHERE pipeline_tag = ? AND id != ?
              ORDER BY downloads DESC
              LIMIT 6
            `);
            const { results } = await stmt.bind(model.pipeline_tag, model.id).all();
            relatedModels = results || [];
          }
          // Ultimate fallback: top downloads excluding current model
          if (relatedModels.length === 0) {
            const stmt = db.prepare(`
              SELECT id, name, author, likes, downloads, cover_image_url, description, resources
              FROM models
              WHERE id != ?
              ORDER BY downloads DESC
              LIMIT 6
            `);
            const { results } = await stmt.bind(model.id).all();
            relatedModels = results || [];
          }
        }
      } catch (fallbackErr) {
        console.warn("Fallback strategies failed:", fallbackErr);
      }
    }
  }
} catch (e) {
  console.error("SSR Error fetching model:", e);
  error = e.message;
}

// ---------------------------------------------------
// Stage 2: Routing control – handle missing/invalid model
// ---------------------------------------------------
if (!model || typeof model !== "object" || !model.id || !model.name) {
  Astro.response.status = 404;
  Astro.response.statusText = "Not Found";
  error = "Model not found or invalid data returned.";
}

// ---------------------------------------------------
// Stage 3: Generate page metadata safely
// ---------------------------------------------------
if (model) {
  pageTitle = typeof model.name === "string" && model.name.trim() !== ""
    ? `${model.name} - AI Nexus`
    : "AI Model Details - AI Nexus";

  pageDescription = typeof model.description === "string"
    ? model.description.substring(0, 160).replace(/[\n\r]/g, " ") + "..."
    : "Explore this AI model on AI Nexus.";
}

// ---------------------------------------------------
// Stage 4: Prepare links data for ModelHero
// ---------------------------------------------------
const linksData = model
  ? JSON.stringify({
      source_url: model.source_url || "",
      docs_url: model.docs_url || "",
      demo_url: model.demo_url || "",
    })
  : "{}";

---
<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8">
    {error ? (
      <div class="max-w-4xl mx-auto text-center py-12">
        <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-8 rounded-lg shadow-sm">
          <h2 class="text-2xl font-bold mb-4">Model Not Found</h2>
          <p class="mb-6">{error}</p>
          <a href="/" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700">
            Return Home
          </a>
        </div>
      </div>
    ) : (
      <article class="lg:prose-xl mx-auto">
        <!-- Forced static placeholder to guarantee visible content -->
        <div class="bg-gray-100 p-8 rounded-lg text-center mb-6">
          <h2 class="text-2xl font-bold mb-2">Content Placeholder</h2>
          <p>This static HTML ensures the page always displays core content even if dynamic data is missing.</p>
        </div>
        <ModelHero
          name={model.name}
          description={model.description}
          author={model.author}
          likes={Number(model.likes || 0)}
          downloads={Number(model.downloads || 0)}
          pipelineTag={model.pipeline_tag}
          linksData={linksData}
          lastUpdated={model.last_updated}
          license={model.license}
        />
        {/* Main Content Area - Simplified Linear Flow */}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 mt-8">
          
          {/* Left Column: Description & Details */}
          <div class="lg:col-span-2 space-y-12">
            
            {/* About Section */}
            <section>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">About this Model</h2>
              <div class="prose lg:prose-xl max-w-none dark:prose-invert text-gray-700 dark:text-gray-300">
                <div class="whitespace-pre-wrap">{model.description || model.seo_summary || "No description available."}</div>
              </div>
            </section>

            {/* Resources Section (Always Visible) */}
            {model.resources && model.resources !== "[]" && (
              <section class="bg-blue-50 dark:bg-gray-800 rounded-xl p-6 border border-blue-100 dark:border-gray-700">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  Resources & Files
                </h3>
                {(() => {
                  try {
                    let parsed = [];
                    try {
                      parsed = JSON.parse(model.resources);
                    } catch (e) {
                      // Fallback for raw strings
                      if (typeof model.resources === 'string' && model.resources.startsWith('http')) {
                        parsed = [{ platform: 'Source', url: model.resources }];
                      }
                    }
                    
                    if (Array.isArray(parsed) && parsed.length > 0) {
                      return (
                        <ul class="space-y-3">
                          {parsed.map((res: any) => (
                            <li class="flex items-start gap-3">
                              <svg class="w-5 h-5 text-gray-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                              </svg>
                              <div>
                                <a href={res.url} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium break-all">
                                  {res.url}
                                </a>
                                {res.files && res.files.length > 0 && (
                                  <p class="text-sm text-gray-500 mt-1">
                                    Includes {res.files.length} file{res.files.length !== 1 ? 's' : ''}
                                  </p>
                                )}
                              </div>
                            </li>
                          ))}
                        </ul>
                      );
                    }
                  } catch (e) {
                    return <p class="text-sm text-gray-500">Resource data available at source link.</p>;
                  }
                })()}
              </section>
            )}

            {/* Comments Placeholder */}
            <Comments modelId={model.id} />

          </div>

          {/* Right Column: Quick Stats & Sidebar */}
          <div class="space-y-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
              <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Quick Stats</h3>
              <dl class="space-y-4">
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">License</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{model.license || "Unknown"}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Downloads</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{Number(model.downloads).toLocaleString()}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Likes</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{Number(model.likes).toLocaleString()}</dd>
                </div>
              </dl>
            </div>
          </div>

        </div>
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">Related Models</h2>
          <ModelCarousel models={relatedModels} />
        </div>
      </article>
    )}
  </main>
</Layout>
