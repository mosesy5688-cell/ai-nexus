---
export const prerender = false;

/**
 * Model Detail Page V4.8.1
 * Constitution V4.8.1 Compliant
 * 6-Section Display Order per Art.1-E
 */

import Layout from '../../layouts/Layout.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import GraphExplorer from '../../components/GraphExplorer.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import FNIBadge from '../../components/FNIBadge.astro';
import FNITrustPanel from '../../components/FNITrustPanel.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import SpecsTable from '../../components/specs/SpecsTable.astro';
import DeployabilityBadge from '../../components/specs/DeployabilityBadge.astro';
import ResourceList from '../../components/ResourceList.astro';
import AffiliateCard from '../../components/Commercial/AffiliateCard.astro';
import NeuralExplorer from '../../components/NeuralExplorer.astro';
import EntityLinksSection from '../../components/EntityLinksSection.astro';

import { resolveToModel } from '../../utils/umid-resolver';
import { safeParseJSON } from '../../utils/model-detail-builder';

const slugParam = Astro.params.slug;
let slug = Array.isArray(slugParam) ? slugParam.join('/') : (slugParam || '');
// Decode URL-encoded characters like %3A ‚Üí : for hf-dataset:deepmind:code_contests
slug = decodeURIComponent(slug);

// Debug: trace actual slug value (check in browser dev tools Network tab)
Astro.response.headers.set('X-Debug-Slug', slug || 'EMPTY');
Astro.response.headers.set('X-Debug-SlugParam', JSON.stringify(slugParam) || 'NULL');

let model = null;
let error = null;
let similarModels = [];
let resolution = null;

let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";

try {
  if (!slug) throw new Error("No slug provided");
  
  console.log(`[Model Page] Resolving slug: "${slug}"`);
  const result = await resolveToModel(slug, Astro.locals);
  console.log(`[Model Page] Resolution result:`, result?.resolution?.source, result?.model?.id);
  model = result?.model || null;
  resolution = result?.resolution || null;
  
  if (model) {
    pageTitle = `${model.name || model.canonical_name || 'Model'} by ${model.author || 'Unknown'} | Free AI Tools`;
    const desc = model.description || model.seo_summary || 'AI model details';
    pageDescription = desc.substring(0, 160).replace(/---[\s\S]*?---/g, '').replace(/[#*`]/g, '');
    
    const db = Astro.locals?.runtime?.env?.DB;
    if (db && model.pipeline_tag) {
      try {
        const stmtResult = await db.prepare(`
          SELECT id, name, author, likes, downloads, cover_image_url, fni_score
          FROM models
          WHERE pipeline_tag = ? AND id != ?
          ORDER BY downloads DESC
          LIMIT 6
        `).bind(model.pipeline_tag, model.id).all();
        similarModels = stmtResult?.results || [];
      } catch (e) {
        console.warn("Similar models fetch failed:", e);
      }
    }
  }
} catch (e) {
  console.error("[Model Page] Error:", e);
  error = e;
}

const tags = model ? safeParseJSON(model.tags, []) : [];
const resources = model ? safeParseJSON(model.resources, []) : [];
const coverImage = model?.cover_image_url || '/default-model.png';
const modelId = model?.umid || model?.id || '';
const modelName = model?.name || model?.canonical_name || 'Unknown Model';
const hasBench = Boolean(
  model?.has_benchmarks ||
  model?.hasBenchmarks ||
  model?.mmlu ||
  model?.avg_score ||
  model?.benchmark_avg
);

// Per Constitution V4.3.1: Error pages should not be cached
if (!model && !error) {
  Astro.response.status = 404;
  Astro.response.headers.set('Cache-Control', 'no-store, no-cache, max-age=0');
}
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="model-detail-page bg-gray-50 dark:bg-gray-900 min-h-screen">
    {error ? (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-red-50 text-red-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Error Loading Model</h1>
          <p class="text-gray-600 mb-6">{error.message}</p>
          <a href="/explore" class="inline-block bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Browse Models</a>
        </div>
      </div>
    ) : model ? (
      <article class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8">
          <div class="flex flex-col lg:flex-row gap-6 items-start">
            <div class="w-full lg:w-64 flex-shrink-0">
              <img 
                src={coverImage} 
                alt={modelName}
                class="w-full rounded-xl shadow-lg bg-gray-200"
                loading="eager"
                fetchpriority="high"
              />
            </div>
            
            <div class="flex-1">
              <div class="flex flex-wrap items-center gap-3 mb-2">
                <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white">
                  {modelName}
                </h1>
                <FNIBadge 
                  score={model?.fni_score || 0} 
                  percentile={model?.fni_percentile || 0}
                  dimensions={{ p: model?.fni_p || 0, v: model?.fni_v || 0, c: model?.fni_c || 0, u: model?.fni_u || 0 }}
                />
                {model?.deploy_score > 0 && (
                  <DeployabilityBadge score={model.deploy_score} />
                )}
              </div>
              
              <p class="text-lg text-gray-600 dark:text-gray-400 mb-4">
                by <span class="font-semibold">{model?.author || 'Unknown'}</span>
              </p>
              
              {Array.isArray(tags) && tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {tags.slice(0, 8).map(tag => (
                    <a 
                      href={`/explore?tag=${encodeURIComponent(tag)}`}
                      class="px-3 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-full text-sm hover:bg-indigo-200 transition-colors"
                    >
                      {tag}
                    </a>
                  ))}
                </div>
              )}
              
              <div class="flex flex-wrap gap-6 text-sm text-gray-600 dark:text-gray-400">
                {model?.downloads && (
                  <span>üì• {Number(model.downloads).toLocaleString()} downloads</span>
                )}
                {model?.likes && (
                  <span>‚ù§Ô∏è {Number(model.likes).toLocaleString()} likes</span>
                )}
                {model?.last_updated && (
                  <span>üïê Updated {new Date(model.last_updated).toLocaleDateString()}</span>
                )}
              </div>
            </div>
          </div>
        </header>

        {hasBench && (
          <section class="mb-8">
            <BenchmarkCard 
              mmlu={model?.mmlu || model?.benchmark_mmlu}
              hellaswag={model?.hellaswag || model?.benchmark_hellaswag}
              arc={model?.arc_challenge || model?.benchmark_arc}
              avgScore={model?.avg_score || model?.benchmark_avg}
            />
          </section>
        )}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 space-y-8">
            <FNITrustPanel 
              score={model?.fni_score || 0}
              percentile={model?.fni_percentile || 0}
              dimensions={{ p: model?.fni_p || 0, v: model?.fni_v || 0, c: model?.fni_c || 0, u: model?.fni_u || 0 }}
              commentary={model?.fni_commentary || null}
            />
            
            <NeuralExplorer model={{
              name: modelName,
              architecture: model?.architecture || model?.pipeline_tag,
              params_billions: model?.params_billions,
              context_length: model?.context_length,
              num_layers: model?.num_layers,
              hidden_size: model?.hidden_size
            }} />
            
            {model?.description && (
              <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">About</h2>
                <div class="prose dark:prose-invert max-w-none">
                  <p class="whitespace-pre-wrap">{(model.description || '').substring(0, 2000).replace(/---[\s\S]*?---/g, '')}</p>
                </div>
              </section>
            )}
            
            {Array.isArray(resources) && resources.length > 0 && (
              <ResourceList resources={resources} sourceUrl={model?.source_url || null} />
            )}
            
            <!-- Section 6: Entity Links (V4.8.1) -->
            <EntityLinksSection 
              modelId={modelId}
              modelName={modelName}
            />
          </div>
          
          <aside class="space-y-6">
            {(model?.params_billions || model?.context_length) && (
              <SpecsTable 
                params={model?.params_billions || null}
                contextLength={model?.context_length || null}
                hasGguf={model?.has_gguf || false}
                ggufVariants={safeParseJSON(model?.gguf_variants ?? null, [])}
                hasOllama={model?.has_ollama || false}
                ollamaId={model?.ollama_id || null}
                ollamaPulls={model?.ollama_pulls || 0}
                license={model?.license_spdx || null}
              />
            )}
            
            <ModelInfoTable model={{
              ...model,
              id: model?.id || '',
              umid: model?.umid || '',
              slug: model?.slug || '',
              pipeline_tag: model?.pipeline_tag || null,
              source_url: model?.source_url || null
            }} />
            
            <GraphExplorer 
              modelId={modelId} 
              modelName={modelName}
            />
          </aside>
        </div>

        {similarModels.length > 0 && (
          <section class="mt-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Similar Models</h2>
            <ModelCarousel models={similarModels} />
          </section>
        )}
      </article>
    ) : (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-yellow-50 text-yellow-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Model Not Found</h1>
          <p class="text-gray-600 mb-6">The model you are looking for does not exist or has been removed.</p>
          <a href="/explore" class="inline-block bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Browse Models</a>
        </div>
      </div>
    )}
  </main>
</Layout>

<style>
  .model-detail-page {
    padding-top: 1rem;
  }
  
  .prose {
    max-width: none;
  }
  
  .prose img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
  }
</style>