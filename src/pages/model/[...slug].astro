---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference.js';
import ModelMainColumn from '../../components/model-detail/ModelMainColumn.astro';
import ModelSidebar from '../../components/model-detail/ModelSidebar.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import ModelGallery from '../../components/model-detail/ModelGallery.astro';
import RelatedResearch from '../../components/model-detail/RelatedResearch.astro';
import RelatedKnowledge from '../../components/model-detail/RelatedKnowledge.astro';
import RelationsPanel from '../../components/model-detail/RelationsPanel.astro';
import VramEstimator from '../../components/model-detail/VramEstimator.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import EntityRelations from '../../components/entity/EntityRelations.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import QuickCommands from '../../components/common/QuickCommands.astro';
import { fetchEntityFromR2, normalizeEntitySlug, hydrateEntity, augmentEntity } from '../../utils/entity-cache-reader-core.js';
import { deriveEntityType, ENTITY_DEFINITIONS } from '../../data/entity-definitions';
import { cleanDescription, generateModelJsonLd, hasCapability } from '../../utils/model-page-helpers.js';
import { getModelFromCache } from '../../utils/entity-cache-reader.js';
import { loadSpecs, loadBenchmarks } from '../../utils/loadCachedJSON.js';
import { prepareModelPageData } from '../../utils/model-page-data.js';


const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
let model = null;
let error = null;
let similarModels = [];
let tagsArray = [];
let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";
let cleanedDesc = "";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug provided");
  const pageData = await prepareModelPageData(slug, slugStr, Astro.locals);
  
  if (!pageData) {
    // V15.12: Explicit 404 for unknown entities
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=entity-not-found&id=' + encodeURIComponent(slugStr));
  }

  const { model: resolvedModel, isFallback, repoName, similarModels: resolvedSimilar, tagsArray: resolvedTags, meshRelations: resolvedMesh } = pageData;
  model = resolvedModel;
  similarModels = resolvedSimilar;
  tagsArray = resolvedTags;
  meshRelations = resolvedMesh || [];

  const displayModelName = model?.name || (isFallback ? repoName : model?.canonical_name) || 'Unknown Model';
  pageTitle = `${displayModelName} - AI Model Insights & Benchmarks`;
  cleanedDesc = cleanDescription(model?.description || '');
  pageDescription = model?.seo_summary?.description || cleanedDesc || `Deep dive into ${displayModelName}.`;

} catch (e) {
  console.error("Error loading model:", e);
  error = e;
  Astro.response.status = 500;
}

if (!model && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=model-not-found');
}

// Capability Gating
const hasFNI = hasCapability(model, 'fni_score') && (model?.fni_score !== undefined || model?.fni_percentile !== undefined);
const hasBenchmarks = hasCapability(model, 'benchmarks');
const hasBench = Boolean(model?.mmlu || model?.benchmark_mmlu || model?.benchmark_hellaswag || model?.benchmark_arc);
const placeholderImage = '/images/models/default-model.jpg';
const coverImage = model?.cover_image_url || placeholderImage;
const modelName = model?.name || model?.canonical_name || 'Unknown Model';
const modelId = model?.umid || model?.id || '';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = model ? getUseCases(tagsArray, model.pipeline_tag, 'model', model.fni_score) : { goodFor: [], limits: [] };

const jsonld = generateModelJsonLd(model, Array.isArray(slug) ? slug.join('/') : slug, coverImage);
---

<EntityLayout 
  entity={model} 
  type="model" 
  title={pageTitle} 
  description={pageDescription}
  image={coverImage}
  jsonld={jsonld}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={modelName}
      entityType="model"
      entityIcon={model?.entityDefinition?.display?.icon || 'ðŸ§ '}
      entityLabel={model?.entityDefinition?.display?.labelSingular || 'Model'}
      verified={false} 
      author={model?.author}
      lastUpdated={model?.last_updated}
      description={model?.seo_summary?.description || cleanedDesc}
      fniScore={model?.fni_score}
      fniPercentile={model?.fni_percentile}
      fniCommentary={model?.fni_commentary}
      paramsB={model?.params_billions}
      sourceUrl={model?.source_url}
      entityId={modelId}
      hasImage={Boolean(model?.image_url)}
    />

    {/* Zone 2: Insights Extra (Decision Metric Elevation) */}
    <div slot="insights-extra" class="mt-4 space-y-6">
       <div class="px-4 py-2 bg-indigo-50 dark:bg-indigo-900/10 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
          <TechSpecsFull entity={model} type="model" />
       </div>
       <QuickCommands entity={model} type="model" className="mt-4" />
       {model?.params_billions && <VramEstimator paramsB={model?.params_billions} contextLen={model?.context_length} />}
    </div>

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />

    {/* Zone 3: Core (Desktop) */}
    <div slot="core-desktop">
       <UniversalCore entity={model} type="model" meshRelations={meshRelations} />
    </div>

    {/* Zone 3: Core (Mobile Tabs) */}
    <div slot="core-knowledge">
       <UniversalCore entity={model} type="model" meshRelations={meshRelations} />
    </div>

    <div slot="core-similar">
        {similarModels.length > 0 ? (
           <ModelCarousel models={similarModels} />
        ) : (
           <p class="text-gray-500 italic p-4 text-center">No similar models found.</p>
        )}
    </div>

     <div slot="core-benchmarks">
         {hasBench && (
           <BenchmarkCard 
             umid={modelId}
             name={modelName}
             mmlu={model?.mmlu || model?.benchmark_mmlu}
             humaneval={model?.humaneval || model?.benchmark_humaneval}
             hellaswag={model?.hellaswag || model?.benchmark_hellaswag}
             arc_challenge={model?.arc_challenge || model?.benchmark_arc}
             avg_score={model?.avg_score || model?.benchmark_avg || 0}
           />
         )}
     </div>
  
    <div slot="deep-dive">
       <div class="space-y-12">
          <ModelMainColumn 
             model={model} 
             hasFNI={hasFNI} 
             hasBenchmarkCap={hasBenchmarks} 
             modelName={modelName} 
             modelId={modelId} 
           />
          <section class="pt-8 border-t border-gray-100 dark:border-gray-800">
             <ModelNavigation 
                pipelineTag={model?.pipeline_tag}
                hasGguf={model?.has_gguf}
             />
          </section>
       </div>
    </div>

    <div slot="sidebar" class="space-y-12">
       <ModelSidebar model={model} modelId={modelId} />
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={model?.source} lastUpdated={model?.last_updated} />
    </div>
</EntityLayout>