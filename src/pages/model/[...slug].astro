---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import ModelMainColumn from '../../components/model-detail/ModelMainColumn.astro';
import ModelSidebar from '../../components/model-detail/ModelSidebar.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import RelatedResearch from '../../components/model-detail/RelatedResearch.astro';
import RelatedKnowledge from '../../components/model-detail/RelatedKnowledge.astro';
import RelationsPanel from '../../components/model-detail/RelationsPanel.astro';
import VramEstimator from '../../components/model-detail/VramEstimator.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import EntityRelations from '../../components/entity/EntityRelations.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import TagsCloud from '../../components/entity/TagsCloud.astro';
import { fetchEntityFromR2, normalizeEntitySlug, hydrateEntity, augmentEntity } from '../../utils/entity-cache-reader-core.js';
import { deriveEntityType, ENTITY_DEFINITIONS } from '../../data/entity-definitions';
import { cleanDescription, generateModelJsonLd, hasCapability } from '../../utils/model-page-helpers';
import { getModelFromCache } from '../../utils/entity-cache-reader';
import { loadSpecs, loadBenchmarks } from '../../utils/loadCachedJSON';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
let model = null;
let error = null;
let similarModels = [];
let tagsArray = [];
let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";
let cleanedDesc = "";

try {
  // V15.15: Load global summary data early for "Warm Cache" hydration
  let summaryData = null;
  try {
    const specsResult = await loadSpecs();
    summaryData = specsResult.data?.data || [];
  } catch (e) {
    console.warn("[ModelPage] Summary data load failed:", e.message);
  }

  const result = await fetchEntityFromR2('model', slug, Astro.locals);
  // Pass summaryData to enable type-specific fallbacks (Params, Context, Name Beautification)
  model = hydrateEntity(result, 'model', summaryData);

  // V15.5: Benchmarks Augmentation
  try {
    const benchResult = await loadBenchmarks();
    const benchEntry = benchResult.data?.data?.find(b => 
      b.umid === slugStr.replace(/\//g, '-') || 
      b.umid === slugStr.replace(/\//g, '--') ||
      b.name === model?.id
    );

    if (benchEntry) {
      model = augmentEntity(model || {}, benchEntry);
    }
  } catch (benchError) {
    console.warn("[ModelPage] Benchmark augmentation failed:", benchError.message);
  }

  if (model && model._hydrated) {
    const resolution = deriveEntityType(model);
    model.entityType = resolution.type;
    model.entityDefinition = ENTITY_DEFINITIONS[model.entityType];

    // Similar models logical stub
    if (model.similar_models && Array.isArray(model.similar_models)) {
        const rawSimilar = model.similar_models;
        const resolvedPromises = rawSimilar.map(async (item) => {
            if (typeof item === 'string') {
                return await getModelFromCache(item, Astro.locals);
            }
            return item;
        });
        similarModels = (await Promise.all(resolvedPromises)).filter(Boolean);
    }

    tagsArray = Array.isArray(model.tags) ? model.tags : [];
    
    const modelName = model.name || model.canonical_name || model.id || 'Unknown Model';
    pageTitle = `${modelName} - AI Model Insights & Benchmarks`;
    
    cleanedDesc = cleanDescription(model.description);
    pageDescription = model.seo_summary?.description || 
                      (cleanedDesc ? cleanedDesc.substring(0, 160) : `Deep dive into ${modelName}.`);
  } else {
    // V15.6 Fallback Logic (Mirroring /space/ strategy)
    const cleanSlug = slugStr.replace(/--/g, '/');
    const parts = cleanSlug.split('/');
    const repoName = parts.pop() || 'Unknown Model';
    const authorName = parts.join('/') || 'huggingface';
    
    // Ensure we don't overwrite if augmentation already created a partial model
    model = model || {
      id: `hf-model--${slugStr.replace(/\//g, '--')}`,
      name: repoName,
      author: authorName,
      source: 'huggingface',
      source_url: `https://huggingface.co/${cleanSlug}`,
      description: `State-of-the-art AI model: ${repoName} by ${authorName}.`,
      tags: [],
      fni_score: 0,
      _cache_source: 'fallback-ui'
    };
    // V15.17: Aggressive Global Fallback (Last line of defense)
    if (summaryData && Array.isArray(summaryData)) {
      const norm = (s) => (s || '').toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      const searchId = norm(slugStr);
      const fallbackEntry = summaryData.find(s => {
          const sid = norm(s.id || s.umid || s.slug || '').replace(/^hf-model-/, '');
          return sid === searchId || sid.endsWith('-' + searchId) || searchId.endsWith('-' + sid) || sid === norm(slugStr);
      });
      if (fallbackEntry) {
        model = augmentEntity(model || {}, fallbackEntry);
      }
    }
    
    // Minimal resolution for EntityHeader
    model.entityType = 'model';
    model.entityDefinition = ENTITY_DEFINITIONS['model'];
    
    // Fix: modelName variable scope issue
    const displayModelName = model.name || repoName || 'Unknown Model';
    pageTitle = `${displayModelName} - AI Model`;
    pageDescription = `Technical specifications and insights for ${displayModelName} AI model.`;
  }
} catch (e) {
  console.error("Error loading model:", e);
  error = e;
  Astro.response.status = 500;
}

if (!model && !error) {
  Astro.response.status = 404;
}

// Capability Gating
const hasFNI = hasCapability(model, 'fni_score') && (model?.fni_score !== undefined || model?.fni_percentile !== undefined);
const hasBenchmarks = hasCapability(model, 'benchmarks');
const hasBench = Boolean(model?.mmlu || model?.benchmark_mmlu || model?.benchmark_hellaswag || model?.benchmark_arc);
const placeholderImage = '/images/models/default-model.jpg';
const coverImage = model?.cover_image_url || placeholderImage;
const modelName = model?.name || model?.canonical_name || 'Unknown Model';
const modelId = model?.umid || model?.id || '';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = model ? getUseCases(tagsArray, model.pipeline_tag, 'model', model.fni_score) : { goodFor: [], limits: [] };

const jsonld = generateModelJsonLd(model, Array.isArray(slug) ? slug.join('/') : slug, coverImage);
---

<EntityLayout 
  entity={model} 
  type="model" 
  title={pageTitle} 
  description={pageDescription}
  image={coverImage}
  jsonld={jsonld}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={modelName}
      entityType="model"
      entityIcon={model?.entityDefinition?.display?.icon || 'ðŸ§ '}
      entityLabel={model?.entityDefinition?.display?.labelSingular || 'Model'}
      verified={false} 
      author={model?.author}
      lastUpdated={model?.last_updated}
      description={model?.seo_summary?.description || cleanedDesc}
      fniScore={model?.fni_score}
      fniPercentile={model?.fni_percentile}
    >
       <div slot="actions" class="flex gap-2">
          <a href={model?.source_url} target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition-all">
             View Source
          </a>
       </div>
    </EntityHeader>

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />

    {/* Zone 3: Core (Desktop) */}
    <div slot="core-desktop">
       <UniversalCore entity={model} type="model" />
    </div>

    {/* Zone 3: Core (Mobile Tabs) */}
    <div slot="core-knowledge">
       <UniversalCore entity={model} type="model" />
    </div>

    <div slot="core-similar">
       {similarModels.length > 0 ? (
          <ModelCarousel models={similarModels} />
       ) : (
          <p class="text-gray-500 italic p-4 text-center">No similar models found.</p>
       )}
    </div>

     <div slot="core-benchmarks">
         {hasBench && (
           <BenchmarkCard 
             umid={modelId}
             name={modelName}
             mmlu={model?.mmlu || model?.benchmark_mmlu}
             humaneval={model?.humaneval || model?.benchmark_humaneval}
             hellaswag={model?.hellaswag || model?.benchmark_hellaswag}
             arc_challenge={model?.arc_challenge || model?.benchmark_arc}
             avg_score={model?.avg_score || model?.benchmark_avg || 0}
           />
         )}
     </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
       <div class="space-y-12">
          <TechSpecsFull entity={model} type="model" />
          <TagsCloud tags={tagsArray} type="model" />
          <ModelMainColumn 
             model={model} 
             hasFNI={hasFNI} 
             hasBenchmarkCap={hasBenchmarks} 
             modelName={modelName} 
             modelId={modelId} 
           />
       </div>
    </div>

    <div slot="sidebar" class="space-y-12">
       <ModelSidebar model={model} modelId={modelId} />
       <ModelNavigation 
          pipelineTag={model?.pipeline_tag}
          hasGguf={model?.has_gguf}
       />
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={model?.source} lastUpdated={model?.last_updated} />
    </div>
</EntityLayout>