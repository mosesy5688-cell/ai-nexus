---
export const prerender = false;
// Model Detail Page V5.1.2 - Entity-First Architecture

import Layout from '../../layouts/Layout.astro';
import ModelHeader from '../../components/model-detail/ModelHeader.astro';
import ModelMainColumn from '../../components/model-detail/ModelMainColumn.astro';
import ModelSidebar from '../../components/model-detail/ModelSidebar.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import RelatedResearch from '../../components/model-detail/RelatedResearch.astro';
import RelatedKnowledge from '../../components/model-detail/RelatedKnowledge.astro';
// TechnicalSpecs import removed - rendered inside ModelMainColumn.astro
import VramEstimator from '../../components/model-detail/VramEstimator.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import EntityRelations from '../../components/entity/EntityRelations.astro';
import RelationsPanel from '../../components/model-detail/RelationsPanel.astro';
import ModelNotFound from '../../components/model-detail/ModelNotFound.astro';
import QuickStart from '../../components/model-detail/QuickStart.astro';

// V4.9.1: Constitutional D1 = 0 - Use R2 cache reader instead of D1 queries
import { getModelFromCache } from '../../utils/entity-cache-reader';
import { deriveEntityType, ENTITY_DEFINITIONS } from '../../data/entity-definitions';
import { cleanDescription, generateModelJsonLd, hasCapability } from '../../utils/model-page-helpers';

const { slug } = Astro.params;

let model = null;
let error = null;
let similarModels = [];
let tagsArray = [];
let pageTitle = "AI Model Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI model.";

try {
  if (!slug) throw new Error("No slug provided");
  
  model = await getModelFromCache(slug, Astro.locals);

  // V14: Handle malformed 'u/' prefix - redirect to search
  if (!model) {
    const parts = Array.isArray(slug) ? slug : slug.split('/');
    if (parts[0] === 'u' && parts.length === 2) {
      return Astro.redirect(`/search?q=${encodeURIComponent(parts[1])}`, 302);
    }
  }
  if (model) {
    const resolution = deriveEntityType(model);
    model.entityType = resolution.type;
    model.entityDefinition = ENTITY_DEFINITIONS[model.entityType];


    // Similar models logical stub (D1 banned)
    if (model.similar_models && Array.isArray(model.similar_models)) {
        // V6.3: Resolve IDs if they are strings (from similarity-compute)
        const rawSimilar = model.similar_models;
        const resolvedPromises = rawSimilar.map(async (item) => {
            if (typeof item === 'string') {
                // Fetch minimal model info for card (name, author, stats)
                return await getModelFromCache(item, Astro.locals);
            }
            return item;
        });
        similarModels = (await Promise.all(resolvedPromises)).filter(Boolean);
    }

    const modelName = model.name || model.canonical_name || 'Unknown Model';
    pageTitle = `${modelName} - AI Model Insights & Benchmarks`;
    
    // Clean description: remove frontmatter, HTML, normalize whitespace
    const cleanDescription = (desc) => !desc ? '' : desc
      .replace(/^---[\s\S]*?---\s*/m, '').replace(/^---\s*\n?[\s\S]*$/m, '')
      .replace(/\blibrary_name:\s*\w+/gi, '').replace(/\blicense:\s*[^\s]+/gi, '')
      .replace(/\bpipeline_tag:\s*\w+/gi, '').replace(/\bbase_model\b[^.]*\.?/gi, '')
      .replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim();
    
    const cleanedDesc = cleanDescription(model.description);
    pageDescription = model.seo_summary?.description || 
                      (cleanedDesc ? cleanedDesc.substring(0, 160) : `Deep dive into ${modelName}.`);
    tagsArray = Array.isArray(model.tags) ? model.tags : [];
  }
} catch (e) {
  console.error("Error loading model:", e);
  error = e;
  Astro.response.status = 500;
}
if (!model && !error) {
  Astro.response.status = 404;
  Astro.response.headers.set('Cache-Control', 'no-store, no-cache, max-age=0');
}
// Capability Gating
const hasFNI = hasCapability(model, 'fni_score') && (model?.fni_score !== undefined || model?.fni_percentile !== undefined);
const hasBenchmarks = hasCapability(model, 'benchmarks');
const hasBench = Boolean(model?.mmlu || model?.benchmark_mmlu || model?.benchmark_hellaswag || model?.benchmark_arc);
const placeholderImage = '/images/models/default-model.jpg';
const coverImage = model?.cover_image_url || placeholderImage;
const modelName = model?.name || model?.canonical_name || 'Unknown Model';
const modelId = model?.umid || model?.id || '';
const cleanDesc = cleanDescription(model?.description);
const jsonld = generateModelJsonLd(model, Array.isArray(slug) ? slug.join('/') : slug, coverImage);
---

<Layout title={pageTitle} description={pageDescription} image={coverImage} jsonld={jsonld}>
  <main class="model-detail-page bg-gray-50 dark:bg-gray-900 min-h-screen">
    {error ? (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-red-50 text-red-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Error Loading Page</h1>
          <p class="text-gray-600 mb-6">{error.message}</p>
          <a href="/explore" class="inline-block bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Browse Models</a>
        </div>
      </div>
    ) : model ? (
      <article class="container mx-auto px-4 py-8 max-w-7xl">
        <ModelHeader 
          modelName={modelName}
          modelId={modelId}
          entityType={model.entityType}
          entityIcon={model.entityDefinition?.display?.icon}
          entityLabel={model.entityDefinition?.display?.labelSingular}
          verified={false} 
          author={model.author}
          lastUpdated={model.last_updated}
          seoDescription={model.seo_summary?.description}
          cleanDescription={cleanDesc}
        />

        <!-- V12: Quick Start for content depth -->
        <QuickStart 
          modelId={modelId}
          modelName={modelName}
          pipeline_tag={model.pipeline_tag}
          author={model.author}
        />

        {hasBench && hasBenchmarks && (
          <section class="mb-8">
            <BenchmarkCard 
              umid={model.umid || model.id || ''}
              name={modelName}
              mmlu={model.mmlu || model.benchmark_mmlu}
              humaneval={model.humaneval || model.benchmark_humaneval}
              hellaswag={model.hellaswag || model.benchmark_hellaswag}
              arc_challenge={model.arc_challenge || model.benchmark_arc}
              avg_score={model.avg_score || model.benchmark_avg || 0}
            />
          </section>
        )}

        {/* TechnicalSpecs removed - rendered inside ModelMainColumn.astro */}

        <!-- V12: Knowledge Relations Panel -->
        <RelationsPanel
          baseModel={model.base_model}
          datasetsUsed={model.datasets_used || []}
          arxivRefs={model.arxiv_refs || []}
        />

        <!-- V8.1-LOCK Phase 2: VRAM Estimator -->
        <VramEstimator paramsB={model.params_billions} />

        <!-- V8.1-LOCK Phase 2: Trust Protocol Disclaimer -->
        <AiDisclaimer source={model.source} lastUpdated={model.last_updated} />

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <ModelMainColumn 
            model={model} 
            hasFNI={hasFNI} 
            hasBenchmarkCap={hasBenchmarks} 
            modelName={modelName} 
            modelId={modelId} 
          />
          
          <ModelSidebar 
            model={model} 
            modelId={modelId} 
          />
        </div>

        <RelatedResearch modelId={modelId} />

        <!-- V8.1-LOCK Phase 3: Entity Relations (Model â†” Paper) -->
        {model.entity_relations && model.entity_relations.length > 0 && (
          <EntityRelations
            entityId={modelId}
            entityType="model"
            relations={model.entity_relations}
          />
        )}
        
        <RelatedKnowledge 
          tags={tagsArray} 
          description={model.description || ''}
          metaJson={model.meta_json}
        />

        {similarModels.length > 0 && (
          <section class="mt-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Similar Models</h2>
             <ModelCarousel models={similarModels} />
          </section>
        )}

        <ModelNavigation 
          pipelineTag={model.pipeline_tag}
          hasGguf={model.has_gguf}
        />
      </article>
    ) : (
      <ModelNotFound slug={slug} />
    )}
  </main>
</Layout>