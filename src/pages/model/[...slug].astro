---
// This is an Astro dynamic route page for server-side rendering (SSR).
// It replaces the logic from the manual `functions/[[path]].js`.
import Layout from '@/layouts/Layout.astro';

export const prerender = false; // This page must be SSR.

const { slug } = Astro.params;
const { locals } = Astro; // Access runtime context provided by the Cloudflare adapter

let model = null;
let error = null;

if (!slug) {
    return Astro.redirect('/', 301);
}

try {
    // This logic is the exact reverse of the link creation in the frontend.
    const modelId = slug.replace(/--/g, '/');
    
    // Access the D1 database via locals.runtime
    const db = locals.runtime?.env?.DB;

    if (db) {
        const stmt = db.prepare('SELECT * FROM models WHERE id = ?');
        model = await stmt.bind(modelId).first();
    } else {
        throw new Error("Database connection is not available.");
    }

} catch (e) {
    console.error(`Error fetching model with slug "${slug}":`, e);
    error = e.message;
}

// If model is not found, Astro will automatically render the 404 page.
if (!model) {
    return new Response(null, { status: 404, statusText: 'Not Found' });
}

const pageTitle = `${model.name} - AI Model Details | Free AI Tools`;
const pageDescription = model.description ? model.description.substring(0, 160) : `Details for the AI model ${model.name} by ${model.author}.`;
---
<Layout title={pageTitle} description={pageDescription}>
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <a href="/" class="text-blue-600 hover:underline">&larr; Back to Home</a>
            <h1 class="text-4xl font-bold mt-4">{model.name}</h1>
            <p class="text-lg text-gray-600">by {model.author}</p>
        </header>
        <main>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Description</h2>
                <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{model.description || 'No description available.'}</p>
                
                <!-- You can add more model details here, similar to the old [[path]].js file -->
            </div>
        </main>
    </div>
</Layout>