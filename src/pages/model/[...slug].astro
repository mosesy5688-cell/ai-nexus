---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import ModelHero from '../../components/ModelHero.astro';
import TabbedContent from '../../components/TabbedContent.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import Comments from '../../components/Comments.astro';
import { getModelBySlug } from '../../utils/db';
import { prepareDetailData, getBestDescription, logDataActivity } from '../../utils/frontend-data';

const { slug } = Astro.params;

// Initialize variables
let model = null;
let enrichedData = null;
let relatedModels = [];
let error = null;
let pageTitle = "AI Model Details";
let pageDescription = "View details for this AI model.";

// ---------------------------------------------------
// Stage 1: Fetch and enrich model data
// ---------------------------------------------------
try {
  if (!slug) {
    throw new Error("No slug provided");
  }

  const rawModel = await getModelBySlug(slug, Astro.locals);
  
  if (rawModel) {
    // Use Frontend Data Coordination System for normalization
    enrichedData = prepareDetailData(rawModel);
    model = enrichedData;
    
    // Log data fetch for debugging
    logDataActivity('model_fetch', {
      slug,
      modelId: model.id,
      hasIssues: model.hasIssues,
      validation: model.validation
    });

    // Defensive: parse related_ids if present
    const relatedIds = model.related_ids || [];
    
    // Fetch related models
    if (relatedIds.length > 0) {
      try {
        const db = Astro.locals?.runtime?.env?.DB;
        if (db) {
          const placeholders = relatedIds.map(() => "?").join(",");
          const stmt = db.prepare(`
            SELECT id, name, author, likes, downloads, cover_image_url, description, resources
            FROM models
            WHERE id IN (${placeholders})
          `);
          const { results } = await stmt.bind(...relatedIds).all();
          relatedModels = results || [];
        }
      } catch (queryErr) {
        console.warn("Failed to query related_ids:", queryErr);
      }
    }

    // Fallback to tag-based or top-downloads if needed
    if (relatedModels.length === 0) {
      try {
        const db = Astro.locals?.runtime?.env?.DB;
        if (db) {
          // Tag-based fallback
          if (model.pipeline_tag) {
            const stmt = db.prepare(`
              SELECT id, name, author, likes, downloads, cover_image_url, description, resources
              FROM models
              WHERE pipeline_tag = ? AND id != ?
              ORDER BY downloads DESC
              LIMIT 6
            `);
            const { results } = await stmt.bind(model.pipeline_tag, model.id).all();
            relatedModels = results || [];
          }
          // Ultimate fallback: top downloads excluding current model
          if (relatedModels.length === 0) {
            const stmt = db.prepare(`
              SELECT id, name, author, likes, downloads, cover_image_url, description, resources
              FROM models
              WHERE id != ?
              ORDER BY downloads DESC
              LIMIT 6
            `);
            const { results } = await stmt.bind(model.id).all();
            relatedModels = results || [];
          }
        }
      } catch (fallbackErr) {
        console.warn("Fallback strategies failed:", fallbackErr);
      }
    }
  }
} catch (e) {
  console.error("SSR Error fetching model:", e);
  error = e.message;
  logDataActivity('model_fetch_error', { slug, error: e.message }, e);
}

// ---------------------------------------------------
// Stage 2: Handle missing/invalid model
// ---------------------------------------------------
if (!model || model._isPlaceholder) {
  Astro.response.status = 404;
  Astro.response.statusText = "Not Found";
  error = "Model not found or invalid data returned.";
}

// ---------------------------------------------------
// Stage 3: Generate page metadata safely
// ---------------------------------------------------
if (model && !model._isPlaceholder) {
  pageTitle = `${model.displayName} by ${model.author} - Free AI Tools`;
  pageDescription = getBestDescription(model).substring(0, 160) + "...";
}

// ---------------------------------------------------
// Stage 4: Prepare links data for ModelHero
// ---------------------------------------------------
const linksData = model ? JSON.stringify({
  source_url: model.links_data?.source_url || model.source_url || "",
  docs_url: model.links_data?.docs_url || model.docs_url || "",
  demo_url: model.links_data?.demo_url || model.demo_url || "",
}) : "{}";

---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8">
    {error ? (
      <div class="max-w-4xl mx-auto text-center py-12">
        <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-8 rounded-lg shadow-sm">
          <h2 class="text-2xl font-bold mb-4">Model Not Found</h2>
          <p class="mb-6">{error}</p>
          <a href="/" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700">
            Return Home
          </a>
        </div>
      </div>
    ) : (
      <article class="lg:prose-xl mx-auto">
        <ModelHero
          name={model.displayName}
          description={model.displayDescription}
          author={model.author}
          likes={model.likes}
          downloads={model.downloads}
          pipelineTag={model.pipeline_tag}
          linksData={linksData}
          lastUpdated={model.last_updated}
          license={model.license}
        />
        
        {/* Main Content Area - Simplified Linear Flow */}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 mt-8">
          
          {/* Left Column: Description & Details */}
          <div class="lg:col-span-2 space-y-12">
            
            {/* About Section */}
            <section>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">About this Model</h2>
              <div class="prose lg:prose-xl max-w-none dark:prose-invert text-gray-700 dark:text-gray-300">
                <div class="whitespace-pre-wrap">{model.displayDescription}</div>
              </div>
              
              {/* SEO Status Indicator */}
              {model.seo_status === 'done' && model.seo_summary && (
                <div class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                  <p class="text-sm text-green-700 dark:text-green-300">
                    âœ¨ Enhanced with AI-generated summary
                  </p>
                </div>
              )}
            </section>

            {/* Resources Section (Always Visible) */}
            {model.resources && model.resources !== "[]" && (
              <section class="bg-blue-50 dark:bg-gray-800 rounded-xl p-6 border border-blue-100 dark:border-gray-700">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  Resources & Files
                </h3>
                {(() => {
                  try {
                    let parsed = [];
                    try {
                      parsed = JSON.parse(model.resources);
                    } catch (e) {
                      // Fallback for raw strings
                      if (typeof model.resources === 'string' && model.resources.startsWith('http')) {
                        parsed = [{ platform: 'Source', url: model.resources }];
                      }
                    }
                    
                    if (Array.isArray(parsed) && parsed.length > 0) {
                      return (
                        <ul class="space-y-3">
                          {parsed.map((res: any) => (
                            <li class="flex items-start gap-3">
                              <svg class="w-5 h-5 text-gray-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                              </svg>
                              <div>
                                <a href={res.url} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium break-all">
                                  {res.url}
                                </a>
                                {res.files && res.files.length > 0 && (
                                  <p class="text-sm text-gray-500 mt-1">
                                    Includes {res.files.length} file{res.files.length !== 1 ? 's' : ''}
                                  </p>
                                )}
                              </div>
                            </li>
                          ))}
                        </ul>
                      );
                    }
                  } catch (e) {
                    return <p class="text-sm text-gray-500">Resource data available at source link.</p>;
                  }
                })()}
              </section>
            )}

            {/* Comments Placeholder */}
            <Comments modelId={model.id} />

          </div>

          {/* Right Column: Quick Stats & Sidebar */}
          <div class="space-y-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
              <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Quick Stats</h3>
              <dl class="space-y-4">
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">License</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{model.license || "Unknown"}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Downloads</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{model.formattedDownloads}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Likes</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{model.formattedLikes}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Last Updated</dt>
                  <dd class="font-medium text-gray-900 dark:text-white">{model.relativeTime}</dd>
                </div>
              </dl>
            </div>
          </div>

        </div>
        
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">Related Models</h2>
          <ModelCarousel models={relatedModels} />
        </div>
      </article>
    )}
  </main>
</Layout>
