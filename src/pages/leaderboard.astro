---
/**
 * Benchmark Leaderboard Page
 * V5.1.2 - Refactored for CES Compliance (Modular)
 * 
 * B.14: Redirect to unified /ranking?type=benchmark
 * Uses /cache/benchmarks.json for all data
 */

export const prerender = false;

// B.14: Redirect to unified ranking page (DISABLED: Handler not ready)
// return Astro.redirect('/ranking?type=benchmark', 301);

// Imports
import Layout from '../layouts/Layout.astro';
import BenchmarkTable from '../components/benchmark/BenchmarkTable.astro';
import LeaderboardHero from '../components/leaderboard/LeaderboardHero.astro';
import LeaderboardFilters from '../components/leaderboard/LeaderboardFilters.astro';
import LeaderboardPodium from '../components/leaderboard/LeaderboardPodium.astro';
import LeaderboardLegend from '../components/leaderboard/LeaderboardLegend.astro';

// Styles
import '../styles/leaderboard.css';

// SEO
const pageTitle = "AI Model Leaderboard â€“ Compare MMLU, HumanEval & ARC Scores";
const pageDescription = "Standardized benchmark rankings for Open Source LLMs. Compare performance on MMLU, HellaSwag, HumanEval, and ARC.";

// Data Fetching (Constitution: Cloudflare Worker Cache)
let benchmarkData = null;
let error = null;

try {
  // V18.2: Try .gz first, then fallback to .json
  const paths = [
    new URL('/cache/benchmarks.json.gz', Astro.url.origin),
    new URL('/cache/benchmarks.json', Astro.url.origin)
  ];

  for (const url of paths) {
    const response = await fetch(url);
    if (response.ok) {
      const isGzip = url.toString().endsWith('.gz');
      if (isGzip) {
        // SSR environment (Cloudflare Workers) supports DecompressionStream
        try {
          const ds = new DecompressionStream('gzip');
          const decompressedStream = response.body.pipeThrough(ds);
          const decompressedRes = new Response(decompressedStream);
          benchmarkData = await decompressedRes.json();
          break;
        } catch (e) {
          console.warn(`[Leaderboard] SSR Decompression failed for ${url}:`, e);
        }
      } else {
        benchmarkData = await response.json();
        break;
      }
    }
  }
  
  if (!benchmarkData) throw new Error("Could not load benchmarks from CDN");
} catch (e) {
  console.error("Leaderboard Load Error:", e);
  error = e.message;
}

const freshness = benchmarkData?.metadata?.last_updated || new Date().toISOString();
const dataSource = benchmarkData?.metadata?.source || "AI Nexus Aggregation";
const benchmarks = benchmarkData?.data || [];

// Sort and Slice
const sortedByAvg = [...benchmarks].sort((a, b) => b.avg_score - a.avg_score);
const top3 = sortedByAvg.slice(0, 3);

// Families for filter
const families = [...new Set(benchmarks.map(b => {
  return b.umid?.split('-')[0] || 'unknown';
}))].filter(f => f !== 'unknown').sort();
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="leaderboard-container">
    
    <LeaderboardHero freshness={freshness} dataSource={dataSource} />

    <LeaderboardFilters families={families} />

    {error || benchmarks.length === 0 ? (
      <div class="empty-state">
        <div class="empty-icon">ðŸ“Š</div>
        <h2>Benchmark Data Loading...</h2>
        <p>Benchmark scores are updated daily. Check back soon!</p>
        <a href="/models" class="btn-primary">Explore All Models</a>
      </div>
    ) : (
      <>
        <LeaderboardPodium topModels={top3} />

        <section class="table-section">
          <h2 class="section-title">ðŸ“Š Full Rankings</h2>
          <BenchmarkTable 
            benchmarks={sortedByAvg}
            showRank={true}
            sortBy="avg_score"
          />
        </section>

        <LeaderboardLegend />
      </>
    )}
  </div>
</Layout>

<script>
  import { initializeLeaderboard } from '../scripts/leaderboard-client.js';
  
  document.addEventListener('DOMContentLoaded', () => {
    initializeLeaderboard();
  });
</script>
