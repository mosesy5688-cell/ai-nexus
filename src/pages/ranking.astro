---
/**
 * Ranking Page - V4.9 Entity-First Architecture
 * Art.X-Entity-List: Lists segregated or polymorphic
 * Uses L8 Precompute cache JSON (D1 reads = 0)
 */

export const prerender = false; // V4.9: Dynamic for entity type tabs

import Layout from '../layouts/Layout.astro';
import ModelCard from '../components/ModelCard.astro';
import EntityTabs from '../components/entity/EntityTabs.astro';
import DataFreshness from '../components/common/DataFreshness.astro';
import RankingTabs from '../components/ranking/RankingTabs.astro';
import FloatingCompareBar from '../components/ranking/FloatingCompareBar.astro';
import AddToCompareButton from '../components/ranking/AddToCompareButton.astro';
import FNIDimensionFilter from '../components/ranking/FNIDimensionFilter.astro';
import FNIBadge from '../components/ranking/FNIBadge.astro';

// V4.9: Get entity type from URL params
const url = new URL(Astro.request.url);
const entityType = url.searchParams.get('type') || 'model';

// Entity-specific page metadata (compressed)
const ENTITY_META: Record<string, { title: string; description: string }> = {
    model: { title: 'AI Model Rankings', description: 'Explore the top AI models ranked by popularity, trending, and FNI scores.' },
    dataset: { title: 'Dataset Rankings', description: 'Discover top datasets for AI/ML training and evaluation.' },
    benchmark: { title: 'Benchmark Rankings', description: 'Compare AI evaluation benchmarks and leaderboards.' },
    paper: { title: 'Research Paper Rankings', description: 'Top cited AI research papers and publications.' },
    agent: { title: 'AI Agent Rankings', description: 'Most popular AI agents and autonomous systems.' }
};
const meta = ENTITY_META[entityType] || ENTITY_META.model;
const pageTitle = meta.title;
const pageDescription = meta.description;
const entityLabels: Record<string, string> = { model: 'Models', dataset: 'Datasets', benchmark: 'Benchmarks', paper: 'Papers', agent: 'Agents' };
const entityLabel = entityLabels[entityType] || 'Models';

// B.14: Get sort parameter (FNI is default)
const sortBy = url.searchParams.get('sort') || 'fni';

// B.14 P2: Get dimension parameter for P/V/C/U sorting
const dimension = url.searchParams.get('dim') || 'fni';

// V4.3.2 Constitution: Load from L8 Precompute cache (D1 reads = 0)
let trendingData = { data: [], generated_at: null };
let benchmarksData = { data: [], generated_at: null };

try {
    // V12: Entity-type specific cache loading
    const cacheEndpoint = entityType === 'agent' 
        ? '/api/cache/trending_agents.json'
        : entityType === 'space'
        ? '/api/cache/trending_spaces.json'
        : entityType === 'dataset'
        ? '/api/cache/trending_datasets.json'
        : '/api/cache/trending.json';  // default: models
    
    const trendingResponse = await fetch(new URL(cacheEndpoint, Astro.url.origin));
    if (trendingResponse.ok) {
        const rawData = await trendingResponse.json();
        // Handle different cache formats
        const dataKey = entityType === 'agent' ? 'agents' 
            : entityType === 'space' ? 'spaces'
            : entityType === 'dataset' ? 'datasets'
            : 'models';
        trendingData = { data: rawData[dataKey] || rawData.models || rawData || [], generated_at: rawData.generated_at };
    }
    
    // Load benchmark data for rising stars (models only)
    if (entityType === 'model') {
        const benchResponse = await fetch(new URL('/api/cache/benchmarks.json', Astro.url.origin));
        if (benchResponse.ok) {
            benchmarksData = await benchResponse.json();
        }
    }
} catch (e) {
    console.error('[Rankings] Cache fetch error:', e);
}

// B.14 P2: Import dimension-based sorting utilities
import { sortByDimension, sortByDownloads, sortByNewest } from '../utils/ranking-utils';

// B.14: Add FNI sorting with dimension support
const fniSorted = sortByDimension(trendingData.data || [], dimension).slice(0, 12);
const hot = (trendingData.data || []).slice(0, 12);
const trending = sortByDownloads((trendingData.data || []).filter(m => m.downloads > 0)).slice(0, 12);
const newest = sortByNewest((trendingData.data || []).filter(m => m.last_updated)).slice(0, 12);
const benchmarks = (benchmarksData.data || []).slice(0, 12);

const generatedAt = trendingData.generated_at || new Date().toISOString();

// B.14: FNI as primary ranking section
const mainRankings = [
    { 
        id: 'fni',
        title: "âš–ï¸ FNI Top Models", 
        description: "Ranked by Free2AI Nexus Index - our comprehensive scoring system.",
        explanation: "FNI combines Popularity, Velocity, Credibility, and Utility metrics.",
        models: fniSorted,
        showFNI: true
    },
    { 
        id: 'hot',
        title: "ðŸ”¥ Hot Models", 
        description: "Models with the highest community engagement this week.",
        explanation: "Based on likes, comments, and shares across platforms.",
        models: hot 
    },
    { 
        id: 'trending',
        title: "ðŸš€ Trending", 
        description: "Fastest growing models by download count.",
        explanation: "These models are seeing rapid adoption right now.",
        models: trending 
    },
    { 
        id: 'newest',
        title: "âœ¨ Newest", 
        description: "Recently updated models worth checking out.",
        explanation: "Fresh updates often mean bug fixes and new features.",
        models: newest 
    },
    { 
        id: 'benchmark',
        title: "ðŸ† Benchmark Leaders", 
        description: "Top performers on standardized benchmarks.",
        explanation: "Objectively measured performance on industry tests.",
        models: benchmarks, 
        isBenchmark: true 
    }
];

// V4.9.1 Step 3: JSON-LD ItemList Schema for SEO
const jsonLd = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": pageTitle,
    "description": pageDescription,
    "url": "https://free2aitools.com/ranking",
    "numberOfItems": hot.length,
    "itemListElement": hot.slice(0, 10).map((model: any, index: number) => ({
        "@type": "ListItem",
        "position": index + 1,
        "item": {
            "@type": "SoftwareApplication",
            "name": model.name,
            "url": `https://free2aitools.com/model/${model.slug || model.umid}`,
            "applicationCategory": "AI Model"
        }
    }))
};
---

<Layout title={pageTitle} description={pageDescription}>
    <!-- V4.9.1: JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <div class="container mx-auto px-4 py-12">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-gray-900 dark:text-white">{entityLabel} Rankings</h1>
            <p class="mt-4 text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
                {pageDescription}
            </p>
            <DataFreshness timestamp={generatedAt} source="L8 Precompute" />
        </header>
        
        <!-- V4.9: Entity Type Tabs (Art.X-Entity-List) -->
        <div class="flex justify-center mb-8">
            <EntityTabs activeType={entityType} basePath="/ranking" />
        </div>

        <!-- V4.9.1: Category Quick Links -->
        <div class="flex flex-wrap justify-center gap-2 mb-6">
            <a href="/ranking/text-generation" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors">Text Generation</a>
            <a href="/ranking/code" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors">Code</a>
            <a href="/ranking/embedding" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors">Embedding</a>
            <a href="/ranking/image" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors">Image</a>
            <a href="/ranking/vision" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors">Vision</a>
            <a href="/ranking/audio" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors">Audio</a>
        </div>

        <!-- B.14: Ranking Sort Tabs (FNI default) -->
        <RankingTabs activeTab={sortBy} className="mb-4" />
        
        <!-- B.14 P2: FNI Dimension Filter -->
        <FNIDimensionFilter activeDimension={dimension} className="mb-8" />

        {mainRankings.map(ranking => (
            <section class="mb-16" id={ranking.id}>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{ranking.title}</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-2">{ranking.description}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 italic mb-6">{ranking.explanation}</p>
                {ranking.models.length > 0 ? (
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {ranking.models.slice(0, 8).map((model, index) => (
                            ranking.isBenchmark ? (
                                <a href={`/model/${model.umid}`} class="block p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition">
                                    <div class="font-semibold text-white">{model.name}</div>
                                    <div class="text-sm text-gray-300">Avg: {model.avg_score?.toFixed(1)}</div>
                                </a>
                            ) : (
                                <div class="relative group">
                                    {/* V12 Phase 9: Rank Badge for Top 10 */}
                                    {ranking.showFNI && index < 10 && (
                                        <div class={`absolute -top-2 -left-2 z-10 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-lg ${
                                            index === 0 ? 'bg-gradient-to-br from-yellow-300 to-yellow-500 text-yellow-900' :
                                            index === 1 ? 'bg-gradient-to-br from-gray-200 to-gray-400 text-gray-800' :
                                            index === 2 ? 'bg-gradient-to-br from-orange-300 to-orange-500 text-orange-900' :
                                            'bg-indigo-600 text-white'
                                        }`}>
                                            {index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : index + 1}
                                        </div>
                                    )}
                                    <ModelCard model={model} />
                                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <AddToCompareButton 
                                            modelId={model.umid || model.id} 
                                            modelName={model.name} 
                                        />
                                    </div>
                                    {ranking.showFNI && <FNIBadge fniScore={model.fni_score} fniPercentile={model.fni_percentile} className="absolute bottom-2 left-2" />}
                                </div>
                            )
                        ))}
                    </div>
                ) : (
                    <p class="text-gray-300 text-center py-8">No models in this category yet.</p>
                )}
            </section>
        ))}

        <div class="mt-12 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 text-center">
            <p class="text-sm text-gray-700 dark:text-gray-300">
                Rankings use the <a href="/methodology" class="text-indigo-600 hover:underline font-semibold">FNI Methodology</a> â€“ 
                a transparent, multi-dimensional scoring system. V4.3.2 Constitution compliant.
            </p>
        </div>
    </div>
    
    <!-- B.14: Floating Compare Bar -->
    <FloatingCompareBar />
</Layout>