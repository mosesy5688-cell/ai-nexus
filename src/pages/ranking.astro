---
import BaseLayout from '../layouts/BaseLayout.astro';
import ModelCard from '../components/ModelCard.astro';
// import rankings from '../data/rankings.json'; // This will be replaced by direct data processing
import allModels from '../data/models.json';
import allKeywords from '../data/keywords.json';

// --- Start of Data Processing ---

// Helper function to get a clean model ID for URLs
const getModelId = (model) => model.id.replace(/\//g, '--');

// 1. Define Categories for Leaderboards
const leaderboardCategories = [
    { id: 'text-generation', name: 'Text Generation' },
    { id: 'image-generation', name: 'Image Generation' },
    { id: 'code-generation', name: 'Code Generation' },
    { id: 'audio-generation', name: 'Audio Generation' },
    { id: 'video-generation', name: 'Video Generation' },
    { id: 'dataset', name: 'Top Datasets' },
];

// 2. Process Category-Specific Leaderboards
const categoryRankings = leaderboardCategories.map(category => {
    const filteredModels = allModels
        .filter(model => model.tags?.includes(category.id) && !model.is_archived)
        .sort((a, b) => (b.likes || 0) - (a.likes || 0))
        .slice(0, 10); // Get top 10

    return {
        ...category,
        models: filteredModels,
    };
});


// 3. Process General Rankings (Hot, Trending, etc.)
const now = Date.now();
const thirtyDaysAgo = now - 30 * 24 * 60 * 60 * 1000;

const modelsWithVelocity = allModels.map(model => {
    const ageInDays = (now - new Date(model.lastModified).getTime()) / (1000 * 60 * 60 * 24);
    // Velocity formula: more likes on newer models get a higher score
    const velocity = (model.likes || 0) / (ageInDays + 1); 
    return { ...model, velocity };
});

const hot = [...modelsWithVelocity].sort((a, b) => b.velocity - a.velocity).slice(0, 12);
const trending = allModels.filter(m => new Date(m.lastModified).getTime() > thirtyDaysAgo).sort((a, b) => (b.likes || 0) - (a.likes || 0)).slice(0, 12);
const newest = [...allModels].sort((a, b) => new Date(b.lastModified).getTime() - new Date(a.lastModified).getTime()).slice(0, 12);
const rising = allModels.filter(m => m.is_rising_star).slice(0, 12);

const generatedAt = new Date().toISOString();

// --- End of Data Processing ---


const pageTitle = "AI Model Rankings";
const pageDescription = "Discover top-performing and trending open-source AI models. Rankings are updated daily based on community engagement and recent activity.";
---
<BaseLayout title={pageTitle} description={pageDescription}>
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-5xl">AI Model Leaderboards</h1>
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">{pageDescription}</p>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Last updated: {new Date(generatedAt).toLocaleString()}</p>
        </div>

        <!-- General Rankings Tabs -->
        <div class="w-full max-w-5xl mx-auto mb-16">
            <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs" id="ranking-tabs">
                    <button data-tab-target="hot" class="tab-button active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg transition-colors">üî• Hot</button>
                    <button data-tab-target="trending" class="tab-button inactive-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg transition-colors">üìà Trending</button>
                    <button data-tab-target="newest" class="tab-button inactive-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg transition-colors">‚ú® Newest</button>
                    <button data-tab-target="rising" class="tab-button inactive-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg transition-colors">üöÄ Rising Stars</button>
                </nav>
            </div>

            <div id="ranking-panels">
                <div id="hot-panel" class="tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {hot.map(model => <ModelCard model={model} />)}
                </div>
                <div id="trending-panel" class="tab-panel hidden grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {trending.map(model => <ModelCard model={model} />)}
                </div>
                <div id="newest-panel" class="tab-panel hidden grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {newest.map(model => <ModelCard model={model} />)}
                </div>
                <div id="rising-panel" class="tab-panel hidden grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {rising.map(model => <ModelCard model={model} />)}
                </div>
            </div>
        </div>

        <!-- Category Leaderboards Section -->
        <div class="text-center my-16">
            <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">Category Leaderboards</h2>
            <p class="mt-3 text-lg text-gray-600 dark:text-gray-300">Top 10 models for specific tasks, ranked by community likes.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            {categoryRankings.map(category => (
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">{category.name}</h3>
                    <ol class="space-y-3">
                        {category.models.map((model, index) => (
                            <li class="flex items-center gap-4">
                                <span class="text-lg font-bold text-gray-400 dark:text-gray-500 w-6 text-center">{index + 1}</span>
                                <div class="flex-1">
                                    <a href={`/model/${getModelId(model)}`} class="font-semibold text-gray-800 dark:text-gray-100 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                        {model.name}
                                    </a>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">by {model.author}</p>
                                </div>
                                <div class="flex items-center gap-1 text-sm text-red-500" title={`${(model.likes || 0).toLocaleString()} likes`}>
                                    ‚ù§Ô∏è
                                    <span class="font-medium">
                                        {(model.likes || 0) >= 1000 ? `${(model.likes / 1000).toFixed(1)}k` : model.likes || 0}
                                    </span>
                                </div>
                            </li>
                        ))}
                    </ol>
                </div>
            ))}
        </div>

    </div>

    <style>
        .active-tab { border-color: #4f46e5; color: #4338ca; }
        .dark .active-tab { color: #818cf8; }
        .inactive-tab { border-color: transparent; color: #6b7280; }
        .dark .inactive-tab { color: #9ca3af; }
        .inactive-tab:hover { border-color: #d1d5db; color: #374151; }
        .dark .inactive-tab:hover { border-color: #4b5563; color: #e5e7eb; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabsContainer = document.getElementById('ranking-tabs');
            if (!tabsContainer) return;

            const tabButtons = tabsContainer.querySelectorAll('.tab-button');
            const panelsContainer = document.getElementById('ranking-panels');
            const tabPanels = panelsContainer.querySelectorAll('.tab-panel');

            tabsContainer.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.tab-button');
                if (!targetButton) return;

                const targetPanelId = targetButton.dataset.tabTarget + '-panel';

                tabButtons.forEach(button => button.classList.replace('active-tab', 'inactive-tab'));
                tabPanels.forEach(panel => panel.classList.add('hidden'));

                targetButton.classList.replace('inactive-tab', 'active-tab');
                const targetPanel = document.getElementById(targetPanelId);
                if (targetPanel) targetPanel.classList.remove('hidden');
            });
        });
    </script>
</BaseLayout>
