---
/**
 * Spaces Index Page - V14.5.8 Universal Architecture
 * Lists HuggingFace Spaces with filtering and sorting
 * Uses Shared UniversalCatalog Logic + Centralized Fetcher
 */

export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { fetchCatalogData } from '../../utils/catalog-fetcher.js';

// SSR Data Fetching (Unified)
const { items: spaces, error, source } = await fetchCatalogData('space', Astro.locals.runtime?.env);

const pageTitle = 'AI Spaces Catalog - Interactive Demos';
const pageDescription = 'Explore interactive AI demos and applications powered by HuggingFace Spaces.';
const canonicalUrl = 'https://free2aitools.com/spaces';

// Category mapping for Spaces
const categories = [
  { id: 'gradio', label: 'Gradio Apps', icon: 'üé®' },
  { id: 'streamlit', label: 'Streamlit Apps', icon: 'üìä' },
  { id: 'static', label: 'Static Demos', icon: '‚ö°' },
  { id: 'docker', label: 'Docker Spaces', icon: 'üê≥' },
];
---

<Layout title={pageTitle} description={pageDescription}>
  <link slot="head" rel="canonical" href={canonicalUrl} />
  
  <main class="container mx-auto px-4 py-8 min-h-screen flex flex-col">
    <!-- Page Header (Catalog Style) -->
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-2">
        AI Spaces Catalog
      </h1>
      <p class="text-gray-600 dark:text-gray-400">
        Browse and discover interactive AI demos and applications
      </p>
    </div>

    <!-- Filters & Sort Bar -->
    <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm z-10 relative">
      <!-- Search -->
      <div class="flex-1 min-w-[200px]">
        <input 
          type="text" 
          id="entity-search" 
          placeholder="Search spaces..." 
          class="w-full px-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
        />
      </div>
      
      <!-- Category Filter (Not standard universal yet, but good to keep specific) -->
      <!-- <select id="category-filter" class="..."> ... </select> -->
      <!-- For V1 Phase 15.8, we can stick to standard sort or keep category if UniversalCatalog supports it. 
           The UniversalCatalog class currently only supports text search and standard sorts. 
           For this first pass, we will prioritize text search and "SDK" tags in the UI. 
      -->
      
      <!-- Sort -->
      <select id="sort-by" class="px-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
        <option value="fni">üõ°Ô∏è FNI Score</option>
        <option value="likes">‚ù§Ô∏è Likes</option>
        <option value="recent">üïê Recently Updated</option>
         <option value="name">Aa Name</option>
      </select>
    </div>

    <!-- Stats Bar -->
    <div class="flex items-center gap-4 mb-6 text-sm text-gray-500 dark:text-gray-400">
       <span id="results-count" class="font-medium">
         {spaces.length > 0 ? `${spaces.length} spaces loaded from ${source.toUpperCase()}` : 'Loading spaces...'}
      </span>
      <span>‚Ä¢</span>
      <span>Updated Mon/Thu</span>
    </div>

    <!-- Debug Block -->
    {spaces.length === 0 && (
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg mb-6 text-sm text-red-600 dark:text-red-400">
            <strong>System Status:</strong> Failed to pre-load spaces. 
            <br/>Source: {source}
            <br/>Error: {error || 'Unknown Data Fetch Failure'}
        </div>
    )}

    <!-- Grid -->
    <div id="entity-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 flex-grow min-h-[500px]">
       {spaces.length > 0 ? (
           spaces.slice(0, 24).map((item: any) => (
            <a href={`/space/${item.slug || item.id}`} 
               class="entity-card p-4 bg-white dark:bg-gray-800 rounded-xl hover:shadow-lg transition-all border border-gray-100 dark:border-gray-700 block">
              <div class="flex items-center justify-between mb-2">
                 <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 capitalize">{item.sdk || 'Space'}</span>
                 {item.fni_score > 0 && (
                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400">
                       üõ°Ô∏è {Math.round(item.fni_score)}
                    </span>
                  )}
              </div>
              <h3 class="font-bold text-gray-900 dark:text-white truncate">{item.name || item.id}</h3>
              {/* Sanitized SSR Description */}
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">
                {item.description ? item.description.replace(/<[^>]*>?/gm, '') : ''}
              </p>
               <div class="flex items-center gap-3 mt-3 text-xs text-gray-400">
                    {item.downloads ? <span>üì• {item.downloads}</span> : null}
                    {item.likes ? <span>‚ù§Ô∏è {item.likes}</span> : null}
                </div>
            </a>
           ))
       ) : (
          /* Skeleton Fallback */
          Array(8).fill(0).map(() => (
            <div class="animate-pulse bg-white dark:bg-gray-800 rounded-xl p-5 h-48">
              <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-3"></div>
              <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full mb-2"></div>
            </div>
          ))
       )}
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-8 mb-12">
      <nav id="pagination" class="flex items-center gap-2"></nav>
    </div>
  </main>
</Layout>

<script define:vars={{ initialSpaces: spaces }}>
  import { UniversalCatalog } from '../../scripts/lib/UniversalCatalog.js';

  console.log('[Spaces Page] Hydrating...', { count: initialSpaces?.length });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
         new UniversalCatalog({ 
            initialData: initialSpaces, 
            type: 'space',
            gridId: 'entity-grid'
         });
    });
  } else {
     new UniversalCatalog({ 
        initialData: initialSpaces, 
        type: 'space', 
        gridId: 'entity-grid'
     });
  }
</script>
