---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import CompareHeader from '../components/compare/CompareHeader.astro';
import BenchmarkComparison from '../components/compare/BenchmarkComparison.astro';
import ScoreComparison from '../components/compare/ScoreComparison.astro';
import SpecsComparison from '../components/compare/SpecsComparison.astro';
import DeployComparison from '../components/compare/DeployComparison.astro';
import CompareEmptyState from '../components/compare/CompareEmptyState.astro';

import { getModelFromCache } from '../utils/entity-cache-reader';
import '../styles/compare.css';

// Logic
const m1 = Astro.url.searchParams.get('m1') || Astro.url.searchParams.get('m');
let modelIds = [];
// Parse standard m=...&m=... array param
const mParams = Astro.url.searchParams.getAll('m');
if (mParams.length > 0) {
  modelIds = mParams;
} else if (m1) {
    // Legacy support or fallback
    modelIds.push(m1);
    const m2 = Astro.url.searchParams.get('m2');
    if (m2) modelIds.push(m2);
}
// Limit to 4
modelIds = modelIds.slice(0, 4);

// Data Fetching (Using R2 Cache)
let benchmarkData = { data: [] };
let specsData = { data: [] };

try {
  // We need to fetch ALL data to filter, or fetch individual?
  // R2 Cache reader (entity-cache-reader) fetches single model.
  // We might need to parallel fetch.
  // BUT the original code used `getCachedBenchmarkData` and `getCachedSpecsData`.
  // If those are deprecated, we should use the new reader.
  // However, for "Available Models", do we fetch ALL?
  // The original code: `import { getCachedBenchmarkData, getCachedSpecsData } from '../utils/data-service';`
  // Wait, `data-service.js` refactor removed those!
  // We need to check if we can get a list of models.
  // Using `index_hot.json` via fetch might be better, or if we have a way to get list.
  // For now, let's assume we can fetch specific models by ID using `getModelFromCache`.
} catch (e) {
  console.error("Data fetch error", e);
}

// Fetch selected models
const compareModels = await Promise.all(modelIds.map(async (id) => {
    const m = await getModelFromCache(id, Astro.locals);
    if (!m) return null;
    return {
        umid: m.umid || m.id,
        name: m.name || m.id,
        benchmark: {
            mmlu: m.mmlu || m.benchmark_mmlu || 0,
            hellaswag: m.hellaswag || m.benchmark_hellaswag || 0,
            arc_challenge: m.arc_challenge || m.benchmark_arc || 0,
            humaneval: m.humaneval || m.benchmark_humaneval || 0,
            avg_score: m.avg_score || m.benchmark_avg || 0
        },
        specs: {
            params_billions: m.params_billions,
            context_length: m.context_length,
            license_spdx: m.license_spdx,
            has_gguf: m.has_gguf,
            gguf_variants: m.gguf_variants,
            has_ollama: m.has_ollama,
            ollama_pulls: m.ollama_pulls
        }
    };
}));

const validModels = compareModels.filter(m => m !== null);
const radarMetrics = ['mmlu', 'humaneval', 'hellaswag', 'arc_challenge'];

// Available models stub - Since we can't easily fetch 20k models here for a select box without massive overhead.
// The original code fetched "allBenchmarks".
// Recommendation: Populate select via SEARCH in V6, or just a small "Trending" list for now.
// For V5.1.2 compliance, we will just use the Valid Models + maybe some defaults?
// Actually, let's keep it simple: "Available" list is hard without D1.
// We can use the Hot Index client-side? No, this is SSR.
// We'll leave availableModels empty or minimal for now, expecting user to arrive via "Compare" buttons on other pages.
const availableModels = validModels.map(m => ({ umid: m.umid, name: m.name, avg_score: m.benchmark.avg_score }));

const pageTitle = validModels.length > 0 
  ? `Compare ${validModels.map(m => m.name.split('/').pop()).join(' vs ')} - AI Nexus` 
  : "Compare AI Models - AI Nexus";
---

<Layout title={pageTitle} description="Compare performance of top AI models side-by-side.">
  <div class="compare-container container mx-auto px-4">
    <CompareHeader 
        slots={[0, 1]} 
        selectedModels={modelIds} 
        availableModels={availableModels}
    />

    {validModels.length === 0 ? (
      <CompareEmptyState />
    ) : (
      <>
        <BenchmarkComparison compareModels={validModels} />
        <ScoreComparison compareModels={validModels} radarMetrics={radarMetrics} />
        <SpecsComparison compareModels={validModels} />
        <DeployComparison compareModels={validModels} />
      </>
    )}
  </div>

  <script>
      import { initComparePage } from '../scripts/compare-client.js';
      document.addEventListener('DOMContentLoaded', initComparePage);
  </script>
</Layout>
