---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import CompareHeader from '../components/compare/CompareHeader.astro';
import BenchmarkComparison from '../components/compare/BenchmarkComparison.astro';
import ScoreComparison from '../components/compare/ScoreComparison.astro';
import SpecsComparison from '../components/compare/SpecsComparison.astro';
import DeployComparison from '../components/compare/DeployComparison.astro';
import CompareEmptyState from '../components/compare/CompareEmptyState.astro';

import { getModelFromCache } from '../utils/entity-cache-reader';
import '../styles/compare.css';

// Logic
const m1 = Astro.url.searchParams.get('m1') || Astro.url.searchParams.get('m');
let modelIds = [];
// Parse standard m=...&m=... array param
const mParams = Astro.url.searchParams.getAll('m');
if (mParams.length > 0) {
  modelIds = mParams;
} else if (m1) {
    // Legacy support or fallback
    modelIds.push(m1);
    const m2 = Astro.url.searchParams.get('m2');
    if (m2) modelIds.push(m2);
}
// V13: Limit to 3 for cleaner comparison UI
modelIds = modelIds.slice(0, 3);

// Data Fetching (Using R2 Cache)
let benchmarkData = { data: [] };
let specsData = { data: [] };

try {
  // We need to fetch ALL data to filter, or fetch individual?
  // R2 Cache reader (entity-cache-reader) fetches single model.
  // We might need to parallel fetch.
  // BUT the original code used `getCachedBenchmarkData` and `getCachedSpecsData`.
  // If those are deprecated, we should use the new reader.
  // However, for "Available Models", do we fetch ALL?
  // The original code: `import { getCachedBenchmarkData, getCachedSpecsData } from '../utils/data-service';`
  // Wait, `data-service.js` refactor removed those!
  // We need to check if we can get a list of models.
  // Using `index_hot.json` via fetch might be better, or if we have a way to get list.
  // For now, let's assume we can fetch specific models by ID using `getModelFromCache`.
} catch (e) {
  console.error("Data fetch error", e);
}

// Direct R2 Cache Fetching (V15.0 Constitutional Fix)
const compareModels = await Promise.all(modelIds.map(async (id) => {
    try {
        let model = null;
        
        // 1. Try env.R2_ASSETS (Production)
        const runtime = Astro.locals.runtime;
        if (runtime?.env?.R2_ASSETS) {
             const cleanId = id.replace(/--/g, '/'); // Normalize double-dash to slash
             // Try common key patterns:
             // 1. cache/entities/model/source--author--name.json (Standard)
             // 2. cache/entities/model/owner--name.json (Fallback)
             const possibleKeys = [
                 `cache/entities/model/${cleanId.replace(/\//g, '--')}.json`,
                 `cache/entities/model/${cleanId.split('/').slice(-2).join('--')}.json`
             ];

             for (const key of possibleKeys) {
                 const obj = await runtime.env.R2_ASSETS.get(key);
                 if (obj) {
                     const data = await obj.json();
                     model = data.entity || data;
                     break;
                 }
             }
        }
        
        // 2. Try public CDN (Direct Access - Zero Runtime)
        if (!model) {
            const cleanId = id.replace(/\//g, '--');
            const res = await fetch(`https://cdn.free2aitools.com/cache/entities/model/${cleanId}.json`);
            if (res.ok) {
                 const data = await res.json();
                 model = data.entity || data;
            }
        }

        if (!model) return null;

        return {
            umid: model.umid || model.id,
            name: model.name || model.id,
            benchmark: {
                mmlu: model.mmlu || model.benchmark_mmlu || 0,
                hellaswag: model.hellaswag || model.benchmark_hellaswag || 0,
                arc_challenge: model.arc_challenge || model.benchmark_arc || 0,
                humaneval: model.humaneval || model.benchmark_humaneval || 0,
                avg_score: model.avg_score || model.benchmark_avg || 0
            },
            specs: {
                params_billions: model.params_billions,
                context_length: model.context_length,
                license_spdx: model.license_spdx,
                has_gguf: model.has_gguf,
                gguf_variants: model.gguf_variants,
                has_ollama: model.has_ollama,
                ollama_pulls: model.ollama_pulls
            }
        };
    } catch (e) {
        console.error(`Compare fetch failed for ${id}:`, e);
        return null;
    }
}));

const validModels = compareModels.filter(m => m !== null);
const radarMetrics = ['mmlu', 'humaneval', 'hellaswag', 'arc_challenge'];

// Available models stub - Since we can't easily fetch 20k models here for a select box without massive overhead.
// The original code fetched "allBenchmarks".
// Recommendation: Populate select via SEARCH in V6, or just a small "Trending" list for now.
// For V5.1.2 compliance, we will just use the Valid Models + maybe some defaults?
// Actually, let's keep it simple: "Available" list is hard without D1.
// We can use the Hot Index client-side? No, this is SSR.
// We'll leave availableModels empty or minimal for now, expecting user to arrive via "Compare" buttons on other pages.
const availableModels = validModels.map(m => ({ umid: m.umid, name: m.name, avg_score: m.benchmark.avg_score }));

const pageTitle = validModels.length > 0 
  ? `Compare ${validModels.map(m => m.name.split('/').pop()).join(' vs ')} - AI Nexus` 
  : "Compare AI Models - AI Nexus";
---

<Layout title={pageTitle} description="Compare performance of top AI models side-by-side.">
  <div class="compare-container container mx-auto px-4">
    <CompareHeader 
        slots={[0, 1]} 
        selectedModels={modelIds} 
        availableModels={availableModels}
    />

    {validModels.length === 0 ? (
      <CompareEmptyState />
    ) : (
      <>
        <BenchmarkComparison compareModels={validModels} />
        <ScoreComparison compareModels={validModels} radarMetrics={radarMetrics} />
        <SpecsComparison compareModels={validModels} />
        <DeployComparison compareModels={validModels} />
      </>
    )}
  </div>

  <script>
      import { initComparePage } from '../scripts/compare-client.js';
      document.addEventListener('DOMContentLoaded', initComparePage);
  </script>
</Layout>
