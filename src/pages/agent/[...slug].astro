---
export const prerender = false;

/**
 * Agent Detail Page V16.5
 * Core Feature: 8 Core Value Pillars Integration
 * Architecture: Zero-Limit Content Disclosure
 * Unified: Synchronized with Model page standards
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import AgentDeepDive from '../../components/agent-detail/AgentDeepDive.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import { getUseCases } from '../../utils/inference.js';
import ShareButtons from '../../components/common/ShareButtons.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import VramEstimator from '../../components/model-detail/VramEstimator.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import BenchmarkCard from '../../components/benchmark/BenchmarkCard.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import QuickCommands from '../../components/common/QuickCommands.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import CiteEntity from '../../components/common/CiteEntity.astro';

import { prepareAgentPageData } from '../../utils/agent-page-data.js';
import { cleanDescription } from '../../utils/model-page-helpers.ts';
import { normalizeEntitySlug } from '../../utils/entity-cache-reader-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
const normalizedSlug = normalizeEntitySlug(slugStr);

let agent = null;
let error = null;
let similarEntities = [];
let tagsArray = [];
let pageTitle = "AI Agent Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI agent.";
let cleanedDesc = "";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug/ID provided");
  const pageData = await prepareAgentPageData(slug, slugStr, Astro.locals);
  
  if (!pageData) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=agent-not-found&id=' + encodeURIComponent(slugStr));
  }

  const { agent: resolvedAgent, isFallback, repoName, similarEntities: resolvedSimilar, tagsArray: resolvedTags, meshRelations: resolvedMesh } = pageData;
  agent = resolvedAgent;
  similarEntities = resolvedSimilar;
  tagsArray = resolvedTags;
  meshRelations = resolvedMesh || [];

  const displayAgentName = agent?.name || (isFallback ? repoName : agent?.canonical_name) || 'Unknown Agent';
  pageTitle = `${displayAgentName} - AI Agent Insights & Frameworks`;
  cleanedDesc = cleanDescription(agent?.description || '');
  pageDescription = agent?.seo_summary?.description || cleanedDesc || `Deep dive into ${displayAgentName}.`;

} catch (e) {
  console.error("Error loading agent:", e);
  error = e;
  Astro.response.status = 500;
}

if (!agent && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=agent-not-found');
}

const agentName = agent?.name || agent?.canonical_name || 'Unknown Agent';
const agentId = agent?.id || normalizedSlug || '';
const displayAuthor = agent?.author || 'Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = agent ? getUseCases(tagsArray, agent?.pipeline_tag, 'agent', agent?.fni_score) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": agentName,
  "description": pageDescription,
  "applicationCategory": "AI Agent",
  "operatingSystem": "Cross-platform",
  "author": {
    "@type": "Organization",
    "name": displayAuthor
  }
};
---

  <EntityLayout
    entity={agent}
    type="agent"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
  >
    {/* Zone 1: Hero */}
    <EntityHeader
      slot="hero"
      name={agentName}
      entityType="agent"
      entityIcon={agent?.entityDefinition?.display?.icon || 'ðŸ¤–'}
      entityLabel={agent?.entityDefinition?.display?.labelSingular || 'Agent'}
      verified={agent?.verified}
      author={displayAuthor}
      description={agent?.seo_summary?.description || cleanedDesc}
      fniScore={agent?.fni_score}
      fniPercentile={agent?.fni_percentile}
      fniCommentary={agent?.fni_commentary}
      sourceUrl={agent?.source_url}
      entityId={agentId}
      hasImage={Boolean(agent?.image_url)}
    />

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases
      slot="use-cases"
      usecases={getUseCases(agent)}
    />

    {/* Zone 2: Insights Extra */}
    <div slot="insights-extra" class="mt-4 space-y-6">
       {/* Use TechSpecs elevated if needed */}
    </div>

    {/* Zone 3: Core (Desktop/Mobile) */}
    <div slot="core-desktop">
       <UniversalCore entity={agent} type="agent" meshRelations={meshRelations} />
    </div>

    <div slot="core-knowledge">
       <UniversalCore entity={agent} type="agent" meshRelations={meshRelations} />
    </div>
    
    <div slot="core-similar">
        {similarEntities.length > 0 ? (
           <ModelCarousel models={similarEntities} />
        ) : (
           <p class="text-gray-500 italic p-4 text-center">Finding related autonomous agents and frameworks...</p>
        )}
    </div>
  
    <div slot="core-benchmarks">
        {agent && (agent.mmlu || agent.humaneval || agent.avg_score || agent.benchmark_avg) ? (
            <BenchmarkCard 
              title={`${agentName} Benchmarks`} 
              scores={agent.meta_json?.benchmarks}
            />
        ) : (
            <p class="text-gray-500 italic p-4 text-center">Benchmark metrics for this agent are currently being analyzed.</p>
        )}
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
       <div class="space-y-12">
          <section class="mb-12">
             <ModelNavigation />
          </section>
          <AgentDeepDive agent={agent} />
       </div>
    </div>

    {/* Zone Sidebar Slots */}
    <div slot="sidebar" class="space-y-8">
       <ModelInfoTable 
         type="agent"
         model={{
           ...(agent || {}),
           displayName: agentName,
           pipeline_tag: agent?.framework || agent?.pipeline_tag || 'Agent Framework'
         }} 
       />

       <CiteEntity 
         id={agentId} 
         name={agentName} 
         author={agent?.author} 
         url={agent?.source_url} 
         type="agent" 
       />
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={agent?.source} lastUpdated={agent?.last_updated} />
    </div>
  </EntityLayout>
