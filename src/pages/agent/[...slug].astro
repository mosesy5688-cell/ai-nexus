---
export const prerender = false;

/**
 * Agent Detail Page V1.0
 * Phase B P2: B.2 Agent Entity Expansion
 * CES Compliant: < 200 lines
 */

import Layout from '../../layouts/Layout.astro';
import AgentHeader from '../../components/agent-detail/AgentHeader.astro';
import AgentSpecs from '../../components/agent-detail/AgentSpecs.astro';
import RelatedResearch from '../../components/model-detail/RelatedResearch.astro';
import RelatedKnowledge from '../../components/model-detail/RelatedKnowledge.astro';

import { getModelFromCache } from '../../utils/entity-cache-reader';
import { ENTITY_DEFINITIONS } from '../../data/entity-definitions';

const { slug } = Astro.params;

// Handle slug as array (from [...slug]) or string
// URL formats: /agent/github-agent--author--name OR /agent/github-agent/author/name
let normalizedSlug = '';
if (Array.isArray(slug)) {
  // If URL was /agent/github-agent/author/name, join with --
  normalizedSlug = slug.join('--').toLowerCase();
} else if (typeof slug === 'string') {
  normalizedSlug = slug.toLowerCase();
}

let agent = null;
let error = null;
let pageTitle = "AI Agent Details - Free AI Tools";
let pageDescription = "Explore this AI agent's capabilities and features.";

try {
  if (!normalizedSlug) throw new Error("No slug provided");
  
  // V12: Get agent from cache/entities/agent/ path
  const runtime = Astro.locals.runtime;
  if (runtime?.env?.R2_ASSETS) {
    const r2 = runtime.env.R2_ASSETS;
    const cacheFile = await r2.get(`cache/entities/agent/${normalizedSlug}.json`);
    if (cacheFile) {
      const cacheData = await cacheFile.json();
      agent = cacheData.entity || cacheData;
    }
  }
  // Fallback to old cache reader
  if (!agent) {
    agent = await getModelFromCache(normalizedSlug, Astro.locals);
  }

  if (agent) {
    const agentName = agent.name || agent.canonical_name || 'Unknown Agent';
    pageTitle = `${agentName} - AI Agent`;
    pageDescription = agent.description 
      ? agent.description.substring(0, 160) 
      : `Explore ${agentName} AI agent.`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
  console.error('[AgentPage] Error:', error);
}

const agentId = agent?.id || agent?.umid || normalizedSlug || '';
const agentName = agent?.name || agent?.canonical_name || 'Unknown Agent';
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8 max-w-5xl">
    {error && (
      <div class="text-center py-16">
        <h1 class="text-3xl font-bold text-red-500 mb-4">Error</h1>
        <p class="text-gray-600 dark:text-gray-400">{error}</p>
        <a href="/ranking" class="mt-4 inline-block text-indigo-500 hover:underline">
          ‚Üê Browse all agents
        </a>
      </div>
    )}

    {agent && (
      <article>
        <AgentHeader 
          name={agentName}
          author={agent.author || agent.organization || 'Unknown'}
          description={agent.description}
          sourceUrl={agent.source_url}
          stars={agent.stars || agent.github_stars}
          agentType={agent.agent_type || 'agent'}
        />
        
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 space-y-6">
            {agent.body_content && (
              <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Description</h2>
                <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">
                  {agent.body_content}
                </div>
              </section>
            )}
            
            <RelatedResearch modelId={agentId} />
            
            <RelatedKnowledge 
              tags={agent.tags || []}
              description={agent.description || ''}
            />
          </div>
          
          <aside>
            <AgentSpecs 
              framework={agent.framework || agent.library_name}
              language={agent.language}
              license={agent.license || agent.license_spdx}
              stars={agent.stars || agent.github_stars}
              forks={agent.forks || agent.github_forks}
              lastCommit={agent.last_commit || agent.github_last_commit}
              sourceUrl={agent.source_url}
              metaJson={agent.meta_json}
            />
          </aside>
        </div>
        
        <div class="mt-8 text-center">
          <a href="/ranking" class="text-indigo-500 hover:underline">
            ‚Üê Browse all agents
          </a>
        </div>
      </article>
    )}

    {!agent && !error && (
      <div class="text-center py-16">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-full mb-6">
          <span class="text-4xl">ü§ñ</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-700 dark:text-gray-300 mb-4">Agent Not Found</h1>
        <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-8">
          This agent may not be available yet or the URL might be incorrect.
          Our data is updated daily - check back soon!
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/agent" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors font-medium">
            Browse All Agents
          </a>
          <a href="/models" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium">
            Explore AI Models
          </a>
        </div>

        <div class="mt-12 text-left max-w-xl mx-auto">
          <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Popular Agents You Might Like</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <a href="/agent/github-agent--langchain-ai--langchain" class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 transition-colors">
              <span class="font-medium text-gray-900 dark:text-white">LangChain</span>
              <span class="text-sm text-gray-500 ml-2">LLM Framework</span>
            </a>
            <a href="/agent/github-agent--microsoft--autogen" class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 transition-colors">
              <span class="font-medium text-gray-900 dark:text-white">AutoGen</span>
              <span class="text-sm text-gray-500 ml-2">Multi-Agent</span>
            </a>
          </div>
        </div>
      </div>
    )}
  </main>
</Layout>
