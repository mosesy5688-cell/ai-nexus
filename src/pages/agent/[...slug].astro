---
export const prerender = false;

/**
 * Agent Detail Page V16.5
 * Core Feature: 8 Core Value Pillars Integration
 * Architecture: Zero-Limit Content Disclosure
 * Unified: Synchronized with Model page standards
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import AgentDeepDive from '../../components/agent-detail/AgentDeepDive.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import { getUseCases } from '../../utils/inference.js';
import ShareButtons from '../../components/common/ShareButtons.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import { cleanDescription } from '../../utils/model-page-helpers.ts';
// V19.0: ModelNavigation removed â€” not applicable to agents
import CiteEntity from '../../components/common/CiteEntity.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';

// 2. Efficient Data Loading (Single-Stream V16.5)
import { loadEntityStreams } from '../../utils/packet-loader.js';
import { getRouteFromId } from '../../utils/mesh-routing-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

let agent = null;
let error = null;
let meshRelations = [];
let tagsArray = [];
let pageTitle = "AI Agent Details - Free AI Tools";
let pageDescription = "Explore comprehensive information about this AI agent.";
let cleanedDesc = "";

try {
  if (!slug) throw new Error("No slug/ID provided");
  
  // V16.5: Usage of 3-Stream Parallel Loader
  const type = 'agent';
  // V16.5: Static Assembly Architecture
  const { entity, html, mesh, _meta } = await loadEntityStreams(type, slugStr);

  // 3. Validation & 404 Handling (Zero-Entropy)
  if (!entity || !_meta.available) {
     Astro.response.status = 404;
     return Astro.redirect('/404?reason=agent-not-found&id=' + encodeURIComponent(slugStr));
  }

  // 4. Transform & Prepare
  agent = entity;
  meshRelations = mesh || [];
  tagsArray = agent?.tags || [];

  const displayAgentName = agent?.name || agent?.canonical_name || 'Unknown Agent';
  pageTitle = `${displayAgentName} - AI Agent Insights & Frameworks`;
  cleanedDesc = cleanDescription(agent?.description || '');
  pageDescription = agent?.seo_summary?.description || cleanedDesc || `Deep dive into ${displayAgentName}.`;

  // V16.5: Explicit HTML Assignment (Stream B Priority)
  agent.html_readme = html || agent.html_readme || null;

} catch (e) {
  console.error("Error loading agent:", e);
  error = e;
  // V16.8: Suppress 500 to allow "Mesh Node Building" fallback UI
  // Astro.response.status = 500;
}

if (!agent && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=agent-not-found');
}

const agentName = agent?.name || agent?.canonical_name || 'Unknown Agent';
const agentId = agent?.id || normalizedSlug || '';
const displayAuthor = agent?.author || 'Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = agent ? getUseCases(tagsArray, agent?.pipeline_tag, 'agent', agent?.fni_score) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": agentName,
  "description": pageDescription,
  "applicationCategory": "AI Agent",
  "operatingSystem": "Cross-platform",
  "author": {
    "@type": "Organization",
    "name": displayAuthor
  }
};
const canonicalPath = agent ? getRouteFromId(agent.id || normalizedSlug, 'agent') : undefined;
---

  <EntityLayout
    entity={agent}
    type="agent"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
    canonical={canonicalPath}
  >
    {/* Zone 1: Hero */}
    {agent && (
      <EntityHeader
        slot="hero"
        name={agentName}
        entityType="agent"
        entityIcon={agent.entityDefinition?.display?.icon || 'ðŸ¤–'}
        entityLabel={agent.entityDefinition?.display?.labelSingular || 'Agent'}
        verified={agent.verified}
        author={displayAuthor}
        lastUpdated={agent.last_updated}
        description={agent.seo_summary?.description || cleanedDesc}
        fniScore={agent.fni_score}
        fniPercentile={agent.fni_percentile}
        fniCommentary={agent.fni_commentary}
        sourceUrl={agent.source_url}
        entityId={agentId}
        hasImage={Boolean(agent.image_url)}
        trend_7d={agent.trend_7d}
      />
    )}

    {/* Zone 1.5: Use Cases */}
    {agent && (
      <ZoneUseCases
        slot="use-cases"
        usecases={getUseCases(agent)}
      />
    )}

    {/* Zone 2: Insights Extra */}
    {agent && (
      <div slot="insights-extra" class="mt-4 space-y-8">
         <div class="passport-block animate-slide-up" style="animation-delay: 0.2s;">
            <ModelInfoTable 
              type="agent"
              model={{
                ...agent,
                displayName: agentName,
                pipeline_tag: agent.framework || agent.pipeline_tag || 'Agent Framework'
              }} 
            />
         </div>
         {agent.params_billions && <VramEstimator paramsB={agent.params_billions} contextLen={agent.context_length} />}
      </div>
    )}

    {/* Zone 3: Core (Knowledge Mesh & Relations) */}
    {agent && (
      <div slot="core-desktop" class="space-y-16">
         <UniversalCore entity={agent} type="agent" meshRelations={meshRelations} />
         
         <div class="cite-block animate-slide-up" style="animation-delay: 0.4s;">
            <CiteEntity 
              id={agentId} 
              name={agentName} 
              author={agent.author} 
              url={agent.source_url} 
              type="agent" 
            />
         </div>
      </div>
    )}
  
    {/* Zone 4: Deep Dive */}
    {agent && (
      <div slot="deep-dive">
         <div class="space-y-12">
            {agent.html_readme ? (
              <article class="prose prose-lg dark:prose-invert max-w-none prose-a:text-indigo-600 dark:prose-a:text-indigo-400 prose-img:rounded-2xl shadow-none" set:html={agent.html_readme} />
            ) : (
              <AgentDeepDive agent={agent} />
            )}
         </div>
      </div>
    )}

    {/* Zone 5: Community */}
    {agent && (
      <div slot="community">
          <AiDisclaimer source={agent.source} lastUpdated={agent.last_updated} />
      </div>
    )}
  </EntityLayout>
