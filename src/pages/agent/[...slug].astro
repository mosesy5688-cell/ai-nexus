---
export const prerender = false;

/**
 * Agent Detail Page V1.0
 * Phase B P2: B.2 Agent Entity Expansion
 * CES Compliant: < 200 lines
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import AgentDeepDive from '../../components/agent-detail/AgentDeepDive.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import { getUseCases } from '../../utils/inference';
import ShareButtons from '../../components/common/ShareButtons.astro';

import { fetchEntityFromR2, normalizeEntitySlug, hydrateEntity } from '../../utils/entity-cache-reader-core.js';
import { ENTITY_DEFINITIONS } from '../../data/entity-definitions';

const { slug } = Astro.params;

// V15.1: Use unified normalization and fetcher
const normalizedSlug = normalizeEntitySlug(slug, 'agent');

let agent = null;
let error = null;
let pageTitle = "AI Agent Details - Free AI Tools";
let pageDescription = "Explore this AI agent's capabilities and features.";

try {
  if (!normalizedSlug) throw new Error("No slug provided");
  
  const result = await fetchEntityFromR2('agent', normalizedSlug, Astro.locals);
  if (result) {
    agent = hydrateEntity(result, 'agent');
  } else {
    // V15.6 Fallback Logic
    const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
    const cleanSlug = slugStr.replace(/--/g, '/');
    const parts = cleanSlug.split('/');
    
    agent = {
      id: `agent--${slugStr.replace(/\//g, '--')}`,
      name: parts.pop() || 'Unknown Agent',
      author: parts.join('/') || 'github',
      description: `Autonomous AI agent: ${cleanSlug}`,
      source_url: `https://github.com/${cleanSlug}`,
      tags: [],
      _cache_source: 'fallback-ui'
    };
  }

  if (agent) {
    const agentName = agent.name || agent.canonical_name || 'Unknown Agent';
    pageTitle = `${agentName} - AI Agent`;
    pageDescription = agent.description 
      ? agent.description.substring(0, 160) 
      : `Explore ${agentName} AI agent.`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
  console.error('[AgentPage] Error:', error);
}

// V15.0: Derived Use Cases and Limits
const derivedUseCases = agent ? getUseCases(agent.tags || [], '', 'agent', agent.fni_score || 0) : { goodFor: [], limits: [] };

const agentId = agent?.id || agent?.umid || normalizedSlug || '';
let agentName = agent?.name || agent?.canonical_name || '';

// V15.1: Robust name fallback if "Unknown"
if (!agentName || agentName === 'Unknown Agent') {
  const slugParts = normalizedSlug.split('--');
  agentName = slugParts[slugParts.length - 1].replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}
const displayAuthor = (agent?.author && agent.author !== 'Unknown') ? agent.author : 'Open Source Community';

const jsonLd = agent ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": agentName,
  "description": agent.description,
  "url": `https://free2aitools.com/agent/${normalizedSlug}`,
  "applicationCategory": "AutonomousAgent",
  "operatingSystem": "Cross-platform"
} : null;
---






<EntityLayout 
  entity={agent} 
  type="agent" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={agentName}
      entityType="agent"
      entityIcon="ðŸ¤–"
      entityLabel={agent?.agent_type || 'Agent'}
      verified={agent?.verified}
      author={displayAuthor}
      description={agent?.description}
      fniScore={agent?.fni_score}
      fniPercentile={agent?.fni_percentile}
      sourceUrl={agent?.source_url}
    >
      <div slot="actions" class="flex gap-2">
         <a href={agent?.source_url} target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors shadow-sm">Visit Agent</a>
      </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
  
    {/* Zone 3: Core (Desktop/Mobile) */}
    <div slot="core-desktop">
       <UniversalCore entity={agent} type="agent" />
    </div>
 
    <div slot="core-knowledge">
       <UniversalCore entity={agent} type="agent" />
    </div>
    
    <div slot="core-similar">
        <p class="text-gray-500 italic p-4 text-center">Identifying similar autonomous agents...</p>
    </div>
  
    <div slot="core-benchmarks">
        <p class="text-gray-500 italic p-4 text-center">Benchmarks for agents are indexed under theoretical meta-analysis.</p>
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
        <AgentDeepDive agent={agent} />
    </div>

    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-purple-50 dark:bg-purple-900/20 rounded-2xl border border-purple-100 dark:border-purple-800/50">
          <h3 class="font-bold text-purple-900 dark:text-indigo-100 mb-2">Autonomous Agent</h3>
          <p class="text-xs text-purple-700 dark:text-indigo-300 leading-relaxed">This agent is indexed as a specialized autonomous entity. Features and benchmarks are derived from technical meta-analysis.</p>
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community" class="py-4">
        <p class="text-sm text-gray-500">Agent data version: {agent?._contract_version || 'V15'}</p>
    </div>
</EntityLayout>
