---
export const prerender = false;

/**
 * Agent Detail Page V1.0
 * Phase B P2: B.2 Agent Entity Expansion
 * CES Compliant: < 200 lines
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import AgentSpecs from '../../components/agent-detail/AgentSpecs.astro';
import RelatedResearch from '../../components/model-detail/RelatedResearch.astro';
import RelatedKnowledge from '../../components/model-detail/RelatedKnowledge.astro';
import AgentDeepDive from '../../components/agent-detail/AgentDeepDive.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';

import { getModelFromCache } from '../../utils/entity-cache-reader';
import { ENTITY_DEFINITIONS } from '../../data/entity-definitions';

const { slug } = Astro.params;

// Handle slug as array (from [...slug]) or string
// URL formats: /agent/github-agent--author--name OR /agent/github-agent/author/name
let normalizedSlug = '';
if (Array.isArray(slug)) {
  // If URL was /agent/github-agent/author/name, join with --
  normalizedSlug = slug.join('--').toLowerCase();
} else if (typeof slug === 'string') {
  normalizedSlug = slug.toLowerCase();
}

let agent = null;
let error = null;
let pageTitle = "AI Agent Details - Free AI Tools";
let pageDescription = "Explore this AI agent's capabilities and features.";

try {
  if (!normalizedSlug) throw new Error("No slug provided");
  
  // V12: Get agent from cache/entities/agent/ path
  const runtime = Astro.locals.runtime;
  if (runtime?.env?.R2_ASSETS) {
    const r2 = runtime.env.R2_ASSETS;
    const cacheFile = await r2.get(`cache/entities/agent/${normalizedSlug}.json`);
    if (cacheFile) {
      const cacheData = await cacheFile.json();
      agent = cacheData.entity || cacheData;
    }
  }
  // Fallback to old cache reader
  if (!agent) {
    agent = await getModelFromCache(normalizedSlug, Astro.locals);
  }

  if (agent) {
    const agentName = agent.name || agent.canonical_name || 'Unknown Agent';
    pageTitle = `${agentName} - AI Agent`;
    pageDescription = agent.description 
      ? agent.description.substring(0, 160) 
      : `Explore ${agentName} AI agent.`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
  console.error('[AgentPage] Error:', error);
}

// V15.0: Derived Use Cases and Limits
const derivedUseCases = agent ? getUseCases(agent.tags || [], '', 'agent', agent.fni_score || 0) : { goodFor: [], limits: [] };

const agentId = agent?.id || agent?.umid || normalizedSlug || '';
const agentName = agent?.name || agent?.canonical_name || 'Unknown Agent';

const jsonLd = agent ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": agentName,
  "description": agent.description,
  "url": `https://free2aitools.com/agent/${normalizedSlug}`,
  "applicationCategory": "AutonomousAgent",
  "operatingSystem": "Cross-platform"
} : null;
---






<EntityLayout 
  entity={agent} 
  type="agent" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={agentName}
      entityType="agent"
      entityIcon="ü§ñ"
      entityLabel={agent.agent_type || 'Agent'}
      verified={agent.verified}
      author={agent.author || 'Unknown'}
      description={agent.description}
      fniScore={agent.fni_score}
      fniPercentile={agent.fni_percentile}
      sourceUrl={agent.source_url}
    >
      <div slot="actions" class="flex gap-2">
         <a href={agent.source_url} target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">Visit Agent</a>
      </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
 
   {/* Zone 1 Mobile Actions */}
   <div slot="actions-mobile">
      <a href={agent.source_url} target="_blank" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold">Visit</a>
   </div>
 
   {/* Zone 3: Core (Desktop) */}
   <div slot="core-desktop" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="space-y-8">
         <RelatedKnowledge 
            tags={agent.tags || []}
            description={agent.description || ''}
         />
      </div>
      <div class="space-y-8">
         <RelatedResearch modelId={normalizedSlug} />
      </div>
   </div>
 
   {/* Zone 3: Core (Mobile Tabs) */}
   <div slot="core-knowledge">
      <RelatedKnowledge 
         tags={agent.tags || []}
         description={agent.description || ''}
      />
   </div>
   
   <div slot="core-related">
       <RelatedResearch modelId={normalizedSlug} />
   </div>
 
   <div slot="core-benchmarks">
       <p class="text-gray-500 italic p-4">No benchmarks available for this agent.</p>
   </div>
 
   {/* Zone 4: Deep Dive */}
   <div slot="deep-dive">
       <AgentDeepDive agent={agent} />
   </div>
 
   {/* Zone 5: Community */}
   <div slot="community" class="text-center py-8">
       <a href="/ranking" class="text-indigo-500 hover:underline">
          ‚Üê Browse all agents
       </a>
   </div>
</EntityLayout>
