---
export const prerender = false;

/**
 * Space Detail Page V16.5
 * Core Feature: Interactive Demo Presentation
 * Architecture: Unified 5-Zone Layout
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import SpaceDeepDive from '../../components/space-detail/SpaceDeepDive.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import { getUseCases } from '../../utils/inference.js';
import { prepareSpacePageData } from '../../utils/space-page-data.js';
import { normalizeEntitySlug } from '../../utils/entity-cache-reader-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
const normalizedSlug = normalizeEntitySlug(slugStr);

let space = null;
let error = null;
let similarEntities = [];
let tagsArray = [];
let pageTitle = "AI Demo Space - Free AI Tools";
let pageDescription = "Explore interactive AI demos and prototype applications.";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug/ID provided");
  const pageData = await prepareSpacePageData(slug, slugStr, Astro.locals);
  
  if (!pageData) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=space-not-found&id=' + encodeURIComponent(slugStr));
  }

  const { space: resolvedSpace, isFallback, repoName, similarEntities: rSimilar, tagsArray: rTags, meshRelations: resolvedMesh } = pageData;
  space = resolvedSpace;
  similarEntities = rSimilar;
  tagsArray = rTags;
  meshRelations = resolvedMesh || [];

  const displaySpaceName = space?.title || space?.name || (isFallback ? repoName : space?.canonical_name);
  pageTitle = `${displaySpaceName} - AI Demo Insight`;
  pageDescription = space?.seo_summary?.description || space?.description || `Deep dive into ${displaySpaceName} interactive space.`;

} catch (e) {
  console.error("[SpacePage] Error loading space:", e);
  error = e;
  Astro.response.status = 500;
}

if (!space && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=space-not-found');
}

const spaceName = space?.title || space?.name || 'Unknown Demo Space';
const spaceId = space?.id || normalizedSlug || '';
const displayAuthor = space?.author || 'Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = space ? getUseCases(tagsArray, '', 'space', space?.fni_score || 0) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = space ? {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": spaceName,
  "description": pageDescription,
  "url": `https://free2aitools.com/space/${slugStr}`,
  "applicationCategory": "AI Demo",
  "operatingSystem": "Web",
  "creator": {
    "@type": "Organization",
    "name": displayAuthor
  },
  "license": space?.license_spdx || space?.license
} : null;
---

  <EntityLayout
    entity={space}
    type="space"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
  >
    {/* Zone 1: Hero */}
    <EntityHeader
      slot="hero"
      name={spaceName}
      entityType="space"
      entityIcon="ðŸŽ®"
      entityLabel={space?.sdk || 'Demo Space'}
      verified={space?.verified}
      author={displayAuthor}
      lastUpdated={space?.last_updated}
      description={space?.seo_summary?.description || space?.description}
      fniScore={space?.fni_score}
      fniPercentile={space?.fni_percentile}
      fniCommentary={space?.fni_commentary}
      sourceUrl={space?.source_url}
      entityId={spaceId}
      hasImage={Boolean(space?.image_url)}
    />

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases
      slot="use-cases"
      usecases={getUseCases(space)}
    />

    {/* Zone 2: Insights Extra */}
    <div slot="insights-extra" class="mt-4 space-y-8">
       <div class="passport-block animate-slide-up" style="animation-delay: 0.2s;">
          <ModelInfoTable 
            type="space"
            model={{
              ...(space || {}),
              displayName: spaceName,
              pipeline_tag: space?.sdk || 'AI SDK'
            }} 
          />
       </div>
    </div>

    {/* Zone 3: Core (Knowledge Mesh & Relations) */}
    <div slot="core-desktop" class="space-y-16">
       <div class="p-6 bg-blue-50 dark:bg-blue-900/20 rounded-3xl border border-blue-100 dark:border-blue-800/50 animate-slide-up">
          <h3 class="font-bold text-blue-900 dark:text-blue-100 mb-2 flex items-center gap-2">
            <span>ðŸš€</span> Interactive Node
          </h3>
          <p class="text-xs text-blue-700 dark:text-blue-300 leading-relaxed">
            This entity is an experiential implementation in the AI Knowledge Mesh. 
            All technical insights are aggregated via <strong>Factory Stage 3</strong>.
          </p>
       </div>

       <UniversalCore entity={space} type="space" meshRelations={meshRelations} />
       
       <div class="cite-block animate-slide-up" style="animation-delay: 0.4s;">
          <CiteEntity 
            id={spaceId} 
            name={spaceName} 
            author={displayAuthor} 
            url={space?.source_url} 
            type="space" 
          />
       </div>
    </div>
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
       <div class="space-y-12">
          <SpaceDeepDive space={space} />
          <section class="pt-8 border-t border-gray-100 dark:border-gray-800">
             <ModelNavigation />
          </section>
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={space?.source} lastUpdated={space?.last_updated} />
    </div>
  </EntityLayout>
