---
/**
 * Space Detail Page - V12 Entity Architecture
 * HuggingFace Spaces: Interactive AI demos and applications
 */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import { getSpaceFromCache } from '../../utils/entity-cache-reader-v6.js';

const { slug } = Astro.params;

// Display slug for UI (preserve original format)
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

let space: any = null;
let relatedModels: any[] = [];
let cacheVersion = '';

try {
  // V14: Use constitutional cache reader function
  space = await getSpaceFromCache(slug, Astro.locals);
  if (space) {
    cacheVersion = space._contract_version || 'V12';
  }
} catch (e) {
  console.error('[Space Page] Cache error:', e);
}

const pageTitle = space ? `${space.title || space.name} - AI Demo` : 'Space Not Found';
const pageDescription = space?.description?.slice(0, 160) || 'Explore AI/ML demos on Free2AITools';
const canonicalUrl = `https://free2aitools.com/space/${displaySlug}`;

const jsonLd = space ? {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": space.title || space.name,
  "description": space.description,
  "url": canonicalUrl,
  "applicationCategory": "AI Demo",
  "operatingSystem": "Web",
  "creator": { "@type": "Person", "name": space.author || "Unknown" }
} : null;

const hasSpace = !!space;
const modelsUsed = space?.meta_json?.models_used || [];
---

<Layout title={pageTitle} description={pageDescription}>
  <link slot="head" rel="canonical" href={canonicalUrl} />
  {jsonLd && <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />}

  <main class="container mx-auto px-4 py-12">
    {hasSpace ? (
      <article class="max-w-4xl mx-auto">
        <nav class="mb-6 text-sm text-gray-500 dark:text-gray-400">
          <a href="/" class="hover:text-indigo-600">Home</a>
          <span class="mx-2">/</span>
          <span class="font-medium text-gray-700 dark:text-gray-300">Space</span>
        </nav>

        <header class="mb-8">
          <div class="flex items-center gap-4 mb-4">
            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
              {space.sdk || 'Demo'}
            </span>
            {space.author && (
              <span class="text-gray-500">by {space.author}</span>
            )}
          </div>
          <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
            {space.title || space.name}
          </h1>
          <p class="text-lg text-gray-600 dark:text-gray-300">
            {space.description}
          </p>
        </header>

        <div class="flex gap-4 mb-8">
          <a href={space.source_url} target="_blank" rel="noopener"
             class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
            üöÄ Open Demo
          </a>
          <div class="flex items-center gap-2 text-gray-500">
            <span>‚ù§Ô∏è {space.likes || 0}</span>
          </div>
          <ShareButtons title={space.title || space.name} description={space.description || ''} />
        </div>

        {modelsUsed.length > 0 && (
          <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Uses Models</h2>
            <div class="flex flex-wrap gap-2">
              {modelsUsed.map((model: string) => (
                <a href={`/model/${model.replace(/\//g, '--')}`}
                   class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                  {model}
                </a>
              ))}
            </div>
          </section>
        )}

        <DataFreshness version={cacheVersion} />
      </article>
    ) : (
      <div class="text-center py-20">
        <h1 class="text-4xl font-bold text-gray-300 mb-4">Space Not Found</h1>
        <p class="text-gray-500 mb-8">The space "{displaySlug}" was not found.</p>
        <a href="/" class="text-indigo-600 hover:underline">‚Üê Back to Home</a>
      </div>
    )}
  </main>
</Layout>
