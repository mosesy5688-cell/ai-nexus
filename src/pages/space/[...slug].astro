---
/**
 * Space Detail Page - V12 Entity Architecture
 * HuggingFace Spaces: Interactive AI demos and applications
 */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import DataFreshness from '../../components/common/DataFreshness.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import SpaceDeepDive from '../../components/space-detail/SpaceDeepDive.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import { fetchEntityFromR2, normalizeEntitySlug, hydrateEntity, augmentEntity } from '../../utils/entity-cache-reader-core.js';
import { getSpaceFromCache } from '../../utils/entity-cache-reader-v6.js';
import { loadSpecs, loadBenchmarks } from '../../utils/loadCachedJSON';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

// Display slug for UI (preserve original format)
const displaySlug = slugStr;

let space: any = null;
let relatedModels: any[] = [];
let cacheVersion = '';

try {
  // V15.1: getSpaceFromCache now uses unified core reader
  const result = await fetchEntityFromR2('space', slug, Astro.locals);
  space = hydrateEntity(result, 'space');

  // V15.10: Augmentation Layer for Spaces
  try {
    const [specsResult, benchResult] = await Promise.all([loadSpecs(), loadBenchmarks()]);
    const specEntry = specsResult.data?.data?.find(s => s.umid === slugStr.replace(/\//g, '-') || s.umid === slugStr.replace(/\//g, '--'));
    if (specEntry) {
      space = augmentEntity(space || {}, specEntry);
    }
  } catch (specError) {
    console.warn("[SpacePage] Spec augmentation failed:", specError.message);
  }
  
  if (space) {
    cacheVersion = space._contract_version || 'V15';
  } else {
    // V15.6 Fallback Logic (Mirroring /spaces/ route)
    const cleanSlug = slugStr.replace(/--/g, '/');
    const parts = cleanSlug.split('/');
    
    space = {
      id: `hf-space--${slugStr.replace(/\//g, '--')}`,
      name: parts.pop() || 'Unknown Space',
      author: parts.join('/') || 'huggingface',
      likes: 0,
      sdk: 'gradio',
      running_status: 'RUNNING',
      description: `Interactive AI demo: ${cleanSlug}`,
      source_url: `https://huggingface.co/spaces/${cleanSlug}`,
      embed_url: `https://huggingface.co/spaces/${cleanSlug}?embed=true`,
      _cache_source: 'fallback-ui'
    };
    cacheVersion = 'Fallback';
  }
} catch (e) {
  console.error('[Space Page] Cache error:', e);
}

const pageTitle = space ? `${space.title || space.name} - AI Demo` : 'Space Not Found';
const pageDescription = space?.description || 'Explore AI/ML demos on Free2AITools';
const canonicalUrl = `https://free2aitools.com/space/${displaySlug}`;

const jsonLd = space ? {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": space.title || space.name,
  "description": space.description,
  "url": canonicalUrl,
  "applicationCategory": "AI Demo",
  "operatingSystem": "Web",
  "creator": { "@type": "Person", "name": space.author || "Unknown" }
} : null;

const hasSpace = !!space;
const modelsUsed = space?.meta_json?.models_used || [];

// V15.0: Derived Use Cases and Limits
const tagsArray = space?.tags ? (typeof space.tags === 'string' ? JSON.parse(space.tags) : space.tags) : [];
const derivedUseCases = space ? getUseCases(tagsArray, '', 'space', space.fni_score || 0) : { goodFor: [], limits: [] };
---

<EntityLayout 
  entity={space} 
  type="space" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={space?.title || space?.name}
      entityType="space"
      entityIcon="ðŸŽ®"
      entityLabel={space?.sdk || 'Demo Space'}
      verified={false}
      author={space?.author || 'Unknown'}
      description={space?.description}
      fniScore={space?.fni_score}
      fniPercentile={space?.fni_percentile}
      sourceUrl={space?.source_url}
    >
      <div slot="actions" class="flex gap-2">
         <a href={space?.source_url} target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm">Visit Demo</a>
      </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
  
    {/* Zone 2: Technical Profile (Promoted in V16.2) */}
    <TechSpecsFull 
      slot="insights-extra"
      entity={space} 
      type="space" 
      className="bg-white/50 dark:bg-white/5 backdrop-blur-sm"
    />

    <div slot="core-desktop" class="space-y-6">
       <UniversalCore entity={space} type="space" />
    </div>
 
    <div slot="core-knowledge" class="space-y-6">
       <div class="px-4 py-2 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-800/30">
          <TechSpecsFull entity={space} type="space" />
       </div>
       <UniversalCore entity={space} type="space" />
    </div>
    
    <div slot="core-similar">
         <div class="p-8 bg-gray-50 dark:bg-gray-800 rounded-xl text-center text-gray-500 italic">
             Discovering demos with similar interaction patterns...
         </div>
    </div>
  
    <div slot="core-benchmarks">
        <p class="text-gray-500 italic p-4 text-center">Benchmark integration for interactive spaces is in preview.</p>
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive" class="space-y-12">
         <SpaceDeepDive space={space} />
    </div>

    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-blue-50 dark:bg-blue-900/20 rounded-2xl border border-blue-100 dark:border-blue-800/50">
          <h3 class="font-bold text-blue-900 dark:text-blue-100 mb-2">Interactive Space</h3>
          <p class="text-xs text-blue-700 dark:text-blue-300 leading-relaxed">This space is hosted on HuggingFace and provides a live demonstration of AI capabilities. Please follow original author's usage policies.</p>
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community" class="py-4">
        <DataFreshness version={cacheVersion} />
    </div>
</EntityLayout>
