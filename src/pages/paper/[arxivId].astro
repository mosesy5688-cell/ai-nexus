---
export const prerender = false;

/**
 * Paper Detail Page V15.0 (B.1.0 Phase 3)
 * Displays ArXiv paper info and citing models from R2 cache
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import PaperDeepDive from '../../components/paper-detail/PaperDeepDive.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import { getPaperFromCache } from '../../utils/entity-cache-reader-v6';


const { arxivId } = Astro.params;

// Validate ArXiv ID format
const isValidArxivId = arxivId && /^\d{4}\.\d{4,5}$/.test(arxivId);

let paper = null;
let pageTitle = "AI Research Paper - Free AI Tools";
let pageDescription = "Explore this AI research paper and related models.";

if (isValidArxivId) {
  try {
    // V15.1: getPaperFromCache is now robust and unified
    paper = await getPaperFromCache(arxivId, Astro.locals);
    
    // V15.6 Fallback Logic
    if (!paper) {
      paper = {
        id: `arxiv--${arxivId}`,
        title: `Research Paper: ${arxivId}`,
        arxiv_id: arxivId,
        abstract: `Open-access research publication indexed under arXiv:${arxivId}. Click 'View Source' to read the full abstract on arXiv.org.`,
        source_url: `https://arxiv.org/abs/${arxivId}`,
        authors: ['Research Community'],
        tags: ['research', 'ai'],
        _cache_source: 'fallback-ui'
      };
    }

    if (paper) {
      pageTitle = `${paper.title || `arXiv:${arxivId}`} - AI Research Paper`;
      pageDescription = paper.abstract?.slice(0, 160) || `View paper arXiv:${arxivId} and discover AI models that cite this research.`;
    }
  } catch (e) {
    console.error('[Paper] R2 cache error:', e.message);
  }
}

// V15.0: Derived Use Cases and Limits
const derivedUseCases = paper ? getUseCases(paper.tags || [], '', 'paper', paper.fni_score || 0) : { goodFor: [], limits: [] };
const authors = paper?.authors || [];
---

<EntityLayout 
  entity={paper} 
  type="paper" 
  title={pageTitle} 
  description={pageDescription}
>
  {!isValidArxivId ? (
    <div slot="hero" class="container mx-auto px-4 py-24 text-center">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-8xl font-black text-gray-100 dark:text-gray-800 absolute left-1/2 -translate-x-1/2 -top-4 -z-10 select-none">400</h1>
        <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-6">Invalid Paper ID</h2>
        <p class="text-lg text-gray-600 dark:text-gray-400 mb-10 max-w-md mx-auto">
            The ArXiv ID format should be like: <code class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded font-mono text-indigo-600">2407.21783</code>
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/" class="inline-flex items-center justify-center px-8 py-3 text-base font-bold text-white bg-indigo-600 rounded-xl shadow-lg hover:bg-indigo-700 transition-all hover:scale-105 active:scale-95">
                Go Home
            </a>
            <a href={`/search?q=${encodeURIComponent(arxivId || '')}`} class="inline-flex items-center justify-center px-8 py-3 text-base font-bold text-gray-700 bg-white border-2 border-gray-100 rounded-xl shadow-sm hover:border-indigo-100 hover:bg-indigo-50/30 transition-all dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-700">
                Search for "{arxivId}"
            </a>
        </div>
      </div>
    </div>
  ) : (
    <>
      {/* Zone 1: Hero */}
      <EntityHeader 
        slot="hero"
        name={paper?.title || `arXiv:${arxivId}`}
        entityType="paper"
        entityIcon="ðŸ“„"
        entityLabel="Research Paper"
        author={authors[0] && authors[0] !== 'Unknown' ? authors[0] : 'Research Community'}
        description={paper?.abstract}
        fniScore={paper?.fni_score}
        fniPercentile={paper?.fni_percentile}
        sourceUrl={`https://arxiv.org/abs/${arxivId}`}
      >
        <div slot="actions" class="flex gap-2">
           <a href={`https://arxiv.org/pdf/${arxivId}.pdf`} target="_blank" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 transition-colors shadow-sm">Download PDF</a>
        </div>
      </EntityHeader>

      {/* Zone 1.5: Use Cases */}
      <ZoneUseCases 
        slot="use-cases" 
        goodFor={derivedUseCases.goodFor} 
        limits={derivedUseCases.limits} 
      />

      {/* Zone 3: Core (Desktop/Mobile) */}
      <div slot="core-desktop">
         <UniversalCore entity={paper} type="paper" />
      </div>

      <div slot="core-knowledge">
         <UniversalCore entity={paper} type="paper" />
      </div>

      <div slot="core-similar">
          <p class="text-gray-500 italic p-4 text-center">Identifying similar research papers...</p>
      </div>

      <div slot="core-benchmarks">
          <p class="text-gray-500 italic p-4 text-center">No benchmarks linked to this publication.</p>
      </div>

      {/* Zone 4: Deep Dive */}
      <div slot="deep-dive" class="space-y-12">
          <TechSpecsFull entity={paper} type="paper" />
          <PaperDeepDive paper={paper} />
      </div>

      <div slot="sidebar" class="space-y-8">
         <div class="p-6 bg-rose-50 dark:bg-rose-900/20 rounded-2xl border border-rose-100 dark:border-rose-800/50">
            <h3 class="font-bold text-rose-900 dark:text-rose-100 mb-2">Academic Research</h3>
            <p class="text-xs text-rose-700 dark:text-rose-300 leading-relaxed">This paper is part of the open-access scientific literatures. Citation graphs are generated via CrossRef and Semantic Scholar.</p>
         </div>
      </div>

      <div slot="community">
          <DataFreshness timestamp={paper?.published_date} source="arXiv API" />
      </div>
    </>
  )}
</EntityLayout>
