---
export const prerender = false;

/**
 * Paper Detail Page V15.0 (B.1.0 Phase 3)
 * Displays ArXiv paper info and citing models from R2 cache
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import FullMetadata from '../../components/entity/FullMetadata.astro';
import PaperDeepDive from '../../components/paper-detail/PaperDeepDive.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import { getPaperFromCache } from '../../utils/entity-cache-reader-v6';

const { arxivId } = Astro.params;

// Validate ArXiv ID format
const isValidArxivId = arxivId && /^\d{4}\.\d{4,5}$/.test(arxivId);

let paper = null;
let pageTitle = "AI Research Paper - Free AI Tools";
let pageDescription = "Explore this AI research paper and related models.";

if (isValidArxivId) {
  try {
    paper = await getPaperFromCache(arxivId, Astro.locals);
    if (paper) {
      pageTitle = `${paper.title || `arXiv:${arxivId}`} - AI Research Paper`;
      pageDescription = paper.abstract?.slice(0, 160) || `View paper arXiv:${arxivId} and discover AI models that cite this research.`;
    }
  } catch (e) {
    console.error('[Paper] R2 cache error:', e.message);
  }
}

// V15.0: Derived Use Cases and Limits
const derivedUseCases = paper ? getUseCases(paper.tags || [], '', 'paper', paper.fni_score || 0) : { goodFor: [], limits: [] };
const authors = paper?.authors || [];
---

<EntityLayout 
  entity={paper} 
  type="paper" 
  title={pageTitle} 
  description={pageDescription}
>
  {!isValidArxivId ? (
    <div slot="hero" class="text-center py-16">
      <h1 class="text-3xl font-bold text-red-500 mb-4">Invalid Paper ID</h1>
      <p class="text-gray-600 dark:text-gray-400">
        The ArXiv ID format should be like: 2407.21783
      </p>
      <a href="/" class="mt-4 inline-block text-indigo-500 hover:underline">
        ‚Üê Back to Home
      </a>
    </div>
  ) : (
    <>
      {/* Zone 1: Hero */}
      <EntityHeader 
        slot="hero"
        name={paper?.title || `arXiv:${arxivId}`}
        entityType="paper"
        entityIcon="üìÑ"
        entityLabel="Research Paper"
        author={authors[0] || 'Unknown'}
        description={paper?.abstract}
        fniScore={paper?.fni_score}
        fniPercentile={paper?.fni_percentile}
        sourceUrl={`https://arxiv.org/abs/${arxivId}`}
      >
        <div slot="actions" class="flex gap-2">
           <a href={`https://arxiv.org/pdf/${arxivId}.pdf`} target="_blank" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 transition-colors shadow-sm">Download PDF</a>
        </div>
      </EntityHeader>

      {/* Zone 1.5: Use Cases */}
      <ZoneUseCases 
        slot="use-cases" 
        goodFor={derivedUseCases.goodFor} 
        limits={derivedUseCases.limits} 
      />

      {/* Zone 3: Core (Desktop/Mobile) */}
      <div slot="core-desktop">
         <UniversalCore entity={paper} type="paper" />
      </div>

      <div slot="core-knowledge">
         <UniversalCore entity={paper} type="paper" />
      </div>

      <div slot="core-similar">
          <p class="text-gray-500 italic p-4 text-center">Identifying similar research papers...</p>
      </div>

      <div slot="core-benchmarks">
          <p class="text-gray-500 italic p-4 text-center">No benchmarks linked to this publication.</p>
      </div>

      {/* Zone 4: Deep Dive */}
      <div slot="deep-dive">
          <PaperDeepDive paper={paper} />
      </div>

      <div slot="sidebar" class="space-y-8">
         <div class="p-6 bg-rose-50 dark:bg-rose-900/20 rounded-2xl border border-rose-100 dark:border-rose-800/50">
            <h3 class="font-bold text-rose-900 dark:text-rose-100 mb-2">Academic Research</h3>
            <p class="text-xs text-rose-700 dark:text-rose-300 leading-relaxed">This paper is part of the open-access scientific literatures. Citation graphs are generated via CrossRef and Semantic Scholar.</p>
         </div>
      </div>

      <div slot="full-metadata">
         <FullMetadata entity={paper} />
      </div>

      <div slot="community">
          <DataFreshness timestamp={paper?.published_date} source="arXiv API" />
      </div>
    </>
  )}
</EntityLayout>

