---
/**
 * Paper Detail Page - V15.0
 * ArXiv Papers: Research publications
 */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import DataFreshness from '../../components/common/DataFreshness.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import PaperDeepDive from '../../components/paper-detail/PaperDeepDive.astro';

const { slug } = Astro.params;
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

let paper: any = null;
let cacheVersion = '';

import { getPaperFromCache } from '../../utils/entity-cache-reader-v6';

try {
  // slug can be array from [...slug]
  paper = await getPaperFromCache(slug, Astro.locals);
  if (paper) {
    cacheVersion = paper._contract_version || 'V15';
  }
} catch (e) {
  console.error('[Paper Page] Cache error:', e);
}

const pageTitle = paper?.title ? `${paper.title} - AI Research Paper` : `${displaySlug} - AI Research Paper`; // Modified for robust fallback
const pageDescription = paper?.abstract?.slice(0, 160) || `Explore ${displaySlug} AI research paper.`; // Modified for robust fallback
const canonicalUrl = `https://free2aitools.com/paper/${displaySlug}`;

const jsonLd = paper ? {
  "@context": "https://schema.org",
  "@type": "ScholarlyArticle",
  "name": paper.title,
  "headline": paper.title,
  "abstract": paper.abstract,
  "url": canonicalUrl,
  "datePublished": paper.published_date,
  "author": paper.authors?.map((a: string) => ({ "@type": "Person", "name": a })) || []
} : null;

const hasPaper = !!paper;
const authors = paper?.authors || [];

// V15.0: Derived Use Cases and Limits
const derivedUseCases = paper ? getUseCases(paper.tags || [], '', 'paper', paper.fni_score || 0) : { goodFor: [], limits: [] };
---

<EntityLayout
  entity={paper}
  type="paper"
  title={pageTitle}
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={paper?.title || displaySlug}
      entityType="paper"
      entityIcon="ðŸ“„"
      entityLabel="Research Paper"
      author={authors[0] || 'Unknown'}
      description={paper?.abstract}
      fniScore={paper?.fni_score}
      fniPercentile={paper?.fni_percentile}
      sourceUrl={paper?.source_url}
    >
       <div slot="actions" class="flex gap-2">
          <a href={paper?.source_url} target="_blank" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 transition-colors shadow-sm">View on arXiv</a>
       </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
  
    {/* Zone 3: Core (Desktop) */}
    <div slot="core-desktop">
       <UniversalCore entity={paper} type="paper" />
    </div>
 
    {/* Zone 3: Core (Mobile Tabs) */}
    <div slot="core-knowledge">
         <UniversalCore entity={paper} type="paper" />
    </div>
    
    <div slot="core-similar">
         <div class="p-8 bg-gray-50 dark:bg-gray-800 rounded-xl text-center">
             <p class="text-gray-500 italic">Similarity graph for papers is being indexed.</p>
         </div>
    </div>
  
    <div slot="core-benchmarks">
        <div class="p-8 bg-gray-50 dark:bg-gray-800 rounded-xl text-center">
            <p class="text-gray-500 italic">No benchmark metadata attached to this paper.</p>
        </div>
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive" class="space-y-12">
        <TechSpecsFull entity={paper} type="paper" />
        <PaperDeepDive paper={paper} />
    </div>

    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-rose-50 dark:bg-rose-900/20 rounded-2xl border border-rose-100 dark:border-rose-800/50">
          <h3 class="font-bold text-rose-900 dark:text-rose-100 mb-2">Research Publication</h3>
          <p class="text-xs text-rose-700 dark:text-rose-300 leading-relaxed">This research paper is indexed via the ArXiv API. Citations and related models are derived through our Knowledge Graph.</p>
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2 text-sm text-gray-500">
             <span>ðŸ“„ arXiv:{paper?.arxiv_id || displaySlug}</span>
          </div>
        </div>
    </div>
</EntityLayout>
