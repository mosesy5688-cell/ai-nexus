---
export const prerender = false;

/**
 * Paper Detail Page V16.5
 * Core Feature: Knowledge Mesh Centrality
 * Architecture: Unified 5-Zone Layout
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import CiteEntity from '../../components/common/CiteEntity.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import PaperDeepDive from '../../components/paper-detail/PaperDeepDive.astro';
// V19.0: ModelNavigation removed â€” not applicable to papers
import { getUseCases } from '../../utils/inference.js';
// 2. Efficient Data Loading (Single-Stream V16.5)
import { loadEntityStreams } from '../../utils/packet-loader.js';
import { getRouteFromId } from '../../utils/mesh-routing-core.js';
import { normalizeEntitySlug } from '../../utils/entity-cache-reader-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

let paper = null;
let error = null;
let tagsArray = [];
let pageTitle = "AI Research Paper - Free AI Tools";
let pageDescription = "Explore the latest breakthroughs in AI research and architectures.";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug/ID provided");
  
  // V16.5: Usage of 3-Stream Parallel Loader
  const type = 'paper';
  // V16.5: Static Assembly Architecture
  const { entity, html, mesh, _meta } = await loadEntityStreams(type, slugStr);
  
  if (!entity || !_meta.available) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=paper-not-found&id=' + encodeURIComponent(slugStr));
  }

  const isFallback = _meta?.source === 'entities-fallback' || _meta?.source === 'fused-fallback';

  // 4. Transform & Prepare
  paper = entity;
  tagsArray = paper?.tags || [];
  meshRelations = mesh || [];

  // V16.5: Explicit HTML Assignment (Stream B Priority)
  paper.body_content = html || paper.body_content || null;
  // Deep Dive sometimes uses html_readme too
  paper.html_readme = html || paper.html_readme || null;

  // V16.96: Canonical Redirection Guard (Art.III URL Stability)
  // 1. Catch legacy /paper/arxiv/ID and redirect to clean /paper/ID
  // V16.96.9: Defensive wrap to prevent loop if data contains the prefix
  if (slugStr.startsWith('arxiv/') && !paper?.slug?.startsWith('arxiv/')) {
    const cleanSlug = slugStr.replace('arxiv/', '');
    return Astro.redirect(`/paper/${cleanSlug}`, 301);
  }

  // 2. Catch descriptive slug mismatches if paper metadata provides a better slug
  const currentNorm = normalizeEntitySlug(slugStr);
  const canonicalNorm = paper?.slug ? normalizeEntitySlug(paper.slug) : null;
  
  if (canonicalNorm && currentNorm !== canonicalNorm) {
    // Only redirect if the target doesn't lead back to the prefix loop
    const targetSlug = paper.slug.replace(/^arxiv[\/-]/, '');
    if (normalizeEntitySlug(targetSlug) !== currentNorm) {
      return Astro.redirect(`/paper/${targetSlug}`, 301);
    }
  }

  const displayPaperTitle = paper?.title || (isFallback ? (slugStr.split('/').pop() || 'Unknown Paper') : paper?.canonical_name);
  pageTitle = `${displayPaperTitle} - AI Research Insight`;
  pageDescription = paper?.seo_summary?.description || paper?.abstract || `Deep dive into ${displayPaperTitle} research paper.`;

} catch (e) {
  console.error("[PaperPage] Error loading paper:", e);
  error = e;
  // V16.8: Suppress 500 to allow "Mesh Node Building" fallback UI
  // Astro.response.status = 500;
}

if (!paper && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=paper-not-found');
}

const paperTitle = paper?.title || 'Unknown Research Paper';
const paperId = paper?.id || normalizedSlug || '';
const displayAuthor = (Array.isArray(paper?.authors) && paper.authors[0]) || paper?.author || 'Research Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = paper ? getUseCases(tagsArray, '', 'paper', paper.fni_score || 0) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = paper ? {
  "@context": "https://schema.org",
  "@type": "ScholarlyArticle",
  "name": paperTitle,
  "headline": paperTitle,
  "description": pageDescription,
  "url": `https://free2aitools.com/paper/${slugStr}`,
  "author": Array.isArray(paper.authors) ? paper.authors.map(a => ({ "@type": "Person", "name": a })) : [{ "@type": "Person", "name": displayAuthor }]
} : null;
const canonicalPath = paper ? getRouteFromId(paper.id || slugStr, 'paper') : undefined; // Changed normalizedSlug to slugStr
---

  <EntityLayout
    entity={paper}
    type="paper"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
    canonical={canonicalPath}
  >
    {/* Zone 1: Hero */}
    {paper && (
      <EntityHeader
        slot="hero"
        name={paperTitle}
        entityType="paper"
        entityIcon="ðŸ“„"
        entityLabel="Research Paper"
        verified={paper.verified}
        author={displayAuthor}
        lastUpdated={paper.last_updated || paper.published_date}
        description={paper.seo_summary?.description || paper.abstract}
        fniScore={paper.fni_score}
        fniPercentile={paper.fni_percentile}
        fniCommentary={paper.fni_commentary}
        sourceUrl={paper.source_url}
        entityId={paperId}
        hasImage={Boolean(paper.image_url)}
        trend_7d={paper.trend_7d}
      />
    )}

    {/* Zone 1.5: Use Cases */}
    {paper && (
      <ZoneUseCases
        slot="use-cases"
        usecases={getUseCases(paper)}
      />
    )}

    {/* Zone 2: Insights Extra */}
    {paper && (
      <div slot="insights-extra" class="mt-4 space-y-8">
         <div class="passport-block animate-slide-up" style="animation-delay: 0.2s;">
            <ModelInfoTable 
              type="paper"
              model={{
                ...paper,
                displayName: paperTitle,
                pipeline_tag: paper.arxiv_category || 'Research Paper'
              }} 
            />
         </div>
      </div>
    )}

    {/* Zone 3: Core (Knowledge Mesh & Relations) */}
    {paper && (
      <div slot="core-desktop" class="space-y-16">
         <UniversalCore entity={paper} type="paper" meshRelations={meshRelations} />
         
         <div class="cite-block animate-slide-up" style="animation-delay: 0.4s;">
            <CiteEntity 
              id={paperId} 
              name={paperTitle} 
              author={displayAuthor} 
              url={paper.source_url} 
              type="paper" 
            />
         </div>
      </div>
    )}
  
    {/* Zone 4: Deep Dive */}
    {paper && (
      <div slot="deep-dive">
         <div class="space-y-12">
            {paper.html_readme ? (
              <article class="prose prose-lg dark:prose-invert max-w-none prose-a:text-indigo-600 dark:prose-a:text-indigo-400 prose-img:rounded-2xl shadow-none" set:html={paper.html_readme} />
            ) : (
              <PaperDeepDive paper={paper} />
            )}
         </div>
      </div>
    )}

    {/* Zone 5: Community */}
    {paper && (
      <div slot="community">
          <AiDisclaimer source={paper.source} lastUpdated={paper.last_updated} />
      </div>
    )}
  </EntityLayout>
