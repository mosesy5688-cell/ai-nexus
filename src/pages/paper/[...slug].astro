---
/**
 * Paper Detail Page - V15.0
 * ArXiv Papers: Research publications
 */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import EntityZones from '../../components/entity/EntityZones.astro';
import RelationsPanel from '../../components/model-detail/RelationsPanel.astro';
import PaperDeepDive from '../../components/paper-detail/PaperDeepDive.astro';

const { slug } = Astro.params;
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

let paper: any = null;
let cacheVersion = '';

import { getPaperFromCache } from '../../utils/entity-cache-reader-v6';

try {
  paper = await getPaperFromCache(slug, Astro.locals);
  if (paper) {
    cacheVersion = paper._contract_version || 'V15';
  }
} catch (e) {
  console.error('[Paper Page] Cache error:', e);
}

const pageTitle = paper ? `${paper.title} - AI Research Paper` : 'Paper Not Found';
const pageDescription = paper?.abstract?.slice(0, 160) || 'Explore AI/ML research papers';
const canonicalUrl = `https://free2aitools.com/paper/${displaySlug}`;

const jsonLd = paper ? {
  "@context": "https://schema.org",
  "@type": "ScholarlyArticle",
  "name": paper.title,
  "headline": paper.title,
  "abstract": paper.abstract,
  "url": canonicalUrl,
  "datePublished": paper.published_date,
  "author": paper.authors?.map((a: string) => ({ "@type": "Person", "name": a })) || []
} : null;

const hasPaper = !!paper;
const authors = paper?.authors || [];
---

<EntityLayout
  entity={paper}
  type="paper"
  title={pageTitle}
  description={pageDescription}
  jsonld={jsonLd}
>
  {/* Zone 1: Hero */}
  <header slot="hero" class="mb-10">
    <div class="flex items-center gap-3 mb-4">
      <span class="px-3 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-md text-xs font-bold tracking-wider uppercase">
        Research Paper
      </span>
      {paper?.published_date && (
        <span class="text-sm text-gray-500">
           Published: {new Date(paper.published_date).toLocaleDateString()}
        </span>
      )}
    </div>
    <h1 class="text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-white leading-tight mb-6">
      {paper?.title}
    </h1>
    <div class="flex flex-wrap gap-2 mb-6">
      {paper?.authors?.slice(0, 5).map((author: string) => (
        <span class="text-sm text-gray-600 dark:text-gray-400">
          {author}{author !== paper.authors[4] && author !== paper.authors[paper.authors.length-1] ? ',' : ''}
        </span>
      ))}
      {paper?.authors?.length > 5 && <span class="text-sm text-gray-500">et al.</span>}
    </div>
  </header>

   {/* Zone 1 Mobile Actions */}
  <div slot="actions-mobile">
      <a href={paper?.source_url} target="_blank" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold">PDF</a>
  </div>

  {/* Zone 3: Core (Desktop) */}
  <div slot="core-desktop" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
     <div class="space-y-8">
        <RelationsPanel 
             arxivRefs={[paper?.arxiv_id || displaySlug]}
        />
     </div>
      <div class="space-y-8">
          <ShareButtons title={paper?.title} description={paper?.abstract || ''} />
      </div>
  </div>

  {/* Zone 3: Core (Mobile Tabs) */}
  <div slot="core-knowledge">
       <RelationsPanel 
          arxivRefs={[paper?.arxiv_id || displaySlug]}
       />
  </div>
  
  <div slot="core-related">
       <div class="p-8 bg-gray-50 dark:bg-gray-800 rounded-xl text-center">
           <p class="text-gray-500 italic">Similarity graph for papers is being indexed.</p>
       </div>
  </div>

  <div slot="core-benchmarks">
      <div class="p-8 bg-gray-50 dark:bg-gray-800 rounded-xl text-center">
          <p class="text-gray-500 italic">No benchmark metadata attached to this paper.</p>
      </div>
  </div>

  {/* Zone 4: Deep Dive */}
  <div slot="deep-dive">
      <PaperDeepDive paper={paper} />
  </div>

  {/* Zone 5: Community */}
  <div slot="community">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
           <span>üìÑ arXiv:{paper?.arxiv_id || displaySlug}</span>
        </div>
      </div>
      <div class="mt-8 text-center">
         <a href="/ranking" class="text-indigo-500 hover:underline">
            ‚Üê Browse all papers
         </a>
      </div>
  </div>
</EntityLayout>
