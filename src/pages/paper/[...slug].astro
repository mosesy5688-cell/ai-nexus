---
export const prerender = false;

/**
 * Paper Detail Page V16.5
 * Core Feature: Knowledge Mesh Centrality
 * Architecture: Unified 5-Zone Layout
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import PaperDeepDive from '../../components/paper-detail/PaperDeepDive.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import CiteEntity from '../../components/common/CiteEntity.astro';
import QuickCommands from '../../components/common/QuickCommands.astro';
import { getUseCases } from '../../utils/inference.js';
import { preparePaperPageData } from '../../utils/paper-page-data.js';
import { normalizeEntitySlug } from '../../utils/entity-cache-reader-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
const normalizedSlug = normalizeEntitySlug(slugStr);

let paper = null;
let error = null;
let similarEntities = [];
let tagsArray = [];
let pageTitle = "AI Research Paper - Free AI Tools";
let pageDescription = "Explore the latest breakthroughs in AI research and architectures.";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug/ID provided");
  const pageData = await preparePaperPageData(slug, slugStr, Astro.locals);
  
  if (!pageData) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=paper-not-found&id=' + encodeURIComponent(slugStr));
  }

  const { paper: resolvedPaper, isFallback, similarEntities: rSimilar, tagsArray: rTags, meshRelations: resolvedMesh } = pageData;
  paper = resolvedPaper;
  similarEntities = rSimilar;
  tagsArray = rTags;
  meshRelations = resolvedMesh || [];

  // V16.96: Canonical Redirection Guard (Art.III URL Stability)
  // 1. Catch legacy /paper/arxiv/ID and redirect to clean /paper/ID
  // V16.96.9: Defensive wrap to prevent loop if data contains the prefix
  if (slugStr.startsWith('arxiv/') && !paper?.slug?.startsWith('arxiv/')) {
    const cleanSlug = slugStr.replace('arxiv/', '');
    return Astro.redirect(`/paper/${cleanSlug}`, 301);
  }

  // 2. Catch descriptive slug mismatches if paper metadata provides a better slug
  const currentNorm = normalizeEntitySlug(slugStr);
  const canonicalNorm = paper?.slug ? normalizeEntitySlug(paper.slug) : null;
  
  if (canonicalNorm && currentNorm !== canonicalNorm) {
    // Only redirect if the target doesn't lead back to the prefix loop
    const targetSlug = paper.slug.replace(/^arxiv[\/-]/, '');
    if (normalizeEntitySlug(targetSlug) !== currentNorm) {
      return Astro.redirect(`/paper/${targetSlug}`, 301);
    }
  }

  const displayPaperTitle = paper?.title || (isFallback ? (slugStr.split('/').pop() || 'Unknown Paper') : paper?.canonical_name);
  pageTitle = `${displayPaperTitle} - AI Research Insight`;
  pageDescription = paper?.seo_summary?.description || paper?.abstract || `Deep dive into ${displayPaperTitle} research paper.`;

} catch (e) {
  console.error("[PaperPage] Error loading paper:", e);
  error = e;
  Astro.response.status = 500;
}

if (!paper && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=paper-not-found');
}

const paperTitle = paper?.title || 'Unknown Research Paper';
const paperId = paper?.id || normalizedSlug || '';
const displayAuthor = (Array.isArray(paper?.authors) && paper.authors[0]) || paper?.author || 'Research Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = paper ? getUseCases(tagsArray, '', 'paper', paper.fni_score || 0) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = paper ? {
  "@context": "https://schema.org",
  "@type": "ScholarlyArticle",
  "name": paperTitle,
  "headline": paperTitle,
  "description": pageDescription,
  "url": `https://free2aitools.com/paper/${slugStr}`,
  "author": Array.isArray(paper.authors) ? paper.authors.map(a => ({ "@type": "Person", "name": a })) : [{ "@type": "Person", "name": displayAuthor }]
} : null;
---

  <EntityLayout
    entity={paper}
    type="paper"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
  >
    {/* Zone 1: Hero */}
    <EntityHeader
      slot="hero"
      name={paperTitle}
      entityType="paper"
      entityIcon="ðŸ“„"
      entityLabel="Research Paper"
      verified={paper?.verified}
      author={displayAuthor}
      description={paper?.seo_summary?.description || paper?.abstract}
      fniScore={paper?.fni_score}
      fniPercentile={paper?.fni_percentile}
      fniCommentary={paper?.fni_commentary}
      sourceUrl={paper?.source_url}
      entityId={paperId}
      hasImage={Boolean(paper?.image_url)}
    />

    {/* Zone 1.5: Use Cases */}

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases
      slot="use-cases"
      goodFor={derivedUseCases.goodFor}
      limits={derivedUseCases.limits}
    />

    {/* Zone 2: Insights Extra */}
    <div slot="insights-extra" class="mt-4 space-y-4">
       <QuickCommands entity={paper} type="paper" />
       <div class="px-4 py-2 bg-rose-50 dark:bg-rose-900/10 rounded-xl border border-rose-100 dark:border-rose-800/30">
          <TechSpecsFull entity={paper} type="paper" />
       </div>
    </div>

    {/* Zone 3: Core */}
    <div slot="core-desktop">
       <UniversalCore entity={paper} type="paper" meshRelations={meshRelations} />
    </div>

    <div slot="core-knowledge">
       <UniversalCore entity={paper} type="paper" meshRelations={meshRelations} />
    </div>
    
    <div slot="core-similar">
        {similarEntities.length > 0 ? (
           <ModelCarousel models={similarEntities} />
        ) : (
           <p class="text-gray-500 italic p-4 text-center">Identifying citing models and related research...</p>
        )}
    </div>
  
    <div slot="core-benchmarks">
        <p class="text-gray-500 italic p-4 text-center">Academic benchmark results for this paper are indexed in the neural mesh.</p>
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
       <div class="space-y-12">
          <PaperDeepDive paper={paper} />
          <section class="pt-8 border-t border-gray-100 dark:border-gray-800">
             <ModelNavigation 
                pipelineTag={paper?.arxiv_category || 'research-paper'}
             />
          </section>
       </div>
    </div>

    {/* Zone 5: Sidebar */}
    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-rose-50 dark:bg-rose-900/20 rounded-2xl border border-rose-100 dark:border-rose-800/50">
          <h3 class="font-bold text-rose-900 dark:text-rose-100 mb-2 flex items-center gap-2">
            <span>ðŸ“„</span> Academic Node
          </h3>
          <p class="text-xs text-rose-700 dark:text-rose-300 leading-relaxed">
            This entity represents a theoretical baseline in the AI Knowledge Mesh. 
            Citations and implementations are mapped via <strong>Factory Stage 3 Aggregator</strong>.
          </p>
       </div>

       <ModelInfoTable 
         type="paper"
         model={{
           ...(paper || {}),
           displayName: paperTitle,
           pipeline_tag: paper?.arxiv_category || 'Research Paper'
         }} 
       />
       
       <ShareButtons 
          url={`https://free2aitools.com/paper/${slugStr}`} 
          title={`${paperTitle} - AI Research Analysis`} 
       />

       <CiteEntity 
         id={paperId} 
         name={paperTitle} 
         author={displayAuthor} 
         url={paper.source_url} 
         type="paper" 
       />
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={paper?.source} lastUpdated={paper?.last_updated} />
    </div>
  </EntityLayout>
