---
export const prerender = false;

/**
 * Dataset Detail Page V6.2
 * Constitution V6.1.1 Universal Entity Protocol
 * Compliant with CES V5.1.2 Anti-Monolith (<250 lines)
 */

import Layout from '../../layouts/Layout.astro';
import DatasetHero from '../../components/dataset/DatasetHero.astro';

const { slug } = Astro.params;

let dataset = null;
let error = null;
let pageTitle = "HuggingFace Dataset - Free AI Tools";
let pageDescription = "Explore this dataset for AI and machine learning.";

try {
  if (!slug) throw new Error("No slug provided");
  
  // V6.2: Fetch dataset from R2 cache
  // For now, construct from slug (will be replaced with cache reader)
  const datasetId = slug?.replace(/--/g, '/');
  
  // Mock dataset data for initial deployment
  // TODO: Implement getDatasetFromCache similar to getModelFromCache
  dataset = {
    id: `hf-dataset--${slug}`,
    name: datasetId?.split('/').pop() || 'Unknown Dataset',
    author: datasetId?.split('/')[0] || 'unknown',
    likes: 0,
    downloads: 0,
    description: `AI/ML dataset: ${datasetId}`,
    source_url: `https://huggingface.co/datasets/${datasetId}`,
    viewer_url: `https://huggingface.co/datasets/${datasetId}/viewer`
  };

  if (dataset) {
    pageTitle = `${dataset.name} - AI Dataset`;
    pageDescription = dataset.description?.substring(0, 160) || `Explore ${dataset.name} dataset.`;
  }
} catch (e) {
  console.error("Error loading dataset:", e);
  error = e;
  Astro.response.status = 500;
}

if (!dataset && !error) {
  Astro.response.status = 404;
  Astro.response.headers.set('Cache-Control', 'no-store, no-cache, max-age=0');
}
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="dataset-detail-page bg-gray-50 dark:bg-gray-900 min-h-screen">
    {error ? (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-red-50 text-red-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Error Loading Page</h1>
          <p class="text-gray-600 mb-6">{error.message}</p>
          <a href="/explore" class="inline-block bg-emerald-600 text-white font-bold py-2 px-4 rounded hover:bg-emerald-700">Browse Datasets</a>
        </div>
      </div>
    ) : dataset ? (
      <article class="container mx-auto px-4 py-8 max-w-7xl">
        <DatasetHero
          name={dataset.name}
          description={dataset.description}
          author={dataset.author}
          likes={dataset.likes}
          downloads={dataset.downloads}
          links={{
            source_url: dataset.source_url,
            viewer_url: dataset.viewer_url
          }}
        />

        <!-- Dataset Preview Section (Placeholder) -->
        <section class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Dataset Preview</h2>
          <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 text-center">
            <p class="text-gray-600 dark:text-gray-400 mb-4">
              View the full dataset on HuggingFace for interactive exploration.
            </p>
            <a 
              href={dataset.viewer_url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-5 py-3 rounded-lg transition-all"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              Open Dataset Viewer
            </a>
          </div>
        </section>

        <!-- Back Navigation -->
        <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
          <a 
            href="/explore?type=dataset"
            class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Browse More Datasets
          </a>
        </div>
      </article>
    ) : (
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="bg-yellow-50 text-yellow-800 p-8 rounded-lg max-w-2xl mx-auto">
          <h1 class="text-3xl font-bold mb-4">Dataset Not Found</h1>
          <p class="text-gray-600 mb-6">The dataset you are looking for does not exist or has been removed.</p>
          <a href="/explore" class="inline-block bg-emerald-600 text-white font-bold py-2 px-4 rounded hover:bg-emerald-700">Browse Datasets</a>
        </div>
      </div>
    )}
  </main>
</Layout>

<style>
  .dataset-detail-page {
    padding-top: 1rem;
  }
</style>
