---
export const prerender = false;

/**
 * Dataset Detail Page V16.5
 * Core Feature: Zero-Limit Data Transparency
 * Architecture: Unified 5-Zone Layout
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import CiteEntity from '../../components/common/CiteEntity.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import DatasetDeepDive from '../../components/dataset/DatasetDeepDive.astro';
// V19.0: ModelNavigation removed â€” not applicable to datasets
import { getUseCases } from '../../utils/inference.js';
// 2. Efficient Data Loading (Single-Stream V16.5)
import { loadEntityPack } from '../../utils/packet-loader.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

let dataset = null;
let error = null;
let tagsArray = [];
let pageTitle = "AI Dataset Details - Free AI Tools";
let pageDescription = "Explore high-quality datasets for AI training and evaluation.";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug/ID provided");
  
  // V16.5: Usage of Prefix-Aware Single-Stream Loader
  const pack = await loadEntityPack('dataset', slugStr);
  
  if (!pack.entity || !pack._meta.available) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=dataset-not-found&id=' + encodeURIComponent(slugStr));
  }

  const { entity: resolvedDataset, html: resolvedHtml, mesh: resolvedMesh } = pack;

  dataset = resolvedDataset;
  tagsArray = dataset?.tags || [];
  meshRelations = resolvedMesh || [];

  // V16.5: Explicit HTML Assignment (Fused Priority)
  dataset.body_content = resolvedHtml || dataset.body_content || null;
  dataset.html_readme = resolvedHtml || dataset.html_readme || null; // Datasets sometimes use html_readme too

  const displayDatasetName = dataset?.name || dataset?.title || dataset?.canonical_name || 'Unknown Dataset';
  pageTitle = `${displayDatasetName} - AI Dataset Analysis`;
  pageDescription = dataset?.seo_summary?.description || dataset?.description || `Deep dive into ${displayDatasetName} dataset.`;

} catch (e) {
  console.error("[DatasetPage] Error loading dataset:", e);
  error = e;
  Astro.response.status = 500;
}

if (!dataset && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=dataset-not-found');
}

const datasetName = dataset?.name || dataset?.title || 'Unknown Dataset';
const datasetId = dataset?.id || normalizedSlug || '';
const displayAuthor = dataset?.author || 'Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = dataset ? getUseCases(tagsArray, '', 'dataset', dataset.fni_score || 0) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = dataset ? {
  "@context": "https://schema.org",
  "@type": "Dataset",
  "name": datasetName,
  "description": pageDescription,
  "url": `https://free2aitools.com/dataset/${slugStr}`,
  "creator": {
    "@type": "Organization",
    "name": displayAuthor
  },
  "license": dataset?.license_spdx || dataset?.license
} : null;
---

  <EntityLayout
    entity={dataset}
    type="dataset"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
  >
    {/* Zone 1: Hero */}
    <EntityHeader
      slot="hero"
      name={datasetName}
      entityType="dataset"
      entityIcon="ðŸ“Š"
      entityLabel="Dataset"
      verified={dataset?.verified}
      author={displayAuthor}
      lastUpdated={dataset?.last_updated}
      description={dataset?.seo_summary?.description || dataset?.description}
      fniScore={dataset?.fni_score}
      fniPercentile={dataset?.fni_percentile}
      fniCommentary={dataset?.fni_commentary}
      sourceUrl={dataset?.source_url}
      entityId={datasetId}
      hasImage={Boolean(dataset?.image_url)}
    />

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases
      slot="use-cases"
      usecases={getUseCases(dataset)}
    />

    {/* Zone 2: Insights Extra */}
    <div slot="insights-extra" class="mt-4 space-y-8">
       <div class="passport-block animate-slide-up" style="animation-delay: 0.2s;">
          <ModelInfoTable 
            type="dataset"
            model={{
              ...(dataset || {}),
              displayName: datasetName,
              pipeline_tag: dataset?.format || 'Dataset'
            }} 
          />
       </div>
    </div>

    {/* Zone 3: Core (Knowledge Mesh & Relations) */}
    <div slot="core-desktop" class="space-y-16">
       <UniversalCore entity={dataset} type="dataset" meshRelations={meshRelations} />
       
       <div class="cite-block animate-slide-up" style="animation-delay: 0.4s;">
          <CiteEntity 
            id={datasetId} 
            name={datasetName} 
            author={displayAuthor} 
            url={dataset?.source_url} 
            type="dataset" 
          />
       </div>
       
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive">
       <div class="space-y-12">
          {dataset?.body_content ? (
            <article class="prose prose-lg dark:prose-invert max-w-none" set:html={dataset.body_content} />
          ) : (
            <DatasetDeepDive dataset={dataset} />
          )}
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={dataset?.source} lastUpdated={dataset?.last_updated} />
    </div>
  </EntityLayout>
