---
/** Dataset Detail Page - V5.0 Entity-First (Art.X-Entity, D1=0) */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import ModelCard from '../../components/ModelCard.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import EntityZones from '../../components/entity/EntityZones.astro';
import { getDatasetFromCache } from '../../utils/entity-cache-reader-v6.js';

// Get slug from URL
const { slug } = Astro.params;

// Display slug for UI (preserve original format)
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

// V4.9 Constitution: Fetch from L8 cache (R2), NOT D1
let dataset: any = null;
let recommendedModels: any[] = [];
let cacheVersion = '';

try {
  // V14: Use constitutional cache reader function
  dataset = await getDatasetFromCache(slug, Astro.locals);
  if (dataset) {
    cacheVersion = dataset._contract_version || 'unknown';
    
    // Fetch recommended models (models that use this dataset)
    const r2 = Astro.locals.runtime?.env?.R2_ASSETS;
    if (r2) {
      const modelsFile = await r2.get('cache/trending_weekly.json');
      if (modelsFile) {
        const modelsData = await modelsFile.json();
        const datasetTags = dataset.tags ? (typeof dataset.tags === 'string' ? JSON.parse(dataset.tags) : dataset.tags) : [];
        recommendedModels = (modelsData.data || [])
          .filter((m: any) => {
            const modelTags = Array.isArray(m.tags) ? m.tags : [];
            return datasetTags.some((dt: string) => modelTags.some((mt: string) => 
              mt.toLowerCase().includes(dt.toLowerCase()) || dt.toLowerCase().includes(mt.toLowerCase())));
          }).slice(0, 6);
      }
    }
  }
} catch (e) { console.error('[Dataset Page] Cache error:', e); }

const pageTitle = dataset ? `${dataset.name} - AI Dataset` : 'Dataset Not Found';
const pageDescription = dataset?.description?.slice(0, 160) || 'Browse AI/ML datasets';
const canonicalUrl = `https://free2aitools.com/dataset/${displaySlug}`;

// JSON-LD for SEO
const jsonLd = dataset ? {
  "@context": "https://schema.org",
  "@type": "Dataset",
  "name": dataset.name,
  "description": dataset.description,
  "url": canonicalUrl,
  "creator": {
    "@type": "Organization",
    "name": dataset.author || "Unknown"
  },
  "dateModified": dataset.last_updated,
  "license": dataset.license_spdx || undefined
} : null;

const hasDataset = !!dataset;
const hasRecommendedModels = recommendedModels.length > 0;
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Canonical URL -->
  <link slot="head" rel="canonical" href={canonicalUrl} />
  
  <!-- JSON-LD -->
  {jsonLd && <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />}

  <main class="container mx-auto px-4 py-12">
    {hasDataset ? (
      <article class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm text-gray-500 dark:text-gray-400" aria-label="Breadcrumb">
          <a href="/" class="hover:text-indigo-600">Home</a>
          <span class="mx-2">â†’</span>
          <a href="/ranking?type=dataset" class="hover:text-indigo-600">Datasets</a>
          <span class="mx-2">â†’</span>
          <span class="text-gray-700 dark:text-gray-300">{dataset.name}</span>
        </nav>

        <!-- Header -->
        <header class="mb-8">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-3xl" role="img" aria-label="Dataset">ğŸ“Š</span>
            <span class="px-2 py-1 text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded">
              DATASET
            </span>
          </div>
          <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-4">
            {dataset.name}
          </h1>
          <p class="text-gray-600 dark:text-gray-400 text-lg">
            {dataset.description || 'No description available'}
          </p>
          <DataFreshness timestamp={dataset.last_updated} source={`L8 v${cacheVersion}`} />
        </header>

        <!-- V15.0: Entity Metrics Zone -->
        <EntityZones entityType="dataset" entity={dataset} />

        <!-- Zone 1.5: Use Cases (Derived from Tags) -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">ğŸš€ Use Cases</h2>
            <div class="flex flex-wrap gap-3">
                 {(dataset.tags ? JSON.parse(dataset.tags) : [])
                    .filter((t: string) => t.includes('classification') || t.includes('generation') || t.includes('nlp') || t.includes('vision'))
                    .map((tag: string) => (
                    <span class="px-3 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-200 rounded-full text-sm">
                        {tag.replace(/-/g, ' ')}
                    </span>
                 ))}
                 <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-full text-sm">
                    Model Training
                 </span>
                 <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-full text-sm">
                    Evaluation Benchmark
                 </span>
            </div>
        </section>

        <!-- Zone 2: Quick Insights (Structure & Stats) -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
            <h2 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">ğŸ“‹ Quick Insights</h2>
            <dl class="space-y-4">
               <div class="flex justify-between items-center border-b border-gray-100 dark:border-gray-700 pb-3">
                 <dt class="text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <span>ğŸ“</span> Size
                 </dt>
                 <dd class="font-medium text-gray-900 dark:text-white">
                    {dataset.size_categories ? dataset.size_categories[0] : 'Unknown'}
                 </dd>
               </div>
               <div class="flex justify-between items-center border-b border-gray-100 dark:border-gray-700 pb-3">
                 <dt class="text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <span>ğŸ—‚ï¸</span> Structure
                 </dt>
                 <dd class="font-medium text-gray-900 dark:text-white">
                    {dataset.task_categories ? dataset.task_categories[0] : 'General'}
                 </dd>
               </div>
               <div class="flex justify-between items-center border-b border-gray-100 dark:border-gray-700 pb-3">
                 <dt class="text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <span>ğŸŒ</span> Language
                 </dt>
                 <dd class="font-medium text-gray-900 dark:text-white">
                    {dataset.language ? (Array.isArray(dataset.language) ? dataset.language[0] : dataset.language) : 'English'}
                 </dd>
               </div>
               <div class="flex justify-between items-center">
                 <dt class="text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <span>âš–ï¸</span> License
                 </dt>
                 <dd class="font-medium text-gray-900 dark:text-white">
                    {dataset.license_spdx || dataset.license || 'Unknown'}
                 </dd>
               </div>
            </dl>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
            <h2 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">ğŸ·ï¸ Tags & Categories</h2>
            <div class="flex flex-wrap gap-2">
              {(dataset.tags ? JSON.parse(dataset.tags) : []).slice(0, 15).map((tag: string) => (
                <a 
                  href={`/ranking?type=dataset&tag=${encodeURIComponent(tag)}`}
                  class="px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors"
                >
                  {tag}
                </a>
              ))}
            </div>
             {dataset.source_url && (
                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                  <a 
                    href={dataset.source_url} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    class="flex items-center justify-center gap-2 w-full px-4 py-2 bg-gray-900 dark:bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium"
                  >
                    <span>View Data Source</span>
                    <span role="img">â†—ï¸</span>
                  </a>
                </div>
              )}
          </div>
        </section>

        <!-- Zone 4: Deep Dive (Schema) -->
        <section class="mb-12">
             <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
                <span>ğŸ§¬</span> Data Structure
             </h2>
             <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-6 border border-gray-200 dark:border-gray-700 font-mono text-sm overflow-x-auto">
                <p class="text-gray-500 mb-4">// Inferred Schema Overview</p>
                <div class="space-y-2 text-gray-700 dark:text-gray-300">
                    <div><span class="text-purple-600 dark:text-purple-400">feature</span>: <span class="text-green-600 dark:text-green-400">string</span></div>
                    <div><span class="text-purple-600 dark:text-purple-400">label</span>: <span class="text-green-600 dark:text-green-400">int64</span> (Class ID)</div>
                    <div><span class="text-purple-600 dark:text-purple-400">split</span>: <span class="text-blue-600 dark:text-blue-400">"train" | "test" | "validation"</span></div>
                    {dataset.configs && (
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-800">
                            <span class="text-gray-500">// Available Configs</span><br/>
                            {JSON.parse(dataset.configs || '[]').map((c: any) => (
                                <span class="inline-block mr-2 px-2 py-1 bg-gray-200 dark:bg-gray-800 rounded text-xs">{c.config_name || c}</span>
                            ))}
                        </div>
                    )}
                </div>
             </div>
        </section>

        <!-- V5.0: Recommended Models Section (Dataset â†’ Models) -->
        <section class="mb-12">
          <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
            <span>ğŸ¤–</span> Recommended Models
            <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(trained on similar data)</span>
          </h2>
          
          {hasRecommendedModels ? (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {recommendedModels.map(model => (
                <ModelCard model={model} />
              ))}
            </div>
          ) : (
            <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-8 text-center">
              <p class="text-gray-500 dark:text-gray-400 mb-4">
                No recommended models available yet.
              </p>
              <a 
                href="/models" 
                class="text-indigo-600 hover:underline"
              >
                Browse all models â†’
              </a>
            </div>
          )}
        </section>

        <!-- Next Step Navigation (V5.0: Related Entities Full Chain) -->
        <section class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-8">
          <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
            <span>ğŸš€</span> What's Next?
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <a href="/models" 
               class="group p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-gray-700">
              <div class="text-3xl mb-3">ğŸ¤–</div>
              <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-emerald-600">Find Compatible Models</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Discover models trained on this dataset
              </p>
            </a>

            <a href="/ranking" 
               class="group p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-gray-700">
              <div class="text-3xl mb-3">ğŸ“ˆ</div>
              <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-emerald-600">View Benchmarks</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Compare model performance on standard tests
              </p>
            </a>

            <a href="/knowledge" 
               class="group p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-gray-700">
              <div class="text-3xl mb-3">ğŸ“š</div>
              <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-emerald-600">Learn More</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Understand AI concepts and best practices
              </p>
            </a>
          </div>
        </section>
      </article>
    ) : (
      <div class="text-center py-20">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full mb-6">
          <span class="text-3xl">â³</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          Dataset: {displaySlug}
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400 mb-8 max-w-lg mx-auto">
          This dataset is currently being indexed or the details are not yet available in our cache.
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                Request Indexing Priority
            </button>
            <a href="/datasets" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium">
                â† Return to Catalog
            </a>
        </div>
        
        <p class="mt-8 text-xs text-gray-400">
            ID: {displaySlug} â€¢ Status: Pending Ingestion
        </p>
      </div>
    )}
  </main>
</Layout>
