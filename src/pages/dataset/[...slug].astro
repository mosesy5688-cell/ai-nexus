---
/** Dataset Detail Page - V5.0 Entity-First (Art.X-Entity, D1=0) */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import ModelCard from '../../components/ModelCard.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import DatasetUseCases from '../../components/dataset/DatasetUseCases.astro';
import DatasetQuickInsights from '../../components/dataset/DatasetQuickInsights.astro';
import DatasetSchema from '../../components/dataset/DatasetSchema.astro';
import DatasetDeepDive from '../../components/dataset/DatasetDeepDive.astro';

import EntityZones from '../../components/entity/EntityZones.astro';
import { getDatasetFromCache } from '../../utils/entity-cache-reader-v6';
// Get slug from URL
const { slug } = Astro.params;

// Display slug for UI (preserve original format)
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

// V4.9 Constitution: Fetch from L8 cache (R2), NOT D1
let dataset: any = null;
let recommendedModels: any[] = [];
let cacheVersion = '';
try {
  // V14: Use constitutional cache reader function
  dataset = await getDatasetFromCache(slug, Astro.locals);
  if (dataset) {
    cacheVersion = dataset._contract_version || 'unknown';
    
    // Fetch recommended models (models that use this dataset)
    const r2 = Astro.locals.runtime?.env?.R2_ASSETS;
    if (r2) {
      const modelsFile = await r2.get('cache/trending_weekly.json');
      if (modelsFile) {
        const modelsData = await modelsFile.json();
        const datasetTags = dataset.tags ? (typeof dataset.tags === 'string' ? JSON.parse(dataset.tags) : dataset.tags) : [];
        recommendedModels = (modelsData.data || [])
          .filter((m: any) => {
            const modelTags = Array.isArray(m.tags) ? m.tags : [];
            return datasetTags.some((dt: string) => modelTags.some((mt: string) => 
              mt.toLowerCase().includes(dt.toLowerCase()) || dt.toLowerCase().includes(mt.toLowerCase())));
          }).slice(0, 6);
      }
    }
  }
} catch (e) { console.error('[Dataset Page] Cache error:', e); }

const pageTitle = dataset ? `${dataset.name} - AI Dataset` : 'Dataset Not Found';
const pageDescription = dataset?.description?.slice(0, 160) || 'Browse AI/ML datasets';
const canonicalUrl = `https://free2aitools.com/dataset/${displaySlug}`;

// JSON-LD for SEO
const jsonLd = dataset ? {
  "@context": "https://schema.org",
  "@type": "Dataset",
  "name": dataset.name,
  "description": dataset.description,
  "url": canonicalUrl,
  "creator": {
    "@type": "Organization",
    "name": dataset.author || "Unknown"
  },
  "dateModified": dataset.last_updated,
  "license": dataset.license_spdx || undefined
} : null;

const hasDataset = !!dataset;
const hasRecommendedModels = recommendedModels.length > 0;
---




<EntityLayout 
  entity={dataset} 
  type="dataset" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
 {dataset && (
  <Fragment>
   {/* Zone 1: Hero */}
   <header slot="hero" class="mb-8">
     <div class="flex items-center gap-3 mb-2">
       <span class="text-3xl" role="img" aria-label="Dataset">üìä</span>
       <span class="px-2 py-1 text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded">
         DATASET
       </span>
     </div>
     <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-4">
       {dataset.name}
     </h1>
     <p class="text-gray-600 dark:text-gray-400 text-lg">
       {dataset.description || 'No description available'}
     </p>
   </header>
 
    {/* Zone 1 Mobile Actions */}
   <div slot="actions-mobile">
       <button class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold">Download</button>
   </div>
 
   {/* Zone 3: Core (Desktop) */}
   <div slot="core-desktop" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* Reuse Relations Logic manually since space object is simple */}
       <div class="space-y-8">
           <section>
             <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white flex items-center gap-2">
               <span>ü§ñ</span> Trained Models
             </h2>
              {hasRecommendedModels ? (
                 <div class="flex flex-col gap-4">
                   {recommendedModels.slice(0, 3).map(model => (
                     <ModelCard model={model} />
                   ))}
                 </div>
               ) : (
                 <p class="text-gray-500 italic">No linked models found.</p>
               )}
           </section>
       </div>
       <div class="space-y-8">
            <DatasetSchema dataset={dataset} />
       </div>
   </div>
 
   {/* Zone 3: Core (Mobile Tabs) */}
   <div slot="core-knowledge">
        <DatasetSchema dataset={dataset} />
   </div>
   
   <div slot="core-related">
        {hasRecommendedModels ? (
           <div class="flex flex-col gap-4">
             {recommendedModels.map(model => (
               <ModelCard model={model} />
             ))}
           </div>
         ) : (
           <p class="text-gray-500 italic">No linked models found.</p>
         )}
   </div>
 
   <div slot="core-benchmarks">
       <p class="text-gray-500 italic p-4">No benchmarks available.</p>
   </div>
 
   {/* Zone 4: Deep Dive */}
   <div slot="deep-dive">
        <DatasetDeepDive dataset={dataset} />
   </div>
 
   {/* Zone 5: Community */}
   <div slot="community">
       <DataFreshness timestamp={dataset.last_updated} source={`L8 v${cacheVersion}`} />
       <div class="mt-8 text-center">
          <a href="/ranking?type=dataset" class="text-indigo-500 hover:underline">
             ‚Üê Browse all datasets
          </a>
       </div>
   </div>
  </Fragment>
 )}
</EntityLayout>

