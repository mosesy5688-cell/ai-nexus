---
/** Dataset Detail Page - V5.0 Entity-First (Art.X-Entity, D1=0) */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import ModelCard from '../../components/ModelCard.astro';
import DataFreshness from '../../components/common/DataFreshness.astro';
import DatasetSchema from '../../components/dataset/DatasetSchema.astro';
import DatasetDeepDive from '../../components/dataset/DatasetDeepDive.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';

import EntityZones from '../../components/entity/EntityZones.astro';
import { getDatasetFromCache } from '../../utils/entity-cache-reader-v6';
// Get slug from URL
const { slug } = Astro.params;

// Display slug for UI (preserve original format)
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

// V4.9 Constitution: Fetch from L8 cache (R2), NOT D1
let dataset: any = null;
let recommendedModels: any[] = [];
let cacheVersion = '';
try {
  // V14: Use constitutional cache reader function
  dataset = await getDatasetFromCache(slug, Astro.locals);
  if (dataset) {
    cacheVersion = dataset._contract_version || 'unknown';
    
    // Fetch recommended models (models that use this dataset)
    const r2 = Astro.locals.runtime?.env?.R2_ASSETS;
    if (r2) {
      const modelsFile = await r2.get('cache/trending_weekly.json');
      if (modelsFile) {
        const modelsData = await modelsFile.json();
        const datasetTags = dataset.tags ? (typeof dataset.tags === 'string' ? JSON.parse(dataset.tags) : dataset.tags) : [];
        recommendedModels = (modelsData.data || [])
          .filter((m: any) => {
            const modelTags = Array.isArray(m.tags) ? m.tags : [];
            return datasetTags.some((dt: string) => modelTags.some((mt: string) => 
              mt.toLowerCase().includes(dt.toLowerCase()) || dt.toLowerCase().includes(mt.toLowerCase())));
          }).slice(0, 6);
      }
    }
  }
} catch (e) { console.error('[Dataset Page] Cache error:', e); }

const pageTitle = dataset?.name ? `${dataset.name} - AI Dataset` : (dataset?.title ? `${dataset.title} - AI Dataset` : `${displaySlug} - AI Dataset`);
const pageDescription = dataset?.description?.slice(0, 160) || `Explore ${displaySlug} AI dataset on Free2AITools.`;
const canonicalUrl = `https://free2aitools.com/dataset/${displaySlug}`;

// JSON-LD for SEO
const jsonLd = dataset ? {
  "@context": "https://schema.org",
  "@type": "Dataset",
  "name": dataset.name || dataset.title || displaySlug,
  "description": dataset.description,
  "url": canonicalUrl,
  "creator": {
    "@type": "Organization",
    "name": dataset.author || "Unknown"
  },
  "dateModified": dataset.last_updated,
  "license": dataset.license_spdx || undefined
} : null;

const hasDataset = !!dataset;
const hasRecommendedModels = recommendedModels.length > 0;

// V15.0: Derived Use Cases and Limits
const tagsArray = dataset?.tags ? (typeof dataset.tags === 'string' ? JSON.parse(dataset.tags) : dataset.tags) : [];
const derivedUseCases = dataset ? getUseCases(tagsArray, '', 'dataset', dataset.fni_score || 0) : { goodFor: [], limits: [] };
---


<EntityLayout 
  entity={dataset} 
  type="dataset" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={dataset?.name || dataset?.title || displaySlug}
      entityType="dataset"
      entityIcon="ðŸ“Š"
      entityLabel="Dataset"
      verified={false}
      author={dataset?.author || 'Unknown'}
      description={dataset?.description}
      fniScore={dataset?.fni_score}
      fniPercentile={dataset?.fni_percentile}
      sourceUrl={dataset?.source_url}
    >
      <div slot="actions" class="flex gap-2">
         <a href={dataset?.source_url} target="_blank" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-colors shadow-sm">Download Dataset</a>
      </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
  
    {/* Zone 3: Core (Desktop/Mobile) */}
    <div slot="core-desktop">
       <UniversalCore entity={dataset} type="dataset" />
    </div>
 
    {/* Zone 3: Core (Mobile Tabs) */}
    <div slot="core-knowledge">
         <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="font-bold mb-2">Capabilities</h3>
            <ul class="space-y-2">
               {derivedUseCases.goodFor.map(useCase => (
                 <li class="text-sm flex items-center gap-2">âœ… {useCase}</li>
               ))}
            </ul>
         </div>
    </div>
    
    <div slot="core-similar">
         {hasRecommendedModels ? (
            <div class="space-y-4">
              {recommendedModels.map(model => (
                <ModelCard model={model} />
              ))}
            </div>
          ) : (
            <p class="text-gray-500 italic p-4 text-center">Finding datasets with similar distribution...</p>
          )}
    </div>
  
    <div slot="core-benchmarks">
         <div class="p-8 bg-gray-50 dark:bg-gray-800 rounded-xl text-center">
             <p class="text-gray-500 italic">No benchmark correlations for this dataset.</p>
         </div>
    </div>
  
    <div slot="deep-dive" class="space-y-12">
         <TechSpecsFull entity={dataset} type="dataset" />
         <DatasetDeepDive dataset={dataset} />
    </div>

    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl border border-indigo-100 dark:border-indigo-800/50">
          <h3 class="font-bold text-indigo-900 dark:text-indigo-100 mb-2">Dataset Information</h3>
          <p class="text-xs text-indigo-700 dark:text-indigo-300 leading-relaxed">This dataset is part of the open-source AI ecosystem. License and usage terms are governed by the original author.</p>
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <DataFreshness timestamp={dataset?.last_updated} source={`L8 v${cacheVersion}`} />
    </div>
</EntityLayout>
