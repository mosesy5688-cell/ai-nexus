---
export const prerender = false;

/**
 * Dataset Detail Page V16.8.14
 * High-Fidelity Emergency Reconstruction
 * Architecture: Unified 5-Zone High-Density Layout
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import CiteEntity from '../../components/common/CiteEntity.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import DatasetDeepDive from '../../components/dataset/DatasetDeepDive.astro';
import { getUseCases } from '../../utils/inference.js';
import QuickCommands from '../../components/common/QuickCommands.astro';
import FNITrustPanel from '../../components/FNITrustPanel.astro';
import { loadEntityStreams } from '../../utils/packet-loader.js';
import { getRouteFromId } from '../../utils/mesh-routing-core.js';
import { hydrateEntity } from '../../utils/entity-cache-reader-core.js';
import { cleanDescription } from '../../utils/model-page-helpers.ts';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

let dataset = null;
let model = null; // Added model variable
let error = null;
let tagsArray = [];
let pageTitle = "AI Dataset Details - Free AI Tools";
let pageDescription = "Explore high-quality datasets for AI training and evaluation.";
let meshRelations = [];
let cleanedDesc = "";

try {
  if (!slug) throw new Error("No slug/ID provided");
  
  const type = 'dataset';
  const { entity, html, mesh, _meta } = await loadEntityStreams(type, slugStr);
  
  if (!entity || !_meta.available) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=dataset-not-found&id=' + encodeURIComponent(slugStr));
  }

  model = hydrateEntity(entity, type); // Changed to model
  dataset = model; // Assign model to dataset for backward compatibility with existing code
  tagsArray = dataset?.tags || [];
  meshRelations = mesh || [];
  
  const normalizedSlug = slugStr; // Removed normalizeEntitySlug as it's no longer imported
  const displayDatasetName = dataset?.name || dataset?.title || 'Unknown Dataset';
  pageTitle = `${displayDatasetName} - AI Dataset Insights`;
  cleanedDesc = cleanDescription(dataset?.description || '');
  pageDescription = dataset?.seo_summary?.description || cleanedDesc || `Deep dive into ${displayDatasetName}.`;
  
  dataset.html_readme = html || dataset.html_readme || null;

} catch (e) {
  console.error("[DatasetPage] Error loading dataset:", e);
  error = e;
}

if (!dataset && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=dataset-not-found');
}

const datasetName = dataset?.name || 'Unknown Dataset';
const entityId = model?.id || slugStr;
const modelId = entityId;
const datasetId = entityId;
const displayAuthor = dataset?.author || 'Independent / Community';

const hasFNI = dataset?.fni_score !== undefined || dataset?.fni_percentile !== undefined;
const placeholderImage = '/images/models/default-model.jpg';
const coverImage = dataset?.image_url || placeholderImage;

const jsonld = dataset ? {
  "@context": "https://schema.org",
  "@type": "Dataset",
  "name": datasetName,
  "description": pageDescription,
  "creator": {
    "@type": "Organization",
    "name": displayAuthor
  },
  "license": dataset?.license_spdx || dataset?.license
} : null;

const canonicalPath = dataset ? getRouteFromId(dataset.id || datasetId, 'dataset') : undefined;
---

<EntityLayout 
  entity={dataset} 
  type="dataset" 
  title={pageTitle} 
  description={pageDescription}
  image={coverImage}
  jsonld={jsonld}
  canonical={canonicalPath}
>
    {/* Zone 1: Hero */}
    {dataset && (
      <EntityHeader 
        slot="hero"
        name={datasetName}
        entityType="dataset"
        entityIcon="ðŸ“Š"
        entityLabel="Dataset"
        verified={false} 
        author={displayAuthor}
        lastUpdated={dataset.last_updated}
        description={dataset.seo_summary?.description || cleanedDesc}
        fniScore={dataset.fni_score}
        fniPercentile={dataset.fni_percentile}
        fniCommentary={dataset.fni_commentary}
        sourceUrl={dataset.source_url}
        entityId={datasetId}
        hasImage={Boolean(dataset.image_url)}
      />
    )}

    {/* Zone 2: Insights Extra */}
    {dataset && (
      <div slot="insights-extra" class="mt-4 space-y-8">
         <div class="passport-block animate-slide-up" style="animation-delay: 0.2s;">
            <ModelInfoTable 
              type="dataset"
              model={{
                ...dataset,
                displayName: datasetName
              }} 
            />
         </div>
      </div>
    )}
    
    {/* Zone 1.5: Use Cases */}
    {dataset && (
      <ZoneUseCases 
        slot="use-cases" 
        usecases={getUseCases(dataset)} 
      />
    )}

    {/* Zone 3: CORE (Knowledge Mesh & Relations) */}
    {dataset && (
      <div slot="core-desktop" class="space-y-16">
         <UniversalCore entity={dataset} type="dataset" meshRelations={meshRelations} />
         
         <div class="cite-block animate-slide-up" style="animation-delay: 0.4s;">
            <CiteEntity 
              id={datasetId} 
              name={datasetName} 
              author={displayAuthor} 
              url={dataset.source_url} 
              type="dataset" 
            />
         </div>
      </div>
    )}
  
    {dataset && (
      <div slot="deep-dive" class="space-y-12">
         {/* Zone 4.1: Developer Quick Tools (Always-On) */}
         <div class="space-y-8">
            <QuickCommands entity={dataset} type="dataset" />
            {hasFNI && (
              <FNITrustPanel 
                fniScore={dataset.fni_score}
                fniPercentile={dataset.fni_percentile}
                fniCommentary={dataset.fni_commentary}
                modelName={datasetName}
                modelId={datasetId}
              />
            )}
         </div>

         {/* Zone 4.2: Primary Documentation / Technical Content */}
         <div class="pt-8 border-t border-gray-100 dark:border-gray-800">
            <DatasetDeepDive dataset={dataset} />
         </div>
      </div>
    )}

    {/* Zone 5: Community */}
    {dataset && (
      <div slot="community">
          <AiDisclaimer source={dataset.source} lastUpdated={dataset.last_updated} />
      </div>
    )}
</EntityLayout>
