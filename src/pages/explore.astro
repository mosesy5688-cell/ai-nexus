---
import ModelCard from '@/components/ModelCard.astro';
import Layout from '@/layouts/Layout.astro';
const allModels = await Astro.glob('../data/models.json').then(res => res[0].default);
import Search from '@/components/Search.astro';

const url = new URL(Astro.request.url);
const query = url.searchParams.get('q')?.toLowerCase().trim() || '';
const tagQuery = url.searchParams.get('tag')?.toLowerCase().trim() || '';

let filteredModels = allModels;
let filteredModels = [...allModels]; // Create a mutable copy

if (query) {
  filteredModels = allModels.filter(model => {
  filteredModels = filteredModels.filter(model => {
    const name = model.name.toLowerCase();
    const desc = (model.description || '').toLowerCase();
    const task = (model.task || '').toLowerCase();
    const tags = (model.tags || []).join(' ').toLowerCase();
    return name.includes(query) || desc.includes(query) || task.includes(query) || tags.includes(query);
  });
} else if (tagQuery) {
    filteredModels = allModels.filter(model => 
}
if (tagQuery) {
    filteredModels = filteredModels.filter(model => 
        (model.tags || []).map(t => t.toLowerCase()).includes(tagQuery)
    );
}

const pageTitle = query ? `Search Results for "${query}"` : tagQuery ? `Models tagged with "${tagQuery}"` : "Explore All AI Models";
const pageDescription = `Browse and discover open-source AI models. Search results for: ${query || tagQuery}`;
---

<Layout 
  title={pageTitle + " | Free AI Tools"}
  description={pageDescription}>

  <section id="explore" class="py-12 sm:py-20">
    <div class="container max-w-7xl mx-auto px-4">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white">
            {query ? `Results for "${query}"` : (tagQuery ? `Models tagged with "${tagQuery}"` : "Explore All Models")}
        </h1>
        <p class="mt-4 text-lg text-gray-500 dark:text-gray-400">
            {filteredModels.length} model(s) found.
        </p>
      </div>

      <!-- Search Bar is in the header, but you could place one here if needed -->
      <div class="max-w-2xl mx-auto mb-16">
        <Search />
      </div>

      <!-- Ad Slot 1: Above the grid -->
      <div class="my-8 text-center">
          <!-- Your Google AdSense ad unit code here. Example: <ins class="adsbygoogle" ...></ins> -->
      </div>

      {filteredModels.length > 0 ? (
        <div id="models-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {filteredModels.map(model => (
            <ModelCard model={model} />
          ))}
        </div>
      ) : (
        <div id="no-results" class="text-center py-16">
            <p class="text-xl text-gray-500">No models found matching your criteria.</p>
            <a href="/explore" class="mt-4 inline-block text-blue-500 hover:underline">
                &larr; Back to Explore All
            </a>
        </div>
      )}

      <!-- Ad Slot 2: Below the grid -->
      <div class="my-8 text-center">
          <!-- Your Google AdSense ad unit code here. -->
      </div>
    </div>
  </section>
</Layout>