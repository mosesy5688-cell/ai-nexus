---
export const prerender = false;

/**
 * Tool Detail Page V16.5
 * Core Feature: Developer Ecosystem Integration
 * Architecture: Unified 5-Zone Layout
 */

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import ToolDeepDive from '../../components/tool-detail/ToolDeepDive.astro';
import ModelCarousel from '../../components/ModelCarousel.astro';
import ModelNavigation from '../../components/model-detail/ModelNavigation.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import AiDisclaimer from '../../components/model-detail/AiDisclaimer.astro';
import TagsCloud from '../../components/entity/TagsCloud.astro';
import ModelInfoTable from '../../components/ModelInfoTable.astro';
import { getUseCases } from '../../utils/inference';
import { prepareToolPageData } from '../../utils/tool-page-data.js';
import { normalizeEntitySlug } from '../../utils/entity-cache-reader-core.js';

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
const normalizedSlug = normalizeEntitySlug(slugStr);

let tool = null;
let error = null;
let similarEntities = [];
let tagsArray = [];
let pageTitle = "AI Development Tool - Free AI Tools";
let pageDescription = "Explore high-performance AI frameworks, CLI tools, and libraries.";
let meshRelations = [];

try {
  if (!slug) throw new Error("No slug/ID provided");
  const pageData = await prepareToolPageData(slug, slugStr, Astro.locals);
  
  if (!pageData) {
    Astro.response.status = 404;
    return Astro.redirect('/404?reason=tool-not-found&id=' + encodeURIComponent(slugStr));
  }

  const { tool: resolvedTool, isFallback, repoName, similarEntities: rSimilar, tagsArray: rTags, meshRelations: resolvedMesh } = pageData;
  tool = resolvedTool;
  similarEntities = rSimilar;
  tagsArray = rTags;
  meshRelations = resolvedMesh || [];

  const displayToolName = tool?.name || (isFallback ? repoName : tool?.canonical_name);
  pageTitle = `${displayToolName} - AI Tool Architecture`;
  pageDescription = tool?.seo_summary?.description || tool?.description || `Deep dive into ${displayToolName} development tool.`;

} catch (e) {
  console.error("[ToolPage] Error loading tool:", e);
  error = e;
  Astro.response.status = 500;
}

if (!tool && !error) {
  Astro.response.status = 404;
  return Astro.redirect('/404?source=tool-not-found');
}

const toolName = tool?.name || 'Unknown Tool';
const toolId = tool?.id || normalizedSlug || '';
const displayAuthor = tool?.author || 'Community';

// V15.0: Derived Use Cases and Limits
const derivedUseCases = tool ? getUseCases(tagsArray, '', 'tool', tool.fni_score || 0) : { goodFor: [], limits: [] };

// Generate JSON-LD
const jsonLd = tool ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": toolName,
  "description": pageDescription,
  "url": `https://free2aitools.com/tool/${slugStr}`,
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Cross-platform",
  "creator": {
    "@type": "Organization",
    "name": displayAuthor
  }
} : null;
---

  <EntityLayout
    entity={tool}
    type="tool"
    title={pageTitle}
    description={pageDescription}
    jsonld={jsonLd}
  >
    {/* Zone 1: Hero */}
    <EntityHeader
      slot="hero"
      name={toolName}
      entityType="tool"
      entityIcon="üõ†Ô∏è"
      entityLabel={tool?.language || 'Dev Tool'}
      verified={tool?.verified}
      author={displayAuthor}
      description={tool?.seo_summary?.description || tool?.description}
      fniScore={tool?.fni_score}
      fniPercentile={tool?.fni_percentile}
      sourceUrl={tool?.source_url}
    >
      <div slot="actions" class="flex gap-2">
         {tool?.source_url && (
           <a href={tool.source_url} target="_blank" class="px-4 py-2 bg-gray-800 text-white rounded-lg font-bold hover:bg-gray-900 transition-colors shadow-sm">
             View Source
           </a>
         )}
      </div>
    </EntityHeader>

    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases
      slot="use-cases"
      goodFor={derivedUseCases.goodFor}
      limits={derivedUseCases.limits}
    />

    {/* Zone 2: Insights Extra */}
    <div slot="insights-extra" class="mt-4">
       <div class="px-4 py-2 bg-purple-50 dark:bg-purple-900/10 rounded-xl border border-purple-100 dark:border-purple-800/30">
          <TechSpecsFull entity={tool} type="tool" />
       </div>
    </div>

    {/* Zone 3: Core */}
    <div slot="core-desktop">
       <UniversalCore entity={tool} type="tool" meshRelations={meshRelations} />
    </div>

    <div slot="core-knowledge">
       <UniversalCore entity={tool} type="tool" meshRelations={meshRelations} />
    </div>
    
    <div slot="core-similar">
        {similarEntities.length > 0 ? (
           <ModelCarousel models={similarEntities} />
        ) : (
           <p class="text-gray-500 italic p-4 text-center">Identifying related frameworks and libraries...</p>
        )}
    </div>
  
    <div slot="core-benchmarks">
        <p class="text-gray-500 italic p-4 text-center">Software performance and throughput benchmarks are being analyzed.</p>
    </div>
  
    {/* Zone 4: Deep Dive */}
    <div slot="deep-dive" class="space-y-12">
       <TagsCloud tags={tagsArray} type="tool" />
       <ToolDeepDive tool={tool} />
       <ModelNavigation />
    </div>

    {/* Zone 5: Sidebar */}
    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-purple-50 dark:bg-purple-900/20 rounded-2xl border border-purple-100 dark:border-purple-800/50">
          <h3 class="font-bold text-purple-900 dark:text-purple-100 mb-2 flex items-center gap-2">
            <span>üõ†Ô∏è</span> Technical Node
          </h3>
          <p class="text-xs text-purple-700 dark:text-purple-300 leading-relaxed">
            This entity is an infrastructure component in the AI ecosystem. 
            All technical insights are aggregated via <strong>Factory Stage 3</strong>.
          </p>
       </div>

       <ModelInfoTable model={{
         ...tool,
         displayName: toolName,
         pipeline_tag: tool.language || 'Software'
       }} />
       
       <ShareButtons 
          url={`https://free2aitools.com/tool/${slugStr}`} 
          title={`${toolName} - AI Tool Architecture`} 
       />
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <AiDisclaimer source={tool?.source} lastUpdated={tool?.last_updated} />
    </div>
  </EntityLayout>
