---
/**
 * Tool Detail Page - V15.0
 * Dev Tools: LangChain, vLLM, Ollama, etc.
 */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import DataFreshness from '../../components/common/DataFreshness.astro';
import RelationsPanel from '../../components/model-detail/RelationsPanel.astro';
import ToolDeepDive from '../../components/tool-detail/ToolDeepDive.astro';

const { slug } = Astro.params;
const displaySlug = Array.isArray(slug) ? slug.join('/') : (slug || '');

let tool: any = null;
let cacheVersion = '';

try {
  const runtime = Astro.locals.runtime;
  if (runtime?.env?.R2_ASSETS) {
    const r2 = runtime.env.R2_ASSETS;
    // V15.0 Fix: Robust multi-path lookup for Tools (GitHub/HF sources)
    const normalizedSlug = displaySlug.replace(/\//g, '--').toLowerCase();
    const cachePaths = [
        `cache/entities/tool/${normalizedSlug}.json`,
        `cache/entities/tool/github--${normalizedSlug}.json`, 
        `cache/entities/tool/huggingface--${normalizedSlug}.json`,
        `cache/entities/tool/${displaySlug}.json` // Fallback for simple slugs
    ];

    let cacheFile = null;
    let hitPath = '';

    for (const path of cachePaths) {
        cacheFile = await r2.get(path);
        if (cacheFile) {
            hitPath = path;
            break;
        }
    }

    if (cacheFile) {
      const data = await cacheFile.json();
      tool = data.entity || data;
      cacheVersion = data._contract_version || 'V15';
    }
  }
} catch (e) {
  console.error('[Tool Page] Cache error:', e);
}

const pageTitle = tool ? `${tool.name || tool.canonical_name} - AI Development Tool` : 'Tool Not Found';
const pageDescription = tool?.description?.slice(0, 160) || 'Explore AI development tools';
const canonicalUrl = `https://free2aitools.com/tool/${displaySlug}`;

const jsonLd = tool ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": tool.name || tool.canonical_name,
  "description": tool.description,
  "url": canonicalUrl,
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Cross-platform"
} : null;

const hasTool = !!tool;

// V15.0: Derived Use Cases and Limits
const tagsArray = tool?.tags ? (typeof tool.tags === 'string' ? JSON.parse(tool.tags) : tool.tags) : [];
const derivedUseCases = tool ? getUseCases(tagsArray, '', 'tool', tool.fni_score || 0) : { goodFor: [], limits: [] };
---




<EntityLayout 
  entity={tool} 
  type="tool" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={tool.name || tool.canonical_name}
      entityType="tool"
      entityIcon="üõ†Ô∏è"
      entityLabel={tool.language || 'Tool'}
      verified={false}
      author={tool.author || 'Unknown'}
      description={tool.description}
      fniScore={tool.fni_score}
      fniPercentile={tool.fni_percentile}
      sourceUrl={tool.source_url}
    >
      <div slot="actions" class="flex gap-2">
         {tool.source_url && (
           <a href={tool.source_url} target="_blank" class="px-4 py-2 bg-gray-800 text-white rounded-lg font-bold hover:bg-gray-900 transition-colors">View on GitHub</a>
         )}
      </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
 
    {/* Zone 1 Mobile Actions */}
   <div slot="actions-mobile">
       {tool.source_url && (
          <a href={tool.source_url} target="_blank" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold">GitHub</a>
       )}
   </div>
 
   {/* Zone 3: Core (Desktop) */}
   <div slot="core-desktop" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="space-y-8">
         <RelationsPanel 
              datasetsUsed={tool.datasets_used}
              arxivRefs={tool.arxiv_refs}
              relatedSpaces={tool.related_spaces}
              knowledgeLinks={tool.knowledge_links}
         />
      </div>
       <div class="space-y-8">
           <ShareButtons title={tool.name || tool.canonical_name} description={tool.description || ''} />
       </div>
   </div>
 
   {/* Zone 3: Core (Mobile Tabs) */}
   <div slot="core-knowledge">
       <RelationsPanel 
           datasetsUsed={tool.datasets_used}
           arxivRefs={tool.arxiv_refs}
           relatedSpaces={tool.related_spaces}
           knowledgeLinks={tool.knowledge_links}
       />
   </div>
   
   <div slot="core-related">
       <p class="text-gray-500 italic p-4">No related tools indexed yet.</p>
   </div>
 
   <div slot="core-benchmarks">
       <p class="text-gray-500 italic p-4">No benchmarks available.</p>
   </div>
 
   {/* Zone 4: Deep Dive */}
   <div slot="deep-dive">
        <ToolDeepDive tool={tool} />
   </div>
 
   {/* Zone 5: Community */}
   <div slot="community">
       <DataFreshness version={cacheVersion} />
       <div class="mt-8 text-center">
          <a href="/ranking" class="text-indigo-500 hover:underline">
             ‚Üê Browse all tools
          </a>
       </div>
   </div>
</EntityLayout>

