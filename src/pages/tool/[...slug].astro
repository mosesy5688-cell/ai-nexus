---
/**
 * Tool Detail Page - V15.0
 * Dev Tools: LangChain, vLLM, Ollama, etc.
 */
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import EntityLayout from '../../layouts/EntityLayout.astro';
import EntityHeader from '../../components/entity/EntityHeader.astro';
import ZoneUseCases from '../../components/entity/ZoneUseCases.astro';
import { getUseCases } from '../../utils/inference';
import DataFreshness from '../../components/common/DataFreshness.astro';
import UniversalCore from '../../components/entity/UniversalCore.astro';
import TechSpecsFull from '../../components/entity/TechSpecsFull.astro';
import ShareButtons from '../../components/common/ShareButtons.astro';
import ToolDeepDive from '../../components/tool-detail/ToolDeepDive.astro';
import { fetchEntityFromR2, normalizeEntitySlug, hydrateEntity, augmentEntity } from '../../utils/entity-cache-reader-core.js';
import { loadSpecs, loadBenchmarks } from '../../utils/loadCachedJSON';


const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');
const displaySlug = slugStr;

let tool: any = null;
let cacheVersion = '';

try {
  const result = await fetchEntityFromR2('tool', slug, Astro.locals);
  tool = hydrateEntity(result, 'tool');

  // V15.10: Augmentation Layer for Tools
  try {
    const [specsResult, benchResult] = await Promise.all([loadSpecs(), loadBenchmarks()]);
    const specEntry = specsResult.data?.data?.find(s => s.umid === slugStr.replace(/\//g, '-') || s.umid === slugStr.replace(/\//g, '--'));
    if (specEntry) {
      tool = augmentEntity(tool || {}, specEntry);
    }
  } catch (specError) {
    console.warn("[ToolPage] Spec augmentation failed:", specError.message);
  }

  if (tool) {
    cacheVersion = tool._contract_version || 'V15';
  }
} catch (e) {
  console.error('[Tool Page] Cache error:', e);
}


const pageTitle = tool?.name ? `${tool.name} - AI Development Tool` : (tool?.canonical_name ? `${tool.canonical_name} - AI Development Tool` : `${displaySlug} - AI Development Tool`);
const pageDescription = tool?.description?.slice(0, 160) || `Explore ${displaySlug} AI development tool on Free2AITools.`;
const canonicalUrl = `https://free2aitools.com/tool/${displaySlug}`;

const jsonLd = tool ? {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": tool.name || tool.canonical_name || displaySlug,
  "description": tool.description,
  "url": canonicalUrl,
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Cross-platform"
} : null;

const hasTool = !!tool;

// V15.0: Derived Use Cases and Limits
const tagsArray = tool?.tags ? (typeof tool.tags === 'string' ? JSON.parse(tool.tags) : tool.tags) : [];
const derivedUseCases = tool ? getUseCases(tagsArray, '', 'tool', tool.fni_score || 0) : { goodFor: [], limits: [] };
---




<EntityLayout 
  entity={tool} 
  type="tool" 
  title={pageTitle} 
  description={pageDescription}
  jsonld={jsonLd}
>
    {/* Zone 1: Hero */}
    <EntityHeader 
      slot="hero"
      name={tool?.name || tool?.canonical_name || displaySlug}
      entityType="tool"
      entityIcon="ðŸ› ï¸"
      entityLabel={tool?.language || 'Tool'}
      verified={false}
      author={tool?.author || 'Unknown'}
      description={tool?.description}
      fniScore={tool?.fni_score}
      fniPercentile={tool?.fni_percentile}
      sourceUrl={tool?.source_url}
    >
      <div slot="actions" class="flex gap-2">
         {tool?.source_url && (
           <a href={tool?.source_url} target="_blank" class="px-4 py-2 bg-gray-800 text-white rounded-lg font-bold hover:bg-gray-900 transition-colors shadow-sm">View on GitHub</a>
         )}
      </div>
    </EntityHeader>
 
    {/* Zone 1.5: Use Cases */}
    <ZoneUseCases 
      slot="use-cases" 
      goodFor={derivedUseCases.goodFor} 
      limits={derivedUseCases.limits} 
    />
  
    {/* Zone 3: Core (Desktop/Mobile) */}
    <div slot="core-desktop">
       <UniversalCore entity={tool} type="tool" />
    </div>
 
    <div slot="core-knowledge">
       <UniversalCore entity={tool} type="tool" />
    </div>
    
    <div slot="core-similar">
        <p class="text-gray-500 italic p-4 text-center">Identifying similar developer tools...</p>
    </div>
  
    <div slot="core-benchmarks">
        <p class="text-gray-500 italic p-4 text-center">Performance benchmarks for CLI tools are being aggregated.</p>
    </div>
  
    <div slot="deep-dive" class="space-y-12">
         <TechSpecsFull entity={tool} type="tool" />
         <ToolDeepDive tool={tool} />
    </div>

    <div slot="sidebar" class="space-y-8">
       <div class="p-6 bg-purple-50 dark:bg-purple-900/20 rounded-2xl border border-purple-100 dark:border-purple-800/50">
          <h3 class="font-bold text-purple-900 dark:text-purple-100 mb-2">Development Tool</h3>
          <p class="text-xs text-purple-700 dark:text-purple-300 leading-relaxed">Integrated via the Free2AITools Open Source Harvester. This information is harvested directly from the root repository metadata.</p>
       </div>
    </div>

    {/* Zone 5: Community */}
    <div slot="community">
        <DataFreshness version={cacheVersion} />
    </div>
</EntityLayout>
