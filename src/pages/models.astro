---
/**
 * AI Models Catalog (V4.1)
 * Optimized SSR + UniversalCatalog Engine
 */
import Layout from '../layouts/Layout.astro';
import ListingControls from '../components/common/ListingControls.astro';
import { fetchCatalogData, truncateListingItem } from '../utils/catalog-fetcher.js';
import CatalogCard from '../components/common/CatalogCard.astro';

// SSR Data Fetching
const { items: allModels = [], error } = await fetchCatalogData('model', Astro.locals.runtime?.env);
const models = (allModels || []).slice(0, 48).map(truncateListingItem).filter(Boolean);

const pageTitle = "AI Models Catalog | Explore 70K+ Open-Source Models";
const pageDescription = "Explore the definitive index of open-source AI models. Filter by performance, category, and framework.";

// V18.10.2: Explicit Edge Caching with Revalidation Guard
Astro.response.headers.set('Cache-Control', 'public, max-age=0, must-revalidate, s-maxage=60');
---

<Layout title={pageTitle} description={pageDescription}>
    <main class="min-h-screen py-4">
        <header class="mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4 tracking-tight">
                AI Models <span class="text-indigo-600">Catalog</span>
            </h1>
            <p class="text-base text-gray-600 dark:text-zinc-400 max-w-2xl">
                The authoritative index of open-weights intelligence. Sharded, verified, and ranked by FNI.
            </p>
        </header>

        {error && (
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-8 text-amber-800">
                <p class="font-bold">ðŸ“¡ Catalog Synchronization in Progress</p>
                <p class="text-sm">We are currently updating the technical index. Some results may be temporarily cached.</p>
            </div>
        )}

        <ListingControls type="model" searchId="models-search" />

        <div id="models-catalog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {models.length > 0 ? models.map((model: any) => (
                <div class="animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <CatalogCard item={model} type="model" />
                </div>
            )) : !error && (
                <div class="col-span-full py-20 text-center">
                    <p class="text-gray-400 font-bold uppercase tracking-widest text-sm">Loading Catalog Index...</p>
                </div>
            )}
        </div>

        <div id="pagination" class="mt-16 flex justify-center items-center gap-4"></div>
    </main>

    <script define:vars={{ initialData: models }}>
        window.__CATALOG_DATA__ = initialData;
    </script>

    <script>
        import { UniversalCatalog } from '../scripts/lib/UniversalCatalog.js';
        
        const init = () => {
            new UniversalCatalog({
                initialData: window.__CATALOG_DATA__ || [],
                type: 'model',
                gridId: 'models-catalog-grid',
                searchId: 'models-search',
                dataUrl: 'https://cdn.free2aitools.com/cache/rankings/model/p1.json'
            });
        };

        document.addEventListener('astro:page-load', init);
    </script>
</Layout>

