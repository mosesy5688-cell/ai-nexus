---
/**
 * Universal Entity Detail Layout (V15.0)
 * Implements the 5-Zone System with Mobile Responsiveness
 * 
 * Zone 1: Hero (Identity)
 * Zone 2: Insights (Metrics)
 * Zone 3: Core (Value/Relations) - Mobile Tabs
 * Zone 4: Deep Dive (Details)
 * Zone 5: Community (Social)
 */
import Layout from '../layouts/Layout.astro';
import QuickInsights from '../components/entity/QuickInsights.astro';
import CommunityStats from '../components/model-detail/CommunityStats.astro';
import { getUseCases } from '../utils/inference';

export interface Props {
  entity: any;
  type: 'model' | 'agent' | 'space' | 'tool' | 'dataset' | 'paper';
  title: string;
  description: string;
  image?: string;
  jsonld?: object;
}

const { entity, type, title, description, image, jsonld } = Astro.props;
const hasEntity = !!entity;

// Safe derivation of values
const useCases = hasEntity ? getUseCases(entity.tags || [], entity.pipeline_tag, type) : [];
const displayId = hasEntity ? (entity.id || entity.name || 'Unknown Entity') : '';
---

{ !hasEntity ? (
  <Layout title={title || "Entity Not Found"} description="Entity details not available.">
     <div class="container mx-auto px-4 py-20 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 text-gray-500 rounded-full mb-6">
           <span class="text-3xl">‚ùì</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">Entity Not Found</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-8">The requested {type} could not be found or is currently indexing.</p>
        <a href="/" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Return Home</a>
     </div>
  </Layout>
) : (
  <Layout title={title} description={description} image={image} jsonld={jsonld}>
    {/* Mobile Sticky Header (Zone 1 Compact) */}
    <div id="sticky-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 dark:bg-gray-900/90 backdrop-blur shadow-md transform -translate-y-full transition-transform duration-300 lg:hidden px-4 py-3 flex items-center justify-between">
      <div class="flex flex-col">
        <span class="font-bold text-gray-900 dark:text-gray-100 truncate max-w-[200px]">{displayId}</span>
        <span class="text-xs text-gray-500">FNI {entity.fni_score || '-'}</span>
      </div>
      <div class="flex gap-2">
         <slot name="actions-mobile" />
      </div>
    </div>

    <main class="container mx-auto px-4 py-6 md:py-10 max-w-7xl">
      
      {/* Zone 1: HERO */}
      <section class="mb-6">
        <slot name="hero" />
      </section>

      {/* Zone 1.5: USE CASES (Inferred) */}
      {useCases.length > 0 && (
        <section class="mb-6 flex flex-wrap gap-2 animate-fade-in">
          {useCases.map(uc => (
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 border border-blue-100 dark:border-blue-800">
              <span>{uc.icon}</span> {uc.label}
            </span>
          ))}
        </section>
      )}

      {/* Zone 2: QUICK INSIGHTS */}
      <section class="mb-10">
        <QuickInsights entity={entity} type={type} />
        <slot name="insights-extra" />
      </section>

      {/* Zone 2.5: COMMUNITY STATS (Global Upgrade) */}
      {hasEntity && (
         <CommunityStats 
            source={entity.source || 'huggingface'}
            sourceUrl={entity.source_url}
            likes={entity.likes || entity.github_stars}
            downloads={entity.downloads}
            stars={entity.github_stars || entity.stars}
            forks={entity.github_forks || entity.forks}
            openIssues={entity.github_issues}
         />
      )}

      {/* Zone 3: CORE FEATURES */}
      {/* Desktop: Stacked / Grid */}
      <section class="hidden md:block mb-12 space-y-10">
        <slot name="core-desktop" />
      </section>

      {/* Mobile: Tab Navigation */}
      <section class="md:hidden mb-12">
        <div class="flex overflow-x-auto border-b border-gray-200 dark:border-gray-700 mb-4 no-scrollbar">
          <button class="z3-tab-btn px-4 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 whitespace-nowrap" data-target="z3-knowledge">
            Knowledge
          </button>
          <button class="z3-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent whitespace-nowrap" data-target="z3-related">
            Similar
          </button>
          <button class="z3-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent whitespace-nowrap" data-target="z3-benchmarks">
            Benchmarks
          </button>
        </div>
        
        <div id="z3-knowledge" class="z3-tab-content block animate-fade-in">
           <slot name="core-knowledge" />
        </div>
        <div id="z3-related" class="z3-tab-content hidden animate-fade-in">
           <slot name="core-related" />
        </div>
        <div id="z3-benchmarks" class="z3-tab-content hidden animate-fade-in">
           <slot name="core-benchmarks" />
        </div>
      </section>

      {/* Zone 4: DEEP DIVE */}
      <section id="deep-dive-section" class="mb-12 space-y-6">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <span>üî¨ Deep Dive</span>
          <span class="h-px flex-1 bg-gray-200 dark:bg-gray-700"></span>
        </h2>
        <slot name="deep-dive" />
      </section>

      {/* Zone 5: COMMUNITY */}
      <section class="border-t border-gray-200 dark:border-gray-800 pt-8">
        <slot name="community" />
      </section>
    </main>
  </Layout>
)}
<script>
  // Mobile Sticky Header Logic
  const header = document.getElementById('sticky-header');
  const heroSection = document.querySelector('main');
  
  if (header && heroSection) {
    window.addEventListener('scroll', () => {
      const offset = 300; // Show after scrolling 300px
      if (window.scrollY > offset) {
        header.classList.remove('-translate-y-full');
      } else {
        header.classList.add('-translate-y-full');
      }
    });
  }

  // Mobile Zone 3 Tab Logic
  const tabs = document.querySelectorAll('.z3-tab-btn');
  const contents = document.querySelectorAll('.z3-tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Reset Tabs
      tabs.forEach(t => {
        t.classList.remove('text-indigo-600', 'border-indigo-600');
        t.classList.add('text-gray-500', 'border-transparent');
      });
      // Activate Clicked
      tab.classList.remove('text-gray-500', 'border-transparent');
      tab.classList.add('text-indigo-600', 'border-indigo-600');

      // Show Content
      const targetId = tab.getAttribute('data-target');
      contents.forEach(c => c.classList.add('hidden'));
      document.getElementById(targetId)?.classList.remove('hidden');
    });
  });
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
