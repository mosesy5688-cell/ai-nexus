---
/**
 * Universal Entity Detail Layout (V15.0)
 * Implements the 5-Zone System with Mobile Responsiveness
 * 
 * Zone 1: Hero (Identity)
 * Zone 2: Insights (Metrics)
 * Zone 3: Core (Value/Relations) - Mobile Tabs
 * Zone 4: Deep Dive (Details)
 * Zone 5: Community (Social)
 */
import Layout from '../layouts/Layout.astro';
import QuickInsights from '../components/entity/QuickInsights.astro';
import CommunityStats from '../components/model-detail/CommunityStats.astro';
import { getUseCases } from '../utils/inference';

export interface Props {
  entity: any;
  type: 'model' | 'agent' | 'space' | 'tool' | 'dataset' | 'paper';
  title: string;
  description: string;
  image?: string;
  jsonld?: object;
}

const { entity, type, title, description, image, jsonld } = Astro.props;
const hasEntity = !!entity;

// Safe derivation of values
const displayId = hasEntity ? (entity.id || entity.name || 'Unknown Entity') : '';
---

{ !hasEntity ? (
  <Layout title={title || "Entity Not Found"} description="Entity details not available.">
     <div class="container mx-auto px-4 py-20 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 text-gray-500 rounded-full mb-6">
           <span class="text-3xl">‚ùì</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">Entity Not Found</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-8">The requested {type} could not be found or is currently indexing.</p>
        <a href="/" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Return Home</a>
     </div>
  </Layout>
) : (
  <Layout title={title} description={description} image={image} jsonld={jsonld}>
    {/* Mobile Sticky Header (Zone 1 Compact) */}
    <div id="sticky-header" class="fixed top-0 left-0 right-0 z-50 glass-effect shadow-lg transform -translate-y-full transition-all duration-500 lg:hidden px-4 py-3 flex items-center justify-between border-b border-gray-200/50 dark:border-gray-800/50">
      <div class="flex items-center gap-3 min-w-0">
        <span class="text-xl">{type === 'model' ? 'üß†' : type === 'agent' ? 'ü§ñ' : type === 'dataset' ? 'üìä' : type === 'paper' ? 'üìÑ' : type === 'space' ? 'üéÆ' : 'üõ†Ô∏è'}</span>
        <div class="flex flex-col truncate">
          <span class="font-black text-gray-900 dark:text-gray-100 truncate text-sm leading-tight">{displayId}</span>
          <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter opacity-70">{type} by {entity.author || 'Unknown'}</span>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        {entity.fni_score && (
          <div class="px-2 py-0.5 bg-indigo-600 text-white rounded shadow-fni-pulse text-[10px] font-black flex items-center gap-1 animate-pulse-subtle">
             <span class="opacity-80">‚≠ê</span> {entity.fni_score}
          </div>
        )}
        <slot name="actions-mobile" />
      </div>
    </div>

    <main class="container mx-auto px-4 py-6 md:py-10 max-w-7xl animate-fade-in">
      
      {/* Zone 1: HERO */}
      <section id="hero-zone" class="mb-10 animate-slide-up" style="animation-delay: 0.1s;">
        <slot name="hero" />
      </section>

      {/* Zone 1.5: USE CASES (V15.0) */}
      <div id="use-cases-zone" class="mb-12 animate-slide-up" style="animation-delay: 0.2s;">
        <slot name="use-cases" />
      </div>

      {/* Zone 2: QUICK INSIGHTS */}
      <section id="insights-zone" class="mb-12 animate-slide-up" style="animation-delay: 0.3s;">
        <QuickInsights entity={entity} type={type} />
        <slot name="insights-extra" />
      </section>

      {/* Zone 2.5: COMMUNITY STATS (Global Upgrade) */}
      {hasEntity && (
         <CommunityStats 
            source={entity.source || 'huggingface'}
            sourceUrl={entity.source_url}
            likes={entity.likes || entity.github_stars}
            downloads={entity.downloads}
            stars={entity.github_stars || entity.stars}
            forks={entity.github_forks || entity.forks}
            openIssues={entity.github_issues}
         />
      )}

      {/* Zone 3: CORE FEATURES */}
      {/* Desktop: Stacked / Grid */}
      <section class="hidden md:block mb-12 space-y-10">
        <slot name="core-desktop" />
      </section>
      
      {/* Mobile: Tab Navigation */}
      <section class="md:hidden mb-12">
        <div class="flex overflow-x-auto border-b border-gray-200 dark:border-gray-700 mb-4 no-scrollbar">
          <button class="z3-tab-btn px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 whitespace-nowrap" data-target="z3-knowledge">
            Knowledge
          </button>
          <button class="z3-tab-btn px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 border-b-2 border-transparent whitespace-nowrap" data-target="z3-related">
            Similar
          </button>
          <button class="z3-tab-btn px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 border-b-2 border-transparent whitespace-nowrap" data-target="z3-benchmarks">
            Benchmarks
          </button>
          <button class="z3-tab-btn px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 border-b-2 border-transparent whitespace-nowrap" data-target="z3-trends">
            Trends
          </button>
        </div>
        
        <div id="z3-knowledge" class="z3-tab-content block animate-fade-in">
           <slot name="core-knowledge" />
        </div>
        <div id="z3-related" class="z3-tab-content hidden animate-fade-in">
           <slot name="core-related" />
        </div>
        <div id="z3-benchmarks" class="z3-tab-content hidden animate-fade-in">
           <slot name="core-benchmarks" />
        </div>
        <div id="z3-trends" class="z3-tab-content hidden animate-fade-in">
           <slot name="core-trends" />
        </div>
      </section>

      {/* Zone 4: DEEP DIVE (Collapsible by Default per Spec) */}
      <section id="deep-dive-section" class="mb-12">
        <details id="z4-details" open class="group">
          <summary class="list-none cursor-pointer flex items-center justify-between mb-6 group-open:mb-4">
             <h2 class="text-2xl font-black flex items-center gap-2 text-gray-900 dark:text-white">
                <span>üî¨</span> <span>Deep Dive</span>
             </h2>
             <span class="text-indigo-600 dark:text-indigo-400 text-sm font-bold uppercase tracking-wider group-open:hidden">Expand Details [+]</span>
             <span class="text-gray-400 group-open:block hidden text-2xl transition-transform duration-300 group-open:rotate-180">‚ñæ</span>
          </summary>
          <div class="space-y-8 animate-slide-up">
            <slot name="deep-dive" />
          </div>
        </details>
      </section>

      {/* Zone 5: COMMUNITY */}
      <section class="border-t border-gray-100 dark:border-gray-800 pt-12 mb-10">
        <div class="flex flex-col md:flex-row justify-between gap-8">
           <div class="flex-1">
              <slot name="community" />
           </div>
           <div class="md:w-1/3">
              <slot name="community-sidebar" />
           </div>
        </div>
      </section>
    </main>
  </Layout>
)}
<script is:inline>
  // Mobile Sticky Header Logic
  const stickyHeader = document.getElementById('sticky-header');
  if (stickyHeader) {
    window.addEventListener('scroll', () => {
      if (window.scrollY > 120) {
        stickyHeader.classList.remove('-translate-y-full');
      } else {
        stickyHeader.classList.add('-translate-y-full');
      }
    }, { passive: true });
  }

  // V15.0: Mobile Zone 3 Tab Logic with Persistence
  const tabs = document.querySelectorAll('.z3-tab-btn');
  const contents = document.querySelectorAll('.z3-tab-content');
  const tabKey = 'f2a_detail_z3_tab';

  function setActiveTab(targetId) {
    tabs.forEach(tab => {
      const isActive = tab.getAttribute('data-target') === targetId;
      if (isActive) {
        tab.classList.add('text-indigo-600', 'border-indigo-600', 'font-black');
        tab.classList.remove('text-gray-500', 'border-transparent', 'font-bold');
      } else {
        tab.classList.remove('text-indigo-600', 'border-indigo-600', 'font-black');
        tab.classList.add('text-gray-500', 'border-transparent', 'font-bold');
      }
    });

    contents.forEach(content => {
      if (content.id === targetId) {
        content.classList.remove('hidden');
      } else {
        content.classList.add('hidden');
      }
    });

    localStorage.setItem(tabKey, targetId);
  }

  // Restore Saved Tab
  const savedTab = localStorage.getItem(tabKey);
  if (savedTab && document.getElementById(savedTab)) {
    setActiveTab(savedTab);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      setActiveTab(tab.getAttribute('data-target'));
    });
  });

  // Zone 4 Collapsible Persistence
  const z4 = document.getElementById('z4-details');
  const z4Key = 'f2a_detail_z4_open';
  
  if (z4) {
    const savedZ4 = localStorage.getItem(z4Key);
    if (savedZ4 === 'false') z4.open = false;

    z4.addEventListener('toggle', () => {
      localStorage.setItem(z4Key, z4.open);
    });
  }
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
