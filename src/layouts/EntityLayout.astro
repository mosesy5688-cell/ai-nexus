---
/**
 * Universal Entity Detail Layout (V15.0)
 * Implements the 5-Zone System with Mobile Responsiveness
 * 
 * Zone 1: Hero (Identity)
 * Zone 2: Insights (Metrics)
 * Zone 3: Core (Value/Relations) - Mobile Tabs
 * Zone 4: Deep Dive (Details)
 * Zone 5: Community (Social)
 */
import Layout from '../layouts/Layout.astro';
import QuickInsights from '../components/entity/QuickInsights.astro';
import CommunityStats from '../components/model-detail/CommunityStats.astro';
import EntityStickyHeader from '../components/entity/EntityStickyHeader.astro';
import FullMetadata from '../components/entity/FullMetadata.astro';
import { getUseCases } from '../utils/inference.js';

export interface Props {
  entity: any;
  type: 'model' | 'agent' | 'space' | 'tool' | 'dataset' | 'paper';
  title: string;
  description: string;
  image?: string;
  jsonld?: object;
}

const { entity, type, title, description, image, jsonld } = Astro.props;
const hasEntity = !!entity;

// Safe derivation of values
const displayId = hasEntity ? (entity.id || entity.name || 'Unknown Entity') : '';
const repoPath = hasEntity ? (entity.id || '').replace(/^(model|agent|dataset|paper|space|tool)--/, '').replace(/--/g, '/') : '';
---

{ !hasEntity ? (
  <Layout title={title || "Mesh Node In Sync"} description="The knowledge graph is currently indexing this entity.">
     <div class="py-24 text-center">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-500 rounded-full mb-8 animate-pulse">
           <span class="text-4xl text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-500">üï∏Ô∏è</span>
        </div>
        <h1 class="text-3xl font-black text-gray-900 dark:text-gray-100 mb-4 tracking-tight">Mesh Node Building...</h1>
        <p class="text-base text-gray-600 dark:text-gray-400 mb-2 max-w-md mx-auto">
          The <span class="font-bold text-indigo-600 dark:text-indigo-400">Neural Mesh Hub</span> has identified this link, but the full technical profile is still being synchronized from the production pipeline.
        </p>
        <p class="text-xs text-gray-400 dark:text-gray-500 mb-10">
          Sync Status: Verified Connectivity | Data Refresh In-Progress
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-500/20 transition-all">Return Home</a>
            <a href="/ranking" class="px-8 py-3 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700 rounded-xl font-bold hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">Explore Rankings</a>
        </div>
     </div>
  </Layout>
) : (
  <Layout title={title} description={description} image={image} jsonld={jsonld}>
    <EntityStickyHeader 
      type={type} 
      entity={entity} 
      displayId={displayId}
    >
      <slot name="actions-mobile" slot="actions-mobile" />
    </EntityStickyHeader>

    <main class="animate-fade-in relative max-w-5xl mx-auto px-4 lg:px-0" data-repo-path={repoPath}>
      
      {/* Zone 1: HERO (Identity) */}
      <section id="hero-zone" class="mb-12 animate-slide-up relative z-10" style="animation-delay: 0.1s;">
        <slot name="hero" />
      </section>

      {/* Zone 1.5: USE CASES (Value Proposition) */}
      <section id="use-cases-zone" class="mb-12 animate-slide-up" style="animation-delay: 0.15s;">
        <slot name="use-cases" />
      </section>

      {/* V16.17: GALLERY ZONE */}
      <section id="gallery-zone" class="mb-12 animate-slide-up" style="animation-delay: 0.2s;">
        <slot name="gallery" />
      </section>

      {/* UNIFIED VERTICAL STACK */}
      <div class="space-y-16 mb-20">
        
        {/* Zone 2: QUICK INSIGHTS & Technical Specs */}
        <section id="insights-zone" class="animate-slide-up" style="animation-delay: 0.25s;">
           <div class="grid grid-cols-1 md:grid-cols-1 gap-8">
              <QuickInsights entity={entity} type={type} />
              <slot name="insights-extra" />
           </div>
        </section>

        {/* Zone 3: CORE (Knowledge Mesh & Relations) */}
        <section id="core-zone" class="animate-slide-up" style="animation-delay: 0.3s;">
           <div class="space-y-12">
             {/* 
                V16.99: STRICT SINGLE-EXECUTION 
                We must NEVER render the same slot twice, even in hidden divs.
                Cloudflare Worker CPU limit is 50ms per request.
             */}
             <div class="z3-core-stack mb-12">
                <slot name="core-desktop" />
                
                {/* Legacy Support: If route still provides granular slots, stack them vertically */}
                <div class="space-y-16">
                   <slot name="core-knowledge" />
                   <slot name="core-similar" />
                   <slot name="core-benchmarks" />
                   <slot name="core-trends" />
                </div>
             </div>
           </div>
        </section>

        {/* SIDEBAR CONTENT (Re-homed to main stack) */}
        <section id="sidebar-relocation" class="animate-slide-up space-y-12" style="animation-delay: 0.35s;">
          {hasEntity && (
             <CommunityStats 
                source={entity.source || 'huggingface'}
                sourceUrl={entity.source_url}
                likes={entity.likes || entity.github_stars}
                downloads={entity.downloads}
                stars={entity.github_stars || entity.stars}
                forks={entity.github_forks || entity.forks}
                openIssues={entity.github_issues}
                fniScore={entity.fni_score}
                fniPercentile={entity.fni_percentile}
             />
          )}
          <slot name="sidebar" />
          <slot name="community-sidebar" />
        </section>

        {/* Zone 4: DEEP DIVE (Technical Documentation) */}
        <section id="deep-dive-section" class="pt-8 border-t border-gray-100 dark:border-gray-800">
          <details id="z4-details" open class="group">
            <summary class="list-none cursor-pointer flex items-center justify-between mb-8 group-open:mb-8">
               <h2 class="text-2xl font-black flex items-center gap-3 text-gray-900 dark:text-white uppercase tracking-tighter">
                  <span class="p-2 bg-indigo-50 dark:bg-indigo-950/40 rounded-xl">üî¨</span> 
                  <span>Technical Deep Dive</span>
               </h2>
               <div class="flex items-center gap-4">
                  <span class="text-indigo-600 dark:text-indigo-400 text-[10px] font-black uppercase tracking-widest group-open:hidden">Full Specifications [+]</span>
                  <span class="text-gray-400 group-open:block hidden text-2xl transition-transform duration-300 group-open:rotate-180">‚ñæ</span>
               </div>
            </summary>
            <div class="space-y-12 animate-slide-up">
              <slot name="deep-dive" />
            </div>
          </details>
        </section>

        {/* Zone 5: COMMUNITY & LEGAL */}
        <div class="pt-12 border-t border-gray-100 dark:border-gray-800 space-y-8">
           <slot name="community" />
           <FullMetadata entity={entity} title={`${type.charAt(0).toUpperCase() + type.slice(1)} Transparency Report`} />
        </div>
      </div>
    </main>
  </Layout>
)}
<script is:inline>

  // V15.0: Mobile Zone 3 Tab Logic with Persistence
  const tabs = document.querySelectorAll('.z3-tab-btn');
  const contents = document.querySelectorAll('.z3-tab-content');
  const tabKey = 'f2a_detail_z3_tab';

  function setActiveTab(targetId) {
    tabs.forEach(tab => {
      const isActive = tab.getAttribute('data-target') === targetId;
      if (isActive) {
        tab.classList.add('text-indigo-600', 'border-indigo-600', 'font-black');
        tab.classList.remove('text-gray-500', 'border-transparent', 'font-bold');
      } else {
        tab.classList.remove('text-indigo-600', 'border-indigo-600', 'font-black');
        tab.classList.add('text-gray-500', 'border-transparent', 'font-bold');
      }
    });

    contents.forEach(content => {
      if (content.id === targetId) {
        content.classList.remove('hidden');
      } else {
        content.classList.add('hidden');
      }
    });

    localStorage.setItem(tabKey, targetId);
  }

  // Restore Saved Tab
  const savedTab = localStorage.getItem(tabKey);
  if (savedTab && document.getElementById(savedTab)) {
    setActiveTab(savedTab);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      setActiveTab(tab.getAttribute('data-target'));
    });
  });

  // Zone 4 Collapsible Persistence
  const z4 = document.getElementById('z4-details');
  const z4Key = 'f2a_detail_z4_open';
  
  if (z4) {
    const savedZ4 = localStorage.getItem(z4Key);
    if (savedZ4 === 'false') z4.open = false;

    z4.addEventListener('toggle', () => {
      localStorage.setItem(z4Key, z4.open);
    });
  }
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
