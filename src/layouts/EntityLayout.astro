---
/**
 * Universal Entity Detail Layout (V15.0)
 * Implements the 5-Zone System with Mobile Responsiveness
 * 
 * Zone 1: Hero (Identity)
 * Zone 2: Insights (Metrics)
 * Zone 3: Core (Value/Relations) - Mobile Tabs
 * Zone 4: Deep Dive (Details)
 * Zone 5: Community (Social)
 */
import Layout from '../layouts/Layout.astro';
import QuickInsights from '../components/entity/QuickInsights.astro';
import CommunityStats from '../components/model-detail/CommunityStats.astro';
import EntityStickyHeader from '../components/entity/EntityStickyHeader.astro';
import FullMetadata from '../components/entity/FullMetadata.astro';
import { getUseCases } from '../utils/inference';

export interface Props {
  entity: any;
  type: 'model' | 'agent' | 'space' | 'tool' | 'dataset' | 'paper';
  title: string;
  description: string;
  image?: string;
  jsonld?: object;
}

const { entity, type, title, description, image, jsonld } = Astro.props;
const hasEntity = !!entity;

// Safe derivation of values
const displayId = hasEntity ? (entity.id || entity.name || 'Unknown Entity') : '';
---

{ !hasEntity ? (
  <Layout title={title || "Entity Not Found"} description="Entity details not available.">
     <div class="container mx-auto px-4 py-20 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 text-gray-500 rounded-full mb-6">
           <span class="text-3xl">‚ùì</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">Entity Not Found</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-8">The requested {type} could not be found or is currently indexing.</p>
        <a href="/" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Return Home</a>
     </div>
  </Layout>
) : (
  <Layout title={title} description={description} image={image} jsonld={jsonld}>
    <EntityStickyHeader 
      type={type} 
      entity={entity} 
      displayId={displayId}
    >
      <slot name="actions-mobile" slot="actions-mobile" />
    </EntityStickyHeader>

    <main class="container mx-auto px-4 py-8 max-w-7xl animate-fade-in relative">
      
      {/* Zone 1: HERO */}
      <section id="hero-zone" class="mb-6 animate-slide-up relative z-10" style="animation-delay: 0.1s;">
        <slot name="hero" />
      </section>

      {/* Zone 1.5: USE CASES */}
      <section id="use-cases-zone" class="mb-8 animate-slide-up" style="animation-delay: 0.2s;">
        <slot name="use-cases" />
      </section>

      {/* V15.0: UNIFIED CONTENT GRID */}
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start mb-12">
        
        {/* LEFT COLUMN: Main Content Ecosystem */}
        <div class="lg:col-span-8">
          <div class="space-y-12">
            
            {/* Zone 2: QUICK INSIGHTS */}
            <section id="insights-zone" class="animate-slide-up" style="animation-delay: 0.3s;">
               <QuickInsights entity={entity} type={type} />
               <slot name="insights-extra" />
            </section>

            <section id="core-zone" class="space-y-12">
               {/* Zone 3 Desktop */}
               <div class="hidden md:block">
                 <slot name="core-desktop" />
               </div>

               {/* Zone 3 Mobile Tabs */}
               <div class="md:hidden">
                 <div class="flex overflow-x-auto border-b border-gray-200 dark:border-gray-700 mb-6 no-scrollbar">
                   {['Knowledge', 'Similar', 'Benchmarks', 'Trends'].map((tab) => (
                     <button 
                       class="z3-tab-btn px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 border-b-2 border-transparent whitespace-nowrap" 
                       data-target={`z3-${tab.toLowerCase()}`}
                     >
                       {tab}
                     </button>
                   ))}
                 </div>
                 
                 <div id="z3-knowledge" class="z3-tab-content block animate-fade-in"><slot name="core-knowledge" /></div>
                 <div id="z3-similar" class="z3-tab-content hidden animate-fade-in"><slot name="core-similar" /></div>
                 <div id="z3-benchmarks" class="z3-tab-content hidden animate-fade-in"><slot name="core-benchmarks" /></div>
                 <div id="z3-trends" class="z3-tab-content hidden animate-fade-in"><slot name="core-trends" /></div>
               </div>
            </section>

            {/* Zone 4: DEEP DIVE */}
            <section id="deep-dive-section">
              <details id="z4-details" open class="group">
                <summary class="list-none cursor-pointer flex items-center justify-between mb-8 group-open:mb-4">
                   <h2 class="text-2xl font-black flex items-center gap-2 text-gray-900 dark:text-white">
                      <span>üî¨</span> <span>Deep Dive</span>
                   </h2>
                   <span class="text-indigo-600 dark:text-indigo-400 text-sm font-bold uppercase tracking-wider group-open:hidden">Expand Details [+]</span>
                   <span class="text-gray-400 group-open:block hidden text-2xl transition-transform duration-300 group-open:rotate-180">‚ñæ</span>
                </summary>
                <div class="space-y-12 animate-slide-up">
                  <slot name="deep-dive" />
                </div>
              </details>
            </section>

            {/* V15.0: FULL METADATA DISCLOSURE (Absolute Transparency) */}
            <div class="pt-12 border-t border-gray-100 dark:border-gray-800">
               <FullMetadata entity={entity} title={`${type.charAt(0).toUpperCase() + type.slice(1)} Transparency Report`} />
            </div>
          </div>
        </div>

        {/* RIGHT COLUMN: Sidebar Ecosystem (Sticky) */}
        <aside id="sidebar-zone" class="lg:col-span-4 sticky top-10 flex flex-col gap-12 self-start pt-0">
          {hasEntity && (
             <CommunityStats 
                source={entity.source || 'huggingface'}
                sourceUrl={entity.source_url}
                likes={entity.likes || entity.github_stars}
                downloads={entity.downloads}
                stars={entity.github_stars || entity.stars}
                forks={entity.github_forks || entity.forks}
                openIssues={entity.github_issues}
                fniScore={entity.fni_score}
                fniPercentile={entity.fni_percentile}
             />
          )}
          <slot name="sidebar" />
          <slot name="community-sidebar" />
          <div class="pt-8 border-t border-gray-50 dark:border-gray-800">
             <slot name="community" />
          </div>
        </aside>
      </div>
    </main>
  </Layout>
)}
<script is:inline>

  // V15.0: Mobile Zone 3 Tab Logic with Persistence
  const tabs = document.querySelectorAll('.z3-tab-btn');
  const contents = document.querySelectorAll('.z3-tab-content');
  const tabKey = 'f2a_detail_z3_tab';

  function setActiveTab(targetId) {
    tabs.forEach(tab => {
      const isActive = tab.getAttribute('data-target') === targetId;
      if (isActive) {
        tab.classList.add('text-indigo-600', 'border-indigo-600', 'font-black');
        tab.classList.remove('text-gray-500', 'border-transparent', 'font-bold');
      } else {
        tab.classList.remove('text-indigo-600', 'border-indigo-600', 'font-black');
        tab.classList.add('text-gray-500', 'border-transparent', 'font-bold');
      }
    });

    contents.forEach(content => {
      if (content.id === targetId) {
        content.classList.remove('hidden');
      } else {
        content.classList.add('hidden');
      }
    });

    localStorage.setItem(tabKey, targetId);
  }

  // Restore Saved Tab
  const savedTab = localStorage.getItem(tabKey);
  if (savedTab && document.getElementById(savedTab)) {
    setActiveTab(savedTab);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      setActiveTab(tab.getAttribute('data-target'));
    });
  });

  // Zone 4 Collapsible Persistence
  const z4 = document.getElementById('z4-details');
  const z4Key = 'f2a_detail_z4_open';
  
  if (z4) {
    const savedZ4 = localStorage.getItem(z4Key);
    if (savedZ4 === 'false') z4.open = false;

    z4.addEventListener('toggle', () => {
      localStorage.setItem(z4Key, z4.open);
    });
  }
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
